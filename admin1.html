<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Lambo Admin üïµÔ∏è‚Äç‚ôÇÔ∏è</title>
    <style>
        :root { --bg: #0b0d12; --card: #151921; --text: #fff; --accent: #ffd400; --green: #2ad06c; --red: #ff4d4d; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 20px; }
        
        /* Inputs */
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        input { background: var(--card); border: 1px solid #333; color: #fff; padding: 12px; border-radius: 8px; flex: 1; min-width: 200px; }
        button { background: var(--accent); color: #000; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 900; cursor: pointer; }
        button:hover { opacity: 0.9; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .tab-btn { background: transparent; color: #777; border: 1px solid #333; }
        .tab-btn.active { background: #333; color: #fff; border-color: #555; }

        /* Sections */
        .section { display: none; }
        .section.active { display: block; }

        /* Report Box */
        .report-box { background: var(--card); padding: 20px; border-radius: 12px; white-space: pre-wrap; font-family: monospace; border: 1px solid #333; }

        /* Stats Grid */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #2a2f3d; }
        .stat-label { color: #777; font-size: 12px; margin-bottom: 5px; }
        .stat-val { font-size: 20px; font-weight: 800; }

        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; color: #777; padding: 10px; border-bottom: 1px solid #333; }
        td { padding: 10px; border-bottom: 1px solid #222; }
        .plus { color: var(--green); }
        .minus { color: var(--red); }
        .type-badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .type-CASE { background: rgba(255, 212, 0, 0.15); color: var(--accent); }
        .type-CRASH { background: rgba(255, 77, 77, 0.15); color: var(--red); }
    </style>
</head>
<body>

    <h1>üïµÔ∏è‚Äç‚ôÇÔ∏è Lambo Admin</h1>

    <div class="controls">
        <input type="password" id="adminSecret" placeholder="–í–≤–µ–¥–∏ ADMIN_SECRET (–∏–∑ Vercel)">
        <button onclick="saveSecret()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('general')">üìä –≠–∫–æ–Ω–æ–º–∏–∫–∞ (AI)</button>
        <button class="tab-btn" onclick="switchTab('user')">üë§ –î–æ—Å—å–µ –ò–≥—Ä–æ–∫–∞</button>
    </div>

    <div id="general" class="section active">
        <button onclick="loadGeneralReport()" style="margin-bottom:15px; width:100%">üîÑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≠–∫–æ–Ω–æ–º–∏–∫—É</button>
        <div id="aiReport" class="report-box">–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç –¥–ª—è –ò–ò...</div>
        <button onclick="copyReport()" style="margin-top:10px; background:#333; color:#fff;">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è ChatGPT</button>
    </div>

    <div id="user" class="section">
        <div class="controls">
            <input type="number" id="userIdInput" placeholder="Telegram ID –∏–≥—Ä–æ–∫–∞">
            <button onclick="loadUserHistory()">–ù–∞–π—Ç–∏ –¥–æ—Å—å–µ</button>
        </div>

        <div id="userStats" style="display:none">
            <div class="grid">
                <div class="stat-card">
                    <div class="stat-label">–ö–ï–ô–°–´ (–ü–æ—Ç—Ä–∞—Ç–∏–ª / –í—ã–∏–≥—Ä–∞–ª)</div>
                    <div class="stat-val">
                        <span id="caseSpend">0</span> / <span id="caseWon" style="color:var(--green)">0</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">CRASH (–ü–æ—Ç—Ä–∞—Ç–∏–ª / –í—ã–∏–≥—Ä–∞–ª)</div>
                    <div class="stat-val">
                        <span id="crashSpend">0</span> / <span id="crashWon" style="color:var(--green)">0</span>
                    </div>
                </div>
            </div>

            <h3>–ò—Å—Ç–æ—Ä–∏—è (–ü–æ—Å–ª–µ–¥–Ω–∏–µ 50)</h3>
            <table>
                <thead>
                    <tr>
                        <th>–í—Ä–µ–º—è</th>
                        <th>–¢–∏–ø</th>
                        <th>–î–µ—Ç–∞–ª–∏</th>
                        <th>–°—É–º–º–∞</th>
                    </tr>
                </thead>
                <tbody id="historyTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ–∫—Ä–µ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ, —á—Ç–æ–±—ã –Ω–µ –≤–≤–æ–¥–∏—Ç—å –∫–∞–∂–¥—ã–π —Ä–∞–∑
        const secretInput = document.getElementById('adminSecret');
        if(localStorage.getItem('admin_secret')) {
            secretInput.value = localStorage.getItem('admin_secret');
        }

        function saveSecret() {
            localStorage.setItem('admin_secret', secretInput.value);
            alert('–ü–∞—Ä–æ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ');
        }

        function switchTab(tabId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // === 1. –ó–ê–ì–†–£–ó–ö–ê –û–ë–©–ï–ì–û –û–¢–ß–ï–¢–ê ===
        async function loadGeneralReport() {
            const secret = secretInput.value;
            if(!secret) return alert('–í–≤–µ–¥–∏ —Å–µ–∫—Ä–µ—Ç!');
            
            document.getElementById('aiReport').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            try {
                // –ó–∞–ø—Ä–æ—Å –∫ api/live?action=admin
                const res = await fetch(`/api/live?action=admin&secret=${secret}`).then(r => r.json());
                
                if(res.error) {
                    document.getElementById('aiReport').textContent = '–û—à–∏–±–∫–∞: ' + res.error;
                } else {
                    document.getElementById('aiReport').textContent = res.full_report;
                }
            } catch(e) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        function copyReport() {
            const text = document.getElementById('aiReport').textContent;
            navigator.clipboard.writeText(text);
            alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ! –í—Å—Ç–∞–≤—å —ç—Ç–æ –≤ ChatGPT.');
        }

        // === 2. –ó–ê–ì–†–£–ó–ö–ê –ò–°–¢–û–†–ò–ò –ò–ì–†–û–ö–ê ===
        async function loadUserHistory() {
            const secret = secretInput.value;
            const uid = document.getElementById('userIdInput').value;
            if(!secret || !uid) return alert('–í–≤–µ–¥–∏ —Å–µ–∫—Ä–µ—Ç –∏ ID');

            try {
                // –ó–∞–ø—Ä–æ—Å –∫ api/live?action=user_history
                const res = await fetch(`/api/live?action=user_history&user_id=${uid}&secret=${secret}`).then(r => r.json());

                if(res.error) return alert(res.error);

                document.getElementById('userStats').style.display = 'block';

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ü–∏—Ñ—Ä—ã
                const s = res.stats;
                document.getElementById('caseSpend').textContent = s.total_case_spend;
                document.getElementById('caseWon').textContent = s.total_case_won;
                document.getElementById('crashSpend').textContent = s.total_crash_spend;
                document.getElementById('crashWon').textContent = s.total_crash_won;

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                const tbody = document.getElementById('historyTable');
                tbody.innerHTML = res.history.map(row => {
                    const date = new Date(row.created_at).toLocaleString('ru-RU');
                    const isPlus = row.change > 0;
                    const colorClass = isPlus ? 'plus' : 'minus';
                    const sign = isPlus ? '+' : '';
                    
                    return `
                        <tr>
                            <td style="color:#555">${date}</td>
                            <td><span class="type-badge type-${row.type}">${row.type}</span></td>
                            <td>${row.info}</td>
                            <td class="${colorClass}"><b>${sign}${row.change} ‚òÖ</b></td>
                        </tr>
                    `;
                }).join('');

            } catch(e) {
                alert('–û—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å ID –∏–ª–∏ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç.');
                console.error(e);
            }
        }
    </script>
</body>
</html>
