<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>–û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–∞</title>
<link rel="stylesheet" href="/styles.css"> 
<style>
/* –õ–æ–∫–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
:root{--bg:#0b0d12;--text:#f7f8fb;--accent:#ffd400}
*{box-sizing:border-box}
html,body{margin:0;min-height:100%;background:#0b0d12;color:var(--text);font-family:system-ui,-apple-system,"Futura PT",Inter,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
.page{max-width:520px;margin:0 auto;padding:14px 16px 90px;}

/* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
.top{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center; z-index: 2; position: relative;}
.back{background:var(--accent);color:#171a1f;font-weight:900;border:none;border-radius:16px;padding:12px 16px;cursor:pointer}
.logo{height:32px}
.balance{background:var(--accent);color:#171a1f;font-weight:900;border-radius:999px;padding:8px 14px;display:flex;gap:8px}

/* –ó–ê–ì–û–õ–û–í–û–ö + –ì–ê–†–ê–ù–¢ */
.title-area {
  display: flex; justify-content: center; align-items: center; gap: 10px;
  margin: 16px 2px 8px; position: relative;
}
.h1 { font-weight:900; font-size:42px; margin:0; text-align:center; line-height: 1; }

.guarant-badge {
  border: 2px solid var(--accent);
  color: var(--accent);
  border-radius: 12px;
  padding: 4px 8px;
  font-size: 11px; font-weight: 800;
  cursor: pointer;
  text-transform: uppercase;
  transition: transform 0.1s, background 0.1s;
}
.guarant-badge:active { transform: scale(0.95); background: rgba(255, 212, 0, 0.1); }

/* –°–µ—Ç–∫–∞ –∫–µ–π—Å–æ–≤ */
.grid-wrapper { position: relative; margin-top: 8px; }
.grid { display:grid; grid-template-columns:1fr 1fr; gap:18px; }

/* –ö–ù–û–ü–ö–ê –°–ë–†–û–°–ê (–û–¢–ö–†–´–¢–¨ –ó–ê–ù–û–í–û) */
.reset-overlay {
  position: absolute; inset: -10px; /* –ß—É—Ç—å —à–∏—Ä–µ —Å–µ—Ç–∫–∏ */
  background: rgba(11, 13, 18, 0.85);
  backdrop-filter: blur(4px);
  display: none; /* –°–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
  align-items: center; justify-content: center;
  z-index: 10; border-radius: 24px;
  opacity: 0; transition: opacity 0.3s;
}
.reset-overlay.show { display: flex; opacity: 1; }

.btn-reset {
  background: var(--accent); color: #171a1f;
  border: none; padding: 16px 32px;
  border-radius: 99px; font-size: 16px; font-weight: 900;
  text-transform: uppercase; cursor: pointer;
  box-shadow: 0 0 30px rgba(255, 212, 0, 0.4);
  transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.reset-overlay.show .btn-reset { transform: scale(1); }
.btn-reset:active { transform: scale(0.95); }


/* –Ø–ß–ï–ô–ö–ê (–¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ) */
.cell {
  position:relative; background:rgba(255,255,255,.03); border:none; border-radius:24px;
  padding:0; /* –£–±–∏—Ä–∞–µ–º –ø–∞–¥–¥–∏–Ω–≥, —á—Ç–æ–±—ã —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–ª–µ–∫—Å–æ–º */
  box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:hidden;
  aspect-ratio: 1/1; cursor:pointer; z-index: 1;
  display: flex; align-items: center; justify-content: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ */
}

.crate {
  width:100%; height:100%; 
  display:flex; align-items:center; justify-content:center;
}
.crate img {
  width:85%; height:85%; object-fit:contain; 
  transition:opacity .15s;
  filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
}

.hint { position:absolute; inset:0; display:grid; place-items:center; font-weight:900; background:rgba(0,0,0,.28); opacity:0; pointer-events:none; transition:.18s }
.cell.show-hint .hint { opacity:1 }

/* === –í–ù–£–¢–†–ï–ù–ù–û–°–¢–ò –Ø–©–ò–ö–ê (–ü–†–ò–ó) === */
.cell-doors {
  position:absolute; inset:14px; /* –û—Ç—Å—Ç—É–ø –≤–æ—Ä–æ—Ç –æ—Ç –∫—Ä–∞—è —è—á–µ–π–∫–∏ */
  background:#0a0c12; border:1px solid #1b2130; border-radius:18px; overflow:hidden; pointer-events: none;
}
.cell-door { position:absolute; top:8%; bottom:8%; width:50%; background:linear-gradient(180deg,#ffc400,#e2ae00); z-index: 2; }
.cell-door.l { left:0; transform-origin:left center }
.cell-door.r { right:0; transform-origin:right center }

.cell.open .cell-door.l { transform:perspective(800px) rotateY(-95deg); transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
.cell.open .cell-door.r { transform:perspective(800px) rotateY(95deg); transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

/* –ö–æ–Ω—Ç–µ–Ω—Ç –≤–Ω—É—Ç—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ —è—â–∏–∫–∞ (–ü—Ä–∏–∑) */
.prize-box {
  position: absolute; inset: 0; 
  display: flex; flex-direction: column; 
  align-items: center; justify-content: center; /* –ò–¥–µ–∞–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä */
  z-index: 1; pointer-events: auto;
  opacity: 0; transition: opacity 0.3s ease;
}
.cell.open .prize-box { opacity: 1; transition-delay: 0.2s; } 

.prize-box img {
  width: 70%; height: 70%; object-fit: contain; 
  filter: drop-shadow(0 0 15px rgba(255, 212, 0, 0.4));
  margin-bottom: 2px; /* –ß—É—Ç—å –æ—Ç—Å—Ç—É–ø –¥–æ —Ç–µ–∫—Å—Ç–∞ */
  transform: scale(0.8); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.cell.open .prize-box img { transform: scale(1); }

.prize-title {
  font-size: 10px; font-weight: 900; color: #fff; text-align: center;
  line-height: 1.1; margin-bottom: 4px;
  width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.prize-actions { display: flex; gap: 4px; width: 90%; }
.prize-btn {
  flex: 1; border: none; border-radius: 6px;
  padding: 5px 0; font-size: 9px; font-weight: 800;
  cursor: pointer; text-transform: uppercase;
}
.btn-take { background: var(--accent); color: #171a1f; }
.btn-sell-mini { background: #2c313f; color: #a5abb8; border: 1px solid #3e4554; }


/* === –û–í–ï–†–õ–ï–ô === */
.overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(12px);
  z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.4s ease;
}
.overlay.show { opacity: 1; pointer-events: auto; }

.close-overlay-btn {
  position: absolute; top: 24px; right: 24px;
  background: rgba(255, 255, 255, 0.1); border: none; color: #fff;
  font-size: 32px; line-height: 1; width: 44px; height: 44px;
  border-radius: 50%; display: flex; align-items: center; justify-content: center;
  cursor: pointer; z-index: 10001; transition: background 0.2s, transform 0.2s;
  padding-bottom: 4px; 
}
.close-overlay-btn:active { transform: scale(0.9); background: rgba(255, 255, 255, 0.2); }

.overlay-card {
  position: relative; overflow: visible; 
  transform: scale(0.8) translateY(20px); transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  display: flex; flex-direction: column; align-items: center;
}
.overlay.show .overlay-card { transform: scale(1) translateY(0); }

.rays {
  position: absolute; left: 50%; top: 120px; width: 250vmax; height: 250vmax;
  background: conic-gradient(from 0deg, transparent 0deg, rgba(255, 212, 0, 0.15) 20deg, transparent 40deg, rgba(255, 212, 0, 0.15) 60deg, transparent 80deg, rgba(255, 212, 0, 0.15) 100deg, transparent 120deg, rgba(255, 212, 0, 0.15) 140deg, transparent 160deg, rgba(255, 212, 0, 0.15) 180deg, transparent 200deg, rgba(255, 212, 0, 0.15) 220deg, transparent 240deg, rgba(255, 212, 0, 0.15) 260deg, transparent 280deg, rgba(255, 212, 0, 0.15) 300deg, transparent 320deg, rgba(255, 212, 0, 0.15) 340deg, transparent 360deg);
  animation: spinCentered 15s linear infinite; z-index: -1; pointer-events: none; border-radius: 50%;
}
@keyframes spinCentered { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }

.overlay-img {
  width: 240px; height: 240px; object-fit: contain;
  filter: drop-shadow(0 0 40px rgba(255, 212, 0, 0.5)); margin-bottom: 24px;
}
.overlay-title {
  font-size: 32px; font-weight: 900; text-transform: uppercase;
  text-shadow: 0 4px 20px rgba(0,0,0,0.8); margin-bottom: 32px; text-align: center;
}

.actions { display: flex; flex-direction: column; gap: 14px; width: 280px; }
.act-btn {
  border: none; padding: 18px; border-radius: 18px;
  font-size: 18px; font-weight: 900; cursor: pointer;
  text-transform: uppercase; width: 100%; transition: transform 0.1s;
}
.act-btn:active { transform: scale(0.97); }
.btn-sell { background: var(--accent); color: #111; box-shadow: 0 0 25px rgba(255,212,0,0.3); }
.btn-keep { background: #2c313f; color: #fff; border: 1px solid #3e4554; }

/* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
.price-wrap { display:flex; justify-content:center; margin:24px 0 32px }
.price { background:var(--accent); color:#171a1f; padding:12px 24px; border-radius:16px; font-weight:900; font-size:18px; box-shadow:0 0 22px rgba(255,212,0,.35) }

.prizes-section { margin-top:20px; background:#151921; border-radius:24px; padding:20px; border:1px solid #232838; }
.section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.section-title { font-weight: 800; color: #fff; font-size: 16px; }
.price-tag { background: var(--accent); color: #171a1f; padding: 6px 12px; border-radius: 8px; font-weight: 900; font-size: 14px; box-shadow: 0 0 10px rgba(255, 212, 0, 0.2); }

.prize-item { background: #0b0d12; border-radius: 16px; padding: 10px; display: flex; flex-direction: column; align-items: center; text-align: center; border: 1px solid #232838; position: relative; }
.prize-item.rare { border-color: var(--accent); box-shadow: 0 0 10px rgba(255, 212, 0, 0.15); }
.prize-img { width: 48px; height: 48px; object-fit: contain; margin-bottom: 8px; }
.prize-name { font-size: 11px; font-weight: 700; color: #a5abb8; line-height: 1.2; }
.rare-badge { position: absolute; top: -6px; right: -6px; background: var(--accent); color: #000; font-size: 9px; font-weight: 900; padding: 2px 6px; border-radius: 8px; }

.nav-spacer { height: 90px; }
</style>
</head>
<body>
<div class="page">
  <div class="top">
    <button class="back" onclick="location.href='/'">‚Üê –ù–∞–∑–∞–¥</button>
    <img class="logo" src="/assets/logo.png" alt="LAMBO DROP">
    <div class="balance">‚òÖ <span id="bal">...</span></div>
  </div>

  <div class="title-area">
    <div id="caseTitle" class="h1">–ö–µ–π—Å</div>
    <div class="guarant-badge" onclick="showGuarantInfo()">–ì–ê–†–ê–ù–¢</div>
  </div>

  <div class="grid-wrapper">
    <div id="grid" class="grid"></div>
    
    <div class="reset-overlay" id="resetOverlay">
      <button class="btn-reset" id="btnReset">–û–¢–ö–†–´–¢–¨ –ó–ê–ù–û–í–û</button>
    </div>
  </div>
  
  <div class="price-wrap"><div id="casePrice" class="price">‚òÖ 0</div></div>

  <div class="prizes-section">
    <div class="section-header">
       <span class="section-title">–°–û–î–ï–†–ñ–ò–ú–û–ï –ö–ï–ô–°–ê</span>
       <div id="priceSmall" class="price-tag">‚òÖ 0</div>
    </div>
    
    <div id="prizesList" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(80px, 1fr)); gap:12px;">
       <div style="grid-column: 1/-1; text-align: center; color: #555; font-size: 13px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>

  <div class="nav-spacer"></div>
</div>

<nav class="nav">
  <a class="btn active" href="/">–ö–µ–π—Å—ã</a>
  <a class="btn" href="/crash.html">Crash üöÄ</a>
  <a class="btn" href="/profile/">–ü—Ä–æ—Ñ–∏–ª—å</a>
</nav>

<div id="overlay" class="overlay">
  <button id="btnCloseOverlay" class="close-overlay-btn">&times;</button>
  <div class="overlay-card" id="cardResult" style="display:none">
    <div class="rays"></div>
    <img id="winImg" class="overlay-img" src="">
    <div id="winTitle" class="overlay-title">PRIZE NAME</div>
    <div class="actions">
      <button id="btnSell" class="act-btn btn-sell">–ü—Ä–æ–¥–∞—Ç—å (+100)</button>
      <button id="btnKeep" class="act-btn btn-keep">–û—Å—Ç–∞–≤–∏—Ç—å –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ</button>
    </div>
  </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
const qs=s=>document.querySelector(s);
const tg = window.Telegram.WebApp;
tg.ready(); tg.expand();
const vib=(t=15)=>('vibrate'in navigator)&&navigator.vibrate(t);

// --- –ö–û–ù–§–ò–ì ---
function getCaseId(){
  const urlId=(new URLSearchParams(location.search)).get('case');
  return urlId ? urlId.toLowerCase() : 'jiga';
}
const caseId=getCaseId();

const ASSETS={
  jiga:{title:'–ñ–∏–≥–∞', price:209, stages:['/assets/Case Lada P1.png', '/assets/Case Lada P2.png', '/assets/Case Lada P3.png']},
  camry:{title:'–ö–∞–º—Ä–∏', price:629, stages:['/assets/Case Cam P1.png', '/assets/Case Cam P2.png', '/assets/Case Cam P3.png']},
  bmw:{title:'–ë—ç—Ö–∞', price:1499, stages:['/assets/Case BMW P1.png', '/assets/Case BMW P2.png', '/assets/Case BMW P3.png']},
  lambo:{title:'–õ–∞–º–±–æ', price:3899, stages:['/assets/Case Lambo P1.png', '/assets/Case Lambo P2.png', '/assets/Case Lambo P3.png']}
};
const conf=ASSETS[caseId]||ASSETS.jiga;
qs('#caseTitle').textContent=conf.title;
qs('#casePrice').textContent=`‚òÖ ${conf.price}`;
qs('#priceSmall').textContent=`‚òÖ ${conf.price}`;

// --- –°–û–°–¢–û–Ø–ù–ò–ï (–î–õ–Ø –ö–ù–û–ü–ö–ò –°–ë–†–û–°–ê) ---
let openedCount = 0; // –°–∫–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã—Ç–æ
const resetOverlay = qs('#resetOverlay');
const btnReset = qs('#btnReset');

// --- –≠–õ–ï–ú–ï–ù–¢–´ –û–í–ï–†–õ–ï–Ø ---
const overlay = qs('#overlay');
const btnCloseOverlay = qs('#btnCloseOverlay');
const cardResult = qs('#cardResult');
const winImg = qs('#winImg');
const winTitle = qs('#winTitle');
const btnSell = qs('#btnSell');
const btnKeep = qs('#btnKeep');

let currentWin = null; 

// --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–ï–¢–ö–ò ---
const grid=qs('#grid');
function initGrid() {
  grid.innerHTML = '';
  openedCount = 0;
  resetOverlay.classList.remove('show');
  
  for(let i=0;i<4;i++){
    const cell=document.createElement('button');
    cell.className='cell';
    cell.dataset.stage='0'; // 0=–∑–∞–∫—Ä—ã—Ç
    cell.innerHTML=`<div class="crate"><img src="${conf.stages[0]}"></div><div class="hint">–ñ–ú–ò</div>`;
    grid.appendChild(cell);
  }
}
initGrid(); // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

// --- –õ–û–ì–ò–ö–ê –ì–ê–†–ê–ù–¢–ê (–ò–Ω—Ñ–æ) ---
function showGuarantInfo() {
  tg.showAlert('–ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–´–ô –û–ö–£–ü!\n\n–ï—Å–ª–∏ –≤—ã –æ—Ç–∫—Ä–æ–µ—Ç–µ 3 –∫–µ–π—Å–∞ –ø–æ–¥—Ä—è–¥ –≤ –º–∏–Ω—É—Å, —Ç–æ –≤ 4-–º –∫–µ–π—Å–µ –≤–∞–º –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û –≤—ã–ø–∞–¥–µ—Ç –ø—Ä–∏–∑ –¥–æ—Ä–æ–∂–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∫–µ–π—Å–∞!');
}

// --- –õ–û–ì–ò–ö–ê –°–ë–†–û–°–ê ---
btnReset.onclick = () => {
  vib(10);
  initGrid(); // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É
};

// --- –ö–õ–ò–ö –ü–û –Ø–©–ò–ö–£ ---
grid.addEventListener('click', async (e)=>{
  const cell=e.target.closest('.cell'); 
  if(!cell || cell.classList.contains('open') || cell.classList.contains('processing')) return;
  
  vib(12);
  let stage = +cell.dataset.stage;
  const img = cell.querySelector('.crate img');

  // –†–∞–∑–æ–≥—Ä–µ–≤ (–≠—Ç–∞–ø—ã 0-1)
  if(stage < 2){
    cell.classList.add('show-hint'); 
    setTimeout(()=>cell.classList.remove('show-hint'), 260);
    stage += 1; img.src = conf.stages[stage]; cell.dataset.stage = String(stage);
    return;
  }

  // –û–¢–ö–†–´–¢–ò–ï (–≠—Ç–∞–ø 3)
  cell.classList.add('processing'); 
  cell.dataset.stage = '3';
  img.style.opacity = '0'; 

  // –î–æ–±–∞–≤–ª—è–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏
  const doors = document.createElement('div');
  doors.className = 'cell-doors';
  doors.innerHTML = `
    <div class="cell-door l"></div>
    <div class="cell-door r"></div>
    <div class="prize-box">
      <img id="pimg" src="/assets/prizes/sample.png" style="opacity:0.5; filter:blur(5px)">
      <div class="prize-title" id="ptitle">–û—Ç–∫—Ä—ã—Ç–∏–µ...</div>
      <div class="prize-actions" style="display:none" id="pactions">
         <button class="prize-btn btn-sell-mini" id="psell">–ü—Ä–æ–¥–∞—Ç—å</button>
         <button class="prize-btn btn-take" id="ptake">–ó–∞–±—Ä–∞—Ç—å</button>
      </div>
    </div>
  `;
  cell.appendChild(doors);

  // –ê–Ω–∏–º–∞—Ü–∏—è –¥–≤–µ—Ä–µ–π
  cell.classList.add('open'); 
  
  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—Ç–∫—Ä—ã—Ç—ã—Ö
  openedCount++;

  // –ó–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
  try {
    const res = await fetch('/api/open', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Telegram-Data': tg.initData },
      body: JSON.stringify({ caseId })
    }).then(r => r.json());

    if (res.error) {
      tg.showAlert(res.error);
      // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º
      cell.classList.remove('open', 'processing');
      doors.remove();
      cell.dataset.stage = '0';
      img.src = conf.stages[0];
      img.style.opacity = '1';
      openedCount--;
      return;
    }

    // –£—Å–ø–µ—Ö
    if (res.stars != null) qs('#bal').textContent = res.stars;
    const p = res.prize;
    const sellPrice = Math.floor(p.value);

    // –¢–∞–π–º–∏–Ω–≥: –∂–¥–µ–º 500–º—Å
    await new Promise(r => setTimeout(r, 500));

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –û–≤–µ—Ä–ª–µ–π
    winImg.src = p.image;
    winTitle.textContent = p.title;
    btnSell.textContent = `–ü–†–û–î–ê–¢–¨ (+${sellPrice} ‚òÖ)`;
    cardResult.style.display = 'flex';
    overlay.classList.add('show');
    tg.HapticFeedback.notificationOccurred('success');

    // –ñ–¥–µ–º 300–º—Å
    await new Promise(r => setTimeout(r, 300));

    // –û–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω–∏-—è—â–∏–∫
    const pImg = doors.querySelector('#pimg');
    pImg.src = p.image; pImg.style.opacity = '1'; pImg.style.filter = 'none'; 
    doors.querySelector('#ptitle').textContent = p.title;
    doors.querySelector('#psell').textContent = `+${sellPrice}`;
    doors.querySelector('#pactions').style.display = 'flex';

    currentWin = { inventoryId: res.inventoryId, sellPrice: sellPrice, cell: cell, img: img, doors: doors };

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –≤ –º–∏–Ω–∏-—è—â–∏–∫–µ
    doors.querySelector('#ptake').onclick = (ev) => { ev.stopPropagation(); /* –ü—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–º */ };
    doors.querySelector('#psell').onclick = async (ev) => {
      ev.stopPropagation();
      ev.target.textContent = '...';
      await sellItem(currentWin.inventoryId, sellPrice);
      // –ü—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –≤–Ω—É—Ç—Ä–∏ —è—â–∏–∫–∞ –º—ã —É–±–∏—Ä–∞–µ–º –ø—Ä–∏–∑ –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –¥–≤–µ—Ä–∏? 
      // –ò–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–º? –û–±—ã—á–Ω–æ –æ—Å—Ç–∞–≤–ª—è—é—Ç –ø—É—Å—Ç—ã–º –∏–ª–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç.
      // –°–¥–µ–ª–∞–µ–º –ø—Ä–æ—Å—Ç–æ –≤–∏–∑—É–∞–ª—å–Ω–æ "–ü—Ä–æ–¥–∞–Ω–æ"
      ev.target.parentElement.innerHTML = '<div style="color:#aaa; font-size:10px">–ü–†–û–î–ê–ù–û</div>';
    };

    // –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã –≤—Å–µ 4 -> –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞
    if(openedCount >= 4) {
       setTimeout(() => {
          resetOverlay.classList.add('show');
       }, 500);
    }

  } catch (err) {
    console.error(err);
    tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
  }
});

// --- –õ–û–ì–ò–ö–ê –û–í–ï–†–õ–ï–Ø ---
btnSell.onclick = async () => {
  if(!currentWin) return;
  btnSell.textContent = '...';
  await sellItem(currentWin.inventoryId, currentWin.sellPrice);
  
  // –í –º–∏–Ω–∏ —è—â–∏–∫–µ —Ç–æ–∂–µ –ø–∏—à–µ–º –ø—Ä–æ–¥–∞–Ω–æ
  const miniActions = currentWin.doors.querySelector('#pactions');
  if(miniActions) miniActions.innerHTML = '<div style="color:#aaa; font-size:10px">–ü–†–û–î–ê–ù–û</div>';
  
  resetOverlayFunc();
};

btnKeep.onclick = () => { resetOverlayFunc(); };
btnCloseOverlay.onclick = () => { vib(10); resetOverlayFunc(); };

function resetOverlayFunc() {
  overlay.classList.remove('show');
  cardResult.style.display = 'none';
  btnSell.textContent = '–ü–†–û–î–ê–¢–¨'; 
}

// --- –§–£–ù–ö–¶–ò–ò ---
async function sellItem(invId, price) {
  try {
    const res = await fetch('/api/sell', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Telegram-Data': tg.initData },
      body: JSON.stringify({ itemId: invId })
    }).then(r => r.json());

    if(res.success) {
      qs('#bal').textContent = res.balance;
      tg.showAlert(`–ü—Ä–æ–¥–∞–Ω–æ –∑–∞ ${res.added} –∑–≤–µ–∑–¥!`);
    } else {
      tg.showAlert(res.error || '–û—à–∏–±–∫–∞');
    }
  } catch(e) { console.error(e); }
}

fetch(`/api/case-items?caseId=${caseId}`).then(r=>r.json()).then(items=>{
  const list = qs('#prizesList');
  list.innerHTML = '';
  if(items.length === 0) return;
  items.forEach(item => {
      const el = document.createElement('div');
      el.className = `prize-item ${item.is_rare ? 'rare' : ''}`;
      el.innerHTML = `<img class="prize-img" src="${item.image_url}"><div class="prize-name">${item.name}</div>`;
      list.appendChild(el);
  });
});

fetch('/api/profile', {headers:{'X-Telegram-Data':tg.initData}}).then(r=>r.json()).then(d=>{if(d.stars) qs('#bal').textContent=d.stars});
</script>
</body>
</html>
