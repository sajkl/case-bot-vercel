<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Открытие кейса — Lambo Drop</title>
  <link rel="preload" href="/assets/logo.png" as="image" type="image/png">
  <link rel="stylesheet" href="/styles.css?v=121">
  <style>
    .case-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px 8px}
    .case-title{font-weight:900;font-size:40px; text-align:center; margin:6px 0 12px}
    .back-btn{background:#ffd400;border-radius:14px;padding:10px 16px;font-weight:900;color:#121212;display:inline-flex;gap:8px;align-items:center}
    .box-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;padding:0 16px 16px}
    .box{background:#d9b000;border-radius:22px; padding:16px; position:relative; overflow:hidden}
    .box-inner{background:#b88f00;border-radius:14px;height:220px;display:grid;place-items:center;position:relative}
    .box .price{position:absolute;left:16px;bottom:16px;transform:none}
    .lock-badge{position:absolute;inset:auto 0 0 0;margin:auto;width:125px;height:58px;background:#333942;color:#fff;border-radius:28px;display:flex;align-items:center;justify-content:center;font-weight:900;gap:8px;border:2px solid rgba(255,255,255,.08)}
    .checker{margin-top:auto}
    .checker img{width:100%;display:block}
    .yellow-divider{height:6px;background:#ffd000;width:100%}
  </style>
</head>
<body>
  <div class="container">
    <!-- Шапка -->
    <header class="case-header">
      <button class="back-btn" id="backBtn">← Назад</button>
      <img class="logo" src="/assets/logo.png" alt="LAMBO DROP" style="height:34px;">
      <div class="balance" id="balance"><span class="star">★</span><span class="value">25</span></div>
    </header>

    <!-- LIVE -->
    <section class="live-bar"><span>LIVE</span></section>

    <!-- Заголовок кейса -->
    <h1 class="case-title" id="caseTitle">Кейс</h1>

    <!-- 4 контейнера -->
    <section class="box-grid" id="boxGrid">
      <!-- рендерим 4 одинаковые коробки -->
    </section>

    <div class="checker"><img src="/assets/checker.png" alt=""></div>
    <div class="yellow-divider"></div>

    <!-- Навбар -->
    <nav class="nav">
      <a class="btn active" data-tab="profile" href="#profile">Профиль</a>
      <a class="btn" data-tab="vote" href="#vote">Голосование</a>
      <a class="btn" data-tab="inv" href="#inv">Инвентарь</a>
    </nav>
  </div>

  <!-- Overlay открытия (тот же, что на главной) -->
  <div id="openCase" class="open-case" hidden>
    <div class="open-case__backdrop"></div>
    <div class="open-case__stage">
      <div class="door door--left"></div>
      <div class="door door--right"></div>
      <div class="lock">
        <div class="lock__body"></div>
        <div class="lock__u"></div>
        <div class="spark spark--1"></div>
        <div class="spark spark--2"></div>
        <div class="spark spark--3"></div>
      </div>
      <div class="prize" aria-live="polite">
        <img class="prize__img" src="/assets/prizes/sample.png" alt="Приз">
        <div class="prize__title">Ваш приз!</div>
        <button class="prize__btn">Забрать</button>
      </div>
    </div>
  </div>

  <!-- Заглушка-панель -->
  <div id="sheet" class="sheet" hidden>
    <div class="sheet-body">
      <div class="sheet-title" id="sheet-title">Заглушка</div>
      <p class="sheet-text" id="sheet-text">Раздел в разработке.</p>
      <button class="sheet-close">Ок</button>
    </div>
  </div>

  <script>
  (function(){
    // --- helpers ---
    const qs = (s, el=document)=>el.querySelector(s);
    const qsa = (s, el=document)=>[...el.querySelectorAll(s)];
    const params = new URLSearchParams(location.search);
    const caseIdFront = params.get('case') || 'lambo'; // jiga|camry|bmw|lambo
    const MAP = { jiga:'lite', camry:'starter', bmw:'pro', lambo:'ultra' };
    const TITLES = { jiga:'Жиґа', camry:'Камри', bmw:'Бэха', lambo:'Ламбо' };

    const titleEl = qs('#caseTitle');
    titleEl.textContent = TITLES[caseIdFront] || 'Кейс';

    // Баланс (не критично)
    const balEl = qs('#balance .value');
    fetch('/api/profile').then(r=>r.ok?r.json():null)
      .then(d=>{ if(d && typeof d.stars!=='undefined') balEl.textContent=d.stars; })
      .catch(()=>{});

    // Рендер коробок
    const grid = qs('#boxGrid');
    for(let i=0;i<4;i++){
      const box = document.createElement('button');
      box.className = 'box';
      box.innerHTML = `
        <div class="box-inner">
          <img src="/assets/box-gold.svg" alt="" style="width:86%;max-width:360px;filter:drop-shadow(0 10px 30px rgba(0,0,0,.45))">
          <div class="lock-badge"><span class="star">★</span> 2999</div>
        </div>
        <div class="price"><span class="star">★</span> 2999</div>
      `;
      box.addEventListener('click', () => openOne());
      grid.appendChild(box);
    }

    // Overlay/анимация
    const oc = qs('#openCase');
    const pImg = qs('.prize__img', oc);
    const pTitle = qs('.prize__title', oc);
    const setPrize = (img, title)=>{ pImg.src=img; pImg.alt=title||'Приз'; pTitle.textContent=title||'Приз'; };
    const runOpen = ()=>{
      oc.hidden = false;
      oc.classList.remove('enter','break','shatter','open','reveal');
      requestAnimationFrame(()=>{
        oc.classList.add('enter');
        setTimeout(()=> oc.classList.add('break'),   180);
        setTimeout(()=> oc.classList.add('shatter'), 520);
        setTimeout(()=> oc.classList.add('open'),    820);
        setTimeout(()=> oc.classList.add('reveal'),  1220);
      });
    };

    async function openOne(){
      setPrize('/assets/prizes/sample.png','Открываем…');
      runOpen();

      const caseId = MAP[caseIdFront] || caseIdFront;
      try{
        const r = await fetch('/api/open', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ caseId })
        });
        const res = await r.json().catch(()=>null);

        if(res && res.stars!=null) balEl.textContent = res.stars;
        setPrize(res?.prize?.image || '/assets/prizes/sample.png',
                 res?.prize?.title || res?.prize?.label || 'Секретный приз');
      }catch(e){
        setPrize('/assets/prizes/sample.png','Тестовый приз');
      }
    }

    // Закрыть overlay
    oc.addEventListener('click', (e)=>{
      if (e.target.classList.contains('open-case__backdrop') ||
          e.target.classList.contains('prize__btn')) {
        oc.classList.remove('enter','break','shatter','open','reveal');
        oc.hidden = true;
      }
    });

    // Назад
    qs('#backBtn').addEventListener('click', ()=> history.length>1 ? history.back() : location.href='/' );

    // Заглушки вкладок
    const sheet = document.getElementById('sheet');
    const title = document.getElementById('sheet-title');
    const text  = document.getElementById('sheet-text');
    const openSheet = (t, msg) => { title.textContent=t; text.textContent=msg; sheet.hidden=false; sheet.classList.add('show'); };
    const closeSheet = () => { sheet.classList.remove('show'); setTimeout(()=>sheet.hidden=true, 200); };
    qsa('.nav .btn').forEach(b=>{
      b.addEventListener('click',(e)=>{
        e.preventDefault();
        qsa('.nav .btn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        const tab = b.dataset.tab;
        if(tab==='profile') openSheet('Профиль','Личный кабинет в разработке.');
        if(tab==='vote')    openSheet('Голосование','Скоро сможете голосовать за кейсы.');
        if(tab==='inv')     openSheet('Инвентарь','Ваши призы появятся здесь позже.');
      });
    });
    sheet.addEventListener('click',(e)=>{ if(e.target===sheet || e.target.classList.contains('sheet-close')) closeSheet(); });
  })();
  </script>
</body>
</html>
