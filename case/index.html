<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Открытие кейса — Lambo Drop</title>
  <link rel="stylesheet" href="/styles.css?v=12">
</head>
<body>
  <!-- Шапка страницы кейса -->
  <header class="case-header">
    <a class="back" href="/" onclick="event.preventDefault(); history.back(); return false;">← Назад</a>
    <img class="logo" src="/assets/logo.png" alt="LAMBO DROP">
    <div class="balance mini" id="balance"><span class="star">★</span><span class="value">25</span></div>
  </header>

  <section class="live-bar"><span>LIVE</span></section>
  <h1 class="case-title" id="caseTitle">Жига</h1>

  <!-- Сетка контейнеров 2x2 -->
  <section class="case-grid">
    <button class="tile" data-box>
      <img class="case-img" alt="Контейнер">
      <div class="price-badge"><span class="star">★</span> 2999</div>
    </button>
    <button class="tile" data-box>
      <img class="case-img" alt="Контейнер">
      <div class="price-badge"><span class="star">★</span> 2999</div>
    </button>
    <button class="tile" data-box>
      <img class="case-img" alt="Контейнер">
      <div class="price-badge"><span class="star">★</span> 2999</div>
    </button>
    <button class="tile" data-box>
      <img class="case-img" alt="Контейнер">
      <div class="price-badge"><span class="star">★</span> 2999</div>
    </button>
  </section>

  <!-- Overlay открытия приза -->
  <div id="openCase" class="open-case" hidden>
    <div class="open-case__backdrop"></div>
    <div class="open-case__stage">
      <div class="door door--left"></div>
      <div class="door door--right"></div>
      <div class="lock"><div class="lock__body"></div><div class="lock__u"></div></div>
      <div class="prize">
        <img class="prize__img" src="/assets/prizes/sample.png" alt="Приз">
        <div class="prize__title">Ваш приз!</div>
        <button class="prize__btn">Забрать</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const params = new URLSearchParams(location.search);
    const CASE = (params.get('case') || 'jiga').toLowerCase();
    const titles = { jiga:'Жига', camry:'Камри', bmw:'Бэха', lambo:'Ламбо' };
    const titleEl = document.getElementById('caseTitle');
    if (titleEl) titleEl.textContent = titles[CASE] || 'Кейс';

    const p = (name) => '/assets/cases/' + encodeURIComponent(name);
    const FRAMES = {
      jiga:  [p('Case Lada P1.svg'), p('Case Lada P2.svg'), p('Case Lada P3.svg'), p('Case Lada P4.svg')],
      camry: [p('Case Cam P1.svg'), p('Case Cam P2.svg'), p('Case Cam P3.svg'), p('Case Cam P4.svg')],
      bmw:   [p('Case BMW P1.svg'), p('Case BMW P2.svg'), p('Case BMW P3.svg'), p('Case BMW P4.svg')],
      lambo: [p('Case Lambo P1.svg'), p('Case Lambo P2.svg'), p('Case Lambo P3.svg'), p('Case Lambo P4.svg')]
    };

    const frames = FRAMES[CASE] || FRAMES.jiga;
    frames.forEach(src => { const img = new Image(); img.src = src; });

    document.querySelectorAll('[data-box]').forEach((box)=>{
      box.dataset.step = '0';
      const img = box.querySelector('.case-img');
      img.src = frames[0];
      box.addEventListener('click', ()=> onBoxClick(box, img));
    });

    function onBoxClick(box, imgEl){
      let step = +box.dataset.step;
      try { navigator.vibrate && navigator.vibrate(15); } catch(_){ }
      box.classList.add('shake'); setTimeout(()=>box.classList.remove('shake'),180);

      if (step < 3){
        step += 1; box.dataset.step = step; imgEl.src = frames[step]; return;
      }

      openPrize().finally(()=>{ box.dataset.step='0'; imgEl.src=frames[0]; });
    }

    async function openPrize(){
      const oc = document.getElementById('openCase');
      const pImg = oc.querySelector('.prize__img');
      const pTitle = oc.querySelector('.prize__title');
      let result;
      try {
        const alias = { jiga:'lite', camry:'starter', bmw:'pro', lambo:'ultra' }[CASE] || 'lite';
        const res = await fetch('/api/open', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ caseId: alias })
        });
        result = await res.json();
      } catch(_){ result = {}; }

      const prizeTitle = result?.prize?.label || 'Секретный приз';
      pTitle.textContent = prizeTitle;
      pImg.src = result?.prize?.image || '/assets/prizes/sample.png';

      oc.hidden = false;
      oc.classList.remove('break','shatter','open','reveal','show');
      oc.classList.add('enter','show');
      setTimeout(()=>oc.classList.add('break'),180);
      setTimeout(()=>oc.classList.add('shatter'),520);
      setTimeout(()=>oc.classList.add('open'),820);
      setTimeout(()=>oc.classList.add('reveal'),1220);

      const onClose = (e)=>{
        if (e.target.classList.contains('open-case__backdrop') || e.target.classList.contains('prize__btn')){
          oc.classList.remove('enter','break','shatter','open','reveal','show');
          oc.hidden = true;
          oc.removeEventListener('click', onClose);
        }
      };
      oc.addEventListener('click', onClose);
    }

    const balEl = document.querySelector('.balance .value');
    fetch('/api/profile').then(r=>r.ok?r.json():null).then(d=>{
      if(d && typeof d.stars!=='undefined') balEl.textContent = d.stars;
    });
  })();
  </script>
</body>
</html>
