<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Открытие кейса</title>
<style>
:root{--bg:#0b0d12;--text:#f7f8fb;--accent:#ffd400}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#0b0d12;color:var(--text);font-family:system-ui,-apple-system,"Futura PT",Inter,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
.page{max-width:520px;margin:0 auto;min-height:100vh;padding:14px 16px 24px}
.top{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center}
.back{background:var(--accent);color:#171a1f;font-weight:900;border:none;border-radius:16px;padding:12px 16px}
.logo{height:32px}
.balance{background:var(--accent);color:#171a1f;font-weight:900;border-radius:999px;padding:8px 14px;display:flex;gap:8px}
.h1{font-weight:900;font-size:42px;margin:16px 2px 8px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:8px}
.cell{
  position:relative;background:rgba(255,255,255,.03);border:none;border-radius:24px;
  padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden
}
.crate{width:100%;aspect-ratio:1/1;display:grid;place-items:center}
.crate img{width:92%;height:92%;object-fit:contain;transition:opacity .15s}
.hint{position:absolute;inset:0;display:grid;place-items:center;font-weight:900;background:rgba(0,0,0,.28);opacity:0;pointer-events:none;transition:.18s}
.cell.show-hint .hint{opacity:1}
.price-wrap{display:flex;justify-content:center;margin:16px 0 0}
.price{background:var(--accent);color:#171a1f;padding:12px 18px;border-radius:16px;font-weight:900;box-shadow:0 0 22px rgba(255,212,0,.35)}

/* локальные двери внутри ячейки */
.cell-doors{
  position:absolute;inset:14px; /* поверх картинки, внутри паддинга плитки */
  background:#0a0c12;border:1px solid #1b2130;border-radius:18px;overflow:hidden
}
.cell-door{position:absolute;top:8%;bottom:8%;width:50%;background:linear-gradient(180deg,#ffc400,#e2ae00)}
.cell-door.l{left:0;transform-origin:left center}
.cell-door.r{right:0;transform-origin:right center}
@keyframes doorL{from{transform:perspective(800px) rotateY(0)}to{transform:perspective(800px) rotateY(-72deg) translateX(-10%)}}
@keyframes doorR{from{transform:perspective(800px) rotateY(0)}to{transform:perspective(800px) rotateY(72deg) translateX(10%)}}
.cell.open .cell-door.l{animation:doorL .55s ease forwards}
.cell.open .cell-door.r{animation:doorR .55s ease forwards}
.prize-box{position:absolute;inset:0;display:grid;place-items:center;text-align:center;padding:14px;opacity:0}
.cell.reveal .prize-box{animation:prizeIn .35s .1s ease both}
@keyframes prizeIn{from{transform:translateY(8px);opacity:0}to{transform:translateY(0);opacity:1}}
.prize-box img{max-width:72%;max-height:60%}
.prize-title{font-weight:900;font-size:20px;margin-top:8px}
.prize-btn{margin-top:10px;background:var(--accent);color:#171a1f;border:none;border-radius:12px;padding:10px 16px;font-weight:900}
</style>
</head>
<body>
<div class="page">
  <div class="top">
    <button class="back" onclick="history.back()">Назад</button>
    <img class="logo" src="/assets/logo.png" alt="LAMBO DROP">
    <div class="balance">★ <span id="bal">25</span></div>
  </div>

  <div id="caseTitle" class="h1">Кейс</div>

  <div id="grid" class="grid"></div>

  <div class="price-wrap"><div id="price" class="price">★ 0</div></div>
</div>

<script>
const qs=s=>document.querySelector(s), qsa=s=>[...document.querySelectorAll(s)];
const vib=(t=15)=>('vibrate'in navigator)&&navigator.vibrate(t);

// ---------- robust caseId resolver ----------
function getCaseId(){
  // 1) ?id=lambo
  const idQ = new URLSearchParams(location.search).get('id');
  if (idQ) return idQ.toLowerCase();

  // 2) /case/lambo или /case-lambo
  const p = (location.pathname||'').toLowerCase();
  if (/(lambo|bmw|camry|jiga)/.test(p)) return RegExp.$1;

  // 3) sessionStorage от главной
  try {
    const s = sessionStorage.getItem('currentCaseId');
    if (s) return s.toLowerCase();
  } catch(_){}

  // 4) localStorage на всякий
  try {
    const l = localStorage.getItem('lastCaseId');
    if (l) return l.toLowerCase();
  } catch(_){}

  return 'jiga';
}
const caseId = getCaseId();

// ---------- assets (безопасные пути с пробелами) ----------
const P = f => encodeURI(f); // оборачиваем путь
const ASSETS = {
  jiga : { title:'Жига',  price:249,  stages:[P('/assets/Case Lada P1.png'),  P('/assets/Case Lada P2.png'),  P('/assets/Case Lada P3.png')] },
  camry: { title:'Камри', price:499,  stages:[P('/assets/Case Cam P1.png'),   P('/assets/Case Cam P2.png'),   P('/assets/Case Cam P3.png')] },
  bmw  : { title:'Бэха',  price:999,  stages:[P('/assets/Case BMW P1.png'),   P('/assets/Case BMW P2.png'),   P('/assets/Case BMW P3.png')] },
  lambo: { title:'Ламбо', price:2999, stages:[P('/assets/Case Lambo P1.png'), P('/assets/Case Lambo P2.png'), P('/assets/Case Lambo P3.png')] },
};
// подстрахуем отсутствие P2/P3
for (const k in ASSETS){ const a=ASSETS[k].stages; if(!a[1]) a[1]=a[0]; if(!a[2]) a[2]=a[1]; }

const cfg = ASSETS[caseId] || ASSETS.jiga;
console.debug('[case] resolved id:', caseId, '→', cfg);

// заголовок/цена
qs('#caseTitle')?.textContent = cfg.title;
qs('#price')?.(qs('#price').textContent = `★ ${cfg.price}`);

// если сетка уже отрендерена версткой — просто вставим P1
document.addEventListener('DOMContentLoaded', () => {
  const imgs = qsa('.crate img');
  if (imgs.length === 0) {
    // если сетка рисуется скриптом – создадим 4 ячейки здесь
    const grid = qs('#grid');
    if (grid) {
      for (let i=0;i<4;i++) {
        const cell = document.createElement('button');
        cell.type='button';
        cell.className='cell';
        cell.dataset.stage='0';
        cell.innerHTML = `
          <div class="crate"><img alt="container"></div>
          <div class="hint">ЖМИ</div>
        `;
        grid.appendChild(cell);
      }
    }
  }
  // выставляем P1 на все плитки
  qsa('.crate img').forEach((img, idx)=>{
    img.src = cfg.stages[0];
    img.onload  = ()=>console.debug(`[img${idx}] ok:`, img.src);
    img.onerror = ()=>console.warn(`[img${idx}] 404:`, img.src);
  });
});

// логика стадий + локальные двери (как было в предыдущей версии)
const grid = document.getElementById('grid');
if (grid) {
  grid.addEventListener('click', (e)=>{
    const cell=e.target.closest('.cell'); if(!cell) return;
    vib(12);
    let stage=+cell.dataset.stage;
    const img=cell.querySelector('.crate img');

    if(stage<2){
      cell.classList.add('show-hint'); setTimeout(()=>cell.classList.remove('show-hint'),260);
      stage+=1; img.src=cfg.stages[stage]; cell.dataset.stage=String(stage);
      return;
    }

    // stage === 2 → запрос приза + локальные двери
    cell.dataset.stage='3';
    img.style.opacity='0';

    const doors=document.createElement('div');
    doors.className='cell-doors';
    doors.innerHTML=`
      <div class="cell-door l"></div>
      <div class="cell-door r"></div>
      <div class="prize-box">
        <img id="pimg" src="/assets/prizes/sample.png" alt="">
        <div class="prize-title" id="ptitle">Ваш приз!</div>
        <button class="prize-btn" id="ptake">Забрать</button>
      </div>`;
    cell.appendChild(doors);

    fetch('/api/open',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({caseId})})
      .then(r=>r.json())
      .then(res=>{
        const prizeImg  = res?.prize?.image || '/assets/prizes/sample.png';
        const prizeTitle= res?.prize?.title || 'Секретный приз';
        doors.querySelector('#pimg').src = prizeImg;
        doors.querySelector('#ptitle').textContent = prizeTitle;

        cell.classList.add('open');
        setTimeout(()=>cell.classList.add('reveal'), 380);

        doors.querySelector('#ptake').onclick=()=>{
          cell.classList.remove('open','reveal');
          doors.remove();
        };
      })
      .catch(err=>{
        console.error('open failed', err);
        img.style.opacity='1';
        cell.dataset.stage='2';
        doors.remove();
      });
  });
}

// подстраховка: если пришли без ?id= — запомним, чтобы потом работать без query
try{ if(!location.search.includes('id=')){ localStorage.setItem('lastCaseId', caseId); } }catch(_){}
</script>


