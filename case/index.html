<script>
(function(){
  // --- helpers ---
  const qs = new URLSearchParams(location.search);
  const id = (qs.get('id') || 'jiga').toLowerCase(); // jiga|camry|bmw|lambo
  const buzz = ms => { try{ navigator.vibrate && navigator.vibrate(ms||15) }catch(_){} };
  const flashHint = cell => { const h=cell.querySelector('.tap-hint'); h.classList.add('show'); setTimeout(()=>h.classList.remove('show'),520) };

  const CASE_META = {
    jiga:{name:'Жига',price:249}, camry:{name:'Камри',price:499},
    bmw:{name:'Бэха',price:999},  lambo:{name:'Ламбо',price:2999}
  };
  const STAGES = {
    jiga:  ['/assets/Case Lada P1.png','/assets/Case Lada P2.png','/assets/Case Lada P3.png'],
    camry: ['/assets/Case Cam P1.png', '/assets/Case Cam P2.png', '/assets/Case Cam P3.png'],
    bmw:   ['/assets/Case BMW P1.png','/assets/Case BMW P2.png','/assets/Case BMW P3.png'],
    lambo: ['/assets/Case Lambo P1.png','/assets/Case Lambo P2.png','/assets/Case Lambo P3.png'],
  };

  // заголовок/цена
  const meta = CASE_META[id] || CASE_META.jiga;
  document.getElementById('caseName').textContent = meta.name;
  document.getElementById('priceVal').textContent = meta.price;

  // баланс
  const balEl = document.querySelector('#balance .value');
  fetch('/api/profile').then(r=>r.ok?r.json():null).then(d=>{
    if(d && typeof d.stars!=='undefined') balEl.textContent=d.stars;
  }).catch(()=>{});

  // прелоад PNG
  (STAGES[id]||[]).forEach(s=>{ const i=new Image(); i.src=s; });

  // подготовили сетку
  const cells = [...document.querySelectorAll('.case-cell')];
  cells.forEach(c=>{
    c.dataset.stage='0';
    c.querySelector('.case-cell__img').src = STAGES[id][0];
  });

  // переход стадии P1->P2->P3->OPEN (локально в ячейке)
  function stepCell(cell){
    let s = +cell.dataset.stage;
    if (s < 2){
      s += 1;
      cell.dataset.stage = String(s);
      cell.querySelector('.case-cell__img').src = STAGES[id][s];
      flashHint(cell);
      buzz(12);
    } else {
      openPrizeInCell(cell);
    }
  }

  // кнопка общей цены = нажимаем первую плитку
  document.getElementById('openAny').addEventListener('click', ()=> stepCell(cells[0]));
  // клики по плиткам
  cells.forEach(c=> c.addEventListener('click', ()=> stepCell(c)));

  // «Назад»
  document.getElementById('backBtn').addEventListener('click', ()=> history.back());

  // ==== ОТКРЫТИЕ ВНУТРИ ПЛИТКИ ====
  function buildDoorsDOM(){
    const wrap = document.createElement('div');
    wrap.className = 'cell-doors';
    wrap.innerHTML = `
      <div class="door door--left"></div>
      <div class="door door--right"></div>
      <div class="lock">
        <div class="lock__body"></div>
        <div class="lock__u"></div>
        <div class="spark spark--1"></div>
        <div class="spark spark--2"></div>
        <div class="spark spark--3"></div>
      </div>
      <div class="prize" aria-live="polite">
        <img class="prize__img" src="/assets/prizes/sample.png" alt="Приз">
        <div class="prize__title">Ваш приз!</div>
        <button class="prize__btn" type="button">Забрать</button>
      </div>
    `;
    return wrap;
  }

  function openPrizeInCell(cell){
    // 1) скрываем PNG контейнера
    const img = cell.querySelector('.case-cell__img');
    img.style.visibility = 'hidden';

    // 2) вставляем двери в эту ячейку
    let doors = cell.querySelector('.cell-doors');
    if (!doors){
      doors = buildDoorsDOM();
      cell.appendChild(doors);
    }

    // 3) дергаем API, подменяем текст/картинку приза
    fetch('/api/open', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ caseId:id })
    })
    .then(r=>r.json())
    .then(res=>{
      if(res && res.stars!=null) balEl.textContent = res.stars;
      const prizeImg   = res?.prize?.image || "/assets/prizes/sample.png";
      const prizeTitle = res?.prize?.label || res?.prize?.title || "Секретный приз";
      doors.querySelector('.prize__img').src = prizeImg;
      doors.querySelector('.prize__img').alt = prizeTitle;
      doors.querySelector('.prize__title').textContent = prizeTitle;
    })
    .catch(()=>{}); // даже если сеть, анимацию всё равно показываем

    // 4) анимации (локально в двери)
    doors.classList.remove('break','shatter','open','reveal');
    doors.classList.add('enter');
    setTimeout(()=>doors.classList.add('break'),   160);
    setTimeout(()=>doors.classList.add('shatter'), 500);
    setTimeout(()=>doors.classList.add('open'),    800);
    setTimeout(()=>doors.classList.add('reveal'), 1200);
    buzz(20);

    // 5) закрытие: вернуть плитку в P1
    const close = () => {
      doors.remove();                        // убрать ворота
      img.style.visibility = 'visible';      // вернуть контейнер
      cell.dataset.stage='0';
      img.src = STAGES[id][0];
    };
    doors.querySelector('.prize__btn').addEventListener('click', (e)=>{ e.stopPropagation(); close(); }, {once:true});
  }
})();
</script>
