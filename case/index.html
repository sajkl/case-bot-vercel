<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>–û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–∞</title>
<link rel="stylesheet" href="/styles.css"> 
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* === 1. FULLSCREEN SCROLL FIX === */
html { background: #0b0d12; }
body {
  margin: 0; padding: 0;
  width: 100vw; height: 100vh;
  overflow: hidden; 
  background: #0b0d12;
  color: #f7f8fb;
  font-family: system-ui, -apple-system, "Futura PT", sans-serif;
  padding-top: calc(env(safe-area-inset-top) + 10px); 
}

.page {
  width: 100%; height: 100%;
  overflow-y: auto; 
  -webkit-overflow-scrolling: touch;
  max-width: 520px; margin: 0 auto;
  padding: 0 16px 90px;
  display: flex; flex-direction: column;
}

:root{--bg:#0b0d12;--text:#f7f8fb;--accent:#ffd400}
*{box-sizing:border-box}

/* === –®–ê–ü–ö–ê –ö–ê–ö –ù–ê –ì–õ–ê–í–ù–û–ô (–ë–ï–ó –ö–ù–û–ü–ö–ò –ù–ê–ó–ê–î) === */
.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 0; z-index: 2; position: relative; flex-shrink: 0;
}
.logo { height: clamp(34px, 6vw, 38px); }
.balance { 
  background: var(--accent); color: #171a1f; 
  font-weight: 900; border-radius: 999px; 
  padding: 8px 14px; display: flex; gap: 8px; align-items: center; 
  text-decoration: none; 
}
.balance .star { font-size: 16px; }

/* –ó–ê–ì–û–õ–û–í–û–ö + –ì–ê–†–ê–ù–¢ */
.title-area {
  display: flex; justify-content: center; align-items: center; gap: 10px;
  margin: 16px 2px 8px; position: relative; flex-shrink: 0;
}
.h1 { font-weight:900; font-size:42px; margin:0; text-align:center; line-height: 1; }

.guarant-badge {
  display: none; 
  border: 2px solid var(--accent);
  color: var(--accent);
  border-radius: 12px;
  padding: 4px 8px;
  font-size: 11px; font-weight: 800;
  cursor: pointer;
  text-transform: uppercase;
  transition: transform 0.1s, background 0.1s;
}
.guarant-badge:active { transform: scale(0.95); background: rgba(255, 212, 0, 0.1); }

/* –°–µ—Ç–∫–∞ –∫–µ–π—Å–æ–≤ */
.grid-wrapper { position: relative; margin-top: 8px; flex-shrink: 0; }
.grid { display:grid; grid-template-columns:1fr 1fr; gap:18px; }

/* –ö–ù–û–ü–ö–ê –°–ë–†–û–°–ê */
.reset-overlay {
  position: absolute; inset: -10px;
  background: rgba(11, 13, 18, 0.85); backdrop-filter: blur(4px);
  display: none; align-items: center; justify-content: center;
  z-index: 10; border-radius: 24px;
  opacity: 0; transition: opacity 0.3s;
}
.reset-overlay.show { display: flex; opacity: 1; }

.btn-reset {
  background: var(--accent); color: #171a1f;
  border: none; padding: 16px 32px;
  border-radius: 99px; font-size: 16px; font-weight: 900;
  text-transform: uppercase; cursor: pointer;
  box-shadow: 0 0 30px rgba(255, 212, 0, 0.4);
  transform: scale(0.8); transition: transform 0.3s;
}
.reset-overlay.show .btn-reset { transform: scale(1); }
.btn-reset:active { transform: scale(0.95); }

/* –Ø–ß–ï–ô–ö–ê */
.cell {
  position:relative; background:rgba(255,255,255,.03); border:none; border-radius:24px;
  padding:0; box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:hidden;
  aspect-ratio: 1/1; cursor:pointer; z-index: 1;
  display: flex; align-items: center; justify-content: center;
}

.crate { width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
.crate img { width:85%; height:85%; object-fit:contain; transition:opacity .15s; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); }

/* === "–ñ–ú–ò" –£–í–ï–õ–ò–ß–ï–ù–û === */
.hint { 
  position:absolute; inset:0; display:grid; place-items:center; 
  font-weight:900; background:rgba(0,0,0,.28); 
  opacity:0; pointer-events:none; transition:.18s;
  font-size: 28px; /* –ë—ã–ª–æ –º–∞–ª–µ–Ω—å–∫–∏–º, —Å—Ç–∞–ª–æ –±–æ–ª—å—à–∏–º */
  letter-spacing: 1px;
}
.cell.show-hint .hint { opacity:1 }

/* –í–ù–£–¢–†–ï–ù–ù–û–°–¢–ò –Ø–©–ò–ö–ê */
.cell-doors { position:absolute; inset:14px; background:#0a0c12; border:1px solid #1b2130; border-radius:18px; overflow:hidden; pointer-events: none; }
.cell-door { position:absolute; top:8%; bottom:8%; width:50%; background:linear-gradient(180deg,#ffc400,#e2ae00); z-index: 2; }
.cell-door.l { left:0; transform-origin:left center }
.cell-door.r { right:0; transform-origin:right center }

.cell.open .cell-door.l { transform:perspective(800px) rotateY(-95deg); transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
.cell.open .cell-door.r { transform:perspective(800px) rotateY(95deg); transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

.prize-box {
  position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;
  z-index: 1; pointer-events: auto; opacity: 0; transition: opacity 0.3s ease;
}
.cell.open .prize-box { opacity: 1; transition-delay: 0.2s; } 
.prize-box img { width: 70%; height: 70%; object-fit: contain; filter: drop-shadow(0 0 15px rgba(255, 212, 0, 0.4)); margin-bottom: 2px; }
.prize-title { font-size: 10px; font-weight: 900; color: #fff; text-align: center; width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* === –û–í–ï–†–õ–ï–ô (CS:GO –†–£–õ–ï–¢–ö–ê) === */
.overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.95); 
  z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
}
.overlay.show { opacity: 1; pointer-events: auto; }

.close-overlay-btn {
  position: absolute; top: calc(env(safe-area-inset-top) + 20px); right: 20px;
  background: rgba(255, 255, 255, 0.1); border: none; color: #fff;
  font-size: 32px; width: 44px; height: 44px; border-radius: 50%;
  cursor: pointer; z-index: 10001; display: flex; align-items: center; justify-content: center; padding-bottom: 4px;
}

/* –ö–û–ù–¢–ï–ô–ù–ï–† –†–£–õ–ï–¢–ö–ò */
.roulette-container {
  width: 100%; height: 280px; position: relative;
  overflow: hidden; margin-bottom: 30px;
  /* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–µ –∫—Ä–∞—è –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
  mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
  -webkit-mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
}

.roulette-track {
  display: flex; align-items: center;
  height: 100%;
  position: absolute; left: 50%; /* –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ */
  transform: translateX(0); /* –ë—É–¥–µ–º –¥–≤–∏–≥–∞—Ç—å —ç—Ç–æ */
  will-change: transform;
}

.roulette-item {
  width: 140px; height: 180px;
  background: #181b22; border: 1px solid #2f3542;
  border-radius: 16px; margin: 0 6px;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 10px; flex-shrink: 0;
  position: relative;
}
.roulette-item.rare { border-color: var(--accent); box-shadow: inset 0 0 15px rgba(255,212,0,0.1); }
.roulette-item img { width: 90%; height: 80px; object-fit: contain; margin-bottom: 10px; }
.roulette-item .name { font-size: 12px; font-weight: 700; text-align: center; color: #a5abb8; }

/* –£–ö–ê–ó–ê–¢–ï–õ–¨ (–°—Ç—Ä–µ–ª–∫–∞) */
.roulette-pointer {
  position: absolute; top: 20px; bottom: 20px; left: 50%; width: 4px;
  background: var(--accent); transform: translateX(-50%);
  z-index: 10; border-radius: 2px;
  box-shadow: 0 0 20px var(--accent);
}
.roulette-pointer::before {
  content:''; position: absolute; top: -5px; left: 50%; transform: translateX(-50%);
  border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 15px solid var(--accent);
}
.roulette-pointer::after {
  content:''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%);
  border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 15px solid var(--accent);
}

/* –ö–ê–†–¢–û–ß–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–ê (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏) */
.result-card {
  display: none; /* –°–∫—Ä—ã—Ç–∞ –ø–æ–∫–∞ –∫—Ä—É—Ç–∏—Ç—Å—è */
  flex-direction: column; align-items: center;
  width: 100%; max-width: 320px;
  animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes popIn { from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1} }

.win-title { font-size: 28px; font-weight: 900; text-transform: uppercase; margin-bottom: 20px; text-align: center; color: #fff; }

.actions { display: flex; flex-direction: column; gap: 14px; width: 100%; }
.act-btn { border: none; padding: 18px; border-radius: 18px; font-size: 18px; font-weight: 900; cursor: pointer; text-transform: uppercase; width: 100%; }
.act-btn:active { transform: scale(0.97); }
.btn-sell { background: var(--accent); color: #111; box-shadow: 0 0 25px rgba(255,212,0,0.3); }
.btn-keep { background: #2c313f; color: #fff; border: 1px solid #3e4554; }

/* === –°–û–î–ï–†–ñ–ò–ú–û–ï –ö–ï–ô–°–ê === */
.prizes-section { margin-top:20px; background:#151921; border-radius:24px; padding:20px; border:1px solid #232838; flex-shrink: 0; }
.section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.section-title { font-weight: 800; color: #fff; font-size: 16px; }
.price-tag { background: var(--accent); color: #171a1f; padding: 6px 12px; border-radius: 8px; font-weight: 900; font-size: 14px; }

.prize-item { background: #0b0d12; border-radius: 16px; padding: 10px; display: flex; flex-direction: column; align-items: center; text-align: center; border: 1px solid #232838; position: relative; }
.prize-item.rare { border-color: var(--accent); box-shadow: 0 0 10px rgba(255, 212, 0, 0.15); }
.prize-img { width: 48px; height: 48px; object-fit: contain; margin-bottom: 8px; }
.prize-name { font-size: 11px; font-weight: 700; color: #a5abb8; line-height: 1.2; }
.nav-spacer { height: 90px; flex-shrink: 0; }

/* === –ú–û–î–ê–õ–ö–ê –ì–ê–†–ê–ù–¢–ê === */
.modal-overlay {
  position: fixed; inset: 0; z-index: 10000;
  background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px);
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: 0.2s ease;
}
.modal-overlay.open { opacity: 1; pointer-events: auto; }
.modal-card {
  background: #181b22; width: 85%; max-width: 320px;
  padding: 24px 20px; border-radius: 24px; border: 1px solid #2f3542;
  text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
  transform: scale(0.95); transition: 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.modal-overlay.open .modal-card { transform: scale(1); }
.modal-badge { display: inline-block; background: #ffd400; color: #000; font-weight: 900; font-size: 10px; padding: 4px 8px; text-transform: uppercase; border-radius: 6px; margin-bottom: 12px; }
.modal-title { margin: 0 0 10px; font-size: 18px; font-weight: 800; color: #fff; line-height: 1.2; }
.modal-text { color: #a5abb8; font-size: 14px; line-height: 1.5; margin-bottom: 20px; }
.modal-text b { color: #fff; font-weight: 700; }
.modal-close-btn { width: 100%; background: #2f3542; color: #fff; border: none; padding: 12px; border-radius: 14px; font-weight: 700; font-size: 15px; }
.modal-close-btn:active { background: #3a4150; transform: scale(0.98); }

</style>
</head>
<body>

<div class="modal-overlay" id="infoModal">
  <div class="modal-card">
    <div class="modal-badge">–ì–∞—Ä–∞–Ω—Ç</div>
    <h3 class="modal-title">–ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–´–ô –û–ö–£–ü</h3>
    <p class="modal-text">
      –í <b>–º–∏–Ω–∏–º—É–º</b> –æ–¥–Ω–æ–º –∏–∑ 4 –∫–µ–π—Å–æ–≤ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ª–µ–∂–∏—Ç –ø—Ä–µ–¥–º–µ—Ç, –ø—Ä–µ–≤—ã—à–∞—é—â–∏–π —Å—Ç–æ–∏–º–æ—Å—Ç—å –∫–µ–π—Å–∞!
    </p>
    <button class="modal-close-btn" onclick="closeInfo()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<div class="page">
  <header class="header">
    <img class="logo" src="/assets/logo.png" alt="LAMBO DROP">
    <a class="balance" href="/topup/">
      <span class="star">‚òÖ</span> <span id="bal">...</span>
    </a>
  </header>

  <div class="title-area">
    <div id="caseTitle" class="h1">–ö–µ–π—Å</div>
    <div class="guarant-badge" id="guarantBadge" onclick="openInfo()">–ì–ê–†–ê–ù–¢</div>
  </div>

  <div class="grid-wrapper">
    <div id="grid" class="grid"></div>
    <div class="reset-overlay" id="resetOverlay">
      <button class="btn-reset" id="btnReset">–û–¢–ö–†–´–¢–¨ –ó–ê–ù–û–í–û</button>
    </div>
  </div>

  <div class="prizes-section">
    <div class="section-header">
       <span class="section-title">–°–û–î–ï–†–ñ–ò–ú–û–ï –ö–ï–ô–°–ê</span>
       <div id="priceSmall" class="price-tag">‚òÖ 0</div>
    </div>
    <div id="prizesList" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(80px, 1fr)); gap:12px;">
       <div style="grid-column: 1/-1; text-align: center; color: #555; font-size: 13px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>

  <div class="nav-spacer"></div>
</div>

<nav class="nav">
  <a class="btn active" href="/">–ö–µ–π—Å—ã</a>
  <a class="btn" href="/crash.html">Crash üöÄ</a>
  <a class="btn" href="/profile/">–ü—Ä–æ—Ñ–∏–ª—å</a>
</nav>

<div id="overlay" class="overlay">
  <button id="btnCloseOverlay" class="close-overlay-btn">&times;</button>
  
  <div class="roulette-container">
     <div class="roulette-pointer"></div>
     <div class="roulette-track" id="rouletteTrack">
        </div>
  </div>

  <div class="result-card" id="cardResult">
    <div class="win-title" id="winTitle">PRIZE NAME</div>
    <div class="actions">
      <button id="btnSell" class="act-btn btn-sell">–ü—Ä–æ–¥–∞—Ç—å (+100)</button>
      <button id="btnKeep" class="act-btn btn-keep">–û—Å—Ç–∞–≤–∏—Ç—å –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ</button>
    </div>
  </div>
</div>

<script>
const qs=s=>document.querySelector(s);
const tg = window.Telegram.WebApp;

// === FULLSCREEN INIT ===
function initApp() {
    tg.ready();
    try {
        if (tg.requestFullscreen) tg.requestFullscreen();
        else tg.expand();
    } catch (e) { tg.expand(); }
    try { tg.setHeaderColor('#0b0d12'); tg.setBackgroundColor('#0b0d12'); } catch (e) {}
}
initApp();
setTimeout(initApp, 100);

const vib=(t=15)=>('vibrate'in navigator)&&navigator.vibrate(t);

// --- –ö–û–ù–§–ò–ì ---
function getCaseId(){
  const urlId=(new URLSearchParams(location.search)).get('case');
  return urlId ? urlId.toLowerCase() : 'jiga';
}
const caseId=getCaseId();

const ASSETS={
  jiga:{title:'–ñ–∏–≥–∞', price:209, stages:['/assets/Case Lada P1.png', '/assets/Case Lada P2.png', '/assets/Case Lada P3.png']},
  camry:{title:'–ö–∞–º—Ä–∏', price:629, stages:['/assets/Case Cam P1.png', '/assets/Case Cam P2.png', '/assets/Case Cam P3.png']},
  bmw:{title:'–ë—ç—Ö–∞', price:1499, stages:['/assets/Case BMW P1.png', '/assets/Case BMW P2.png', '/assets/Case BMW P3.png']},
  lambo:{title:'–õ–∞–º–±–æ', price:3899, stages:['/assets/Case Lambo P1.png', '/assets/Case Lambo P2.png', '/assets/Case Lambo P3.png']}
};
const conf=ASSETS[caseId]||ASSETS.jiga;
qs('#caseTitle').textContent=conf.title;
qs('#priceSmall').textContent=`‚òÖ ${conf.price}`;

// --- [1] –ì–ê–†–ê–ù–¢: –ë–≠–•–ê, –ö–ê–ú–†–ò, –õ–ê–ú–ë–û ---
if (['camry', 'lambo', 'bmw'].includes(caseId)) {
    qs('#guarantBadge').style.display = 'block'; 
}

// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
function openInfo() {
  qs('#infoModal').classList.add('open');
  if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
}
function closeInfo() { qs('#infoModal').classList.remove('open'); }
qs('#infoModal').addEventListener('click', (e) => { if(e.target === qs('#infoModal')) closeInfo(); });


// --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï ---
let allCaseItems = []; // –°—é–¥–∞ –∑–∞–≥—Ä—É–∑–∏–º –ø—Ä–µ–¥–º–µ—Ç—ã –¥–ª—è —Ä—É–ª–µ—Ç–∫–∏
let openedCount = 0;
let currentWin = null; 

// --- –°–ï–¢–ö–ê ---
const grid=qs('#grid');
function initGrid() {
  grid.innerHTML = '';
  openedCount = 0;
  qs('#resetOverlay').classList.remove('show');
  
  for(let i=0;i<4;i++){
    const cell=document.createElement('button');
    cell.className='cell';
    cell.dataset.stage='0';
    cell.innerHTML=`<div class="crate"><img src="${conf.stages[0]}"></div><div class="hint">–ñ–ú–ò</div>`;
    grid.appendChild(cell);
  }
}
initGrid();

// --- –°–ë–†–û–° ---
qs('#btnReset').onclick = () => { vib(10); initGrid(); };

// --- –ì–õ–ê–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ö–õ–ò–ö–ê ---
grid.addEventListener('click', async (e)=>{
  const cell=e.target.closest('.cell'); 
  if(!cell || cell.classList.contains('open') || cell.classList.contains('processing')) return;
  
  vib(12);
  let stage = +cell.dataset.stage;
  const img = cell.querySelector('.crate img');

  // –†–∞–∑–æ–≥—Ä–µ–≤ (–∫–ª–∏–∫–∏ 1, 2)
  if(stage < 2){
    cell.classList.add('show-hint'); 
    setTimeout(()=>cell.classList.remove('show-hint'), 260);
    stage += 1; img.src = conf.stages[stage]; cell.dataset.stage = String(stage);
    return;
  }

  // –û–¢–ö–†–´–¢–ò–ï (–∫–ª–∏–∫ 3)
  cell.classList.add('processing'); 
  cell.dataset.stage = '3';
  img.style.opacity = '0'; 

  // –í–∏–∑—É–∞–ª—å–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —è—â–∏–∫
  const doors = document.createElement('div');
  doors.className = 'cell-doors';
  doors.innerHTML = `
    <div class="cell-door l"></div>
    <div class="cell-door r"></div>
    <div class="prize-box">
       <img id="miniPImg" src="" style="opacity:0">
       <div id="miniPTitle" class="prize-title"></div>
    </div>
  `;
  cell.appendChild(doors);
  cell.classList.add('open'); 
  openedCount++;

  try {
    const res = await fetch('/api/open', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Telegram-Data': tg.initData },
      body: JSON.stringify({ caseId })
    }).then(r => r.json());

    if (res.error) { throw new Error(res.error); }
    if (res.stars != null) qs('#bal').textContent = res.stars;

    const winItem = res.prize;
    const sellPrice = Math.floor(winItem.value);

    // –°–û–•–†–ê–ù–Ø–ï–ú –¢–ï–ö–£–©–ò–ô –í–´–ò–ì–†–´–®
    currentWin = { 
       inventoryId: res.inventoryId, 
       sellPrice: sellPrice, 
       cell: cell, 
       doors: doors 
    };

    // –ó–ê–ü–£–°–ö–ê–ï–ú –†–£–õ–ï–¢–ö–£ (CS:GO STYLE)
    startRoulette(winItem);

  } catch (err) {
    console.error(err);
    tg.showAlert(err.message || "–û—à–∏–±–∫–∞");
    // –û—Ç–∫–∞—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
    cell.classList.remove('open', 'processing');
    doors.remove();
    cell.dataset.stage = '0';
    img.style.opacity = '1';
    openedCount--;
  }
});


// === [4] –õ–û–ì–ò–ö–ê –†–£–õ–ï–¢–ö–ò ===
const overlay = qs('#overlay');
const track = qs('#rouletteTrack');
const cardResult = qs('#cardResult');
const ROULETTE_ITEM_WIDTH = 152; // 140 width + 12 margin

function startRoulette(winner) {
   // 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
   overlay.classList.add('show');
   cardResult.style.display = 'none'; // –ü—Ä—è—á–µ–º –∫–Ω–æ–ø–∫–∏
   track.style.transition = 'none';
   track.style.transform = 'translateX(0px)';
   track.innerHTML = '';

   // 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ª–µ–Ω—Ç—É (100 –ø—Ä–µ–¥–º–µ—Ç–æ–≤, –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –Ω–∞ 85 –º–µ—Å—Ç–µ)
   const winIndex = 85; 
   const totalItems = 100;
   
   // –ï—Å–ª–∏ –ø—Ä–µ–¥–º–µ—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
   const pool = allCaseItems.length > 0 ? allCaseItems : [{image_url:'/assets/logo.png', name:'Loading...'}];

   let html = '';
   for (let i = 0; i < totalItems; i++) {
       let item;
       if (i === winIndex) {
           item = winner; // –°–¢–ê–í–ò–ú –ü–û–ë–ï–î–ò–¢–ï–õ–Ø
       } else {
           item = pool[Math.floor(Math.random() * pool.length)];
       }
       html += `
         <div class="roulette-item ${item.is_rare?'rare':''}">
            <img src="${item.image_url}" onerror="this.src='/assets/logo.png'">
            <div class="name">${item.name || item.title}</div>
         </div>
       `;
   }
   track.innerHTML = html;

   // 3. –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à–æ–π —Ç–∞–π–º–∞—É—Ç
   setTimeout(() => {
       // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ: 
       // (winIndex * width) + (–ø–æ–ª–æ–≤–∏–Ω–∞ item width) - (–ø–æ–ª–æ–≤–∏–Ω–∞ screen width)
       // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –æ—Ñ—Ñ—Å–µ—Ç –≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ–¥–º–µ—Ç–∞ –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏ (+/- 40px)
       const randomOffset = Math.floor(Math.random() * 80) - 40;
       
       const containerWidth = qs('.roulette-container').offsetWidth;
       const centerOffset = containerWidth / 2;
       const itemCenter = (ROULETTE_ITEM_WIDTH / 2);
       
       const scrollX = (winIndex * ROULETTE_ITEM_WIDTH) + itemCenter - centerOffset + randomOffset;

       // –ê–Ω–∏–º–∞—Ü–∏—è 4.5 —Å–µ–∫—É–Ω–¥—ã, cubic-bezier –¥–ª—è "—Ç–æ—Ä–º–æ–∂–µ–Ω–∏—è"
       track.style.transition = 'transform 4.5s cubic-bezier(0.15, 0.9, 0.3, 1)';
       track.style.transform = `translateX(-${scrollX}px)`;
       
       // –ó–≤—É–∫ —Å—Ç–∞—Ä—Ç–∞
       if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');

   }, 100);

   // 4. –§–∏–Ω–∏—à
   setTimeout(() => {
       showResultCard(winner);
   }, 4600); // –ß—É—Ç—å –±–æ–ª—å—à–µ —á–µ–º –≤—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏
}

function showResultCard(p) {
    if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
    
    qs('#winTitle').textContent = p.title || p.name;
    qs('#btnSell').textContent = `–ü–†–û–î–ê–¢–¨ (+${currentWin.sellPrice} ‚òÖ)`;
    
    cardResult.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏

    // –û–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω–∏-—è—â–∏–∫ –Ω–∞ —Ñ–æ–Ω–µ (–≤ –≥—Ä–∏–¥–µ)
    const img = currentWin.doors.querySelector('#miniPImg');
    img.src = p.image || p.image_url;
    img.style.opacity = '1';
    currentWin.doors.querySelector('#miniPTitle').textContent = p.title || p.name;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–±—Ä–æ—Å (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã 4)
    if(openedCount >= 4) {
       setTimeout(() => { qs('#resetOverlay').classList.add('show'); }, 500);
    }
}

// === –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô ===
qs('#btnKeep').onclick = () => {
   closeOverlay();
};

qs('#btnSell').onclick = async () => {
   const btn = qs('#btnSell');
   btn.textContent = '...';
   
   try {
     const res = await fetch('/api/sell', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Telegram-Data': tg.initData },
        body: JSON.stringify({ itemId: currentWin.inventoryId })
     }).then(r => r.json());

     if(res.success) {
        qs('#bal').textContent = res.balance;
        currentWin.doors.querySelector('#miniPTitle').textContent = "–ü–†–û–î–ê–ù–û";
        currentWin.doors.querySelector('#miniPImg').style.opacity = "0.3";
        closeOverlay();
        tg.showAlert(`–ü—Ä–æ–¥–∞–Ω–æ –∑–∞ ${res.added} –∑–≤–µ–∑–¥!`);
     } else {
        tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–æ–¥–∞–∂–∏");
     }
   } catch(e) { console.error(e); }
};

qs('#btnCloseOverlay').onclick = closeOverlay;

function closeOverlay() {
  overlay.classList.remove('show');
}

// === –ó–ê–ì–†–£–ó–ö–ê –ü–†–ï–î–ú–ï–¢–û–í (–î–õ–Ø –†–£–õ–ï–¢–ö–ò) ===
fetch(`/api/case-items?caseId=${caseId}`).then(r=>r.json()).then(items=>{
  allCaseItems = items; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä—É–ª–µ—Ç–∫–∏
  const list = qs('#prizesList');
  list.innerHTML = '';
  if(items.length === 0) return;
  items.forEach(item => {
      const el = document.createElement('div');
      el.className = `prize-item ${item.is_rare ? 'rare' : ''}`;
      el.innerHTML = `<img class="prize-img" src="${item.image_url}"><div class="prize-name">${item.name}</div>`;
      list.appendChild(el);
  });
});

fetch('/api/profile', {headers:{'X-Telegram-Data':tg.initData}}).then(r=>r.json()).then(d=>{if(d.stars) qs('#bal').textContent=d.stars});
</script>
</body>
</html>
