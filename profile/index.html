<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>–ü—Ä–æ—Ñ–∏–ª—å ‚Äî Lambo Drop</title>
  <link rel="stylesheet" href="/styles.css?v=13">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π ‚Äî —á—Ç–æ–±—ã –∞–≤–∞—Ç–∞—Ä –±—ã–ª –≤–∏–¥–µ–Ω –¥–∞–∂–µ –±–µ–∑ —Å—Ç–∏–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞ */
    .profile-hero .avatar {
      width: 88px; height: 88px; border-radius: 50%;
      background: #1f1f1f center/cover no-repeat;
      border: 1px solid rgba(255,255,255,.08);
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <a class="back" href="/"><span>–ó–∞–∫—Ä—ã—Ç—å</span></a>
      <img class="logo" src="/assets/logo.png" alt="LAMBO DROP" style="height:32px;">
      <a class="balance" id="balance" href="/topup/">
        <span class="star">‚òÖ</span><span class="value" id="balanceValue">0</span>
      </a>
    </header>

    <!-- –ê–≤–∞—Ç–∞—Ä/—é–∑–µ—Ä–Ω–µ–π–º -->
    <section class="profile-hero">
      <div class="avatar" id="avatar"></div>
      <div class="username" id="username">@username</div>
    </section>

    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <section class="cards-vertical">
      <a class="row-btn" href="/promo/"><span>üéüÔ∏è –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</span></a>
      <a class="row-btn" href="/history/payments/"><span>‚ÜîÔ∏è –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</span></a>
      <a class="row-btn" href="/history/bets/"><span>üïí –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞–≤–æ–∫</span></a>
    </section>

    <!-- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ -->
    <section class="ref-card">
      <h3>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</h3>
      <p class="muted">–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π –±–æ–Ω—É—Å—ã –∑–∞ –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</p>

      <div class="ref-grid">
        <div class="ref-stat">
          <div class="big">+10%</div>
          <div class="small">–ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞</div>
        </div>
        <div class="ref-stat">
          <div class="pill"><span id="earned">0.0</span> ‚òÖ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
          <div class="small"><span id="invited">0</span> —á. –ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</div>
        </div>
      </div>

      <div class="ref-actions">
        <button id="inviteBtn" class="primary">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π</button>
        <button id="copyLink" class="icon-btn" aria-label="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">üîó</button>
      </div>
    </section>

    <!-- –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –∫–∞–∫ —Å–µ–∫—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
    <section class="inventory">
      <h3>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
      <div class="inv-grid" id="invGrid">
        <!-- —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è —Å—é–¥–∞ –∏–∑ /api/inventory -->
      </div>
    </section>

    <div class="nav-spacer" aria-hidden="true"></div>
    <nav class="nav">
      <a class="btn active" href="/profile/">–ü—Ä–æ—Ñ–∏–ª—å</a>
      <a class="btn" href="/vote/">–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</a>
    </nav>
  </div>

  <script>
    (async () => {
      // 0) –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
      const tg = window.Telegram?.WebApp;
      if (!tg) {
        console.warn('Telegram WebApp SDK not found');
        return;
      }
      tg.ready();
      try { tg.expand(); } catch (_) {}

      // –õ–æ–≥ –¥–ª–∏–Ω—ã initData (—É–¥–æ–±–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
      console.log('initData len:', (tg.initData || '').length);

      // 1) –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–∫—É–∫–∞ + –≤–æ–∑–≤—Ä–∞—Ç JWT –≤ —Ç–µ–ª–µ –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º —Å –∫—É–∫–∞–º–∏ –≤ WebView)
      let auth = null;
      try {
        auth = await fetch('/api/tg-auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ initData: tg.initData })
        }).then(r => r.json());
      } catch (e) {
        console.warn('tg-auth network error', e);
      }

      console.log('AUTH:', auth);
      if (!auth?.ok) {
        console.warn('Auth failed:', auth);
        // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é:
        try { tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è. –û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞.'); } catch(_) {}
        return;
      }

      // 2) –ì–æ—Ç–æ–≤–∏–º headers –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      if (auth.token) {
        try { localStorage.setItem('sid_token', auth.token); } catch(_) {}
      }
      const bearer = (localStorage.getItem('sid_token') || auth.token) ? { Authorization: 'Bearer ' + (localStorage.getItem('sid_token') || auth.token) } : {};
      const commonFetch = (url) => fetch(url, { credentials: 'include', headers: bearer }).then(r => r.ok ? r.json() : null).catch(() => null);

      // 3) –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Ç—è–Ω–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è/–±–∞–ª–∞–Ω—Å–∞/—Ä–µ—Ñ–µ—Ä–∞–ª–æ–∫/–∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
      const [meData, prof, ref, linkRes, inv] = await Promise.all([
        commonFetch('/api/me'),
        commonFetch('/api/profile'),
        commonFetch('/api/referral/stats'),
        commonFetch('/api/referral/link'),
        commonFetch('/api/inventory'),
      ]);

      // 4) –û–±–Ω–æ–≤–ª—è–µ–º UI
      const balEl   = document.getElementById('balanceValue');
      const userEl  = document.getElementById('username');
      const avatarEl= document.getElementById('avatar');

      if (prof && typeof prof.stars === 'number') {
        balEl.textContent = String(prof.stars);
      }

      if (meData?.ok && meData.user) {
        const u = meData.user;
        // username / FIO
        userEl.textContent = u.username ? '@' + u.username :
          [u.first_name, u.last_name].filter(Boolean).join(' ') || '–ë–µ–∑ –∏–º–µ–Ω–∏';

        // –∞–≤–∞—Ç–∞—Ä: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã photo_url -> –ø—Ä–æ—Ñ.–∞–≤–∞—Ç–∞—Ä -> proxy tg-avatar
        const src = u.photo_url || (prof?.avatarUrl) || (u.id ? `/api/tg-avatar?user_id=${u.id}` : '');
        if (src) avatarEl.style.backgroundImage = `url("${src}")`;
      } else {
        console.warn('/api/me returned no session', meData);
      }

      if (ref) {
        const earnedEl = document.getElementById('earned');
        const invitedEl= document.getElementById('invited');
        if (earnedEl)  earnedEl.textContent  = ((ref.earned ?? 0) * 1).toFixed(1);
        if (invitedEl) invitedEl.textContent = ref.invited ?? 0;
      }

      const inviteUrl = linkRes?.url || location.origin;
      const inviteBtn = document.getElementById('inviteBtn');
      const copyBtn   = document.getElementById('copyLink');

      if (inviteBtn) inviteBtn.onclick = () => {
        try { tg.openTelegramLink(inviteUrl); }
        catch { location.href = inviteUrl; }
      };
      if (copyBtn) copyBtn.onclick = async () => {
        try { await navigator.clipboard.writeText(inviteUrl); tg.showAlert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'); }
        catch { tg.showAlert(inviteUrl); }
      };

      // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
      const grid = document.getElementById('invGrid');
      if (grid && inv?.items?.length) {
        inv.items.forEach(it => {
          const el = document.createElement('div');
          el.className = 'inv-item';
          el.innerHTML = `<img src="${it.icon}" alt=""><div class="inv-name">${it.name}</div>`;
          grid.appendChild(el);
        });
      }
    })();
  </script>
</body>
</html>

