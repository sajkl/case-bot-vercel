<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>–ü—Ä–æ—Ñ–∏–ª—å ‚Äî Lambo Drop</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* === 1. FULLSCREEN INIT === */
    html { background: #0b0d12; }
    body {
      margin: 0; padding: 0;
      width: 100vw; height: 100vh;
      overflow: hidden; 
      background: #0b0d12;
      color: #fff;
      font-family: system-ui, -apple-system, sans-serif;
      padding-top: calc(env(safe-area-inset-top) -23px); 
    }
    
    .page {
      width: 100%; height: 100%;
      overflow-y: auto; 
      -webkit-overflow-scrolling: touch;
      max-width: 520px; margin: 0 auto;
      padding: 0 16px 90px;
      display: flex; flex-direction: column;
    }

    :root { --accent: #ffd400; }

    /* === –®–ê–ü–ö–ê === */
    .header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 20px; flex-shrink: 0;
    }
    .back {
      background: #000; color: var(--accent); border: 1px solid #2a2f3d;
      text-decoration: none; font-weight: 900; border-radius: 14px;
      padding: 10px 16px; font-size: 14px; transition: transform 0.1s;
    }
    .back:active { transform: scale(0.95); }

    .balance { 
      background: var(--accent); color: #171a1f; 
      font-weight: 900; border-radius: 999px; 
      padding: 8px 14px; display: flex; gap: 8px; align-items: center; 
      text-decoration: none; font-size: 14px;
    }
    .balance .star { font-size: 16px; }

    /* === –ü–†–û–§–ò–õ–¨ === */
    .profile-hero {
      display: flex; flex-direction: column; align-items: center;
      margin-top: 10px; margin-bottom: 24px; flex-shrink: 0;
    }
    .avatar {
      width: 88px; height: 88px; border-radius: 50%;
      background: #2c313f center/cover no-repeat;
      border: 2px solid var(--accent);
      box-shadow: 0 0 20px rgba(255,212,0,0.15);
      margin-bottom: 12px;
    }
    .username { font-size: 20px; font-weight: 900; color: #fff; }
    .user-id { font-size: 13px; font-weight: 700; color: #777; margin-top: 4px; }

    /* === –ò–ù–í–ï–ù–¢–ê–†–¨ === */
    .inventory-section {
      background: #151921; border-radius: 24px; padding: 16px;
      border: 1px solid #232838; margin-bottom: 80px; flex-shrink: 0;
    }
    .section-title {
      font-size: 16px; font-weight: 800; color: #fff; margin-bottom: 16px;
      display: flex; justify-content: space-between; align-items: center;
    }
    
    .section-right { display: flex; align-items: center; gap: 10px; }
    .inv-count { background: #232838; padding: 2px 8px; border-radius: 6px; font-size: 12px; color: #aaa; }
    
    .btn-sell-all {
      display: none;
      background: rgba(255, 77, 77, 0.15); color: #ff4d4d;
      border: 1px solid #ff4d4d; border-radius: 8px;
      padding: 4px 10px; font-size: 10px; font-weight: 800;
      cursor: pointer; text-transform: uppercase; transition: transform 0.1s;
    }
    .btn-sell-all:active { transform: scale(0.95); background: rgba(255, 77, 77, 0.3); }

    .inv-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px;
    }
    
    /* –ö–ê–†–¢–û–ß–ö–ê –ü–†–ï–î–ú–ï–¢–ê (–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω) */
    .inv-item {
      background: #0b0d12; border: 1px solid #232838; border-radius: 16px;
      padding: 10px 8px 8px; /* –ß—É—Ç—å –º–µ–Ω—å—à–µ –ø–∞–¥–¥–∏–Ω–≥ —Å–Ω–∏–∑—É, —á—Ç–æ–±—ã —Ü–µ–Ω–∞ –±—ã–ª–∞ –±–ª–∏–∂–µ –∫ –∫—Ä–∞—é */
      text-align: center; cursor: pointer; position: relative;
      transition: transform 0.1s;
      display: flex; flex-direction: column; align-items: center;
      overflow: hidden;
    }
    .inv-item:active { transform: scale(0.96); }
    .inv-item.rare { border-color: var(--accent); box-shadow: 0 0 10px rgba(255,212,0,0.1); }
    
    .inv-img { width: 64px; height: 64px; object-fit: contain; margin-bottom: 8px; }
    .inv-name { 
        font-size: 11px; font-weight: 700; color: #fff; line-height: 1.2; 
        margin-bottom: 8px; flex-grow: 1; /* –ß—Ç–æ–±—ã —Ç–æ–ª–∫–∞–ª —Ü–µ–Ω—É –≤–Ω–∏–∑ */
    }
    
    /* –¶–ï–ù–ê (–ö–ê–ö –ù–ê –°–ö–†–ò–ù–ï) */
    .inv-price-badge {
        background: #ef4444; /* –ö—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ç–µ—Å—Ç–∞, —Å–∫—Ä–∏–ø—Ç –ø–æ–º–µ–Ω—è–µ—Ç –µ—Å–ª–∏ –Ω–∞–¥–æ */
        width: 100%;
        border-radius: 6px;
        padding: 4px 0;
        font-size: 11px; font-weight: 900; 
        color: #fff;
        display: flex; align-items: center; justify-content: center; gap: 4px;
        margin-top: auto; /* –ü—Ä–∏–∂–∏–º–∞–µ–º –∫ –Ω–∏–∑—É */
    }
    /* –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –¥–µ–ª–∞–µ–º —Å–µ—Ä—ã–π —Ñ–æ–Ω, –¥–ª—è —Ä–µ–¥–∫–∏—Ö - –º–æ–∂–Ω–æ —Ü–≤–µ—Ç–Ω–æ–π */
    .inv-item .inv-price-badge { background: #1d212b; color: #a5abb8; }
    /* –ï—Å–ª–∏ —Ä–µ–¥–∫–∏–π - –¥–µ–ª–∞–µ–º –∫—Ä–∞—Å–Ω—ã–π –∏–ª–∏ –∂–µ–ª—Ç—ã–π */
    .inv-item.rare .inv-price-badge { background: #ef4444; color: #fff; } 
    /* –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤—Å–µ–≥–¥–∞ –∫—Ä–∞—Å–Ω—ã–π –∫–∞–∫ —Ç—ã –æ–±–≤–µ–ª */
    .inv-item .inv-price-badge.highlight { background: #ef4444; color: #fff; }


    .empty-state {
      grid-column: 1 / -1; text-align: center; padding: 30px 0; color: #555; font-size: 14px;
    }

    /* === MODAL === */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
      z-index: 1000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s;
    }
    .modal-overlay.open { display: flex; opacity: 1; }
    
    .modal-card {
      background: #1d212b; width: 90%; max-width: 320px; border-radius: 24px; padding: 24px;
      border: 1px solid #2a2f3d; text-align: center; transform: scale(0.9); transition: transform 0.2s;
    }
    .modal-overlay.open .modal-card { transform: scale(1); }
    
    .modal-img { width: 120px; height: 120px; object-fit: contain; margin-bottom: 16px; }
    .modal-title { font-size: 20px; font-weight: 900; color: #fff; margin-bottom: 8px; }
    .modal-price { font-size: 16px; font-weight: 700; color: var(--accent); margin-bottom: 24px; }
    
    .modal-actions { display: flex; flex-direction: column; gap: 10px; }
    .modal-btn {
      padding: 14px; border-radius: 14px; border: none; font-size: 16px; font-weight: 800; cursor: pointer; width: 100%;
    }
    .btn-sell { background: #2c313f; color: #fff; border: 1px solid #3e4554; }
    .btn-withdraw { background: var(--accent); color: #111; }
    .btn-close { background: transparent; color: #777; margin-top: 8px; font-size: 14px; }
    
    .nav-spacer { height: 90px; flex-shrink: 0; }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <a class="back" href="/">‚Üê –ù–∞–∑–∞–¥</a>
      <div style="font-weight:900; font-size:20px;">–ü–†–û–§–ò–õ–¨</div>
      <a class="balance" href="/topup/">
         <span class="star">‚òÖ</span> <span id="balanceValue">...</span>
      </a>
    </header>

    <section class="profile-hero">
      <div class="avatar" id="avatar"></div>
      <div class="username" id="username">Loading...</div>
      <div class="user-id" id="userId">ID: ...</div>
    </section>

    <section class="inventory-section">
      <div class="section-title">
        <span>–¢–í–û–ò –ü–†–ï–î–ú–ï–¢–´</span>
        <div class="section-right">
           <button id="btnSellAll" class="btn-sell-all">–ü–†–û–î–ê–¢–¨ –í–°–ï</button>
           <span class="inv-count" id="invCount">0</span>
        </div>
      </div>
      <div class="inv-grid" id="invGrid">
        <div class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </section>

    <div class="nav-spacer"></div>
  </div>

  <nav class="nav">
    <a class="btn" href="/">–ö–µ–π—Å—ã</a>
    <a class="btn" href="/crash.html">Crash üöÄ</a>
    <a class="btn active" href="/profile/">–ü—Ä–æ—Ñ–∏–ª—å</a>
  </nav>

  <div class="modal-overlay" id="itemModal">
    <div class="modal-card">
      <img src="" class="modal-img" id="mImg">
      <div class="modal-title" id="mTitle">Title</div>
      <div class="modal-price" id="mPrice">0 ‚òÖ</div>
      
      <div class="modal-actions">
        <button class="modal-btn btn-withdraw" id="btnWithdraw">–ó–ê–ë–†–ê–¢–¨ (–ü–æ–¥–∞—Ä–æ–∫)</button>
        <button class="modal-btn btn-sell" id="btnSellModal">–ü–†–û–î–ê–¢–¨</button>
        <button class="modal-btn btn-close" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    
    // FULLSCREEN INIT
    function initApp() {
        tg.ready();
        try {
            if (tg.requestFullscreen) tg.requestFullscreen();
            else tg.expand();
        } catch (e) { tg.expand(); }
        try { tg.setHeaderColor('#0b0d12'); tg.setBackgroundColor('#0b0d12'); } catch (e) {}
    }
    initApp();
    setTimeout(initApp, 100);

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const els = {
       bal: document.getElementById('balanceValue'),
       user: document.getElementById('username'),
       uid: document.getElementById('userId'),
       ava: document.getElementById('avatar'),
       grid: document.getElementById('invGrid'),
       count: document.getElementById('invCount'),
       modal: document.getElementById('itemModal'),
       btnSellAll: document.getElementById('btnSellAll')
    };

    let currentItem = null; 
    let allItems = []; 

    // === –ó–ê–ì–†–£–ó–ö–ê –ü–†–û–§–ò–õ–Ø ===
    async function loadProfile() {
       try {
          const res = await fetch('/api/user?action=auth', {
             method: 'POST',
             headers: { 'Content-Type': 'application/json' },
             body: JSON.stringify({ initData: tg.initData })
          }).then(r => r.json());

          if(res.ok) {
             els.bal.textContent = (res.stars !== undefined) ? res.stars : '0';
             const u = res.user;
             els.user.textContent = u.username ? `@${u.username}` : u.first_name;
             els.uid.textContent = `ID: ${u.id}`;
             if(u.photo_url) {
                els.ava.style.backgroundImage = `url(/api/user?action=avatar&user_id=${u.id})`;
             } else {
                els.ava.textContent = u.first_name[0];
                els.ava.style.display = 'flex'; els.ava.style.alignItems='center'; els.ava.style.justifyContent='center'; els.ava.style.fontSize='32px';
             }
          }
       } catch(e) { console.error('Profile load error:', e); }
    }
    loadProfile();

    // === –ó–ê–ì–†–£–ó–ö–ê –ò–ù–í–ï–ù–¢–ê–†–Ø ===
    function loadInventory() {
       fetch('/api/inventory', {headers:{'X-Telegram-Data':tg.initData}})
         .then(r=>r.json())
         .then(res => {
            const items = res.items || [];
            allItems = items; 
            
            els.count.textContent = items.length;
            els.grid.innerHTML = '';

            if(items.length > 0) {
               els.btnSellAll.style.display = 'block';
            } else {
               els.btnSellAll.style.display = 'none';
               els.grid.innerHTML = '<div class="empty-state">–ü—É—Å—Ç–æ üï∏Ô∏è<br>–û—Ç–∫—Ä–æ–π –∫–µ–π—Å!</div>';
               return;
            }

            items.forEach(item => {
               const el = document.createElement('div');
               el.className = `inv-item ${item.is_rare ? 'rare' : ''}`;
               
               // –õ–û–ì–ò–ö–ê –¶–í–ï–¢–ê –¶–ï–ù–´
               // –ï—Å–ª–∏ —Ä–µ–¥–∫–∏–π - –¥–µ–ª–∞–µ–º –∫—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω, –µ—Å–ª–∏ –æ–±—ã—á–Ω—ã–π - —Ç–µ–º–Ω—ã–π
               const badgeClass = item.is_rare ? 'inv-price-badge highlight' : 'inv-price-badge';

               el.innerHTML = `
                 <img class="inv-img" src="${item.image_url}">
                 <div class="inv-name">${item.name}</div>
                 <div class="${badgeClass}">
                    ${item.stars_cost} ‚òÖ
                 </div>
               `;
               el.onclick = () => openModal(item);
               els.grid.appendChild(el);
            });
         })
         .catch(e => {
            els.grid.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>';
         });
    }
    loadInventory();

    // --- –õ–û–ì–ò–ö–ê "–ü–†–û–î–ê–¢–¨ –í–°–ï" ---
    els.btnSellAll.onclick = async () => {
       if(allItems.length === 0) return;
       const totalValue = allItems.reduce((sum, item) => sum + parseInt(item.stars_cost), 0);
       
       if(!confirm(`–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–∞—Ç—å –í–°–ï –ø—Ä–µ–¥–º–µ—Ç—ã (${allItems.length} —à—Ç.) –∑–∞ ${totalValue} ‚òÖ?`)) return;
       
       els.btnSellAll.textContent = '...';
       
       try {
          const promises = allItems.map(item => 
             fetch('/api/sell', {
                method: 'POST',
                headers: {'Content-Type':'application/json', 'X-Telegram-Data':tg.initData},
                body: JSON.stringify({ itemId: item.id })
             }).then(r => r.json())
          );

          await Promise.all(promises);
          tg.showAlert(`–£—Å–ø–µ—à–Ω–æ –ø—Ä–æ–¥–∞–Ω–æ –Ω–∞ ${totalValue} –∑–≤–µ–∑–¥!`);
          
          loadProfile(); 
          loadInventory();
          els.btnSellAll.textContent = '–ü–†–û–î–ê–¢–¨ –í–°–ï';
          
       } catch(e) {
          tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ');
          loadInventory();
       }
    };

    // --- –ú–û–î–ê–õ–ö–ê ---
    function openModal(item) {
       currentItem = item;
       document.getElementById('mImg').src = item.image_url;
       document.getElementById('mTitle').textContent = item.name;
       document.getElementById('mPrice').textContent = `–¶–µ–Ω–∞: ${item.stars_cost} ‚òÖ`;
       document.getElementById('btnSellModal').textContent = `–ü–†–û–î–ê–¢–¨ (+${item.stars_cost} ‚òÖ)`;
       els.modal.classList.add('open');
       if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
    }

    function closeModal() {
       els.modal.classList.remove('open');
       currentItem = null;
    }

    document.getElementById('btnSellModal').onclick = async () => {
       if(!currentItem) return;
       const btn = document.getElementById('btnSellModal');
       btn.textContent = '...';
       
       try {
         const res = await fetch('/api/sell', {
            method: 'POST',
            headers: {'Content-Type':'application/json', 'X-Telegram-Data':tg.initData},
            body: JSON.stringify({ itemId: currentItem.id })
         }).then(r=>r.json());

         if(res.success) {
            tg.showAlert(`–ü—Ä–æ–¥–∞–Ω–æ! +${res.added} –∑–≤–µ–∑–¥`);
            els.bal.textContent = res.balance;
            closeModal();
            loadInventory(); 
         } else {
            tg.showAlert(res.error || '–û—à–∏–±–∫–∞');
         }
       } catch(e) { tg.showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
    };

    document.getElementById('btnWithdraw').onclick = async () => {
       if(!currentItem) return;
       if(!confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –∞–¥–º–∏–Ω—É –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞ –≤ Telegram?')) return;
       tg.showAlert('–§—É–Ω–∫—Ü–∏—è –≤—ã–≤–æ–¥–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ! –ü–æ–∫–∞ –º–æ–∂–µ—à—å –ø—Ä–æ–¥–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç.');
    };

  </script>
</body>
</html>
