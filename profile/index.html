<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>–ü—Ä–æ—Ñ–∏–ª—å ‚Äî Lambo Drop</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    /* === –ü–†–û–§–ò–õ–¨ === */
    .profile-hero {
      display: flex; flex-direction: column; align-items: center;
      margin-top: 20px; margin-bottom: 24px;
    }
    .avatar {
      width: 88px; height: 88px; border-radius: 50%;
      background: #2c313f center/cover no-repeat;
      border: 2px solid var(--accent);
      box-shadow: 0 0 20px rgba(255,212,0,0.15);
      margin-bottom: 12px;
    }
    .username {
      font-size: 20px; font-weight: 900; color: #fff;
    }
    .user-id {
      font-size: 13px; font-weight: 700; color: #777; margin-top: 4px;
    }

    /* === –ò–ù–í–ï–ù–¢–ê–†–¨ === */
    .inventory-section {
      background: #151921; border-radius: 24px; padding: 16px;
      border: 1px solid #232838; margin-bottom: 80px;
    }
    .section-title {
      font-size: 16px; font-weight: 800; color: #fff; margin-bottom: 16px;
      display: flex; justify-content: space-between; align-items: center;
    }
    
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–∞–≤–æ–π —á–∞—Å—Ç–∏ (–ö–Ω–æ–ø–∫–∞ + –°—á–µ—Ç—á–∏–∫) */
    .section-right {
      display: flex; align-items: center; gap: 10px;
    }

    .inv-count { background: #232838; padding: 2px 8px; border-radius: 6px; font-size: 12px; color: #aaa; }
    
    /* –°–¢–ò–õ–¨ –ö–ù–û–ü–ö–ò "–ü–†–û–î–ê–¢–¨ –í–°–ï" */
    .btn-sell-all {
      display: none; /* –°–∫—Ä—ã—Ç–∞ –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤ */
      background: rgba(255, 77, 77, 0.15);
      color: #ff4d4d;
      border: 1px solid #ff4d4d;
      border-radius: 8px;
      padding: 4px 10px;
      font-size: 10px; font-weight: 800;
      cursor: pointer; text-transform: uppercase;
      transition: transform 0.1s;
    }
    .btn-sell-all:active { transform: scale(0.95); background: rgba(255, 77, 77, 0.3); }

    .inv-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px;
    }
    .inv-item {
      background: #0b0d12; border: 1px solid #232838; border-radius: 16px;
      padding: 10px; text-align: center; cursor: pointer; position: relative;
      transition: transform 0.1s;
    }
    .inv-item:active { transform: scale(0.96); }
    .inv-item.rare { border-color: var(--accent); box-shadow: 0 0 10px rgba(255,212,0,0.1); }
    
    .inv-img { width: 64px; height: 64px; object-fit: contain; margin-bottom: 8px; }
    .inv-name { font-size: 12px; font-weight: 700; color: #fff; line-height: 1.2; }
    .inv-price { font-size: 10px; font-weight: 700; color: #777; margin-top: 4px; }
    
    .empty-state {
      grid-column: 1 / -1; text-align: center; padding: 30px 0; color: #555; font-size: 14px;
    }

    /* === MODAL (Item Details) === */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
      z-index: 1000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s;
    }
    .modal-overlay.open { display: flex; opacity: 1; }
    
    .modal-card {
      background: #1d212b; width: 90%; max-width: 320px; border-radius: 24px; padding: 24px;
      border: 1px solid #2a2f3d; text-align: center; transform: scale(0.9); transition: transform 0.2s;
    }
    .modal-overlay.open .modal-card { transform: scale(1); }
    
    .modal-img { width: 120px; height: 120px; object-fit: contain; margin-bottom: 16px; }
    .modal-title { font-size: 20px; font-weight: 900; color: #fff; margin-bottom: 8px; }
    .modal-price { font-size: 16px; font-weight: 700; color: var(--accent); margin-bottom: 24px; }
    
    .modal-actions { display: flex; flex-direction: column; gap: 10px; }
    .modal-btn {
      padding: 14px; border-radius: 14px; border: none; font-size: 16px; font-weight: 800; cursor: pointer; width: 100%;
    }
    .btn-sell { background: #2c313f; color: #fff; border: 1px solid #3e4554; }
    .btn-withdraw { background: var(--accent); color: #111; }
    .btn-close { background: transparent; color: #777; margin-top: 8px; font-size: 14px; }

    /* === –ù–ê–í–ò–ì–ê–¶–ò–Ø (–ò–∑ —Ç–≤–æ–µ–≥–æ –∫–æ–¥–∞) === */
    .nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(11,13,18,0.95); 
      backdrop-filter: blur(10px);
      border-top: 1px solid #1f232e;
      padding: 12px 16px 34px; /* –ß—É—Ç—å –±–æ–ª—å—à–µ —Å–Ω–∏–∑—É –¥–ª—è iPhone */
      display: flex; justify-content: space-around;
      z-index: 100;
    }
    
    .nav .btn {
      color: #5d6470; 
      text-decoration: none; 
      font-weight: 800; 
      font-size: 14px;
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: 4px;
      transition: transform 0.1s;
    }
    
    .nav .btn:active { transform: scale(0.95); }

    /* –ê–∫—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ (–∂–µ–ª—Ç–∞—è) */
    .nav .btn.active { color: #ffd400; }

    /* –†–∞—Å–ø–æ—Ä–∫–∞, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª—Å—è –º–µ–Ω—é */
    .nav-spacer { height: 90px; }

  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <a class="back" href="/">‚Üê –ù–∞–∑–∞–¥</a>
      <div style="font-weight:900; font-size:20px;">–ü–†–û–§–ò–õ–¨</div>
      <div class="balance">
        <span class="star">‚òÖ</span><span class="value" id="balanceValue">...</span>
      </div>
    </header>

    <section class="profile-hero">
      <div class="avatar" id="avatar"></div>
      <div class="username" id="username">Loading...</div>
      <div class="user-id" id="userId">ID: ...</div>
    </section>

    <section class="inventory-section">
      <div class="section-title">
        <span>–¢–í–û–ò –ü–†–ï–î–ú–ï–¢–´</span>
        <div class="section-right">
           <button id="btnSellAll" class="btn-sell-all">–ü–†–û–î–ê–¢–¨ –í–°–ï</button>
           <span class="inv-count" id="invCount">0</span>
        </div>
      </div>
      <div class="inv-grid" id="invGrid">
        <div class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </section>
    
    <div class="nav-spacer"></div>
  </div>


    <nav class="nav">
      <a class="btn" href="/">–ö–µ–π—Å—ã</a>
      <a class="btn active" href="/crash.html">Crash üöÄ</a>
      <a class="btn" href="/profile/">–ü—Ä–æ—Ñ–∏–ª—å</a>
    </nav>

  <div class="modal-overlay" id="itemModal">
    <div class="modal-card">
      <img src="" class="modal-img" id="mImg">
      <div class="modal-title" id="mTitle">Title</div>
      <div class="modal-price" id="mPrice">0 ‚òÖ</div>
      
      <div class="modal-actions">
        <button class="modal-btn btn-withdraw" id="btnWithdraw">–ó–ê–ë–†–ê–¢–¨ (–ü–æ–¥–∞—Ä–æ–∫)</button>
        <button class="modal-btn btn-sell" id="btnSellModal">–ü–†–û–î–ê–¢–¨</button>
        <button class="modal-btn btn-close" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const els = {
       bal: document.getElementById('balanceValue'),
       user: document.getElementById('username'),
       uid: document.getElementById('userId'),
       ava: document.getElementById('avatar'),
       grid: document.getElementById('invGrid'),
       count: document.getElementById('invCount'),
       modal: document.getElementById('itemModal'),
       btnSellAll: document.getElementById('btnSellAll') // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–¥–∞—Ç—å –≤—Å–µ
    };

    let currentItem = null; 
    let allItems = []; // –°–ø–∏—Å–æ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤

    // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
    const u = tg.initDataUnsafe?.user;
    if(u) {
       els.user.textContent = u.username ? `@${u.username}` : u.first_name;
       els.uid.textContent = `ID: ${u.id}`;
       if(u.photo_url) els.ava.style.backgroundImage = `url(${u.photo_url})`;
       else els.ava.textContent = u.first_name[0];
    }

    // –ë–∞–ª–∞–Ω—Å
    fetch('/api/profile', {headers:{'X-Telegram-Data':tg.initData}})
      .then(r=>r.json()).then(d=>{ if(d.stars) els.bal.textContent = d.stars });

    // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
    loadInventory();

    function loadInventory() {
       fetch('/api/inventory', {headers:{'X-Telegram-Data':tg.initData}})
         .then(r=>r.json())
         .then(res => {
            const items = res.items || [];
            allItems = items; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
            
            els.count.textContent = items.length;
            els.grid.innerHTML = '';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–¥–∞—Ç—å –≤—Å–µ" —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã
            if(items.length > 0) {
               els.btnSellAll.style.display = 'block';
            } else {
               els.btnSellAll.style.display = 'none';
               els.grid.innerHTML = '<div class="empty-state">–ü—É—Å—Ç–æ üï∏Ô∏è<br>–û—Ç–∫—Ä–æ–π –∫–µ–π—Å!</div>';
               return;
            }

            items.forEach(item => {
               const el = document.createElement('div');
               el.className = `inv-item ${item.is_rare ? 'rare' : ''}`;
               el.innerHTML = `
                 <img class="inv-img" src="${item.image_url}">
                 <div class="inv-name">${item.name}</div>
                 <div class="inv-price">${item.stars_cost} ‚òÖ</div>
               `;
               el.onclick = () => openModal(item);
               els.grid.appendChild(el);
            });
         })
         .catch(e => {
            els.grid.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>';
         });
    }

    // --- –õ–û–ì–ò–ö–ê "–ü–†–û–î–ê–¢–¨ –í–°–ï" ---
    els.btnSellAll.onclick = async () => {
       if(allItems.length === 0) return;
       
       // –°—á–∏—Ç–∞–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
       const totalValue = allItems.reduce((sum, item) => sum + parseInt(item.stars_cost), 0);
       
       if(!confirm(`–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–∞—Ç—å –í–°–ï –ø—Ä–µ–¥–º–µ—Ç—ã (${allItems.length} —à—Ç.) –∑–∞ ${totalValue} ‚òÖ?`)) return;
       
       els.btnSellAll.textContent = '...';
       
       // –ü—Ä–æ–¥–∞–µ–º –ø–æ –æ–¥–Ω–æ–º—É (—á–µ—Ä–µ–∑ Promise.all –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
       try {
          const promises = allItems.map(item => 
             fetch('/api/sell', {
                method: 'POST',
                headers: {'Content-Type':'application/json', 'X-Telegram-Data':tg.initData},
                body: JSON.stringify({ itemId: item.id })
             }).then(r => r.json())
          );

          await Promise.all(promises);
          
          tg.showAlert(`–£—Å–ø–µ—à–Ω–æ –ø—Ä–æ–¥–∞–Ω–æ –Ω–∞ ${totalValue} –∑–≤–µ–∑–¥!`);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –∏ —Å–ø–∏—Å–æ–∫
          fetch('/api/profile', {headers:{'X-Telegram-Data':tg.initData}})
            .then(r=>r.json()).then(d=>{ if(d.stars) els.bal.textContent = d.stars });
          
          loadInventory();
          els.btnSellAll.textContent = '–ü–†–û–î–ê–¢–¨ –í–°–ï';
          
       } catch(e) {
          tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ');
          loadInventory();
       }
    };

    // --- –ú–û–î–ê–õ–ö–ê ---
    function openModal(item) {
       currentItem = item;
       document.getElementById('mImg').src = item.image_url;
       document.getElementById('mTitle').textContent = item.name;
       document.getElementById('mPrice').textContent = `–¶–µ–Ω–∞: ${item.stars_cost} ‚òÖ`;
       
       document.getElementById('btnSellModal').textContent = `–ü–†–û–î–ê–¢–¨ (+${item.stars_cost} ‚òÖ)`;
       
       els.modal.classList.add('open');
       tg.HapticFeedback.selectionChanged();
    }

    function closeModal() {
       els.modal.classList.remove('open');
       currentItem = null;
    }

    // --- –î–ï–ô–°–¢–í–ò–Ø (–û–¥–∏–Ω –ø—Ä–µ–¥–º–µ—Ç) ---
    document.getElementById('btnSellModal').onclick = async () => {
       if(!currentItem) return;
       const btn = document.getElementById('btnSellModal');
       btn.textContent = '...';
       
       try {
         const res = await fetch('/api/sell', {
            method: 'POST',
            headers: {'Content-Type':'application/json', 'X-Telegram-Data':tg.initData},
            body: JSON.stringify({ itemId: currentItem.id })
         }).then(r=>r.json());

         if(res.success) {
            tg.showAlert(`–ü—Ä–æ–¥–∞–Ω–æ! +${res.added} –∑–≤–µ–∑–¥`);
            els.bal.textContent = res.balance;
            closeModal();
            loadInventory(); 
         } else {
            tg.showAlert(res.error || '–û—à–∏–±–∫–∞');
         }
       } catch(e) { tg.showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
    };

    document.getElementById('btnWithdraw').onclick = async () => {
       if(!currentItem) return;
       if(!confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –∞–¥–º–∏–Ω—É –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞ –≤ Telegram?')) return;
       tg.showAlert('–§—É–Ω–∫—Ü–∏—è –≤—ã–≤–æ–¥–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ! –ü–æ–∫–∞ –º–æ–∂–µ—à—å –ø—Ä–æ–¥–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç.');
    };

  </script>
</body>
</html>
