<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>–ü—Ä–æ—Ñ–∏–ª—å ‚Äî Lambo Drop</title>
  <link rel="stylesheet" href="/styles.css?v=13">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <header class="header">
      <a class="back" href="/"><span>–ó–∞–∫—Ä—ã—Ç—å</span></a>
      <img class="logo" src="/assets/logo.png" alt="LAMBO DROP" style="height:32px;">
      <a class="balance" id="balance" href="/topup/"><span class="star">‚òÖ</span><span class="value" id="balanceValue">0</span></a>
    </header>

    <!-- –ê–≤–∞—Ç–∞—Ä/—é–∑–µ—Ä–Ω–µ–π–º -->
    <section class="profile-hero">
      <div class="avatar" id="avatar"></div>
      <div class="username" id="username">@username</div>
    </section>

    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <section class="cards-vertical">
      <a class="row-btn" href="/promo/"><span>üéüÔ∏è –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</span></a>
      <a class="row-btn" href="/history/payments/"><span>‚ÜîÔ∏è –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</span></a>
      <a class="row-btn" href="/history/bets/"><span>üïí –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞–≤–æ–∫</span></a>
    </section>

    <!-- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ -->
    <section class="ref-card">
      <h3>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</h3>
      <p class="muted">–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π –±–æ–Ω—É—Å—ã –∑–∞ –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</p>

      <div class="ref-grid">
        <div class="ref-stat"><div class="big">+10%</div><div class="small">–ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞</div></div>
        <div class="ref-stat"><div class="pill"><span id="earned">0.0</span> ‚òÖ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div><div class="small"><span id="invited">0</span> —á. –ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</div></div>
      </div>

      <div class="ref-actions">
        <button id="inviteBtn" class="primary">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π</button>
        <button id="copyLink" class="icon-btn" aria-label="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">üîó</button>
      </div>
    </section>

    <!-- –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –∫–∞–∫ —Å–µ–∫—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
    <section class="inventory">
      <h3>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
      <div class="inv-grid" id="invGrid">
        <!-- —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è —Å—é–¥–∞ –∏–∑ /api/inventory -->
      </div>
    </section>

    <div class="nav-spacer" aria-hidden="true"></div>
    <nav class="nav">
      <a class="btn active" href="/profile/">–ü—Ä–æ—Ñ–∏–ª—å</a>
      <a class="btn" href="/vote/">–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</a>
    </nav>
  </div>
<script>
(async () => {
  const tg = window.Telegram.WebApp;
  tg.ready(); tg.expand();

  // 1) –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: —Å–æ–∑–¥–∞—ë–º –∫—É–∫—É sid
  try {
    if (tg.initData) {
      await fetch('/api/tg-auth', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ initData: tg.initData })
      });
    } else {
      console.warn('initData is empty ‚Äî –æ—Ç–∫—Ä–æ–π –∏–∑ Telegram');
    }
  } catch (e) { console.warn('tg-auth error', e); }

  // 2) –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Ç—è–Ω–µ–º –¥–∞–Ω–Ω—ã–µ
  const [me, prof, ref, linkRes, inv] = await Promise.all([
    fetch('/api/me', { credentials:'include' }).then(r=>r.ok?r.json():null).catch(()=>null),
    fetch('/api/profile').then(r=>r.ok?r.json():null).catch(()=>null),
    fetch('/api/referral/stats').then(r=>r.ok?r.json():null).catch(()=>null),
    fetch('/api/referral/link').then(r=>r.ok?r.json():null).catch(()=>null),
    fetch('/api/inventory').then(r=>r.ok?r.json():null).catch(()=>null),
  ]);

  // 3) UI
  const balEl = document.getElementById('balanceValue');
  const userEl = document.getElementById('username');
  const avatarEl = document.getElementById('avatar');

  if (prof?.stars != null) balEl.textContent = prof.stars;

  if (me?.ok) {
    const u = me.user || {};
    userEl.textContent = u.username ? '@' + u.username :
      [u.first_name, u.last_name].filter(Boolean).join(' ') || '–ë–µ–∑ –∏–º–µ–Ω–∏';

    const src = u.photo_url || (prof?.avatarUrl || (u.id ? `/api/tg-avatar?user_id=${u.id}` : ''));
    if (src) avatarEl.style.backgroundImage = `url("${src}")`;
  } else {
    console.warn('/api/me returned no session', me);
  }

  if (ref) {
    document.getElementById('earned').textContent = (ref.earned ?? 0).toFixed(1);
    document.getElementById('invited').textContent = ref.invited ?? 0;
  }

  const inviteUrl = linkRes?.url || location.origin;
  document.getElementById('inviteBtn').onclick = () => tg.openTelegramLink(inviteUrl);
  document.getElementById('copyLink').onclick = async () => {
    try { await navigator.clipboard.writeText(inviteUrl); tg.showAlert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'); }
    catch { tg.showAlert(inviteUrl); }
  };

  const grid = document.getElementById('invGrid');
  (inv?.items || []).forEach(it => {
    const el = document.createElement('div');
    el.className = 'inv-item';
    el.innerHTML = `<img src="${it.icon}" alt=""><div class="inv-name">${it.name}</div>`;
    grid.appendChild(el);
  });
})();
</script>


</body>
</html>
