<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö–µ–π—Å—ã –∑–∞ ‚≠ê ‚Äî Telegram Mini App</title>

  <!-- libs -->
  <script src="https://telegram.org/js/telegram-web-app.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com" crossorigin="anonymous"></script>
  <script>tailwind.config={darkMode:'class',theme:{extend:{}}};</script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- error catcher -->
  <script>
    (function(){
      const show=(title,detail)=>{try{const box=document.getElementById('err');if(box){box.style.display='block';box.textContent=`${title}\n${detail||''}`;}}catch(_){}}; 
      window.onerror=(m,src,line,col,err)=>show(`JS error: ${m}`,[`source: ${src||'-'}`,`line: ${line||'-'}, col: ${col||'-'}`,`stack: ${(err&&err.stack)||'-'}`].join('\n'));
      window.addEventListener('unhandledrejection',e=>show('Promise error',(e.reason&&e.reason.stack)||String(e.reason)));
    })();
  </script>

  <style>
    :root{
      --black:#0A0B0C; --white:#FFFFFF; --nardo:#8E9492; --orange:#FF7A1A;
      --border:#272a2e; --card:#0b0f14;
    }
    html,body,#root{height:100%}
    body{
      background:
        radial-gradient(1200px 800px at 15% -10%, #14181e 0%, transparent 60%),
        radial-gradient(1000px 700px at 120% 0%, #191a1f 0%, transparent 55%),
        linear-gradient(180deg,#0b0d10 0%, #090a0c 100%);
      color:var(--white); font-family:'Manrope',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    @keyframes fadeInUp{from{opacity:0;transform:translateY(10px) scale(.98);}to{opacity:1;transform:translateY(0) scale(1);}}
    .fade-in{animation:fadeInUp .38s cubic-bezier(.2,.8,.2,1) both;}

    /* live feed */
    .hfeed-wrap{margin-top:10px;margin-bottom:12px}
    .hfeed{display:flex;gap:10px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:2px}
    .hfeed::-webkit-scrollbar{display:none}
    .hfeed-item{min-width:240px;border-radius:14px;border:1px solid var(--border);
      background:linear-gradient(135deg,#14171b,#0d0f12);padding:10px 12px;display:flex;align-items:center;justify-content:space-between}

    /* mini fan (top3) */
    .mini-fan{position:relative;height:70px;display:flex;align-items:flex-end;justify-content:center}
    .mini-card{width:58px;height:74px;border-radius:12px;background:#111418;border:1px solid var(--border);
      display:flex;align-items:center;justify-content:center;position:relative;box-shadow:0 12px 28px rgba(0,0,0,.35)}
    .glow-common{box-shadow:0 0 0 2px rgba(142,148,146,.45) inset,0 12px 26px rgba(0,0,0,.35)}
    .glow-rare{box-shadow:0 0 0 2px rgba(120,180,255,.55) inset,0 12px 26px rgba(0,0,0,.35)}
    .glow-epic{box-shadow:0 0 0 2px rgba(180,120,255,.55) inset,0 12px 26px rgba(0,0,0,.35)}
    .glow-legendary{box-shadow:0 0 0 2px rgba(255,122,26,.70) inset,0 12px 26px rgba(0,0,0,.35)}

    /* grid 2xN */
    .cases-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:1rem}

    /* flip detail ‚Äî UPDATED for mobile */
    .hand{position:relative;height:clamp(150px,44vw,176px);display:flex;justify-content:center;align-items:flex-end;pointer-events:none}
    .hand-card{position:relative;pointer-events:auto;margin-left:-36px;transition:transform .35s cubic-bezier(.2,.8,.2,1),filter .2s,opacity .2s}
    .hand-card:first-child{margin-left:0}
    .flip-card{
      width:clamp(96px,28vw,118px);
      height:clamp(128px,36vw,156px);
      position:relative;transform-style:preserve-3d;transition:transform 700ms cubic-bezier(.2,.8,.2,1);
      border-radius:16px;box-shadow:0 16px 34px rgba(0,0,0,.42)
    }
    .flip-card.flipped{transform:rotateY(180deg)}
    .flip-face{position:absolute;inset:0;border-radius:16px;backface-visibility:hidden;display:flex;align-items:center;justify-content:center;border:1px solid var(--border)}
    .flip-face.front{background:linear-gradient(135deg,#151920,#0f1216);color:#eaeef2}
    .flip-face.back{background:#0f1114;transform:rotateY(180deg)}
    .glow-common-b{box-shadow:0 0 0 2px rgba(142,148,146,.45),0 0 18px rgba(142,148,146,.22)}
    .glow-rare-b{box-shadow:0 0 0 2px rgba(120,180,255,.55),0 0 20px rgba(120,180,255,.28)}
    .glow-epic-b{box-shadow:0 0 0 2px rgba(180,120,255,.60),0 0 22px rgba(180,120,255,.30)}
    .glow-legendary-b{box-shadow:0 0 0 2px rgba(255,122,26,.70),0 0 24px rgba(255,122,26,.35)}

    .hand-card:hover{transform:translateY(-4px) scale(1.0);filter:brightness(1.04)}
    @media (hover:none){.hand-card:hover{transform:none;filter:none}}
    @media (max-width:390px){ .hand{height:150px} .hand-card{margin-left:-30px} }

    .btn-orange{background:linear-gradient(180deg,#f97316,#ea580c);color:#111;border:none;border-radius:18px;padding:.9rem 1.1rem;font-weight:800;
      box-shadow:0 8px 24px rgba(234,88,12,.28),0 0 0 1px rgba(234,88,12,.35) inset}
    .btn-secondary{background:#101317;color:#e4e4e7;border:1px solid var(--border);border-radius:16px;padding:.8rem 1rem;font-weight:700}

    /* tabbar */
    .tabbar{display:flex;gap:10px}
    .tab-btn{flex:1 1 0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;
      padding:10px 6px;border-radius:14px;border:1px solid var(--border);background:#0f1216;font-weight:800;transition:transform .12s,filter .15s,border-color .25s}
    .tab-btn:hover{filter:brightness(1.06)}
    .tab-btn:active{transform:scale(.96)}
    .tab-btn.active{border-color:rgba(255,122,26,.65);box-shadow:0 0 0 2px rgba(255,122,26,.28) inset}
  </style>
</head>

<body>
  <div id="root"></div>
  <pre id="err" style="display:none;position:fixed;left:8px;bottom:64px;right:8px;max-height:40vh;overflow:auto;background:#111;color:#fff;padding:8px;border-radius:8px;z-index:9999"></pre>

  <script type="text/babel">
    const {useState,useEffect,useRef} = React;
    const tg = window.Telegram?.WebApp;

    /* ===== data ===== */
    const START_STARS = 25;
    const DEFAULT_CASES = [
      { id:'lite', title:'–õ–∞–π—Ç-–∫–µ–π—Å', priceStars:3, description:'–î–µ—à—ë–≤—ã–π –≤—Ö–æ–¥',
        prizes:[{id:'l1',label:'–°—Ç–∏–∫–µ—Ä –º–∏–Ω–∏',emoji:'üêæ',rarity:'common',weight:55},
                {id:'l2',label:'1‚≠ê –Ω–∞–∑–∞–¥',emoji:'‚≠ê',rarity:'common',weight:30,starsValue:1},
                {id:'l4',label:'5‚≠ê –¥–∂–µ–∫–ø–æ—Ç',emoji:'üí•',rarity:'epic',weight:3,starsValue:5}]},
      { id:'starter', title:'–°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–µ–π—Å', priceStars:6, description:'–î–ª—è –Ω–æ–≤–∏—á–∫–æ–≤',
        prizes:[{id:'s1',label:'–°—Ç–∏–∫–µ—Ä-–ø–∞–∫',emoji:'üò∫',rarity:'common',weight:45},
                {id:'s3',label:'–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –±–µ–π–¥–∂',emoji:'üèÖ',rarity:'rare',weight:17},
                {id:'s5',label:'–ú–µ–≥–∞–ø—Ä–∏–∑: 20‚≠ê',emoji:'üí´',rarity:'legendary',weight:2,starsValue:20}]},
      { id:'pro', title:'–ü—Ä–æ-–∫–µ–π—Å', priceStars:12, description:'–ë–æ–ª—å—à–æ–π —Ä–∏—Å–∫',
        prizes:[{id:'p2',label:'–°–∫–∏–Ω',emoji:'üé®',rarity:'rare',weight:28},
                {id:'p4',label:'10‚≠ê –Ω–∞–∑–∞–¥',emoji:'üåü',rarity:'epic',weight:15,starsValue:10},
                {id:'p5',label:'60‚≠ê –¥–∂–µ–∫–ø–æ—Ç',emoji:'üèÜ',rarity:'legendary',weight:5,starsValue:60}]},
      { id:'ultra', title:'–£–ª—å—Ç—Ä–∞-–∫–µ–π—Å', priceStars:30, description:'–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–µ –Ω–∞–≥—Ä–∞–¥—ã',
        prizes:[{id:'u2',label:'–†–µ–¥–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç',emoji:'üßø',rarity:'epic',weight:28},
                {id:'u4',label:'120‚≠ê',emoji:'üèÜ',rarity:'legendary',weight:6,starsValue:120},
                {id:'u6',label:'300‚≠ê',emoji:'ü¶Ñ',rarity:'legendary',weight:2,starsValue:300}]},
    ];
    const SELL_BY_RARITY = { common:1, rare:2, epic:6, legendary:20 };
    const rarityOrder={legendary:4,epic:3,rare:2,common:1};
    const glowMini=(r)=>({common:'glow-common',rare:'glow-rare',epic:'glow-epic',legendary:'glow-legendary'}[r]||'glow-common');
    const glowBig =(r)=>({common:'glow-common-b',rare:'glow-rare-b',epic:'glow-epic-b',legendary:'glow-legendary-b'}[r]||'glow-common-b');
    const top3Prizes=(list=[])=>list.slice().sort((a,b)=>{
      const ra=rarityOrder[a.rarity]||0, rb=rarityOrder[b.rarity]||0;
      if(rb!==ra) return rb-ra;
      const sa=a.starsValue||0, sb=b.starsValue||0; if(sb!==sa) return sb-sa;
      return (a.weight||0)-(b.weight||0);
    }).slice(0,3);

    /* audio */
    class SpinAudio{
      constructor(){this.ctx=null;this.gain=null;}
      ensure(){if(!this.ctx){const AC=window.AudioContext||window.webkitAudioContext;if(!AC)return;this.ctx=new AC();this.gain=this.ctx.createGain();this.gain.gain.value=0.06;this.gain.connect(this.ctx.destination);}}
      flip(){this.ensure();if(!this.ctx||!this.gain)return;const o=this.ctx.createOscillator(),g=this.ctx.createGain();o.type='triangle';o.frequency.value=520;o.connect(g).connect(this.gain);const t=this.ctx.currentTime;g.gain.setValueAtTime(0.05,t);g.gain.exponentialRampToValueAtTime(0.00001,t+0.15);o.start(t);o.stop(t+0.16);}
      win(){this.ensure();if(!this.ctx||!this.gain)return;const o=this.ctx.createOscillator(),g=this.ctx.createGain();o.type='sine';o.frequency.value=880;o.connect(g).connect(this.gain);const t=this.ctx.currentTime;g.gain.setValueAtTime(0.08,t);g.gain.exponentialRampToValueAtTime(0.00001,t+0.4);o.frequency.exponentialRampToValueAtTime(1320,t+0.35);o.start(t);o.stop(t+0.4);}
    }
    const audio=new SpinAudio();

    /* components */
    const MiniCards=({prizes})=>{
      const picks=top3Prizes(prizes);
      const fan=[{rot:-14,x:-16,z:10,s:0.98,ml:0},{rot:0,x:0,z:30,s:1.06,ml:-24},{rot:14,x:16,z:20,s:0.98,ml:-24}];
      return(
        <div className="mini-fan">
          {picks.map((p,i)=>(
            <div key={p.id||i} className={`mini-card ${glowMini(p.rarity)}`}
              style={{transform:`translateX(${fan[i].x}px) rotate(${fan[i].rot}deg) scale(${fan[i].s})`,zIndex:fan[i].z,marginLeft:i===0?0:fan[i].ml}}>
              <span className="text-lg leading-none">{p.emoji||'üéÅ'}</span>
            </div>
          ))}
        </div>
      );
    };

    const HomeCaseCard=({c,onClick})=>(
      <div onClick={onClick} role="button" className="rounded-2xl p-4 border transition cursor-pointer fade-in"
        style={{background:'var(--card)',borderColor:'var(--border)'}}>
        <MiniCards prizes={c.prizes}/>
        <div className="mt-3 flex flex-col items-center justify-center text-center">
          <div className="text-base font-extrabold">{c.title}</div>
          <div className="text-xs" style={{color:'var(--nardo)'}}>{c.description}</div>
          <div className="mt-2 text-xs" style={{color:'var(--nardo)'}}>–¶–µ–Ω–∞: <span style={{color:'#fff'}}>{c.priceStars} ‚≠ê</span></div>
        </div>
      </div>
    );

    const LiveFeed=({events})=>{
      const ref=useRef(null);
      useEffect(()=>{ if(ref.current){ ref.current.scrollLeft = ref.current.scrollWidth; }},[events]);
      return(
        <div className="hfeed-wrap">
          <div className="hfeed" ref={ref}>
            {events.map((e,i)=>(
              <div key={i} className="hfeed-item">
                <div className="flex items-center gap-2 min-w-0">
                  <div className="text-xl">{e.emoji}</div>
                  <div className="truncate text-sm"><span style={{color:'var(--nardo)'}}>{e.user}</span> –ø–æ–ª—É—á–∏–ª <span className="font-semibold">{e.label}</span></div>
                </div>
                <div className="text-[11px]" style={{color:'var(--nardo)'}}>{e.time}</div>
              </div>
            ))}
          </div>
        </div>
      );
    };

    function CardFront({prize}){
      return(
        <div className="flip-face back">
          <div className="flex flex-col items-center justify-center h-full p-3 text-center">
            <div className="text-4xl">{prize?.emoji ?? 'üéÅ'}</div>
            <div className="mt-2 text-sm font-semibold">{prize?.label ?? '–ü—Ä–∏–∑'}</div>
            {prize ? <div className="mt-1 inline-block px-2 py-0.5 rounded-full text-[10px]" style={{background:'var(--nardo)',color:'#111'}}>{prize.rarity}</div> : null}
          </div>
        </div>
      );
    }

    function CaseDetail({data,onBack,onOpenServer,opening,onClaimPrize,onSellPrize,pushFeed,live}){
      const [phase,setPhase]=useState('idle');
      const [cards,setCards]=useState(Array(5).fill(null).map(()=>({prize:null,flipped:false,picked:false})));
      const [pickedIndex,setPickedIndex]=useState(null);
      const [landedPrize,setLandedPrize]=useState(null);

      // COMPACT fan for mobile
      const baseTransform=(i,n)=>{
        const isNarrow = window.innerWidth <= 414;
        const spread = isNarrow ? 18 : 24;
        const start  = -spread/2;
        const angle  = start + i * (spread / Math.max(1, n - 1));
        const yLift  = isNarrow ? 2 : 3;
        const y      = Math.abs(i - (n - 1) / 2) * yLift;
        return {angle,y};
      };
      const displacedStyle=(i,n,picked)=>{
        const {angle,y}=baseTransform(i,n);
        const isNarrow = window.innerWidth <= 414;
        if(picked==null) return {transform:`rotate(${angle}deg) translateY(${y}px)`,zIndex:5};
        if(i===picked) return {transform:`rotate(${angle}deg) translateY(${Math.max(0,y-(isNarrow?1:2))}px) scale(${isNarrow?1.03:1.06})`,zIndex:50};
        const dir=i<picked?-1:1, distance=(isNarrow?56:90)+Math.abs(i-picked)*(isNarrow?8:12), lift=isNarrow?6:10, ang=angle*(isNarrow?0.9:0.8);
        return {transform:`rotate(${ang}deg) translate(${dir*distance}px, ${y+lift}px) scale(${isNarrow?0.965:0.96})`,zIndex:5-Math.abs(i-picked)};
      };

      const prepare=()=>{ setPhase('choosing'); setCards(Array(5).fill(null).map(()=>({prize:null,flipped:false,picked:false}))); setPickedIndex(null); setLandedPrize(null); };

      const onPick=async(i)=>{
        if(phase!=='choosing') return;
        setPhase('picking'); setPickedIndex(i); setCards(cs=>cs.map((c,idx)=>idx===i?{...c,picked:true}:c));
        let prize=null;
        try{
          const res=await fetch('/api/open',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({caseId:data.id})});
          if(res.ok){ const json=await res.json().catch(()=>({})); if(json&&json.prize) prize=json.prize; }
        }catch(_){}
        if(!prize||!prize.id){
          const total=(data.prizes||[]).reduce((s,p)=>s+(p?.weight||0),0); let r=Math.random()*Math.max(1,total);
          prize=data.prizes?.[0]||null; for(const p of (data.prizes||[])){ r-=(p?.weight||0); if(r<=0){ prize=p; break; } }
        }
        audio.flip(); tg?.HapticFeedback?.selectionChanged?.();
        setCards(cs=>cs.map((c,idx)=>idx===i?{...c,prize,flipped:true}:c));
        setPhase('revealed'); setLandedPrize(prize);
        setTimeout(()=>{ setCards(cs=>{ const chosenId=prize&&prize.id; const pool=Array.isArray(data.prizes)?data.prizes.slice():[];
          const rest=chosenId?pool.filter(p=>p.id!==chosenId):pool; const shuffled=rest.slice().sort(()=>Math.random()-0.5); let ri=0;
          return cs.map((c,idx)=>idx===i?c:{...c,prize:(shuffled[ri++]||rest[0]||prize),flipped:true}); }); },380);
        setTimeout(()=>{audio.win(); tg?.HapticFeedback?.impactOccurred?.('heavy');},150);
      };

      const onStart=async()=>{
        if(opening) return;
        const ok=await onOpenServer(data);
        if(ok) prepare();
      };

      return(
        <>
          <LiveFeed events={live}/>
          <div className="flex items-center gap-2 mb-4">
            <button onClick={onBack} className="btn-secondary">‚Üê –ù–∞–∑–∞–¥</button>
            <div className="text-xl font-semibold">{data.title}</div>
            <div className="ml-auto text-sm" style={{color:'var(--nardo)'}}>–¶–µ–Ω–∞: {data.priceStars} ‚≠ê</div>
          </div>

          <div className="rounded-2xl p-4 border" style={{borderColor:'var(--border)',background:'var(--card)'}}>
            <div className="text-sm" style={{color:'var(--nardo)'}}>
              {phase==='idle'?'–ù–∞–∂–º–∏ ¬´–û—Ç–∫—Ä—ã—Ç—å¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å':(phase==='choosing'?'–í—ã–±–µ—Ä–∏ –æ–¥–Ω—É –∫–∞—Ä—Ç—É':'–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç')}
            </div>

            <div className="mt-3 hand">
              {cards.map((card,idx)=>(
                <div key={idx} className="hand-card"
                  style={phase==='revealed'?displacedStyle(idx,cards.length,pickedIndex):(()=>{const {angle,y}=baseTransform(idx,cards.length);return{transform:`rotate(${angle}deg) translateY(${y}px)`,zIndex:5}})()}>
                  <div className={`flip-card ${card?.flipped?'flipped':''} ${(!card?.flipped||!card?.prize)?'':glowBig(card.prize.rarity)}`}
                       onClick={()=>phase==='choosing'&&onPick(idx)}>
                    <div className="flip-face front"><div className="text-4xl">?</div></div>
                    <CardFront prize={card?.prize}/>
                  </div>
                </div>
              ))}
            </div>

            <div className="mt-5">
              <button className="btn-orange w-full" onClick={onStart} disabled={opening} style={opening?{filter:'grayscale(.2) opacity(.7)'}:undefined}>
                –û—Ç–∫—Ä—ã—Ç—å –∑–∞ {data.priceStars} ‚≠ê
              </button>
            </div>

            {phase==='revealed'&&landedPrize&&(
              <div className="mt-4 flex items-center justify-between gap-3 rounded-2xl p-3 border"
                   style={{borderColor:'var(--border)',background:'var(--card)'}}>
                <div className="flex items-center gap-2">
                  <div className="text-2xl">{landedPrize.emoji||'üéÅ'}</div>
                  <div className="text-sm">
                    <div className="font-semibold">{landedPrize.label}</div>
                    <div className="mt-1 inline-block px-2 py-0.5 rounded-full text-[10px]" style={{background:'var(--nardo)',color:'#111'}}>{landedPrize.rarity}</div>
                  </div>
                </div>
                <div className="flex gap-2">
                  <button className="btn-secondary" onClick={()=>onSellPrize(landedPrize)}>–ü—Ä–æ–¥–∞—Ç—å –∑–∞ {(SELL_BY_RARITY[landedPrize.rarity]||1)} ‚≠ê</button>
                  <button className="btn-orange" onClick={()=>{onClaimPrize(landedPrize); pushFeed(landedPrize,'@you');}}>–ó–∞–±—Ä–∞—Ç—å</button>
                </div>
              </div>
            )}
          </div>
        </>
      );
    }

    const Toast=({text,onClose})=>{useEffect(()=>{const t=setTimeout(onClose,2000);return()=>clearTimeout(t);},[onClose]);return <div className="fixed bottom-20 left-1/2 -translate-x-1/2 px-4 py-2 rounded-xl bg-orange-500 text-black shadow-xl z-[60]">{text}</div>};

    /* ===== APP ===== */
    function App(){
      const [cases]=useState(DEFAULT_CASES);
      const [stars,setStars]=useState(START_STARS);
      const [opening,setOpening]=useState(false);
      const [selected,setSelected]=useState(null);
      const [toast,setToast]=useState(null);
      const [page,setPage]=useState('home'); // home | profile | voting | inventory

      const [feed,setFeed]=useState([
        {user:'@dino',emoji:'üí•',label:'–≠–ø–∏–∫ –ø—Ä–∏–∑',time:new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})},
        {user:'@anna',emoji:'üöÄ',label:'–õ–µ–≥–µ–Ω–¥–∞—Ä–∫–∞',time:new Date(Date.now()-6e4).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})},
      ]);

      useEffect(()=>{
        const users=['@max','@ivan','@lena','@art','@kira','@john','@mike'];
        const all=cases.flatMap(c=>c.prizes);
        const t=setInterval(()=>{
          const p=all[Math.floor(Math.random()*all.length)];
          const u=users[Math.floor(Math.random()*users.length)];
          setFeed(f=>[...f.slice(-60),{user:u,emoji:p.emoji||'üéÅ',label:p.label||'–ü—Ä–∏–∑',time:new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}]);
        },6500+Math.random()*1500);
        return()=>clearInterval(t);
      },[cases]);

      useEffect(()=>{try{tg?.ready?.();tg?.expand?.();}catch(_){}} ,[]);

      const pushFeed=(p,user='@you')=>setFeed(f=>[...f.slice(-60),{user,emoji:p.emoji||'üéÅ',label:p.label||'–ü—Ä–∏–∑',time:new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}]);

      const openDetails=(c)=>{setSelected(c);window.scrollTo({top:0,behavior:'smooth'});};

      const onOpenServerPrepare=async(c)=>{
        if(opening) return false;
        if(stars<c.priceStars){ setToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚≠ê'); tg?.HapticFeedback?.notificationOccurred?.('warning'); return false; }
        setOpening(true); setStars(s=>s-c.priceStars); tg?.HapticFeedback?.impactOccurred?.('medium');
        await new Promise(r=>setTimeout(r,180)); setOpening(false); return true;
      };

      const onSellPrize=(p)=>{const v=SELL_BY_RARITY[p.rarity]||1; setStars(s=>s+v); setToast(`–ü—Ä–æ–¥–∞–Ω–æ: +${v} ‚≠ê`);};
      const onClaimPrize=(p)=>{if(p.starsValue) setStars(s=>s+p.starsValue); setToast('–ü—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω');};

      const Home=()=>(
        <>
          <LiveFeed events={feed}/>
          <section className="mt-3 cases-grid">
            {cases.map((c,i)=>(
              <div key={c.id} className="fade-in" style={{animationDelay:`${i*60+40}ms`}}>
                <HomeCaseCard c={c} onClick={()=>openDetails(c)}/>
              </div>
            ))}
          </section>
        </>
      );

      const Profile=()=>(
        <div className="rounded-2xl p-4 border" style={{borderColor:'var(--border)',background:'var(--card)'}}>
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-full bg-[#161a1f] flex items-center justify-center">üë§</div>
            <div><div className="font-semibold">@username</div><div className="text-sm" style={{color:'var(--nardo)'}}>‚≠ê {stars}</div></div>
          </div>
        </div>
      );

      const Voting=()=>(
        <div className="rounded-2xl p-4 border" style={{borderColor:'var(--border)',background:'var(--card)'}}>
          <div className="text-sm mb-3" style={{color:'var(--nardo)'}}>–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ —Ñ–∏—á–∏</div>
          {['–ù–æ–≤—ã–π ¬´–£–ª—å—Ç—Ä–∞-–∫–µ–π—Å¬ª','–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ —Ç—É—Ä–Ω–∏—Ä—ã','–û–±–º–µ–Ω –ø—Ä–∏–∑–æ–≤'].map((opt,i)=>(
            <div key={i} className="flex items-center justify-between gap-3 p-3 rounded-xl border mb-2" style={{borderColor:'var(--border)',background:'var(--card)'}}>
              <div className="text-sm">{opt}</div><button className="btn-orange px-3">–ì–æ–ª–æ—Å–æ–≤–∞—Ç—å</button>
            </div>
          ))}
        </div>
      );

      const Inventory=()=>(
        <div className="rounded-2xl p-4 border" style={{borderColor:'var(--border)',background:'var(--card)'}}>
          <div className="text-sm" style={{color:'var(--nardo)'}}>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å (–¥–µ–º–æ)</div>
        </div>
      );

      return(
        <div className="min-h-dvh pb-20 px-4 py-5">
          <div className="mx-auto max-w-md">
            <header className="flex items-center justify-between">
              <h1 className="text-2xl font-bold">–ö–µ–π—Å—ã –∑–∞ ‚≠ê</h1>
              <div className="px-3 py-2 rounded-xl bg-orange-500 text-black font-semibold shadow-lg">{stars} ‚≠ê</div>
            </header>

            {!selected && page==='home' && <Home/>}
            {selected && (
              <section className="mt-4">
                <CaseDetail
                  data={selected}
                  onBack={()=>setSelected(null)}
                  onOpenServer={onOpenServerPrepare}
                  opening={opening}
                  onClaimPrize={(p)=>{onClaimPrize(p); pushFeed(p); setSelected(null);}}
                  onSellPrize={onSellPrize}
                  pushFeed={pushFeed}
                  live={feed}
                />
              </section>
            )}
            {page==='profile' && <section className="mt-4"><Profile/></section>}
            {page==='voting' && <section className="mt-4"><Voting/></section>}
            {page==='inventory' && <section className="mt-4"><Inventory/></section>}

            <footer className="mt-8 text-center text-xs" style={{color:'var(--nardo)'}}>
              –î–µ–º–æ—Ä–µ–∂–∏–º. –°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∏–∑ —á–µ—Ä–µ–∑ <span style={{color:'#fff'}}>/api/open</span>.
            </footer>
          </div>

          <!-- TABBAR -->
          <div className="fixed bottom-0 left-0 right-0 px-4 py-3" style={{background:'rgba(0,0,0,.72)',backdropFilter:'blur(8px)',borderTop:'1px solid var(--border)'}}>
            <div className="mx-auto max-w-md tabbar">
              <button className={`tab-btn ${page==='profile'?'active':''}`} onClick={()=>{setSelected(null);setPage('profile')}}>
                <span>üë§</span><span className="text-xs">–ü—Ä–æ—Ñ–∏–ª—å</span>
              </button>
              <button className={`tab-btn ${page==='voting'?'active':''}`} onClick={()=>{setSelected(null);setPage('voting')}}>
                <span>üó≥Ô∏è</span><span className="text-xs">–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</span>
              </button>
              <button className={`tab-btn ${page==='inventory'?'active':''}`} onClick={()=>{setSelected(null);setPage('inventory')}}>
                <span>üéí</span><span className="text-xs">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</span>
              </button>
            </div>
          </div>

          {toast && <Toast text={toast} onClose={()=>setToast(null)}/>}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
