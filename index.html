<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö–µ–π—Å—ã –∑–∞ ‚≠ê ‚Äî Telegram Mini App</title>

  <!-- –≤–Ω–µ—à–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç—ã -->
  <script src="https://telegram.org/js/telegram-web-app.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com" crossorigin="anonymous"></script>
  <script>
    tailwind.config = { darkMode: 'class', theme: { extend: {} } };
  </script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- –ª–æ–≤–µ—Ü –æ—à–∏–±–æ–∫ -->
  <script>
    (function () {
      const show = (title, detail) => {
        try {
          const box = document.getElementById('err');
          if (box) { box.style.display='block'; box.textContent = `${title}\n${detail || ''}`; }
        } catch(_) {}
      };
      window.onerror = function (msg, src, line, col, err) {
        const detail = [
          `source: ${src || '-'}`,
          `line: ${line || '-'}, col: ${col || '-'}`,
          `stack: ${(err && err.stack) || '-'}`
        ].join('\n');
        show(`JS error: ${msg}`, detail);
      };
      window.addEventListener('unhandledrejection', (e) => {
        const detail = (e.reason && e.reason.stack) || String(e.reason);
        show('Promise error', detail);
      });
    })();
  </script>

  <style>
    html, body, #root { height:100%; }
    body {
      background:
        radial-gradient(1200px 800px at 20% -10%, #1a2334 0%, transparent 60%),
        radial-gradient(1400px 900px at 110% 20%, #221632 0%, transparent 55%),
        linear-gradient(180deg, #070b10 0%, #0b0f14 100%);
      color:#e7f1ff;
      font-family:'Manrope', Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    @keyframes fadeInUp { from{opacity:0;transform:translateY(10px) scale(.98);} to{opacity:1;transform:translateY(0) scale(1);} }
    .fade-in { animation: fadeInUp .38s cubic-bezier(.2,.8,.2,1) both; }

    /* –º–∏–Ω–∏ –∫–∞—Ä—Ç—ã */
    .mini-fan{ position:relative; height:70px; display:flex; align-items:flex-end; justify-content:center; }
    .mini-card{ width:58px; height:74px; border-radius:12px; background:#0f172a; border:1px solid #334155; display:flex; align-items:center; justify-content:center; position:relative; }
    .glow-common{ box-shadow:0 0 0 2px rgba(122,138,160,.55), 0 0 22px rgba(122,138,160,.35) inset; }
    .glow-rare{ box-shadow:0 0 0 2px rgba(108,240,255,.65), 0 0 26px rgba(108,240,255,.35) inset; }
    .glow-epic{ box-shadow:0 0 0 2px rgba(183,108,255,.65), 0 0 28px rgba(183,108,255,.40) inset; }
    .glow-legendary{ box-shadow:0 0 0 2px rgba(255,108,196,.70), 0 0 30px rgba(255,108,196,.45) inset; }

    /* –ª–∞–π–≤-–ª–µ–Ω—Ç–∞ */
    .hfeed-wrap{ margin-top:12px; margin-bottom:14px; }
    .hfeed{ display:flex; gap:12px; overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .hfeed::-webkit-scrollbar{ display:none; }
    .hfeed-item{ min-width:220px; border-radius:16px; border:1px solid #334155; background:linear-gradient(135deg,#1e293b,#111827); padding:10px 12px; display:flex; align-items:center; justify-content:space-between; }

    /* —Å–µ—Ç–∫–∞ –∫–µ–π—Å–æ–≤ */
    .cases-grid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 1rem; }

    /* —Ñ–ª–∏–ø-–∫–∞—Ä—Ç—ã */
    .flip-card{ width:120px; height:160px; position:relative; transform-style:preserve-3d; transition:transform .6s; border-radius:16px; box-shadow:0 12px 32px rgba(0,0,0,.4); }
    .flip-card.flipped{ transform:rotateY(180deg); }
    .flip-face{ position:absolute; inset:0; border-radius:16px; backface-visibility:hidden; display:flex; align-items:center; justify-content:center; }
    .flip-face.front{ background:#1e293b; color:#fff; }
    .flip-face.back{ background:#0f172a; transform:rotateY(180deg); }

    /* —Ç–∞–±–±–∞—Ä */
    .tabbar{ display:flex; gap:12px; }
    .tab-btn{ flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; padding:10px 6px; border-radius:14px; border:1px solid #334155; background:#0f172a; font-weight:700; transition:transform .12s; }
    .tab-btn:hover{ filter:brightness(1.06) }
    .tab-btn:active{ transform:scale(.96) }
    .tab-btn.active{ border-color:rgba(108,240,255,.7); }
  </style>
</head>

<body>
  <div id="root"></div>
  <pre id="err" style="display:none; position:fixed; left:8px; bottom:64px; right:8px; max-height:40vh; overflow:auto; background:#111; color:#fff; padding:8px; border-radius:8px; z-index:9999"></pre>

  <script type="text/babel">
    const { useState } = React;
    const tg = window.Telegram?.WebApp;

    const rarityOrder={legendary:4,epic:3,rare:2,common:1};
    const glowClass=(r)=>({common:'glow-common',rare:'glow-rare',epic:'glow-epic',legendary:'glow-legendary'}[r]||'');

    const top3Prizes=(list=[])=>list.slice().sort((a,b)=>{
      const ra=rarityOrder[a.rarity]||0, rb=rarityOrder[b.rarity]||0;
      if(rb!==ra) return rb-ra;
      const sa=a.starsValue||0, sb=b.starsValue||0;
      if(sb!==sa) return sb-sa;
      return (a.weight||0)-(b.weight||0);
    }).slice(0,3);

    const MiniCards=({prizes})=>{
      const picks=top3Prizes(prizes);
      const fan=[{rot:-14,x:-18,z:10},{rot:0,x:0,z:30},{rot:14,x:18,z:20}];
      return <div className="mini-fan mt-2">{picks.map((p,i)=><div key={i} className={`mini-card ${glowClass(p.rarity)}`} style={{transform:`translateX(${fan[i].x}px) rotate(${fan[i].rot}deg)`,zIndex:fan[i].z}}>{p.emoji}</div>)}</div>;
    };

    const HomeCaseCard=({c,onClick})=>(
      <div onClick={onClick} className="rounded-2xl p-4 bg-[#0b0f14] border border-slate-700 hover:border-cyan-400 transition cursor-pointer">
        <MiniCards prizes={c.prizes}/>
        <div className="mt-3 flex flex-col items-center text-center fade-in">
          <div className="text-base font-semibold">{c.title}</div>
          <div className="text-xs text-zinc-400">{c.description}</div>
          <div className="mt-2 text-xs text-zinc-400">–¶–µ–Ω–∞: <span className="text-zinc-200">{c.priceStars} ‚≠ê</span></div>
        </div>
      </div>
    );

    const LiveFeed=({events})=>(
      <div className="hfeed-wrap">
        <div className="text-sm text-zinc-400 mb-2">–õ–∞–π–≤: –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–∏–≥—Ä—ã—à–∏</div>
        <div className="hfeed">
          {events.map((e,i)=><div key={i} className="hfeed-item"><div className="flex items-center gap-2 min-w-0"><div className="text-xl">{e.emoji}</div><div className="truncate text-sm"><span className="text-zinc-300">{e.user}</span> –ø–æ–ª—É—á–∏–ª <span className="font-semibold">{e.label}</span></div></div><div className="text-[11px] text-zinc-400">{e.time}</div></div>)}
        </div>
      </div>
    );

    const CaseDetail=({data,onBack,onSell,onClaim})=>{
      const [cards,setCards]=useState(Array(5).fill({flipped:false,prize:null}));
      const [picked,setPicked]=useState(null);
      const onPick=(i)=>{
        if(picked!=null) return;
        const prize=data.prizes[Math.floor(Math.random()*data.prizes.length)];
        setPicked(i);
        setCards(cs=>cs.map((c,j)=> j===i?{flipped:true,prize}:{flipped:true,prize:data.prizes[j%data.prizes.length]}));
        tg?.HapticFeedback?.selectionChanged?.();
      };
      return <div>
        <button onClick={onBack} className="btn-secondary mb-3">‚Üê –ù–∞–∑–∞–¥</button>
        <div className="hand">{cards.map((c,i)=><div key={i} className="hand-card"><div className={`flip-card ${c.flipped?'flipped':''} ${c.prize?glowClass(c.prize.rarity):''}`} onClick={()=>onPick(i)}><div className="flip-face front">?</div><div className="flip-face back">{c.prize?c.prize.emoji:'üéÅ'}</div></div></div>)}</div>
        {picked!=null && <div className="mt-4 flex gap-2"><button className="btn-secondary" onClick={()=>onSell(cards[picked].prize)}>–ü—Ä–æ–¥–∞—Ç—å</button><button className="btn-primary" onClick={()=>onClaim(cards[picked].prize)}>–ó–∞–±—Ä–∞—Ç—å</button></div>}
      </div>;
    };

    function App(){
      const [cases]=useState([
        {id:'lite',title:'–õ–∞–π—Ç-–∫–µ–π—Å',priceStars:3,description:'–î–µ—à—ë–≤—ã–π –≤—Ö–æ–¥',prizes:[{emoji:'‚≠ê',rarity:'common',weight:50,starsValue:1},{emoji:'üí•',rarity:'epic',weight:5,starsValue:10},{emoji:'üöÄ',rarity:'legendary',weight:1,starsValue:30}]},
        {id:'pro',title:'–ü—Ä–æ-–∫–µ–π—Å',priceStars:12,description:'–ë–æ–ª—å—à–æ–π —Ä–∏—Å–∫',prizes:[{emoji:'üåü',rarity:'rare',weight:20,starsValue:5},{emoji:'üé®',rarity:'epic',weight:8},{emoji:'üèÜ',rarity:'legendary',weight:2,starsValue:60}]}
      ]);
      const [stars,setStars]=useState(20);
      const [selected,setSelected]=useState(null);
      const [events]=useState([{user:'–ò–≤–∞–Ω',emoji:'üí•',label:'–≠–ø–∏–∫',time:'—Ç–æ–ª—å–∫–æ —á—Ç–æ'}]);
      const [inv,setInv]=useState([]);
      const [tab,setTab]=useState('profile');
      const onSell=(p)=>setStars(s=>s+1);
      const onClaim=(p)=>setInv([...inv,p]);

      return <div className="min-h-dvh pb-20 px-4 py-5">
        <div className="mx-auto max-w-md">
          {!selected && <>
            <LiveFeed events={events}/>
            <section className="mt-4 cases-grid">{cases.map(c=><HomeCaseCard key={c.id} c={c} onClick={()=>setSelected(c)}/>)}</section>
          </>}
          {selected && <CaseDetail data={selected} onBack={()=>setSelected(null)} onSell={onSell} onClaim={onClaim}/>}
        </div>
        <div className="fixed bottom-0 left-0 right-0 px-4 py-3 bg-black/70 backdrop-blur border-t border-slate-800">
          <div className="mx-auto max-w-md tabbar">
            <button className={`tab-btn ${tab==='profile'?'active':''}`} onClick={()=>setTab('profile')}><span>üë§</span><span className="text-xs">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
            <button className={`tab-btn ${tab==='voting'?'active':''}`} onClick={()=>setTab('voting')}><span>üó≥Ô∏è</span><span className="text-xs">–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</span></button>
            <button className={`tab-btn ${tab==='inventory'?'active':''}`} onClick={()=>setTab('inventory')}><span>üéí</span><span className="text-xs">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</span></button>
          </div>
        </div>
      </div>;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
