<!DOCTYPE html>
<html lang="ru">
<head>
<script>
  (function () {
    const show = (title, detail) => {
      try {
        const box = document.getElementById('err');
        if (box) {
          box.style.display = 'block';
          box.textContent = title + '\n' + (detail || '');
        }
      } catch (_) {}
    };

    window.onerror = function (message, source, lineno, colno, error) {
      const detail = [
        'source: ' + (source || '-'),
        'line: ' + (lineno || '-') + ', col: ' + (colno || '-'),
        'stack: ' + (error && error.stack ? error.stack : '-')
      ].join('\n');
      show('JS error: ' + message, detail);
    };

    window.addEventListener('unhandledrejection', (e) => {
      const reason = e && e.reason;
      const detail = (reason && reason.stack) || JSON.stringify(reason);
      show('Promise error', detail);
    });
  })();
</script>


  <style>
    html, body, #root { height: 100%; }
    /* ==== FLIP CARD ANIMATION ==== */
    .flip-scene { perspective: 1000px; }
    .flip-card {
      width: 120px; height: 160px;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 700ms cubic-bezier(.2,.8,.2,1);
    }
    .flip-card.flipped { transform: rotateY(180deg); }
    .flip-face {
      position: absolute; inset: 0; border-radius: 16px;
      backface-visibility: hidden; -webkit-backface-visibility: hidden;
      display: flex; align-items: center; justify-content: center;
    }
    .flip-face.back { transform: rotateY(180deg); }
    /* –º—è–≥–∫–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ —Å—Ü–µ–Ω—ã */
    .cards-enter { opacity: 0; transform: translateY(16px) scale(0.98); }
    .cards-enter-active {
      opacity: 1; transform: translateY(0) scale(1);
      transition: all 300ms cubic-bezier(.2,.8,.2,1);
    }
  </style>

  <!-- –ü–æ–π–º–∞–µ–º –æ—à–∏–±–∫–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–≥–∞—Ç—å "–±–µ–ª–æ–≥–æ —ç–∫—Ä–∞–Ω–∞" -->
  <script>
    window.addEventListener('error', (e) => {
      const box = document.getElementById('err');
      if (box) { box.style.display='block'; box.textContent = 'JS error: ' + e.message; }
      console.error(e.error || e.message);
    });
    window.addEventListener('unhandledrejection', (e) => {
      const box = document.getElementById('err');
      if (box) { box.style.display='block'; box.textContent = 'Promise error: ' + (e.reason && e.reason.message || e.reason); }
      console.error(e.reason);
    });
  </script>
</head>
<body class="bg-gradient-to-b from-white to-gray-50 text-gray-900">
  <div id="root"></div>
  <pre id="err" style="display:none; position:fixed; left:8px; bottom:8px; right:8px; max-height:40vh; overflow:auto; background:#111; color:#fff; padding:8px; border-radius:8px; z-index:9999"></pre>

  <script type="text/babel">
    const { useEffect, useRef, useState } = React;
    const tg = (typeof window !== 'undefined' ? window.Telegram : undefined);

    // ===== –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ (—Å–æ–≤–ø–∞–¥–∞—é—Ç —Å —Å–µ—Ä–≤–µ—Ä–æ–º) =====
    const START_STARS = 25;
    const DEFAULT_CASES = [
      { id:'lite', title:'–õ–∞–π—Ç-–∫–µ–π—Å', priceStars:3, bannerEmoji:'üéà', description:'–î–µ—à—ë–≤—ã–π –≤—Ö–æ–¥, –±—ã—Å—Ç—Ä—ã–µ –ø—Ä–∏–∑—ã',
        prizes:[ {id:'l1',label:'–°—Ç–∏–∫–µ—Ä –º–∏–Ω–∏',emoji:'üêæ',rarity:'common',weight:55},
                 {id:'l2',label:'1‚≠ê –Ω–∞–∑–∞–¥',emoji:'‚≠ê',rarity:'common',weight:30,starsValue:1},
                 {id:'l3',label:'–ú–∞–ª—ã–π –±—É—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è',emoji:'üîπ',rarity:'rare',weight:12},
                 {id:'l4',label:'5‚≠ê –¥–∂–µ–∫–ø–æ—Ç',emoji:'üí•',rarity:'epic',weight:3,starsValue:5} ]},
      { id:'starter', title:'–°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–µ–π—Å', priceStars:6, bannerEmoji:'üéÅ', description:'–û—Ç–∫—Ä—ã–≤–∞–π –∏ –ª–æ–≤–∏ —É–¥–∞—á—É!',
        prizes:[ {id:'s1',label:'–°—Ç–∏–∫–µ—Ä-–ø–∞–∫',emoji:'üò∫',rarity:'common',weight:45},
                 {id:'s2',label:'2‚≠ê –Ω–∞–∑–∞–¥',emoji:'‚≠ê',rarity:'common',weight:28,starsValue:2},
                 {id:'s3',label:'–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –±–µ–π–¥–∂',emoji:'üèÖ',rarity:'rare',weight:17},
                 {id:'s4',label:'–ê–≤–∞—Ç–∞—Ä-—Ä–∞–º–∫–∞',emoji:'üñºÔ∏è',rarity:'epic',weight:8},
                 {id:'s5',label:'–ú–µ–≥–∞–ø—Ä–∏–∑: 20‚≠ê',emoji:'üí´',rarity:'legendary',weight:2,starsValue:20} ]},
      { id:'pro', title:'–ü—Ä–æ-–∫–µ–π—Å', priceStars:12, bannerEmoji:'‚ö°', description:'–ë–æ–ª—å—à–µ —Ä–∏—Å–∫ ‚Äî –∫—Ä—É—á–µ –ø—Ä–∏–∑—ã',
        prizes:[ {id:'p1',label:'3‚≠ê –Ω–∞–∑–∞–¥',emoji:'‚≠ê',rarity:'common',weight:32,starsValue:3},
                 {id:'p2',label:'–°–∫–∏–Ω –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è',emoji:'üé®',rarity:'rare',weight:28},
                 {id:'p3',label:'–ê–Ω–∏–º–∞—Ü–∏—è –∏–º–µ–Ω–∏',emoji:'‚ú®',rarity:'rare',weight:20},
                 {id:'p4',label:'10‚≠ê –Ω–∞–∑–∞–¥',emoji:'üåü',rarity:'epic',weight:15,starsValue:10},
                 {id:'p5',label:'–°—É–ø–µ—Ä–ø—Ä–∏–∑: 60‚≠ê',emoji:'üöÄ',rarity:'legendary',weight:5,starsValue:60} ]},
      { id:'ultra', title:'–£–ª—å—Ç—Ä–∞-–∫–µ–π—Å', priceStars:30, bannerEmoji:'üëë', description:'–í—ã—Å–æ–∫–∞—è —Å—Ç–∞–≤–∫–∞ ‚Äî –∫–æ—Ä–æ–ª–µ–≤—Å–∫–∏–µ –Ω–∞–≥—Ä–∞–¥—ã',
        prizes:[ {id:'u1',label:'7‚≠ê –Ω–∞–∑–∞–¥',emoji:'‚≠ê',rarity:'rare',weight:30,starsValue:7},
                 {id:'u2',label:'–†–µ–¥–∫–∏–π —Å–∫–∏–Ω + —ç—Ñ—Ñ–µ–∫—Ç',emoji:'üßø',rarity:'epic',weight:28},
                 {id:'u3',label:'15‚≠ê –Ω–∞–∑–∞–¥',emoji:'üåü',rarity:'epic',weight:20,starsValue:15},
                 {id:'u4',label:'–õ–µ–≥–µ–Ω–¥–∞: 120‚≠ê',emoji:'üèÜ',rarity:'legendary',weight:6,starsValue:120},
                 {id:'u5',label:'–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π —Å–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤',emoji:'üéñÔ∏è',rarity:'legendary',weight:4},
                 {id:'u6',label:'–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π: 300‚≠ê',emoji:'ü¶Ñ',rarity:'legendary',weight:2,starsValue:300} ]},
    ];

    const SELL_BY_RARITY = { common:1, rare:2, epic:6, legendary:20 };
    const rarityColor = (r) => ({
      common: 'bg-gray-200 text-gray-800',
      rare: 'bg-blue-200 text-blue-900',
      epic: 'bg-purple-200 text-purple-900',
      legendary: 'bg-amber-200 text-amber-900'
    }[r] || 'bg-gray-200 text-gray-800');

    // ===== –∑–≤—É–∫/–≤–∏–±—Ä–æ =====
    class SpinAudio {
      constructor(){ this.ctx=null; this.gain=null; }
      ensure(){ if(!this.ctx){ const AC = window.AudioContext||window.webkitAudioContext; if(!AC) return;
        this.ctx=new AC(); this.gain=this.ctx.createGain(); this.gain.gain.value=0.06; this.gain.connect(this.ctx.destination);} }
      flip(){ this.ensure(); if(!this.ctx||!this.gain) return; const o=this.ctx.createOscillator(), g=this.ctx.createGain();
        o.type='triangle'; o.frequency.value=520; o.connect(g).connect(this.gain);
        const t=this.ctx.currentTime; g.gain.setValueAtTime(0.05,t); g.gain.exponentialRampToValueAtTime(0.00001,t+0.15);
        o.start(t); o.stop(t+0.16); }
      win(){ this.ensure(); if(!this.ctx||!this.gain) return; const o=this.ctx.createOscillator(), g=this.ctx.createGain();
        o.type='sine'; o.frequency.value=880; o.connect(g).connect(this.gain);
        const t=this.ctx.currentTime; g.gain.setValueAtTime(0.08,t); g.gain.exponentialRampToValueAtTime(0.00001,t+0.4);
        o.frequency.exponentialRampToValueAtTime(1320, t+0.35); o.start(t); o.stop(t+0.4); }
    }
    const audio = new SpinAudio();

    // ===== –ö–∞—Ä—Ç–æ—á–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è =====
    function CardBack() {
      return (
        <div className="flip-face front bg-gradient-to-br from-zinc-900 to-zinc-700 text-white border border-black/20 shadow-lg">
          <div className="text-4xl">?</div>
        </div>
      );
    }
    function CardFront({ prize }) {
      return (
        <div className="flip-face back bg-white border border-black/10 shadow-md">
          <div className="flex flex-col items-center justify-center h-full p-3 text-center">
            <div className="text-4xl">{prize?.emoji ?? 'üéÅ'}</div>
            <div className="mt-2 text-sm font-semibold">{prize?.label ?? '–ü—Ä–∏–∑'}</div>
            {prize ? (
              <div className={`mt-1 inline-block px-2 py-0.5 rounded-full text-[10px] ${rarityColor(prize.rarity)}`}>
                {prize.rarity}
              </div>
            ) : null}
          </div>
        </div>
      );
    }

    // ===== –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å —Ä–µ–∂–∏–º–æ–º "5 –∫–∞—Ä—Ç" =====
    function CaseDetailCards({ data, onBack, onOpenServer, opening, onSell, onClaim, setLastPrize, setToast, addHistory }) {
      const [phase, setPhase] = useState('idle'); // idle | choosing | revealed
      const [cards, setCards] = useState(Array(5).fill(null)); // [{prize, flipped:boolean, picked:boolean}]
      const [pickedIndex, setPickedIndex] = useState(null);

      // –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—Ü–µ–Ω—ã –∫–∞—Ä—Ç–æ—á–µ–∫ (–ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è "–û—Ç–∫—Ä—ã—Ç—å")
      const prepareCards = () => {
        setPhase('choosing');
        setCards(Array(5).fill(null).map(() => ({ prize: null, flipped: false, picked: false })));
      };

      // –∏–≥—Ä–æ–∫ –∫–ª–∏–∫–∞–µ—Ç –∫–∞—Ä—Ç—É ‚Üí –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∑–∞ –ø—Ä–∏–∑–æ–º ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–µ ‚Üí –ø–æ—Å–ª–µ –ø–∞—É–∑—ã –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
 const onPick = async (idx) => {
  if (phase !== 'choosing') return;

  // –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω—ã—Ö –∫–ª–∏–∫–æ–≤
  setPhase('picking');
  setPickedIndex(idx);
  setCards((cs) => cs.map((c, i) => i === idx ? { ...c, picked: true } : c));

  // 1) –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–∑ —Å —Å–µ—Ä–≤–µ—Ä–∞
  let prize = null;
  try {
    const res = await fetch('/api/open', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ caseId: data.id })
    });
    if (res.ok) {
      // –∑–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ JSON
      const json = await res.json().catch(() => ({}));
      if (json && json.prize) prize = json.prize;
    }
  } catch (_) {
    // –∏–≥–Ω–æ—Ä ‚Äî –ø–æ–π–¥—ë–º –≤ —Ñ–æ–ª–±—ç–∫
  }

  // 2) –Ω–∞–¥—ë–∂–Ω—ã–π —Ñ–æ–ª–±—ç–∫, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ—Ç/–æ—Ç–≤–µ—Ç –ø—É—Å—Ç–æ–π
  if (!prize || !prize.id) {
    const total = (data.prizes || []).reduce((s,p)=>s+(p?.weight||0),0);
    let r = Math.random()*Math.max(1,total);
    prize = data.prizes?.[data.prizes.length-1] || null;
    for (const p of (data.prizes || [])) { r -= (p?.weight||0); if (r<=0) { prize=p; break; } }
  }

  // 3) –µ—Å–ª–∏ –ø–æ –∫–∞–∫–∏–º-—Ç–æ –ø—Ä–∏—á–∏–Ω–∞–º –¥–∞–∂–µ —Ñ–æ–ª–±—ç–∫ –Ω–µ –¥–∞–ª –ø—Ä–∏–∑ ‚Äî –º—è–≥–∫–æ –≤—ã–π–¥–µ–º
  if (!prize) {
    setPhase('choosing');
    return;
  }

  // 4) –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã
  audio.flip();
  tg?.WebApp?.HapticFeedback?.selectionChanged?.();
  setCards((cs) => cs.map((c, i) => i === idx ? ({ ...c, prize, flipped: true }) : c));
  setPhase('revealed');
  setLastPrize(prize);
  addHistory(prize);

  setTimeout(()=>{ audio.win(); tg?.WebApp?.HapticFeedback?.impactOccurred?.('heavy'); }, 150);

  // 5) –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
  setTimeout(() => {
    setCards((cs) => {
      const chosenId = prize && prize.id;
      const pool = Array.isArray(data.prizes) ? data.prizes.slice() : [];
      const remainingPool = chosenId ? pool.filter(p => p.id !== chosenId) : pool;
      const shuffled = remainingPool.slice().sort(()=>Math.random()-0.5);
      let ri = 0;
      return cs.map((c, i) => {
        if (i === idx) return c;
        const alt = shuffled[ri++] || remainingPool[0] || prize;
        return { ...c, prize: alt, flipped: true };
      });
    });
  }, 500);
};


      // —Å–ø–∏—Å—ã–≤–∞–µ–º –∑–≤—ë–∑–¥—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ü–µ–Ω—É –∫–∞—Ä—Ç
      const onStart = async () => {
        if (opening) return;
        const ok = await onOpenServer(data);
        if (ok) prepareCards();
      };

      const sellValue = (p)=>({common:1,rare:2,epic:6,legendary:20}[p.rarity]||1);

      return (
        <div>
          <div className="flex items-center gap-2 mb-4">
            <button onClick={onBack} className="px-3 py-2 rounded-xl bg-white/70 border border-black/10">‚Üê –ù–∞–∑–∞–¥</button>
            <div className="text-xl font-semibold flex items-center gap-2">
              <span className="text-2xl">{data.bannerEmoji ?? 'üéÅ'}</span> {data.title}
            </div>
            <div className="ml-auto text-sm opacity-70">–¶–µ–Ω–∞: {data.priceStars} ‚≠ê</div>
          </div>

          {/* —Å—Ü–µ–Ω–∞ –∫–∞—Ä—Ç */}
          <div className={`mt-2 rounded-2xl p-4 border border-black/5 bg-white/60 backdrop-blur flip-scene ${phase==='choosing' ? 'cards-enter-active' : ''}`}>
            <div className="text-sm opacity-70">{phase==='idle' ? '–ù–∞–∂–º–∏ ¬´–û—Ç–∫—Ä—ã—Ç—å¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å' : (phase==='choosing' ? '–í—ã–±–µ—Ä–∏ –æ–¥–Ω—É –∫–∞—Ä—Ç—É' : '–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç')}</div>

            <div className="mt-3 grid grid-cols-3 sm:grid-cols-5 gap-3 justify-items-center">
              {cards.map((card, i) => (
                <div key={i} className={`transition-transform ${card?.picked?'scale-105':''}`}>
                  <div className={`flip-card ${card?.flipped?'flipped':''}`} onClick={() => (phase==='choosing') && onPick(i)}>
                    <div className="flip-face front bg-gradient-to-br from-zinc-900 to-zinc-700 text-white border border-black/20 shadow-lg">
                      <div className="text-4xl">?</div>
                    </div>
                    <div className="flip-face back bg-white border border-black/10 shadow-md">
                      <div className="flex flex-col items-center justify-center h-full p-3 text-center">
                        <div className="text-4xl">{card?.prize?.emoji ?? 'üéÅ'}</div>
                        <div className="mt-2 text-sm font-semibold">{card?.prize?.label ?? '–ü—Ä–∏–∑'}</div>
                        {card?.prize ? (
                          <div className={`mt-1 inline-block px-2 py-0.5 rounded-full text-[10px] ${rarityColor(card.prize.rarity)}`}>
                            {card.prize.rarity}
                          </div>
                        ) : null}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>

            {/* –∫–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å" –≤—Å–µ–≥–¥–∞ —Å–Ω–∏–∑—É, —Å–ø–∏—Å—ã–≤–∞–µ—Ç –∑–≤—ë–∑–¥—ã –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å—Ü–µ–Ω—É */}
            <div className="sticky bottom-3 mt-4 z-10">
              <button
                className={`w-full px-4 py-3 rounded-2xl text-sm font-semibold shadow-sm transition transform active:scale-95 ${opening ? 'bg-gray-300 cursor-not-allowed' : 'bg-black text-white'}`}
                onClick={onStart}
                disabled={opening}
              >
                –û—Ç–∫—Ä—ã—Ç—å –∑–∞ {data.priceStars} ‚≠ê
              </button>
            </div>
          </div>

          {/* —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–∑–æ–≤ –Ω–∏–∂–µ */}
          <div className="mt-5 rounded-2xl p-4 border border-black/5 bg-white/60 backdrop-blur">
            <div className="text-sm opacity-70 mb-3">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–∏–∑—ã</div>
            <div className="grid grid-cols-2 gap-2 sm:grid-cols-3">
              {data.prizes.map((p) => (
                <div key={p.id} className="flex items-center gap-2 p-2 rounded-xl border border-black/5 bg-white/80">
                  <div className="text-xl">{p.emoji ?? 'üéÅ'}</div>
                  <div className="text-sm">
                    <div className="font-medium">{p.label}</div>
                    <div className={`mt-1 inline-block px-2 py-0.5 rounded-full text-[10px] ${rarityColor(p.rarity)}`}>{p.rarity}</div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // ===== Toast / Spinner =====
    const Toast = ({ text, onClose }) => {
      useEffect(()=>{ const t=setTimeout(onClose,2000); return ()=>clearTimeout(t); },[onClose]);
      return <div className="fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-xl bg-black text-white shadow-lg">{text}</div>;
    };
    const Spinner = ({ spinning }) => (
      <div className="relative h-24 my-4 flex items-center justify-center">
        <div className={`w-20 h-20 rounded-full border-4 border-black/10 border-t-black/60 ${spinning?'animate-spin':''}`} />
      </div>
    );

    // ===== –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç =====
    function App(){
      const [cases] = useState(DEFAULT_CASES);
      const [stars,setStars]=useState(START_STARS);
      const [opening,setOpening]=useState(false);
      const [selectedCase,setSelectedCase]=useState(null);
      const [lastPrize,setLastPrize]=useState(null);
      const [toast,setToast]=useState(null);
      const [history,setHistory]=useState([]);

      useEffect(()=>{ try{ tg?.WebApp?.ready?.(); tg?.WebApp?.expand?.(); }catch(e){} },[]);
      const addHistory = (p) => setHistory((h)=> [{prize:p, ts:Date.now(), caseTitle:selectedCase?.title||'–ö–µ–π—Å'}, ...h].slice(0,20));

      const openDetails=(c)=>{ setSelectedCase(c); };

      // —Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–±–µ–∑ –≤—ã–±–æ—Ä–∞ –ø—Ä–∏–∑–∞)
      const onOpenServerPrepare = async (c) => {
        if (opening) return false;
        if (stars < c.priceStars) { setToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚≠ê'); tg?.WebApp?.HapticFeedback?.notificationOccurred?.('warning'); return false; }
        setOpening(true);
        setLastPrize(null);
        setStars(s=>s-c.priceStars);                 // —Å–ø–∏—Å—ã–≤–∞–µ–º —Å—Ä–∞–∑—É (–∫–∞–∫ —Ä–∞–Ω–µ–µ)
        tg?.WebApp?.HapticFeedback?.impactOccurred?.('medium');
        // –Ω–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ—â—É—â–µ–Ω–∏—è ¬´–ø–æ—è–≤–ª–µ–Ω–∏—è¬ª –∫–∞—Ä—Ç
        await new Promise(r=>setTimeout(r, 200));
        setOpening(false);
        return true;
      };

      const onSell=(p)=>{ const v=SELL_BY_RARITY[p.rarity]||1; setStars(s=>s+v); setToast(`–ü—Ä–æ–¥–∞–Ω–æ: +${v} ‚≠ê`); };
      const onClaim=(p)=>{ if(p.starsValue) setStars(s=>s+p.starsValue); setToast('–ü—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω (–¥–µ–º–æ)'); };

      return (
        <div className="min-h-dvh px-4 py-5">
          <div className="mx-auto max-w-md">
            <header className="flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold tracking-tight">–ö–µ–π—Å—ã –∑–∞ ‚≠ê</h1>
                <p className="opacity-70 text-sm">–û—Ç–∫—Ä—ã–≤–∞–π –∫–µ–π—Å—ã –∏ –∑–∞–±–∏—Ä–∞–π –ø—Ä–∏–∑—ã</p>
              </div>
              <div className="px-3 py-2 rounded-xl bg-yellow-200 text-yellow-900 font-semibold shadow">{stars} ‚≠ê</div>
            </header>

            {!selectedCase && (
              <>
                <section className="mt-5 grid gap-3">
                  {cases.map((c)=>(
                    <div key={c.id} className="rounded-2xl shadow-md p-4 bg-white/70 backdrop-blur border border-black/5">
                      <div className="flex items-center gap-3">
                        <div className="text-3xl">{c.bannerEmoji ?? 'üéÅ'}</div>
                        <div>
                          <div className="text-lg font-semibold">{c.title}</div>
                          <div className="text-sm opacity-70">{c.description}</div>
                        </div>
                      </div>
                      <div className="mt-4 flex justify-between items-center">
                        <div className="text-sm opacity-80">–¶–µ–Ω–∞: {c.priceStars} ‚≠ê</div>
                        <div className="flex gap-2">
                          <button className="px-3 py-2 rounded-xl text-sm font-semibold shadow-sm bg-white/70 border border-black/10" onClick={()=>openDetails(c)}>–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
                          <button className={`px-4 py-2 rounded-2xl text-sm font-semibold shadow-sm transition transform active:scale-95 ${opening?'bg-gray-300 cursor-not-allowed':'bg-black text-white'}`} onClick={()=>openDetails(c)} disabled={opening}>–û—Ç–∫—Ä—ã—Ç—å</button>
                        </div>
                      </div>
                      <div className="mt-3 flex flex-wrap gap-2">
                        {c.prizes.map(p=><span key={p.id} className={`px-2 py-1 rounded-full text-xs ${rarityColor(p.rarity)}`}>{(p.emoji?p.emoji+' ':'')+p.label}</span>)}
                      </div>
                    </div>
                  ))}
                </section>

                <section className="mt-6">
                  <div className="rounded-2xl p-4 border border-black/5 bg-white/60 backdrop-blur">
                    <div className="text-sm opacity-70">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
                    <Spinner spinning={opening} />
                    {!opening && lastPrize && (
                      <div className="text-center">
                        <div className="text-4xl mb-2">{lastPrize.emoji ?? 'üéâ'}</div>
                        <div className="text-lg font-semibold">{lastPrize.label}</div>
                        <div className={`mt-2 inline-block px-2 py-1 rounded-full text-xs ${rarityColor(lastPrize.rarity)}`}>{lastPrize.rarity}</div>
                        {lastPrize.starsValue ? (<div className="mt-2 text-sm opacity-70">–í–æ–∑–≤—Ä–∞—Ç: +{lastPrize.starsValue} ‚≠ê</div>) : null}
                      </div>
                    )}
                    {!opening && !lastPrize && (<div className="text-center opacity-60 text-sm">–û—Ç–∫—Ä–æ–π –∫–µ–π—Å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–∏–∑</div>)}
                  </div>
                </section>

                {history.length>0 && (
                  <section className="mt-6">
                    <div className="rounded-2xl p-4 border border-black/5 bg-white/60 backdrop-blur">
                      <div className="text-sm font-semibold mb-2">–ò—Å—Ç–æ—Ä–∏—è</div>
                      {history.map((h, i)=>(
                        <div key={i} className="flex items-center justify-between py-2">
                          <div className="flex items-center gap-2">
                            <span className={`px-2 py-1 rounded-full text-xs ${rarityColor(h.prize.rarity)}`}>{h.prize.rarity}</span>
                            <span className="text-base">{(h.prize.emoji ?? 'üéÅ') + ' ' + h.prize.label}</span>
                            <span className="opacity-60 text-sm">–≤ {h.caseTitle}</span>
                          </div>
                          <span className="opacity-60 text-sm">{new Date(h.ts).toLocaleTimeString()}</span>
                        </div>
                      ))}
                    </div>
                  </section>
                )}
              </>
            )}

            {selectedCase && (
              <section className="mt-5">
                <CaseDetailCards
                  data={selectedCase}
                  onBack={()=>setSelectedCase(null)}
                  onOpenServer={onOpenServerPrepare}
                  opening={opening}
                  onSell={onSell}
                  onClaim={onClaim}
                  setLastPrize={setLastPrize}
                  setToast={setToast}
                  addHistory={addHistory}
                />
              </section>
            )}

            <footer className="mt-8 text-center opacity-60 text-xs">–î–µ–º–æ—Ä–µ–∂–∏–º. –°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∏–∑ —á–µ—Ä–µ–∑ /api/open.</footer>
          </div>

          {toast && <Toast text={toast} onClose={()=>setToast(null)} />}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
