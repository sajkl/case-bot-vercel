<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö–µ–π—Å—ã –∑–∞ ‚≠ê ‚Äî Telegram Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Small helper so the page fills the viewport nicely */
    html, body, #root { height: 100%; }
  </style>
  <!-- React / ReactDOM / Babel for in-browser JSX build -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gradient-to-b from-white to-gray-50 text-gray-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    // Telegram handle
    const tg = (typeof window !== 'undefined' ? window.Telegram : undefined);

    // Demo data
    const START_STARS = 25;
    const DEFAULT_CASES = [
      {
        id: 'lite', title: '–õ–∞–π—Ç-–∫–µ–π—Å', priceStars: 3, bannerEmoji: 'üéà',
        description: '–î–µ—à—ë–≤—ã–π –≤—Ö–æ–¥, –±—ã—Å—Ç—Ä—ã–µ –ø—Ä–∏–∑—ã',
        prizes: [
          { id: 'l1', label: '–°—Ç–∏–∫–µ—Ä –º–∏–Ω–∏', emoji: 'üêæ', rarity: 'common', weight: 55 },
          { id: 'l2', label: '1‚≠ê –Ω–∞–∑–∞–¥', emoji: '‚≠ê', rarity: 'common', weight: 30, starsValue: 1 },
          { id: 'l3', label: '–ú–∞–ª—ã–π –±—É—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è', emoji: 'üîπ', rarity: 'rare', weight: 12 },
          { id: 'l4', label: '5‚≠ê –¥–∂–µ–∫–ø–æ—Ç', emoji: 'üí•', rarity: 'epic', weight: 3, starsValue: 5 },
        ],
      },
      {
        id: 'starter', title: '–°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–µ–π—Å', priceStars: 6, bannerEmoji: 'üéÅ',
        description: '–û—Ç–∫—Ä—ã–≤–∞–π –∏ –ª–æ–≤–∏ —É–¥–∞—á—É!',
        prizes: [
          { id: 's1', label: '–°—Ç–∏–∫–µ—Ä-–ø–∞–∫', emoji: 'üò∫', rarity: 'common', weight: 45 },
          { id: 's2', label: '2‚≠ê –Ω–∞–∑–∞–¥', emoji: '‚≠ê', rarity: 'common', weight: 28, starsValue: 2 },
          { id: 's3', label: '–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –±–µ–π–¥–∂', emoji: 'üèÖ', rarity: 'rare', weight: 17 },
          { id: 's4', label: '–ê–≤–∞—Ç–∞—Ä-—Ä–∞–º–∫–∞', emoji: 'üñºÔ∏è', rarity: 'epic', weight: 8 },
          { id: 's5', label: '–ú–µ–≥–∞–ø—Ä–∏–∑: 20‚≠ê', emoji: 'üí´', rarity: 'legendary', weight: 2, starsValue: 20 },
        ],
      },
      {
        id: 'pro', title: '–ü—Ä–æ-–∫–µ–π—Å', priceStars: 12, bannerEmoji: '‚ö°',
        description: '–ë–æ–ª—å—à–µ —Ä–∏—Å–∫ ‚Äî –∫—Ä—É—á–µ –ø—Ä–∏–∑—ã',
        prizes: [
          { id: 'p1', label: '3‚≠ê –Ω–∞–∑–∞–¥', emoji: '‚≠ê', rarity: 'common', weight: 32, starsValue: 3 },
          { id: 'p2', label: '–°–∫–∏–Ω –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è', emoji: 'üé®', rarity: 'rare', weight: 28 },
          { id: 'p3', label: '–ê–Ω–∏–º–∞—Ü–∏—è –∏–º–µ–Ω–∏', emoji: '‚ú®', rarity: 'rare', weight: 20 },
          { id: 'p4', label: '10‚≠ê –Ω–∞–∑–∞–¥', emoji: 'üåü', rarity: 'epic', weight: 15, starsValue: 10 },
          { id: 'p5', label: '–°—É–ø–µ—Ä–ø—Ä–∏–∑: 60‚≠ê', emoji: 'üöÄ', rarity: 'legendary', weight: 5, starsValue: 60 },
        ],
      },
      {
        id: 'ultra', title: '–£–ª—å—Ç—Ä–∞-–∫–µ–π—Å', priceStars: 30, bannerEmoji: 'üëë',
        description: '–í—ã—Å–æ–∫–∞—è —Å—Ç–∞–≤–∫–∞ ‚Äî –∫–æ—Ä–æ–ª–µ–≤—Å–∫–∏–µ –Ω–∞–≥—Ä–∞–¥—ã',
        prizes: [
          { id: 'u1', label: '7‚≠ê –Ω–∞–∑–∞–¥', emoji: '‚≠ê', rarity: 'rare', weight: 30, starsValue: 7 },
          { id: 'u2', label: '–†–µ–¥–∫–∏–π —Å–∫–∏–Ω + —ç—Ñ—Ñ–µ–∫—Ç', emoji: 'üßø', rarity: 'epic', weight: 28 },
          { id: 'u3', label: '15‚≠ê –Ω–∞–∑–∞–¥', emoji: 'üåü', rarity: 'epic', weight: 20, starsValue: 15 },
          { id: 'u4', label: '–õ–µ–≥–µ–Ω–¥–∞: 120‚≠ê', emoji: 'üèÜ', rarity: 'legendary', weight: 6, starsValue: 120 },
          { id: 'u5', label: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π —Å–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤', emoji: 'üéñÔ∏è', rarity: 'legendary', weight: 4 },
          { id: 'u6', label: '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π: 300‚≠ê', emoji: 'ü¶Ñ', rarity: 'legendary', weight: 2, starsValue: 300 },
        ],
      },
    ];

    function pickPrize(prizes) {
      const total = prizes.reduce((s, p) => s + Math.max(0, p.weight), 0);
      const safe = Math.max(0, total);
      if (!isFinite(safe) || safe <= 0) return prizes[0];
      let r = Math.random() * safe;
      for (const p of prizes) {
        r -= Math.max(0, p.weight);
        if (r <= 0) return p;
      }
      return prizes[prizes.length - 1];
    }

    function rarityColor(r) {
      switch (r) {
        case 'common': return 'bg-gray-200 text-gray-800';
        case 'rare': return 'bg-blue-200 text-blue-900';
        case 'epic': return 'bg-purple-200 text-purple-900';
        case 'legendary': return 'bg-amber-200 text-amber-900';
        default: return 'bg-gray-200 text-gray-800';
      }
    }

    function rarityTileClasses(r, highlight) {
      const base = 'rounded-xl border shadow-sm flex flex-col items-center justify-center text-center';
      const size = 'w-[120px] h-24 shrink-0';
      const hl = highlight ? ' ring-2 ring-amber-400' : '';
      switch (r) {
        case 'common': return base + ' ' + size + ' bg-gradient-to-b from-gray-50 to-gray-200 border-gray-300 text-gray-900' + hl;
        case 'rare': return base + ' ' + size + ' bg-gradient-to-b from-blue-50 to-blue-200 border-blue-300 text-blue-950' + hl;
        case 'epic': return base + ' ' + size + ' bg-gradient-to-b from-purple-50 to-purple-200 border-purple-300 text-purple-950' + hl;
        case 'legendary': return base + ' ' + size + ' bg-gradient-to-b from-amber-50 to-amber-200 border-amber-300 text-amber-950' + hl;
        default: return base + ' ' + size + ' bg-white border-black/10 text-gray-900' + hl;
      }
    }

    class SpinAudio {
      constructor() { this.ctx = null; this.gain = null; }
      ensure() {
        if (typeof window === 'undefined') return;
        if (!this.ctx) {
          const Ctor = window.AudioContext || window.webkitAudioContext;
          if (!Ctor) return;
          this.ctx = new Ctor();
          this.gain = this.ctx.createGain();
          this.gain.gain.value = 0.05;
          this.gain.connect(this.ctx.destination);
        }
      }
      tick(volume = 1) {
        this.ensure();
        if (!this.ctx || !this.gain) return;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = 'square';
        o.frequency.value = 900;
        o.connect(g).connect(this.gain);
        const t = this.ctx.currentTime;
        g.gain.setValueAtTime(0.015 * volume, t);
        g.gain.exponentialRampToValueAtTime(0.00001, t + 0.05);
        o.start(t);
        o.stop(t + 0.055);
      }
      thud() {
        this.ensure();
        if (!this.ctx || !this.gain) return;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 160;
        o.connect(g).connect(this.gain);
        const t = this.ctx.currentTime;
        g.gain.setValueAtTime(0.06, t);
        g.gain.exponentialRampToValueAtTime(0.00001, t + 0.18);
        o.start(t);
        o.stop(t + 0.18);
      }
    }
    const audio = new SpinAudio();

    const Confetti = ({ show }) => (
      <div className={`pointer-events-none fixed inset-0 overflow-hidden ${show ? 'block' : 'hidden'}`}>
        <div className="absolute inset-0 animate-confetti" />
        <style>{`
          @keyframes confettiFall {
            0% { transform: translateY(-100vh); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(100vh); opacity: 0; }
          }
          .animate-confetti::before {
            content: '';
            position: absolute; inset: 0;
            background-image: repeating-linear-gradient(90deg,
              rgba(255,0,0,.7) 0 8px,
              rgba(255,165,0,.7) 8px 16px,
              rgba(255,255,0,.7) 16px 24px,
              rgba(0,128,0,.7) 24px 32px,
              rgba(0,0,255,.7) 32px 40px,
              rgba(75,0,130,.7) 40px 48px,
              rgba(238,130,238,.7) 48px 56px
            );
            -webkit-mask-image: radial-gradient(8px 8px at 8px 8px, #000 98%, transparent 100%);
            mask-image: radial-gradient(8px 8px at 8px 8px, #000 98%, transparent 100%);
            background-size: 56px 8px;
            animation: confettiFall 1.4s ease-in forwards;
          }
        `}</style>
      </div>
    );

    const CaseCard = ({ data, onOpen, onDetails, disabled }) => (
      <div className="rounded-2xl shadow-md p-4 bg-white/70 backdrop-blur border border-black/5">
        <div className="flex items-center gap-3">
          <div className="text-3xl">{data.bannerEmoji ?? 'üéÅ'}</div>
          <div>
            <div className="text-lg font-semibold">{data.title}</div>
            {data.description && <div className="text-sm opacity-70">{data.description}</div>}
          </div>
        </div>
        <div className="mt-4 flex justify-between items-center">
          <div className="text-sm opacity-80">–¶–µ–Ω–∞: {data.priceStars} ‚≠ê</div>
          <div className="flex gap-2">
            <button
              className="px-3 py-2 rounded-xl text-sm font-semibold shadow-sm bg-white/70 border border-black/10"
              onClick={() => onDetails(data)}
            >
              –ü–æ–¥—Ä–æ–±–Ω–µ–µ
            </button>
            <button
              className={`px-4 py-2 rounded-2xl text-sm font-semibold shadow-sm transition transform active:scale-95 ${disabled ? 'bg-gray-300 cursor-not-allowed' : 'bg-black text-white'}`}
              onClick={() => onDetails(data)}
              disabled={disabled}
            >
              –û—Ç–∫—Ä—ã—Ç—å
            </button>
          </div>
        </div>
        <div className="mt-3 flex flex-wrap gap-2">
          {data.prizes.map((p) => (
            <span key={p.id} className={`px-2 py-1 rounded-full text-xs ${rarityColor(p.rarity)}`}>
              {(p.emoji ? p.emoji + ' ' : '') + p.label}
            </span>
          ))}
        </div>
      </div>
    );

    const HistoryItem = ({ prize, caseTitle, ts }) => {
      const date = new Date(ts);
      return (
        <div className="flex items-center justify-between py-2">
          <div className="flex items-center gap-2">
            <span className={`px-2 py-1 rounded-full text-xs ${rarityColor(prize.rarity)}`}>{prize.rarity}</span>
            <span className="text-base">{(prize.emoji ?? 'üéÅ') + ' ' + prize.label}</span>
            <span className="opacity-60 text-sm">–≤ {caseTitle}</span>
          </div>
          <span className="opacity-60 text-sm">{date.toLocaleTimeString()}</span>
        </div>
      );
    };

    const Spinner = ({ spinning }) => (
      <div className="relative h-24 my-4 flex items-center justify-center">
        <div className={\`w-20 h-20 rounded-full border-4 border-black/10 border-t-black/60 \${spinning ? 'animate-spin' : ''}\`} />
      </div>
    );

    const Toast = ({ text, onClose }) => {
      useEffect(() => { const t = setTimeout(onClose, 2000); return () => clearTimeout(t); }, [onClose]);
      return (
        <div className="fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-xl bg-black text-white shadow-lg">
          {text}
        </div>
      );
    };

    // Roulette constants
    const ITEM_WIDTH_PX = 120;
    const ITEM_GAP_PX = 8;
    const TILE_STEP = ITEM_WIDTH_PX + ITEM_GAP_PX;
    const HALF_STEP = TILE_STEP / 2;
    const SELL_BY_RARITY = { common: 1, rare: 2, epic: 6, legendary: 20 };
    const PERF_SAFE = false;

    const PrizeTile = ({ prize, highlight }) => (
      <div className={rarityTileClasses(prize.rarity, Boolean(highlight))}>
        <div className="text-2xl leading-none">{prize.emoji ?? 'üéÅ'}</div>
        <div className="text-xs mt-1 px-2 truncate">{prize.label}</div>
        <div className={\`mt-1 px-1.5 py-0.5 rounded-full text-[10px] bg-white/70 backdrop-blur-sm \${rarityColor(prize.rarity)}\`}>{prize.rarity}</div>
      </div>
    );

    const CaseDetail = ({ data, onBack, onOpen, opening, lastPrize, onSell, onClaim }) => {
      const trackRef = useRef(null);
      const viewportRef = useRef(null);

      const [sequence, setSequence] = useState([]);
      const [offset, setOffset] = useState(0);
      const [spinning, setSpinning] = useState(false);
      const [landed, setLanded] = useState(null);

      const rafId = useRef(null);
      const pos = useRef(0);
      const velocity = useRef(0);
      const decel = useRef(0);
      const targetPx = useRef(0);
      const lastTs = useRef(null);
      const prevHalfStep = useRef(0);
      const centerRef = useRef(0);
      const roRef = useRef(null);

      const cycles = 16;

      const stopAnimation = () => { if (rafId.current) cancelAnimationFrame(rafId.current); rafId.current = null; };

      useEffect(() => {
        if (!viewportRef.current) return;
        const ro = new ResizeObserver(() => {
          const vw = viewportRef.current?.clientWidth ?? 0;
          centerRef.current = Math.max(0, vw / 2);
        });
        ro.observe(viewportRef.current);
        roRef.current = ro;
        const vw = viewportRef.current.clientWidth;
        centerRef.current = Math.max(0, vw / 2);
        return () => ro.disconnect();
      }, []);

      useEffect(() => () => stopAnimation(), []);

      const startSpin = async () => {
        if (opening || spinning) return;

        let vw = viewportRef.current?.clientWidth ?? 0;
        if (vw === 0) {
          await new Promise((r) => requestAnimationFrame(() => r(null)));
          vw = viewportRef.current?.clientWidth ?? 0;
        }

        setSpinning(true);
        setLanded(null);

        const baseSeq = Array.from({ length: cycles }, () => data.prizes).flat();
        setSequence(baseSeq);

        pos.current = offset;

        await onOpen(data, (picked) => {
          const finalSeq = [...baseSeq, picked, ...data.prizes.slice(0, 3)];
          setSequence(finalSeq);

          const pickedIndex = finalSeq.findIndex((p) => p.id === picked.id);
          const pickedStart = pickedIndex * TILE_STEP;
          const center = centerRef.current;
          targetPx.current = pickedStart - center + ITEM_WIDTH_PX / 2;

          const distance = Math.max(targetPx.current - pos.current, TILE_STEP * 6);
          decel.current = 2800;
          velocity.current = Math.sqrt(2 * decel.current * distance);
          lastTs.current = null;
          prevHalfStep.current = Math.floor(pos.current / HALF_STEP);

          const tick = (ts) => {
            if (!lastTs.current) lastTs.current = ts;
            const dt = (ts - lastTs.current) / 1000;
            lastTs.current = ts;

            const v = velocity.current;
            const a = decel.current;
            const dx = Math.max(0, v * dt - 0.5 * a * dt * dt);
            const newPos = pos.current + dx;
            pos.current = newPos;
            setOffset(newPos);

            const halfIndex = Math.floor(newPos / HALF_STEP);
            if (halfIndex !== prevHalfStep.current) {
              prevHalfStep.current = halfIndex;
              const isFull = halfIndex % 2 === 0;
              audio.tick(isFull ? 1 : 0.6);
              tg?.WebApp?.HapticFeedback?.selectionChanged?.();
            }

            velocity.current = Math.max(0, v - a * dt);

            if (trackRef.current) {
              if (!PERF_SAFE) {
                const blur = Math.min(3.2, velocity.current / 1200);
                trackRef.current.style.filter = blur > 0.12 ? \`blur(\${blur}px)\` : 'none';
              } else {
                trackRef.current.style.filter = 'none';
              }
              trackRef.current.style.transform = \`translate3d(calc(50% - \${newPos}px),0,0)\`;
            }

            if (newPos >= targetPx.current - 0.5 || velocity.current <= 5) {
              stopAnimation();
              pos.current = targetPx.current;
              setOffset(targetPx.current);
              if (trackRef.current) {
                trackRef.current.style.filter = 'none';
                trackRef.current.style.transform = \`translate3d(calc(50% - \${targetPx.current}px),0,0)\`;
              }
              setSpinning(false);
              setTimeout(() => {
                setLanded(picked);
                audio.thud();
                tg?.WebApp?.HapticFeedback?.impactOccurred?.('heavy');
              }, 100);
              return;
            }

            rafId.current = requestAnimationFrame(tick);
          };

          stopAnimation();
          rafId.current = requestAnimationFrame(tick);
        });
      };

      const SELL_MAP = SELL_BY_RARITY;
      const sellValue = (p) => SELL_MAP[p.rarity] ?? 1;

      return (
        <div>
          <div className="flex items-center gap-2 mb-4">
            <button onClick={onBack} className="px-3 py-2 rounded-xl bg-white/70 border border-black/10">‚Üê –ù–∞–∑–∞–¥</button>
            <div className="text-xl font-semibold flex items-center gap-2">
              <span className="text-2xl">{data.bannerEmoji ?? 'üéÅ'}</span> {data.title}
            </div>
            <div className="ml-auto text-sm opacity-70">–¶–µ–Ω–∞: {data.priceStars} ‚≠ê</div>
          </div>

          <div className="mt-1">
            <div className="text-sm opacity-70 mb-2">–ê–Ω–∏–º–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è</div>
            <div ref={viewportRef} className="relative overflow-hidden rounded-2xl border border-black/5 bg-white/60 backdrop-blur">
              <div className="pointer-events-none absolute left-1/2 top-0 -translate-x-1/2 h-full w-[0px]">
                <div className="absolute top-0 left-1/2 -translate-x-1/2 w-0 h-0 border-l-[10px] border-r-[10px] border-b-[10px] border-l-transparent border-r-transparent border-b-black/20" />
                <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-[2px] h-full bg-black/15" />
              </div>
              <div className="pointer-events-none absolute inset-0" style={{
                background: 'linear-gradient(90deg, rgba(0,0,0,0.20), transparent 10%, transparent 90%, rgba(0,0,0,0.20))',
                mixBlendMode: 'multiply'
              }} />
              <div
                ref={trackRef}
                className="flex gap-2 p-3 will-change-transform [backface-visibility:hidden]"
                style={{ transform: \`translate3d(calc(50% - \${offset}px), 0, 0)\` }}
              >
                {sequence.length === 0
                  ? data.prizes.concat(data.prizes).map((p, i) => <PrizeTile key={p.id + ':' + i} prize={p} />)
                  : sequence.map((p, i) => <PrizeTile key={p.id + ':' + i} prize={p} highlight={landed?.id === p.id} />)}
              </div>
            </div>
          </div>

          <div className="sticky bottom-3 mt-4 z-10">
            <button
              className={\`w-full px-4 py-3 rounded-2xl text-sm font-semibold shadow-sm transition transform active:scale-95 \${spinning || opening ? 'bg-gray-300 cursor-not-allowed' : 'bg-black text-white'}\`}
              onClick={startSpin}
              disabled={spinning || opening}
            >
              –û—Ç–∫—Ä—ã—Ç—å –∑–∞ {data.priceStars} ‚≠ê
            </button>
          </div>

          {landed && (
            <div className="mt-3 p-3 rounded-2xl border border-black/5 bg-white/80 flex items-center justify-between gap-3">
              <div className="flex items-center gap-2">
                <span className="text-2xl">{landed.emoji ?? 'üéâ'}</span>
                <div className="text-sm">
                  <div className="font-semibold">–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏: {landed.label}</div>
                  <div className={\`mt-1 inline-block px-2 py-0.5 rounded-full text-[10px] \${rarityColor(landed.rarity)}\`}>{landed.rarity}</div>
                </div>
              </div>
              <div className="flex gap-2">
                <button className="px-3 py-2 rounded-xl text-sm font-semibold shadow-sm bg-white/70 border border-black/10" onClick={() => onSell?.(landed)}>
                  –ü—Ä–æ–¥–∞—Ç—å –∑–∞ {sellValue(landed)} ‚≠ê
                </button>
                <button className="px-4 py-2 rounded-2xl text-sm font-semibold shadow-sm bg-black text-white" onClick={() => onClaim?.(landed)}>
                  –ó–∞–±—Ä–∞—Ç—å
                </button>
              </div>
            </div>
          )}

          <div className="mt-5 rounded-2xl p-4 border border-black/5 bg-white/60 backdrop-blur">
            <div className="text-sm opacity-70 mb-3">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–∏–∑—ã</div>
            <div className="grid grid-cols-2 gap-2 sm:grid-cols-3">
              {data.prizes.map((p) => (
                <div key={p.id} className="flex items-center gap-2 p-2 rounded-xl border border-black/5 bg-white/80">
                  <div className="text-xl">{p.emoji ?? 'üéÅ'}</div>
                  <div className="text-sm">
                    <div className="font-medium">{p.label}</div>
                    <div className={\`mt-1 inline-block px-2 py-0.5 rounded-full text-[10px] \${rarityColor(p.rarity)}\`}>{p.rarity}</div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    function App() {
      const [cases] = useState(DEFAULT_CASES);
      const [stars, setStars] = useState(START_STARS);
      const [opening, setOpening] = useState(false);
      const [selectedCase, setSelectedCase] = useState(null);
      const [lastPrize, setLastPrize] = useState(null);
      const [confetti, setConfetti] = useState(false);
      const [toast, setToast] = useState(null);
      const [view, setView] = useState({ name: 'home' });
      const openLock = useRef(false);

      useEffect(() => {
        try {
          tg?.WebApp?.ready?.();
          tg?.WebApp?.expand?.();
          const theme = tg?.WebApp?.themeParams || {};
          const bg = theme.bg_color || (tg?.WebApp?.colorScheme === 'dark' ? '#0f0f0f' : '#ffffff');
          const header = theme.header_color || (tg?.WebApp?.colorScheme === 'dark' ? '#0f0f0f' : '#ffffff');
          if (tg?.WebApp) {
            tg.WebApp.backgroundColor = bg;
            tg.WebApp.headerColor = header;
          }
        } catch (e) {}
      }, []);

      const openDetails = (c) => { setSelectedCase(c); setView({ name: 'detail', caseId: c.id }); };

      
      const onOpen = async (c, pickedCb) => {
        if (openLock.current) return;
        openLock.current = true;
        try {
          if (stars < c.priceStars) {
            setToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚≠ê');
            tg?.WebApp?.HapticFeedback?.notificationOccurred?.('warning');
            openLock.current = false;
            return;
          }
          setOpening(true);
          setLastPrize(null);
          setStars((s) => s - c.priceStars);
          tg?.WebApp?.HapticFeedback?.impactOccurred?.('medium');

          // --- Server call (primary) ---
          let prize = null;
          try {
            const res = await fetch('/api/open', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ caseId: c.id })
            });
            if (res.ok) {
              const data = await res.json();
              if (data && data.prize) {
                prize = data.prize;
              }
            }
          } catch (e) {
            console.warn('API /api/open failed, fallback to client pick', e);
          }

          // Fallback to client RNG if server didn't return prize
          if (!prize) {
            await new Promise((r) => setTimeout(r, 250));
            prize = pickPrize(c.prizes);
          }

          // notify roller
          pickedCb(prize);

          setLastPrize(prize);
          setConfetti(true);
          setTimeout(() => setConfetti(false), 1600);
        } catch (e) {
          console.error(e);
          setToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–µ–π—Å–∞');
          tg?.WebApp?.HapticFeedback?.notificationOccurred?.('error');
        } finally {
          setTimeout(() => {
            setOpening(false);
            openLock.current = false;
          }, 2000);
        }
      };


      const onSell = (p) => {
        const value = SELL_BY_RARITY[p.rarity] ?? 1;
        setStars((s) => s + value);
        setToast(\`–ü—Ä–æ–¥–∞–Ω–æ: +\${value} ‚≠ê\`);
      };

      const onClaim = (p) => {
        if (p.starsValue) setStars((s) => s + p.starsValue);
        setToast('–ü—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å (–¥–µ–º–æ)');
      };

      return (
        <div className="min-h-dvh px-4 py-5">
          <div className="mx-auto max-w-md">
            <header className="flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold tracking-tight">–ö–µ–π—Å—ã –∑–∞ ‚≠ê</h1>
                <p className="opacity-70 text-sm">–û—Ç–∫—Ä—ã–≤–∞–π –∫–µ–π—Å—ã –∏ –∑–∞–±–∏—Ä–∞–π –ø—Ä–∏–∑—ã</p>
              </div>
              <div className="px-3 py-2 rounded-xl bg-yellow-200 text-yellow-900 font-semibold shadow">
                {stars} ‚≠ê
              </div>
            </header>

            {view.name === 'home' && (
              <>
                <section className="mt-5 grid gap-3">
                  {cases.map((c) => (
                    <CaseCard key={c.id} data={c} onOpen={() => openDetails(c)} onDetails={openDetails} disabled={opening} />
                  ))}
                </section>

                <section className="mt-6">
                  <div className="rounded-2xl p-4 border border-black/5 bg-white/60 backdrop-blur">
                    <div className="text-sm opacity-70">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
                    <Spinner spinning={opening} />
                    {!opening && lastPrize && (
                      <div className="text-center">
                        <div className="text-4xl mb-2">{lastPrize.emoji ?? 'üéâ'}</div>
                        <div className="text-lg font-semibold">{lastPrize.label}</div>
                        <div className={\`mt-2 inline-block px-2 py-1 rounded-full text-xs \${rarityColor(lastPrize.rarity)}\`}>{lastPrize.rarity}</div>
                        {lastPrize.starsValue ? (<div className="mt-2 text-sm opacity-70">–í–æ–∑–≤—Ä–∞—Ç: +{lastPrize.starsValue} ‚≠ê</div>) : null}
                      </div>
                    )}
                    {!opening && !lastPrize && (
                      <div className="text-center opacity-60 text-sm">–û—Ç–∫—Ä–æ–π –∫–µ–π—Å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–∏–∑</div>
                    )}
                  </div>
                </section>
              </>
            )}

            {view.name === 'detail' && selectedCase && (
              <section className="mt-5">
                <CaseDetail
                  data={selectedCase}
                  onBack={() => setView({ name: 'home' })}
                  onOpen={onOpen}
                  opening={opening}
                  lastPrize={lastPrize}
                  onSell={onSell}
                  onClaim={onClaim}
                />
              </section>
            )}

            {lastPrize && (
              <section className="mt-6">
                <div className="rounded-2xl p-4 border border-black/5 bg-white/60 backdrop-blur">
                  <div className="text-sm font-semibold mb-2">–ò—Å—Ç–æ—Ä–∏—è</div>
                  <HistoryItem prize={lastPrize} caseTitle={selectedCase?.title ?? '–ö–µ–π—Å'} ts={Date.now()} />
                </div>
              </section>
            )}

            <footer className="mt-8 text-center opacity-60 text-xs">
              –î–µ–º–æ—Ä–µ–∂–∏–º. –í —Ä–µ–∞–ª–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à –∏ Telegram Stars Payments.
            </footer>
          </div>

          <Confetti show={Boolean(lastPrize)} />
          {toast && <Toast text={toast} onClose={() => setToast(null)} />}
        </div>
      );
    }

    // Mount
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
