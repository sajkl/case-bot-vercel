<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Lambo Drop ‚Äî Gift Wins</title>
  <link rel="preload" href="/assets/logo.png" as="image" type="image/png">
  <link rel="stylesheet" href="/styles.css?v=13">
  
  <style>
    /* === LIVE –õ–ï–ù–¢–ê === */
    .live-bar {
      height: 64px;
      background: #111319;
      border-top: 1px solid #1f232e;
      border-bottom: 1px solid #1f232e;
      display: flex; align-items: center;
      overflow: hidden; position: relative;
      margin-bottom: 10px;
    }

    /* –ñ–µ–ª—Ç—ã–π –ª–µ–π–±–ª */
    .live-label {
      background: var(--accent); color: #000;
      font-weight: 900; font-size: 12px;
      padding: 0 10px; height: 100%;
      display: flex; align-items: center; justify-content: center;
      position: absolute; left: 0; top: 0; bottom: 0; z-index: 10;
      box-shadow: 4px 0 15px rgba(0,0,0,0.5);
    }
    .live-label span { writing-mode: vertical-rl; transform: rotate(180deg); }

    /* –ë–µ–≥—É—â–∞—è –¥–æ—Ä–æ–∂–∫–∞ */
    .live-track {
      display: flex; gap: 8px; padding-left: 40px;
      will-change: transform;
    }
    .live-track.animate { animation: scrollLive 25s linear infinite; }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ –≤ –ª–µ–Ω—Ç–µ */
    .live-item {
      width: 50px; height: 50px; background: #1a1d26;
      border-radius: 8px; border: 1px solid #2a2f3d;
      flex-shrink: 0; display: flex; align-items: center; justify-content: center;
      position: relative; overflow: hidden;
    }
    .live-item::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: #777; }
    .live-item.rare::after { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
    .live-item img { width: 80%; height: 80%; object-fit: contain; }

    @keyframes scrollLive {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
  </style>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <header class="header">
      <img class="logo" src="/assets/logo.png" alt="LAMBO DROP" style="height:38px;">
      <a class="balance" id="balance" href="/topup/">
        <span class="star">‚òÖ</span><span class="value" id="balanceValue">...</span>
      </a>
    </header>

    <section class="live-bar">
      <div class="live-label"><span>LIVE</span></div>
      <div class="live-track" id="liveTrack">
         <div style="padding:22px; color:#555; font-size:10px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </section>

    <main class="grid">
      <a class="card gray"  data-caseid="jiga"  href="/case/?case=jiga"  aria-label="–ñ–∏–≥–∞"  style="--w:150%; --top:-48px; --left:49%;">
        <div class="art"><img src="/assets/case-1.png" alt="–ñ–∏–≥–∞"></div>
        <div class="title">–ñ–∏–≥–∞</div><div class="price"><span class="star">‚òÖ</span> 209</div>
      </a>
      <a class="card green" data-caseid="camry" href="/case/?case=camry" aria-label="–ö–∞–º—Ä–∏" style="--w:152%; --top:-54px; --left:52%;">
        <div class="art"><img src="/assets/case-2.png" alt="–ö–∞–º—Ä–∏"></div>
        <div class="title">–ö–∞–º—Ä–∏</div><div class="price"><span class="star">‚òÖ</span> 629</div>
      </a>
      <a class="card red"   data-caseid="bmw"   href="/case/?case=bmw"   aria-label="–ë—ç—Ö–∞"  style="--w:158%; --top:-52px; --left:51%;">
        <div class="art"><img src="/assets/case-3.png" alt="–ë—ç—Ö–∞"></div>
        <div class="title">–ë—ç—Ö–∞</div><div class="price"><span class="star">‚òÖ</span> 1499</div>
      </a>
      <a class="card yellow"data-caseid="lambo" href="/case/?case=lambo" aria-label="–õ–∞–º–±–æ" style="--w:160%; --top:-64px; --left:53%;">
        <div class="art"><img src="/assets/case-4.png" alt="–õ–∞–º–±–æ"></div>
        <div class="title">–õ–∞–º–±–æ</div><div class="price"><span class="star">‚òÖ</span> 3899</div>
      </a>
    </main>

    <div class="nav-spacer" aria-hidden="true"></div>

    <nav class="nav">
      <a class="btn active" href="/">–ö–µ–π—Å—ã</a>
      <a class="btn" href="/crash.html">Crash üöÄ</a>
      <a class="btn" href="/profile/">–ü—Ä–æ—Ñ–∏–ª—å</a>
    </nav>
  </div>

  <script>
  (async () => {
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    // 1. –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø (—á–µ—Ä–µ–∑ api/user)
    const auth = await fetch('/api/user?action=auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ initData: tg.initData })
    }).then(r => r.json());

    if (!auth.ok) console.warn('Auth failed:', auth);

    // 2. –ü—Ä–æ—Ñ–∏–ª—å
    await fetch('/api/me', { credentials:'include' }).catch(()=>{});
    
    // 3. –ë–∞–ª–∞–Ω—Å
    const balEl = document.getElementById('balanceValue');
    fetch('/api/profile', {headers:{'X-Telegram-Data':tg.initData}})
      .then(r => r.ok ? r.json() : null)
      .then(d => { if (d && typeof d.stars !== 'undefined') balEl.textContent = d.stars; })
      .catch(()=>{});

    // 4. –ö–ª–∏–∫ –ø–æ –∫–µ–π—Å—É
    document.addEventListener('click', (e) => {
      const a = e.target.closest('a.card'); if (!a) return;
      const caseId = a.dataset.caseid || '';
      if (caseId) {
        try { sessionStorage.setItem('currentCaseId', caseId); localStorage.setItem('lastCaseId', caseId); } catch(_){}
        const url = new URL(a.href, location.origin);
        url.searchParams.set('case', caseId); a.href = url.pathname + '?' + url.searchParams.toString();
      }
    });

    // 5. LIVE –õ–ï–ù–¢–ê (—á–µ—Ä–µ–∑ api/live)
    async function loadLiveFeed() {
      const track = document.getElementById('liveTrack');
      try {
        // –ó–∞–ø—Ä–æ—Å –∫ —Å—Ç–∞—Ä–æ–º—É –¥–æ–±—Ä–æ–º—É api/live
        const drops = await fetch('/api/live').then(r => r.json());
        
        if(!drops || drops.length === 0) {
           track.innerHTML = '<div style="padding:22px; color:#555; font-size:10px;">–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞</div>';
           return;
        }

        // –†–µ–Ω–¥–µ—Ä
        const itemsHtml = drops.map(d => `
          <div class="live-item ${d.is_rare ? 'rare' : ''}">
             <img src="${d.image_url}" onerror="this.src='/assets/logo.png'">
          </div>
        `).join('');

        // –î—É–±–ª–∏—Ä—É–µ–º –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
        track.innerHTML = itemsHtml + itemsHtml; 
        track.classList.add('animate');

      } catch(e) {
        console.error(e);
        track.innerHTML = '<div style="padding:22px; color:#555; font-size:10px;">Offline</div>';
      }
    }
    
    loadLiveFeed();

  })();
  </script>
</body>
</html>
