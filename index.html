<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Lambo Drop ‚Äî Gift Wins</title>
  <link rel="preload" href="/assets/logo.png" as="image" type="image/png">
  <link rel="stylesheet" href="/styles.css">
  
  <style>
    /* === –°–¢–ò–õ–ò LIVE –õ–ï–ù–¢–´ (–û–ë–ù–û–í–õ–ï–ù–ù–´–ï) === */
    .live-bar {
      height: 64px;
      background: #111319;
      border-top: 1px solid #1f232e;
      border-bottom: 1px solid #1f232e;
      display: flex; align-items: center;
      overflow: hidden; position: relative;
      margin-bottom: 10px;
    }

    /* –õ–µ–π–±–ª LIVE */
    .live-label {
      background: var(--accent); color: #000;
      font-weight: 900; font-size: 12px;
      padding: 0 10px; height: 100%;
      display: flex; align-items: center; justify-content: center;
      position: absolute; left: 0; top: 0; bottom: 0; z-index: 10;
      box-shadow: 4px 0 15px rgba(0,0,0,0.5);
    }
    .live-label span { writing-mode: vertical-rl; transform: rotate(180deg); }

    /* –î–æ—Ä–æ–∂–∫–∞ —Å –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏ */
    .live-track {
      display: flex; gap: 8px; padding-left: 40px;
      will-change: transform;
    }
    .live-track.animate { animation: scrollLive 25s linear infinite; }

    /* === –ö–ê–†–¢–û–ß–ö–ê –ü–†–ï–î–ú–ï–¢–ê –í –õ–ï–ù–¢–ï === */
    .live-item {
      width: 50px; height: 50px; 
      background: #1a1d26;
      border-radius: 10px; 
      border: 1px solid #2f3542; /* –û–±—ã—á–Ω–∞—è —Ä–∞–º–∫–∞ */
      flex-shrink: 0; display: flex; align-items: center; justify-content: center;
      position: relative; overflow: hidden;
      transition: transform 0.2s;
    }

    /* –ü–û–î–°–í–ï–¢–ö–ê –†–ï–î–ö–ò–• (RARE) */
    .live-item.rare {
      border: 1px solid #ffd400; /* –ó–æ–ª–æ—Ç–∞—è —Ä–∞–º–∫–∞ */
      box-shadow: 0 0 10px rgba(255, 212, 0, 0.4), inset 0 0 10px rgba(255, 212, 0, 0.1); /* –°–≤–µ—á–µ–Ω–∏–µ */
    }

    /* –≠—Ñ—Ñ–µ–∫—Ç "–ø—Ä–æ–ª–µ—Ç–∞—é—â–µ–≥–æ –±–ª–∏–∫–∞" –¥–ª—è —Ä–µ–¥–∫–∏—Ö */
    .live-item.rare::after {
      content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: shine 3s infinite;
      pointer-events: none;
    }

    .live-item img { width: 80%; height: 80%; object-fit: contain; z-index: 1; }

    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%); }
      20% { transform: translateX(100%) translateY(100%); }
      100% { transform: translateX(100%) translateY(100%); }
    }

    @keyframes scrollLive {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); } 
    }

    /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ –Ω–∞–≤–∏–≥–∞—Ü–∏—é */
    .nav-spacer { height: 90px; }
  </style>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <header class="header">
      <img class="logo" src="/assets/logo.png" alt="LAMBO DROP" style="height:38px;">
 <a class="balance" href="/topup/" style="text-decoration:none">
  ‚òÖ <span id="bal">...</span>
</a>
    </header>

    <section class="live-bar">
      <div class="live-label"><span>LIVE</span></div>
      <div class="live-track" id="liveTrack">
         <div style="padding:22px; color:#555; font-size:10px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </section>

    <main class="grid">
      <a class="card gray"  data-caseid="jiga"  href="/case/?case=jiga"  aria-label="–ñ–∏–≥–∞"  style="--w:150%; --top:-48px; --left:49%;">
        <div class="art"><img src="/assets/case-1.png" alt="–ñ–∏–≥–∞"></div>
        <div class="title">–ñ–∏–≥–∞</div><div class="price"><span class="star">‚òÖ</span> 209</div>
      </a>
      <a class="card green" data-caseid="camry" href="/case/?case=camry" aria-label="–ö–∞–º—Ä–∏" style="--w:152%; --top:-54px; --left:52%;">
        <div class="art"><img src="/assets/case-2.png" alt="–ö–∞–º—Ä–∏"></div>
        <div class="title">–ö–∞–º—Ä–∏</div><div class="price"><span class="star">‚òÖ</span> 629</div>
      </a>
      <a class="card red"   data-caseid="bmw"   href="/case/?case=bmw"   aria-label="–ë—ç—Ö–∞"  style="--w:158%; --top:-52px; --left:51%;">
        <div class="art"><img src="/assets/case-3.png" alt="–ë—ç—Ö–∞"></div>
        <div class="title">–ë—ç—Ö–∞</div><div class="price"><span class="star">‚òÖ</span> 1499</div>
      </a>
      <a class="card yellow"data-caseid="lambo" href="/case/?case=lambo" aria-label="–õ–∞–º–±–æ" style="--w:160%; --top:-64px; --left:53%;">
        <div class="art"><img src="/assets/case-4.png" alt="–õ–∞–º–±–æ"></div>
        <div class="title">–õ–∞–º–±–æ</div><div class="price"><span class="star">‚òÖ</span> 3899</div>
      </a>
    </main>

    <div class="nav-spacer" aria-hidden="true"></div>

    <nav class="nav">
      <a class="btn active" href="/">–ö–µ–π—Å—ã</a>
      <a class="btn" href="/crash.html">Crash üöÄ</a>
      <a class="btn" href="/profile/">–ü—Ä–æ—Ñ–∏–ª—å</a>
    </nav>
  </div>

  <script>
  (async () => {
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    const balEl = document.getElementById('balanceValue');

    try {
        // 1. –ü—ã—Ç–∞–µ–º—Å—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è
        const res = await fetch('/api/user?action=auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ initData: tg.initData })
        }).then(r => r.json());

        // 2. –°–º–æ—Ç—Ä–∏–º, —á—Ç–æ –æ—Ç–≤–µ—Ç–∏–ª —Å–µ—Ä–≤–µ—Ä
        if (res.ok) {
            console.log('Auth success. Stars:', res.stars); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
            
            // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏—Å–ª–∞–ª –ø–æ–ª–µ stars (–¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ 0)
            if (res.stars !== undefined && res.stars !== null) {
                balEl.textContent = res.stars;
            } else {
                // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –∑–∞–±—ã–ª –ø—Ä–∏—Å–ª–∞—Ç—å –∑–≤–µ–∑–¥—ã
                balEl.textContent = '0';
            }

            // (–ó–¥–µ—Å—å —Ç–≤–æ–π –∫–æ–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏ –∏ –∏–º–µ–Ω–∏, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
            // ...
        } else {
            console.error('Auth error:', res);
        }

    } catch (e) {
        console.error('Network error:', e);
        // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ - –ø–æ–ø—Ä–æ–±—É–µ–º —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ (api/profile) –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
        fetch('/api/profile', {headers:{'X-Telegram-Data':tg.initData}})
           .then(r => r.json())
           .then(d => { if(d.stars !== undefined) balEl.textContent = d.stars; })
           .catch(() => balEl.textContent = '?');
    }
  })();
</script>

    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ (–∫–ª–∏–∫–∏ –ø–æ –∫–µ–π—Å–∞–º) ...

    // 3. –°–û–•–†–ê–ù–ï–ù–ò–ï –í–´–ë–†–ê–ù–ù–û–ì–û –ö–ï–ô–°–ê
    document.addEventListener('click', (e) => {
      const a = e.target.closest('a.card'); if (!a) return;
      const caseId = a.dataset.caseid || '';
      if (caseId) {
        try { sessionStorage.setItem('currentCaseId', caseId); localStorage.setItem('lastCaseId', caseId); } catch(_){}
        const url = new URL(a.href, location.origin);
        url.searchParams.set('case', caseId); a.href = url.pathname + '?' + url.searchParams.toString();
      }
    });

    // 4. LIVE –õ–ï–ù–¢–ê (–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π api/live)
    async function loadLiveFeed() {
      const track = document.getElementById('liveTrack');
      try {
        // –ó–∞–ø—Ä–æ—Å –∫ –æ—Ç–¥–µ–ª—å–Ω–æ–º—É —Ñ–∞–π–ª—É api/live.js
        const drops = await fetch('/api/live').then(r => r.json());
        
        if(!drops || drops.length === 0) {
           track.innerHTML = '<div style="padding:22px; color:#555; font-size:10px;">–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞</div>';
           return;
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML (–∫–ª–∞—Å—Å .rare –¥–æ–±–∞–≤–∏—Ç –ø–æ–¥—Å–≤–µ—Ç–∫—É)
        const itemsHtml = drops.map(d => `
          <div class="live-item ${d.is_rare ? 'rare' : ''}">
             <img src="${d.image_url}" onerror="this.src='/assets/logo.png'">
          </div>
        `).join('');

        // –î—É–±–ª–∏—Ä—É–µ–º –¥–ª—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        track.innerHTML = itemsHtml + itemsHtml; 
        track.classList.add('animate');

      } catch(e) {
        console.error(e);
        track.innerHTML = '<div style="padding:22px; color:#555; font-size:10px;">Offline</div>';
      }
    }
    
    loadLiveFeed();

  })();
  </script>
</body>
</html>
