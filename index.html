<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–µ–π—Å—ã –∑–∞ ‚≠ê ‚Äî Mini App</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js" crossorigin="anonymous"></script>
  <style>
    :root{ --bg-dark:#0a0b0c; --bg-card:#0b0f14; --border:#272a2e; --text:#fff; --muted:#8e9492; --orange:#ff7a1a; --blue:#7bb5ff; --purple:#b68aff; --shadow-lg:0 16px 34px rgba(0,0,0,.42); --ease:cubic-bezier(.2,.8,.2,1); }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text); font-family:'Manrope',system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1100px 700px at 15% -10%, #14181e 0%, transparent 60%),
        radial-gradient(900px 600px at 115% 0%, #191a1f 0%, transparent 55%),
        linear-gradient(180deg,#0b0d10 0%, #090a0c 100%);
    }
    a{color:inherit;text-decoration:none}

    .container{max-width:960px;margin:0 auto;padding:20px 16px 96px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(10px) scale(.98);}to{opacity:1;transform:translateY(0) scale(1);}} .fade{animation:fadeInUp .38s var(--ease) both}

    .title{font-size:32px;font-weight:800;letter-spacing:-.01em;margin:0}
    .pill{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg,#ff8a2a,#ff7a1a);color:#111;border-radius:18px;padding:10px 14px;font-weight:800;box-shadow:0 10px 26px rgba(255,122,26,.28)}

    /* feed */
    .feed{display:flex;gap:12px;overflow-x:auto;padding:10px 2px 2px;margin-top:12px} .feed::-webkit-scrollbar{display:none}
    .feed-item{min-width:280px;border:1px solid var(--border);background:linear-gradient(135deg,#14171b,#0d0f12);border-radius:14px;padding:10px 12px;display:flex;align-items:center;justify-content:space-between}
    .feed-text{display:flex;align-items:center;gap:10px;min-width:0} .feed-time{font-size:12px;color:var(--muted)} .emoji{font-size:20px}

    /* home grid */
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px;margin-top:14px} @media (min-width:820px){ .grid{grid-template-columns:repeat(4,minmax(0,1fr))} }
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:16px;box-shadow:var(--shadow-lg);transition:transform .18s var(--ease),filter .18s var(--ease);cursor:pointer}
    .card:hover{transform:translateY(-4px);filter:brightness(1.04)}
    .fan{position:relative;height:74px;display:flex;align-items:flex-end;justify-content:center}
    .mini{width:58px;height:74px;border-radius:12px;background:#111418;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;box-shadow:0 12px 28px rgba(0,0,0,.35)}
    .mini.glow-blue{box-shadow:0 0 0 2px rgba(123,181,255,.55) inset,0 12px 26px rgba(0,0,0,.35)}
    .mini.glow-purple{box-shadow:0 0 0 2px rgba(182,138,255,.55) inset,0 12px 26px rgba(0,0,0,.35)}
    .mini.glow-orange{box-shadow:0 0 0 2px rgba(255,122,26,.7) inset,0 12px 26px rgba(0,0,0,.35)}
    .mini:nth-child(1){transform:translateX(-16px) rotate(-14deg) scale(.98)}
    .mini:nth-child(2){transform:translateX(0) rotate(0) scale(1.06);z-index:2;margin-left:-24px}
    .mini:nth-child(3){transform:translateX(16px) rotate(14deg) scale(.98);margin-left:-24px}

    .card-title{font-size:18px;font-weight:800;text-align:center;margin:12px 0 4px}
    .card-sub{font-size:12px;color:var(--muted);text-align:center;margin:0}
    .meta{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}

    /* detail */
    .detail-head{display:flex;align-items:center;gap:8px;margin:6px 0 12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:none;cursor:pointer}
    .btn-primary{background:linear-gradient(180deg,#ff8a2a,#ff7a1a);color:#111;border-radius:18px;padding:10px 14px;font-weight:800;box-shadow:0 8px 24px rgba(255,122,26,.28)}
    .btn-secondary{background:#101317;color:#e4e4e7;border:1px solid var(--border);border-radius:16px;padding:8px 12px;font-weight:700}

    .hand{position:relative;height:clamp(150px,44vw,176px);display:flex;justify-content:center;align-items:flex-end;pointer-events:none;margin-top:8px}
    .hand-card{position:relative;pointer-events:auto;margin-left:-36px;transition:transform .35s var(--ease),filter .2s,opacity .2s}
    .hand-card:first-child{margin-left:0}
    .flip{width:clamp(96px,28vw,118px);height:clamp(128px,36vw,156px);position:relative;transform-style:preserve-3d;transition:transform 700ms var(--ease);border-radius:16px;box-shadow:var(--shadow-lg)}
    .flip.flipped{transform:rotateY(180deg)}
    .face{position:absolute;inset:0;border-radius:16px;backface-visibility:hidden;display:flex;align-items:center;justify-content:center;border:1px solid var(--border)}
    .front{background:linear-gradient(135deg,#151920,#0f1216);color:#eaeef2}
    .back{background:#0f1114;transform:rotateY(180deg)}
    .rar-chip{margin-top:6px;display:inline-block;padding:2px 6px;border-radius:999px;font-size:10px;background:var(--muted);color:#111}
    .glow-b-blue{box-shadow:0 0 0 2px rgba(123,181,255,.55),0 0 20px rgba(123,181,255,.28)}
    .glow-b-purple{box-shadow:0 0 0 2px rgba(182,138,255,.60),0 0 22px rgba(182,138,255,.30)}
    .glow-b-orange{box-shadow:0 0 0 2px rgba(255,122,26,.70),0 0 24px rgba(255,122,26,.35)}
    .result{margin-top:12px;display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid var(--border);background:var(--bg-card);border-radius:16px;padding:10px 12px}

    /* tabs */
    .tabbar{position:fixed;left:0;right:0;bottom:0;padding:12px 16px;background:rgba(0,0,0,.72);backdrop-filter:blur(8px);border-top:1px solid var(--border);z-index:5}
    .tabs{max-width:960px;margin:0 auto;display:flex;gap:12px}
    .tab{flex:1 1 0;display:flex;flex-direction:column;align-items:center;gap:4px;background:#0f1216;border:1px solid var(--border);border-radius:14px;padding:10px 6px;font-weight:800;transition:filter .15s var(--ease),transform .12s var(--ease),border-color .25s var(--ease)}
    .tab:active{transform:scale(.96)} .tab.active{border-color:rgba(255,122,26,.65);box-shadow:0 0 0 2px rgba(255,122,26,.28) inset} .tab small{font-size:12px;color:#cdd0d4}

    /* inventory */
    .inv-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:12px}
    .inv-item{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:10px;display:flex;gap:10px;align-items:center}
    .inv-emoji{font-size:24px}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;font-size:10px;background:#20262d;color:#b9c1ca;margin-top:4px}
    .row-actions{display:flex;gap:8px;margin-top:8px}
    .statbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .stat{background:#101317;border:1px solid var(--border);padding:6px 8px;border-radius:10px;font-size:12px;color:#cfd5da}

    /* voting */
    .vote-list{display:flex;flex-direction:column;gap:12px;margin-top:12px}
    .vote-card{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .vote-actions{display:flex;gap:8px;margin-top:10px}
    .vote-pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#0f1216;border-radius:999px;padding:6px 10px;font-weight:700}
    .vote-pill.active{border-color:rgba(255,122,26,.6);box-shadow:inset 0 0 0 2px rgba(255,122,26,.25)}
    @media (max-width:390px){ .hand{height:150px} .hand-card{margin-left:-30px} }

    /* error */
    #err{position:fixed;left:8px;right:8px;bottom:88px;background:#241;color:#fff;font:12px/1.4 monospace;padding:10px;border-radius:10px;border:1px solid #6c4;box-shadow:0 10px 20px rgba(0,0,0,.4);display:none;white-space:pre-wrap;z-index:9999}
  </style>
</head>
<body>
  <main class="container" id="app"></main>

  <nav class="tabbar">
    <div class="tabs">
      <a href="#" class="tab active" data-tab="home"><div>üè†</div><small>–ì–ª–∞–≤–Ω–∞—è</small></a>
      <a href="#" class="tab" data-tab="voting"><div>üó≥Ô∏è</div><small>–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</small></a>
      <a href="#" class="tab" data-tab="inventory"><div>üéí</div><small>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</small></a>
      <a href="#" class="tab" data-tab="profile"><div>üë§</div><small>–ü—Ä–æ—Ñ–∏–ª—å</small></a>
    </div>
  </nav>

  <pre id="err"></pre>

  <script>
  (function(){
    'use strict';

    /* error box */
    function showErr(title, detail){
      var box=document.getElementById('err'); if(!box) return;
      box.style.display='block'; box.textContent=title+"\n"+(detail||'');
    }
    window.onerror=function(message, source, lineno, colno, error){
      var detail=['source: '+(source||'-'),'line: '+(lineno||'-')+', col: '+(colno||'-'),'stack: '+(error&&error.stack?error.stack:'-')].join('\n');
      showErr('JS error: '+message, detail);
    };
    window.addEventListener('unhandledrejection', function(e){
      var reason=e&&e.reason; var detail=(reason&&reason.stack)||String(reason);
      showErr('Promise error', detail);
    });

    var tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    try{ tg&&tg.ready&&tg.ready(); tg&&tg.expand&&tg.expand(); }catch(_){}

    function qs(s,r){return (r||document).querySelector(s)}
    function el(t,c,h){var n=document.createElement(t); if(c) n.className=c; if(h!=null) n.innerHTML=h; return n;}

    /* data */
    var START_STARS=25;
    var CASES=[
      {id:'lite',title:'–õ–∞–π—Ç-–∫–µ–π—Å',price:3,sub:'–î–µ—à—ë–≤—ã–π –≤—Ö–æ–¥',prizes:[
        {id:'l1',label:'–°—Ç–∏–∫–µ—Ä –º–∏–Ω–∏',emoji:'üêæ',rarity:'common',weight:55},
        {id:'l2',label:'1‚≠ê –Ω–∞–∑–∞–¥',emoji:'‚≠ê',rarity:'common',weight:30,stars:1},
        {id:'l4',label:'5‚≠ê –¥–∂–µ–∫–ø–æ—Ç',emoji:'üí•',rarity:'epic',weight:3,stars:5}
      ]},
      {id:'starter',title:'–°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–µ–π—Å',price:6,sub:'–î–ª—è –Ω–æ–≤–∏—á–∫–æ–≤',prizes:[
        {id:'s1',label:'–°—Ç–∏–∫–µ—Ä-–ø–∞–∫',emoji:'üò∫',rarity:'common',weight:45},
        {id:'s3',label:'–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –±–µ–π–¥–∂',emoji:'üèÖ',rarity:'rare',weight:17},
        {id:'s5',label:'–ú–µ–≥–∞–ø—Ä–∏–∑: 20‚≠ê',emoji:'üí´',rarity:'legendary',weight:2,stars:20}
      ]},
      {id:'pro',title:'–ü—Ä–æ-–∫–µ–π—Å',price:12,sub:'–ë–æ–ª—å—à–æ–π —Ä–∏—Å–∫',prizes:[
        {id:'p2',label:'–°–∫–∏–Ω',emoji:'üé®',rarity:'rare',weight:28},
        {id:'p4',label:'10‚≠ê –Ω–∞–∑–∞–¥',emoji:'üåü',rarity:'epic',weight:15,stars:10},
        {id:'p5',label:'60‚≠ê –¥–∂–µ–∫–ø–æ—Ç',emoji:'üèÜ',rarity:'legendary',weight:5,stars:60}
      ]},
      {id:'ultra',title:'–£–ª—å—Ç—Ä–∞-–∫–µ–π—Å',price:30,sub:'–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–µ –Ω–∞–≥—Ä–∞–¥—ã',prizes:[
        {id:'u2',label:'–†–µ–¥–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç',emoji:'üßø',rarity:'epic',weight:28},
        {id:'u4',label:'120‚≠ê',emoji:'üèÜ',rarity:'legendary',weight:6,stars:120},
        {id:'u6',label:'300‚≠ê',emoji:'ü¶Ñ',rarity:'legendary',weight:2,stars:300}
      ]}
    ];
    var SELL={common:1,rare:2,epic:6,legendary:20};
    var rarityOrder={legendary:4,epic:3,rare:2,common:1};
    function top3(a){return a.slice().sort(function(x,y){var rx=rarityOrder[x.rarity]||0,ry=rarityOrder[y.rarity]||0;if(ry!==rx)return ry-rx;var sx=x.stars||0,sy=y.stars||0;if(sy!==sx)return sy-sx;return (x.weight||0)-(y.weight||0)}).slice(0,3)}
    function glowMiniClass(r){var m={common:'glow-blue',rare:'glow-purple',epic:'glow-orange',legendary:'glow-orange'};return m[r]||'glow-blue'}
    function ts(){try{return new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}catch(_){var d=new Date();return (''+d.getHours()).padStart(2,'0')+':'+(''+d.getMinutes()).padStart(2,'0')}}

    /* state */
    var stars=START_STARS;
    var selectedCase=null;       // id –∫–µ–π—Å–∞ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è
    var activeTab='home';        // home | voting | inventory | profile
    var feed=[];                 // –ª–∞–π–≤-–ª–µ–Ω—Ç–∞
    var inventory=[];            // [{id,label,emoji,rarity,stars,time}]
    var proposals = loadProposals(); // –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ

    function loadProposals(){
      try{
        var raw=localStorage.getItem('gw_proposals');
        if(raw) return JSON.parse(raw);
      }catch(_){}
      // –¥–µ–º–æ-–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
      return [
        {id:'p1',title:'–î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–∞ –ø—Ä–∏ –ø–æ–±–µ–¥–µ', up:12, down:1, voters:{}},
        {id:'p2',title:'–°–¥–µ–ª–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –∑–∞ ‚≠ê', up:21, down:3, voters:{}},
        {id:'p3',title:'–¢–µ–º–Ω–∞—è/—Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞', up:8, down:2, voters:{}},
      ];
    }
    function saveProposals(){ try{ localStorage.setItem('gw_proposals', JSON.stringify(proposals)); }catch(_){ } }

    (function seed(){
      var users=['@max','@ivan','@lena','@art','@kira','@john','@mike'];
      var all=[];for(var i=0;i<CASES.length;i++) all=all.concat(CASES[i].prizes);
      for(var j=0;j<4;j++){ var p=all[Math.floor(Math.random()*all.length)],u=users[Math.floor(Math.random()*users.length)]; feed.push({user:u,emoji:p.emoji||'üéÅ',label:p.label||'–ü—Ä–∏–∑',time:ts()}); }
      setInterval(function(){ var p=all[Math.floor(Math.random()*all.length)],u=users[Math.floor(Math.random()*users.length)]; feed.push({user:u,emoji:p.emoji||'üéÅ',label:p.label||'–ü—Ä–∏–∑',time:ts()}); render(); }, 6500+Math.random()*1500);
    })();

    /* audio */
    function SpinAudio(){this.ctx=null;this.gain=null}
    SpinAudio.prototype.ensure=function(){if(!this.ctx){var AC=window.AudioContext||window.webkitAudioContext;if(!AC)return;try{this.ctx=new AC();this.gain=this.ctx.createGain();this.gain.gain.value=0.06;this.gain.connect(this.ctx.destination)}catch(_){}}}
    SpinAudio.prototype.flip=function(){this.ensure();if(!this.ctx||!this.gain)return;var o=this.ctx.createOscillator(),g=this.ctx.createGain();o.type='triangle';o.frequency.value=520;o.connect(g).connect(this.gain);var t=this.ctx.currentTime;g.gain.setValueAtTime(0.05,t);g.gain.exponentialRampToValueAtTime(0.00001,t+0.15);o.start(t);o.stop(t+0.16)}
    SpinAudio.prototype.win=function(){this.ensure();if(!this.ctx||!this.gain)return;var o=this.ctx.createOscillator(),g=this.ctx.createGain();o.type='sine';o.frequency.value=880;o.connect(g).connect(this.gain);var t=this.ctx.currentTime;g.gain.setValueAtTime(0.08,t);g.gain.exponentialRampToValueAtTime(0.00001,t+0.4);o.frequency.exponentialRampToValueAtTime(1320,t+0.35);o.start(t);o.stop(t+0.4)}
    var audio=new SpinAudio();

    /* tabs click */
    document.querySelectorAll('.tab').forEach(function(t){
      t.addEventListener('click',function(e){
        e.preventDefault();
        document.querySelectorAll('.tab').forEach(function(x){x.classList.remove('active')});
        t.classList.add('active');
        activeTab = t.getAttribute('data-tab') || 'home';
        selectedCase = null; // –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ —Å —ç–∫—Ä–∞–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è
        window.scrollTo({top:0,behavior:'smooth'});
        render();
      });
    });

    /* render root */
    function render(){
      var root=qs('#app'); root.innerHTML='';
      var title = (selectedCase? '–û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–∞' :
                  activeTab==='inventory' ? '–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å' :
                  activeTab==='voting' ? '–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ' :
                  activeTab==='profile' ? '–ü—Ä–æ—Ñ–∏–ª—å' : '–ö–µ–π—Å—ã –∑–∞ ‚≠ê');

      var header=el('div','row fade','<h1 class="title">'+title+'</h1><div class="pill"><span id="stars">'+stars+'</span><span>‚≠ê</span></div>');
      root.appendChild(header);

      // –ª–∞–π–≤-–ª–µ–Ω—Ç–∞ –Ω–∞ –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–∞—Ö
      root.appendChild(renderFeed());

      if(selectedCase){
        root.appendChild(renderDetail(selectedCase));
      }else if(activeTab==='home'){
        root.appendChild(renderHome());
      }else if(activeTab==='inventory'){
        root.appendChild(renderInventory());
      }else if(activeTab==='voting'){
        root.appendChild(renderVoting());
      }else{
        root.appendChild(renderProfile());
      }

      var foot=el('div','fade'); foot.style.marginTop='16px'; foot.style.textAlign='center'; foot.style.color='var(--muted)'; foot.style.fontSize='12px';
      foot.innerHTML='–î–µ–º–æ—Ä–µ–∂–∏–º. –°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∏–∑ —á–µ—Ä–µ–∑ <b style="color:#fff">/api/open</b>.'; root.appendChild(foot);
    }

    function renderFeed(){
      var wrap=el('section','feed fade'); var last=feed.slice(-20);
      for(var i=0;i<last.length;i++){
        var e=last[i];
        wrap.appendChild(el('div','feed-item',
          '<div class="feed-text"><div class="emoji">'+e.emoji+'</div><div class="txt"><span style="color:var(--muted)">'+e.user+'</span>&nbsp;–ø–æ–ª—É—á–∏–ª&nbsp;<b>'+e.label+'</b></div></div><div class="feed-time">'+e.time+'</div>'
        ));
      }
      setTimeout(function(){wrap.scrollLeft=wrap.scrollWidth},0);
      return wrap;
    }

    function renderHome(){
      var grid=el('section','grid fade');
      for(var i=0;i<CASES.length;i++){
        var c=CASES[i], picks=top3(c.prizes);
        var card=el('article','card',
          '<div class="fan">'+picks.map(function(p){return '<div class="mini '+glowMiniClass(p.rarity)+'"><span>'+(p.emoji||'üéÅ')+'</span></div>'}).join('')+'</div>'+
          '<h3 class="card-title">'+c.title+'</h3><p class="card-sub">'+c.sub+'</p>'+
          '<div class="meta">–¶–µ–Ω–∞: <b style="color:#fff">'+c.price+' ‚≠ê</b></div>');
        (function(id){card.addEventListener('click',function(){selectedCase=id; activeTab='home'; window.scrollTo({top:0,behavior:'smooth'}); render()})})(c.id);
        grid.appendChild(card);
      }
      return grid;
    }

    function renderDetail(caseId){
      var data=CASES.filter(function(x){return x.id===caseId})[0]; if(!data) return el('div',null,'–ö–µ–π—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
      var wrap=el('section','fade');

      var head=el('div','detail-head','<button class="btn btn-secondary" id="back">‚Üê –ù–∞–∑–∞–¥</button><div style="font-size:18px;font-weight:800">'+data.title+'</div><div style="margin-left:auto;font-size:13px;color:var(--muted)">–¶–µ–Ω–∞: '+data.price+' ‚≠ê</div>');
      wrap.appendChild(head); qs('#back',head).onclick=function(){selectedCase=null; render()};

      var hint=el('div'); hint.style.color='var(--muted)'; hint.style.fontSize='14px'; hint.textContent='–ù–∞–∂–º–∏ ¬´–û—Ç–∫—Ä—ã—Ç—å¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å'; wrap.appendChild(hint);

      var hand=el('div','hand'); wrap.appendChild(hand); var cards=[], i;
      for(i=0;i<5;i++){
        var holder=el('div','hand-card');
        var f=el('div','flip','<div class="face front"><div style="font-size:32px">?</div></div><div class="face back"><div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center"><div style="font-size:34px" class="p-emoji">üéÅ</div><div style="margin-top:6px;font-size:13px;font-weight:700" class="p-label">–ü—Ä–∏–∑</div><div class="rar-chip p-rar">rarity</div></div></div>');
        holder.appendChild(f); hand.appendChild(holder); cards.push({el:holder});
      }

      function baseTransform(i,n){var narrow=(window.innerWidth||390)<=414, spread=narrow?18:24, start=-spread/2, angle=start+i*(spread/Math.max(1,n-1)), y=Math.abs(i-(n-1)/2)*(narrow?2:3); return {angle:angle,y:y}}
      function placeIdle(){for(var k=0;k<cards.length;k++){var t=baseTransform(k,cards.length); cards[k].el.style.transform='rotate('+t.angle+'deg) translateY('+t.y+'px)'; cards[k].el.style.zIndex=5 }}
      function placeRevealed(p){var narrow=(window.innerWidth||390)<=414; for(var k=0;k<cards.length;k++){var t=baseTransform(k,cards.length); if(k===p){cards[k].el.style.transform='rotate('+t.angle+'deg) translateY('+Math.max(0,t.y-(narrow?1:2))+'px) scale('+(narrow?1.03:1.06)+')'; cards[k].el.style.zIndex=50}else{var dir=k<p?-1:1,dist=(narrow?56:90)+Math.abs(k-p)*(narrow?8:12),lift=narrow?6:10,ang=t.angle*(narrow?0.9:0.8); cards[k].el.style.transform='rotate('+ang+'deg) translate('+(dir*dist)+'px,'+(t.y+lift)+'px) scale('+(narrow?0.965:0.96)+')'; cards[k].el.style.zIndex=5-Math.abs(k-p) } } }
      placeIdle();

      var opening=false, pickedIndex=null, landedPrize=null;
      function weightedPick(a){var tot=0;for(var q=0;q<a.length;q++)tot+=a[q].weight||0; if(tot<=0)tot=1; var r=Math.random()*tot; for(var w=0;w<a.length;w++){r-=a[w].weight||0; if(r<=0)return a[w]} return a[a.length-1]}

      function startOpen(){ if(opening) return; if(stars<data.price){ toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚≠ê'); try{tg&&tg.HapticFeedback&&tg.HapticFeedback.notificationOccurred&&tg.HapticFeedback.notificationOccurred('warning')}catch(_){ } return } opening=true; stars-=data.price; updateStars(); try{tg&&tg.HapticFeedback&&tg.HapticFeedback.impactOccurred&&tg.HapticFeedback.impactOccurred('medium')}catch(_){ } hint.textContent='–í—ã–±–µ—Ä–∏ –æ–¥–Ω—É –∫–∞—Ä—Ç—É' }

      function flipPick(idx){
        if(!opening||pickedIndex!==null) return;
        pickedIndex=idx;
        var prize=weightedPick(data.prizes);

        try{audio.flip(); tg&&tg.HapticFeedback&&tg.HapticFeedback.selectionChanged&&tg.HapticFeedback.selectionChanged()}catch(_){}
        var holder=cards[idx].el.querySelector('.flip'); holder.classList.add('flipped');
        fillPrize(holder,prize);
        var glow = prize.rarity==='legendary'?'glow-b-orange':prize.rarity==='epic'?'glow-b-purple':prize.rarity==='rare'?'glow-b-blue':'';
        if(glow) holder.classList.add(glow);

        landedPrize=prize; placeRevealed(idx);

        setTimeout(function(){
          for(var t=0;t<cards.length;t++){ if(t===idx) continue; var alt=weightedPick(data.prizes); var f=cards[t].el.querySelector('.flip'); f.classList.add('flipped'); fillPrize(f,alt); }
          try{audio.win(); tg&&tg.HapticFeedback&&tg.HapticFeedback.impactOccurred&&tg.HapticFeedback.impactOccurred('heavy')}catch(_){}
          hint.textContent='–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç'; renderResult();
        },400);
      }

      function fillPrize(f,prize){ var e=f.querySelector('.p-emoji'); if(e) e.textContent=prize.emoji||'üéÅ'; var l=f.querySelector('.p-label'); if(l) l.textContent=prize.label||'–ü—Ä–∏–∑'; var r=f.querySelector('.p-rar'); if(r) r.textContent=prize.rarity||'rare' }

      var actions=el('div'); actions.style.marginTop='12px'; actions.innerHTML='<button class="btn btn-primary" id="open">–û—Ç–∫—Ä—ã—Ç—å –∑–∞ '+data.price+' ‚≠ê</button>'; wrap.appendChild(actions);
      qs('#open',actions).onclick=function(){startOpen()};
      for(i=0;i<cards.length;i++){(function(ii){cards[ii].el.addEventListener('click',function(){flipPick(ii)})})(i)}

      function renderResult(){
        var box=el('div','result','<div style="display:flex;align-items:center;gap:8px"><div style="font-size:22px">'+(landedPrize.emoji||'üéÅ')+'</div><div style="font-size:14px"><div style="font-weight:800">'+landedPrize.label+'</div><div class="rar-chip">'+landedPrize.rarity+'</div></div></div><div style="display:flex;gap:8px"><button class="btn btn-secondary" id="sell">–ü—Ä–æ–¥–∞—Ç—å –∑–∞ '+((SELL[landedPrize.rarity]||1))+' ‚≠ê</button><button class="btn btn-primary" id="claim">–ó–∞–±—Ä–∞—Ç—å</button></div>');
        wrap.appendChild(box);
        qs('#sell',box).onclick=function(){var v=SELL[landedPrize.rarity]||1; stars+=v; updateStars(); toast('–ü—Ä–æ–¥–∞–Ω–æ: +'+v+' ‚≠ê'); selectedCase=null; render()};
        qs('#claim',box).onclick=function(){
          if(landedPrize.stars){stars+=landedPrize.stars;updateStars()}
          pushFeed(landedPrize,'@you'); addToInventory(landedPrize);
          toast('–ü—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω'); selectedCase=null; render();
        };
      }

      return wrap;
    }

    /* inventory view */
    function addToInventory(prize){
      inventory.push({ id:'inv_'+Date.now(), label:prize.label, emoji:prize.emoji||'üéÅ', rarity:prize.rarity||'common', stars:prize.stars||0, time:Date.now() });
    }
    function renderInventory(){
      var wrap=el('section','fade');
      if(inventory.length===0){
        var empty=el('div',null,'–ü–æ–∫–∞ –ø—É—Å—Ç–æ ‚Äî –∑–∞–±–∏—Ä–∞–π –ø—Ä–∏–∑—ã –∏–∑ –∫–µ–π—Å–æ–≤, –∏ –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.');
        empty.style.color='var(--muted)'; empty.style.marginTop='8px';
        wrap.appendChild(empty);
        return wrap;
      }
      // stats
      var cnt={common:0,rare:0,epic:0,legendary:0};
      for(var i=0;i<inventory.length;i++){ cnt[inventory[i].rarity]=(cnt[inventory[i].rarity]||0)+1; }
      var stat=el('div','statbar',
        '<div class="stat">–í—Å–µ–≥–æ: <b>'+inventory.length+'</b></div>'+
        '<div class="stat">common: <b>'+cnt.common+'</b></div>'+
        '<div class="stat">rare: <b>'+cnt.rare+'</b></div>'+
        '<div class="stat">epic: <b>'+cnt.epic+'</b></div>'+
        '<div class="stat">legendary: <b>'+cnt.legendary+'</b></div>'
      );
      wrap.appendChild(stat);

      var grid=el('div','inv-grid');
      for(i=0;i<inventory.length;i++){
        (function(item){
          var card=el('div','inv-item',
            '<div class="inv-emoji">'+item.emoji+'</div>'+
            '<div style="flex:1 1 auto"><div style="font-weight:800">'+item.label+'</div><div class="chip">'+item.rarity+'</div></div>'+
            '<div class="row-actions"><button class="btn btn-secondary" data-sell>–ü—Ä–æ–¥–∞—Ç—å '+(SELL[item.rarity]||1)+' ‚≠ê</button></div>'
          );
          grid.appendChild(card);
          qs('[data-sell]',card).onclick=function(){
            var v=SELL[item.rarity]||1; stars+=v; updateStars();
            inventory = inventory.filter(function(x){return x.id!==item.id});
            toast('–ü—Ä–æ–¥–∞–Ω–æ: +'+v+' ‚≠ê'); render();
          };
        })(inventory[i]);
      }
      wrap.appendChild(grid);
      return wrap;
    }

    /* voting view */
    function getVoteKey(){ return 'gw_vote_' + (tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 'anon'); }
    function renderVoting(){
      var wrap=el('section','fade');
      var add = el('div'); add.innerHTML='<button class="btn btn-primary" id="addProp">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ—é</button>';
      wrap.appendChild(add);
      qs('#addProp',add).onclick=function(){
        var t = prompt('–û–ø–∏—à–∏ –∏–¥–µ—é –∫—Ä–∞—Ç–∫–æ:');
        if(!t) return;
        proposals.push({id:'p'+Date.now(), title:t, up:0, down:0, voters:{}});
        saveProposals(); render();
      };

      var list=el('div','vote-list');
      var voterKey=getVoteKey();
      for(var i=0;i<proposals.length;i++){
        (function(p){
          var voted = (p.voters && p.voters[voterKey]) || 'none'; // 'up' | 'down' | 'none'
          var card=el('div','vote-card',
            '<div style="font-weight:800">'+p.title+'</div>'+
            '<div class="vote-actions">'+
              '<span class="vote-pill '+(voted==='up'?'active':'')+'" data-up>üëç '+p.up+'</span>'+
              '<span class="vote-pill '+(voted==='down'?'active':'')+'" data-down>üëé '+p.down+'</span>'+
            '</div>'
          );
          list.appendChild(card);
          qs('[data-up]',card).onclick=function(){ applyVote(p,'up'); };
          qs('[data-down]',card).onclick=function(){ applyVote(p,'down'); };
        })(proposals[i]);
      }
      wrap.appendChild(list);
      return wrap;
    }
    function applyVote(p, dir){
      var voterKey=getVoteKey();
      var prev = (p.voters && p.voters[voterKey]) || 'none';
      if(!p.voters) p.voters={};

      if(prev===dir){
        // —Å–Ω—è—Ç—å –≥–æ–ª–æ—Å
        if(dir==='up' && p.up>0) p.up--;
        if(dir==='down' && p.down>0) p.down--;
        p.voters[voterKey]='none';
      }else{
        if(dir==='up'){ p.up++; if(prev==='down'&&p.down>0) p.down--; }
        if(dir==='down'){ p.down++; if(prev==='up'&&p.up>0) p.up--; }
        p.voters[voterKey]=dir;
      }
      saveProposals(); render();
    }

    /* profile view (–∑–∞–≥–ª—É—à–∫–∞) */
    function renderProfile(){
      var wrap=el('section','fade');
      var b=el('div',null,'–¢—É—Ç –±—É–¥–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.');
      b.style.color='var(--muted)'; b.style.marginTop='8px';
      wrap.appendChild(b);
      return wrap;
    }

    function updateStars(){ var s=qs('#stars'); if(s) s.textContent=String(stars) }
    function pushFeed(prize,user){ feed.push({user:user||'@you',emoji:prize.emoji||'üéÅ',label:prize.label||'–ü—Ä–∏–∑',time:ts()}); }

    function toast(text){
      var t=qs('#toast'); if(t) t.remove();
      t=el('div'); t.id='toast';
      t.style.position='fixed'; t.style.left='50%'; t.style.bottom='88px'; t.style.transform='translateX(-50%)';
      t.style.background='var(--orange)'; t.style.color='#111'; t.style.padding='8px 12px'; t.style.borderRadius='12px';
      t.style.boxShadow='0 8px 24px rgba(255,122,26,.25)'; t.style.fontWeight='800'; t.style.zIndex='9';
      t.textContent=text; document.body.appendChild(t); setTimeout(function(){t.remove()},1800);
    }

    render();
  })();
  </script>
</body>
</html>
