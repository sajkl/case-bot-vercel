<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö–µ–π—Å—ã –∑–∞ ‚≠ê ‚Äî Telegram Mini App</title>

  <!-- –í–Ω–µ—à–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç—ã —Å CORS, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ —Å—Ç–µ–∫–∏ –æ—à–∏–±–æ–∫ -->
  <script src="https://telegram.org/js/telegram-web-app.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>

  <!-- –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–≤–µ—Ü –æ—à–∏–±–æ–∫ —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏ -->
  <script>
    (function () {
      const show = (title, detail) => {
        try {
          const box = document.getElementById('err');
          if (box) {
            box.style.display = 'block';
            box.textContent = title + '\n' + (detail || '');
          }
        } catch (_) {}
      };

      window.onerror = function (message, source, lineno, colno, error) {
        const detail = [
          'source: ' + (source || '-'),
          'line: ' + (lineno || '-') + ', col: ' + (colno || '-'),
          'stack: ' + (error && error.stack ? error.stack : '-')
        ].join('\n');
        show('JS error: ' + message, detail);
      };

      window.addEventListener('unhandledrejection', (e) => {
        const reason = e && e.reason;
        const detail = (reason && reason.stack) || JSON.stringify(reason);
        show('Promise error', detail);
      });
    })();
  </script>

  <style>
    html, body, #root { height: 100%; }

    /* ==== Fade-in –∞–Ω–∏–º–∞—Ü–∏—è ==== */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px) scale(0.98); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }
    .fade-in { animation: fadeInUp .38s cubic-bezier(.2,.8,.2,1) both; }

    /* ==== FLIP CARD ==== */
    .flip-scene { perspective: 1000px; }
    .flip-card {
      width: 120px; height: 160px;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 700ms cubic-bezier(.2,.8,.2,1);
      border-radius: 16px;
    }
    .flip-card.flipped { transform: rotateY(180deg); }
    .flip-face {
      position: absolute; inset: 0; border-radius: 16px;
      backface-visibility: hidden; -webkit-backface-visibility: hidden;
      display: flex; align-items: center; justify-content: center;
    }
    .flip-face.back { transform: rotateY(180deg); }

    /* –ú—è–≥–∫–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ —Å—Ü–µ–Ω—ã */
    .cards-enter { opacity: 0; transform: translateY(16px) scale(0.98); }
    .cards-enter-active {
      opacity: 1; transform: translateY(0) scale(1);
      transition: all 300ms cubic-bezier(.2,.8,.2,1);
    }

    /* ==== Glow –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏ ==== */
    .glow-common    { box-shadow: 0 0 0 2px rgba(113,113,122,.35), 0 0 18px rgba(113,113,122,.25); } /* zinc */
    .glow-rare      { box-shadow: 0 0 0 2px rgba(59,130,246,.40), 0 0 22px rgba(59,130,246,.30); }  /* blue */
    .glow-epic      { box-shadow: 0 0 0 2px rgba(168,85,247,.45), 0 0 24px rgba(168,85,247,.32); }  /* purple */
    .glow-legendary { box-shadow: 0 0 0 2px rgba(234,88,12,.55),  0 0 26px rgba(234,88,12,.40); }   /* orange */
  </style>
</head>

<body class="bg-gradient-to-b from-black to-zinc-900 text-white">
  <div id="root"></div>
  <pre id="err" style="display:none; position:fixed; left:8px; bottom:64px; right:8px; max-height:40vh; overflow:auto; background:#111; color:#fff; padding:8px; border-radius:8px; z-index:9999"></pre>

  <!-- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. Babel —Å–æ–±–µ—Ä—ë—Ç JSX –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ -->
  <script type="text/babel">
    const { useEffect, useState } = React;
    const tg = (typeof window !== 'undefined' ? window.Telegram : undefined);

    // ===== –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ =====
    const START_STARS = 25;
    const DEFAULT_CASES = [
      { id:'lite', title:'–õ–∞–π—Ç-–∫–µ–π—Å', priceStars:3, bannerEmoji:'üéà', description:'–î–µ—à—ë–≤—ã–π –≤—Ö–æ–¥, –±—ã—Å—Ç—Ä—ã–µ –ø—Ä–∏–∑—ã',
        prizes:[ {id:'l1',label:'–°—Ç–∏–∫–µ—Ä –º–∏–Ω–∏',emoji:'üêæ',rarity:'common',weight:55},
                 {id:'l2',label:'1‚≠ê –Ω–∞–∑–∞–¥',emoji:'‚≠ê',rarity:'common',weight:30,starsValue:1},
                 {id:'l3',label:'–ú–∞–ª—ã–π –±—É—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è',emoji:'üîπ',rarity:'rare',weight:12},
                 {id:'l4',label:'5‚≠ê –¥–∂–µ–∫–ø–æ—Ç',emoji:'üí•',rarity:'epic',weight:3,starsValue:5} ]},
      { id:'starter', title:'–°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–µ–π—Å', priceStars:6, bannerEmoji:'üéÅ', description:'–û—Ç–∫—Ä—ã–≤–∞–π –∏ –ª–æ–≤–∏ —É–¥–∞—á—É!',
        prizes:[ {id:'s1',label:'–°—Ç–∏–∫–µ—Ä-–ø–∞–∫',emoji:'üò∫',rarity:'common',weight:45},
                 {id:'s2',label:'2‚≠ê –Ω–∞–∑–∞–¥',emoji:'‚≠ê',rarity:'common',weight:28,starsValue:2},
                 {id:'s3',label:'–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –±–µ–π–¥–∂',emoji:'üèÖ',rarity:'rare',weight:17},
                 {id:'s4',label:'–ê–≤–∞—Ç–∞—Ä-—Ä–∞–º–∫–∞',emoji:'üñºÔ∏è',rarity:'epic',weight:8},
                 {id:'s5',label:'–ú–µ–≥–∞–ø—Ä–∏–∑: 20‚≠ê',emoji:'üí´',rarity:'legendary',weight:2,starsValue:20} ]},
      { id:'pro', title:'–ü—Ä–æ-–∫–µ–π—Å', priceStars:12, bannerEmoji:'‚ö°', description:'–ë–æ–ª—å—à–µ —Ä–∏—Å–∫ ‚Äî –∫—Ä—É—á–µ –ø—Ä–∏–∑—ã',
        prizes:[ {id:'p1',label:'3‚≠ê –Ω–∞–∑–∞–¥',emoji:'‚≠ê',rarity:'common',weight:32,starsValue:3},
                 {id:'p2',label:'–°–∫–∏–Ω –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è',emoji:'üé®',rarity:'rare',weight:28},
                 {id:'p3',label:'–ê–Ω–∏–º–∞—Ü–∏—è –∏–º–µ–Ω–∏',emoji:'‚ú®',rarity:'rare',weight:20},
                 {id:'p4',label:'10‚≠ê –Ω–∞–∑–∞–¥',emoji:'üåü',rarity:'epic',weight:15,starsValue:10},
                 {id:'p5',label:'–°—É–ø–µ—Ä–ø—Ä–∏–∑: 60‚≠ê',emoji:'üöÄ',rarity:'legendary',weight:5,starsValue:60} ]},
      { id:'ultra', title:'–£–ª—å—Ç—Ä–∞-–∫–µ–π—Å', priceStars:30, bannerEmoji:'üëë', description:'–í—ã—Å–æ–∫–∞—è —Å—Ç–∞–≤–∫–∞ ‚Äî –∫–æ—Ä–æ–ª–µ–≤—Å–∫–∏–µ –Ω–∞–≥—Ä–∞–¥—ã',
        prizes:[ {id:'u1',label:'7‚≠ê –Ω–∞–∑–∞–¥',emoji:'‚≠ê',rarity:'rare',weight:30,starsValue:7},
                 {id:'u2',label:'–†–µ–¥–∫–∏–π —Å–∫–∏–Ω + —ç—Ñ—Ñ–µ–∫—Ç',emoji:'üßø',rarity:'epic',weight:28},
                 {id:'u3',label:'15‚≠ê –Ω–∞–∑–∞–¥',emoji:'üåü',rarity:'epic',weight:20,starsValue:15},
                 {id:'u4',label:'–õ–µ–≥–µ–Ω–¥–∞: 120‚≠ê',emoji:'üèÜ',rarity:'legendary',weight:6,starsValue:120},
                 {id:'u5',label:'–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π —Å–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤',emoji:'üéñÔ∏è',rarity:'legendary',weight:4},
                 {id:'u6',label:'–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π: 300‚≠ê',emoji:'ü¶Ñ',rarity:'legendary',weight:2,starsValue:300} ]},
    ];

    const SELL_BY_RARITY = { common:1, rare:2, epic:6, legendary:20 };
    const rarityColor = (r) => ({
      common: 'bg-zinc-700 text-zinc-100',
      rare: 'bg-blue-700 text-blue-100',
      epic: 'bg-purple-700 text-purple-100',
      legendary: 'bg-amber-600 text-amber-100'
    }[r] || 'bg-zinc-700 text-zinc-100');
    const glowClass = (r) => ({
      common: 'glow-common',
      rare: 'glow-rare',
      epic: 'glow-epic',
      legendary: 'glow-legendary'
    }[r] || 'glow-common');

    // ===== –∑–≤—É–∫/–≤–∏–±—Ä–æ =====
    class SpinAudio {
      constructor(){ this.ctx=null; this.gain=null; }
      ensure(){ if(!this.ctx){ const AC = window.AudioContext||window.webkitAudioContext; if(!AC) return;
        this.ctx=new AC(); this.gain=this.ctx.createGain(); this.gain.gain.value=0.06; this.gain.connect(this.ctx.destination);} }
      flip(){ this.ensure(); if(!this.ctx||!this.gain) return; const o=this.ctx.createOscillator(), g=this.ctx.createGain();
        o.type='triangle'; o.frequency.value=520; o.connect(g).connect(this.gain);
        const t=this.ctx.currentTime; g.gain.setValueAtTime(0.05,t); g.gain.exponentialRampToValueAtTime(0.00001,t+0.15);
        o.start(t); o.stop(t+0.16); }
      win(){ this.ensure(); if(!this.ctx||!this.gain) return; const o=this.ctx.createOscillator(), g=this.ctx.createGain();
        o.type='sine'; o.frequency.value=880; o.connect(g).connect(this.gain);
        const t=this.ctx.currentTime; g.gain.setValueAtTime(0.08,t); g.gain.exponentialRampToValueAtTime(0.00001,t+0.4);
        o.frequency.exponentialRampToValueAtTime(1320, t+0.35); o.start(t); o.stop(t+0.4); }
    }
    const audio = new SpinAudio();

    // ===== –ö–∞—Ä—Ç–æ—á–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è (—ç–∫—Ä–∞–Ω –æ—Ç–∫—Ä—ã—Ç–∏—è) =====
    function CardFront({ prize }) {
      return (
        <div className="flip-face back bg-zinc-900 border border-zinc-700 shadow-md">
          <div className="flex flex-col items-center justify-center h-full p-3 text-center">
            <div className="text-4xl">{prize?.emoji ?? 'üéÅ'}</div>
            <div className="mt-2 text-sm font-semibold text-zinc-100">{prize?.label ?? '–ü—Ä–∏–∑'}</div>
            {prize ? (
              <div className={`mt-1 inline-block px-2 py-0.5 rounded-full text-[10px] ${rarityColor(prize.rarity)}`}>
                {prize.rarity}
              </div>
            ) : null}
          </div>
        </div>
      );
    }

    // ===== –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ c ¬´5 –∫–∞—Ä—Ç–∞–º–∏¬ª =====
    function CaseDetailCards({ data, onBack, onOpenServer, opening, setLastPrize, addHistory, setToast, onClaimPrize, onSellPrize }) {
      const [phase, setPhase] = useState('idle'); // idle | choosing | revealed | picking
      const [cards, setCards] = useState(Array(5).fill(null)); // [{prize, flipped, picked}]
      const [pickedIndex, setPickedIndex] = useState(null);
      const [landedPrize, setLandedPrize] = useState(null);

      const prepareCards = () => {
        setPhase('choosing');
        setCards(Array(5).fill(null).map(() => ({ prize: null, flipped: false, picked: false })));
        setPickedIndex(null);
        setLandedPrize(null);
      };

      const onPick = async (idx) => {
        if (phase !== 'choosing') return;

        setPhase('picking');
        setPickedIndex(idx);
        setCards((cs) => cs.map((c, i) => i === idx ? { ...c, picked: true } : c));

        let prize = null;
        try {
          const res = await fetch('/api/open', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ caseId: data.id })
          });
          if (res.ok) {
            const json = await res.json().catch(() => ({}));
            if (json && json.prize) prize = json.prize;
          }
        } catch (_) {}

        if (!prize || !prize.id) {
          const total = (data.prizes || []).reduce((s,p)=>s+(p?.weight||0),0);
          let r = Math.random()*Math.max(1,total);
          prize = data.prizes?.[data.prizes.length-1] || null;
          for (const p of (data.prizes || [])) { r -= (p?.weight||0); if (r<=0) { prize=p; break; } }
        }

        if (!prize) { setPhase('choosing'); return; }

        audio.flip();
        tg?.WebApp?.HapticFeedback?.selectionChanged?.();
        setCards((cs) => cs.map((c, i) => i === idx ? ({ ...c, prize, flipped: true }) : c));
        setPhase('revealed');
        setLastPrize(prize);
        setLandedPrize(prize);
        addHistory(prize);

        setTimeout(()=>{ audio.win(); tg?.WebApp?.HapticFeedback?.impactOccurred?.('heavy'); }, 150);

        setTimeout(() => {
          setCards((cs) => {
            const chosenId = prize && prize.id;
            const pool = Array.isArray(data.prizes) ? data.prizes.slice() : [];
            const remainingPool = chosenId ? pool.filter(p => p.id !== chosenId) : pool;
            const shuffled = remainingPool.slice().sort(()=>Math.random()-0.5);
            let ri = 0;
            return cs.map((c, i) => {
              if (i === idx) return c;
              const alt = shuffled[ri++] || remainingPool[0] || prize;
              return { ...c, prize: alt, flipped: true };
            });
          });
        }, 500);
      };

      const onStart = async () => {
        if (opening) return;
        const ok = await onOpenServer(data);
        if (ok) prepareCards();
      };

      const glowFor = (card) => {
        if (!card?.flipped || !card?.prize) return '';
        return glowClass(card.prize.rarity);
        };

      return (
        <div className="fade-in">
          <div className="flex items-center gap-2 mb-4">
            <button onClick={onBack} className="px-3 py-2 rounded-xl bg-zinc-800 border border-zinc-700 text-zinc-100 hover:bg-zinc-700 transition">‚Üê –ù–∞–∑–∞–¥</button>
            <div className="text-xl font-semibold flex items-center gap-2">
              <span className="text-2xl">{data.bannerEmoji ?? 'üéÅ'}</span> {data.title}
            </div>
            <div className="ml-auto text-sm text-zinc-300">–¶–µ–Ω–∞: {data.priceStars} ‚≠ê</div>
          </div>

          {/* —Å—Ü–µ–Ω–∞ –∫–∞—Ä—Ç */}
          <div className={`mt-2 rounded-2xl p-4 border border-zinc-700 bg-zinc-900/70 backdrop-blur flip-scene ${phase==='choosing' ? 'cards-enter-active' : ''}`}>
            <div className="text-sm text-zinc-400">
              {phase==='idle' ? '–ù–∞–∂–º–∏ ¬´–û—Ç–∫—Ä—ã—Ç—å¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å' : (phase==='choosing' ? '–í—ã–±–µ—Ä–∏ –æ–¥–Ω—É –∫–∞—Ä—Ç—É' : '–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç')}
            </div>

            <div className="mt-4 grid grid-cols-3 sm:grid-cols-5 gap-4 justify-items-center">
              {cards.map((card, i) => (
                <div key={i} className={`transition-transform ${card?.picked?'scale-105':''} fade-in`} style={{ animationDelay: `${i*60}ms` }}>
                  <div className={`flip-card ${card?.flipped?'flipped':''} ${glowFor(card)}`} onClick={() => (phase==='choosing') && onPick(i)}>
                    <div className="flip-face front bg-gradient-to-br from-zinc-800 to-zinc-700 text-white border border-zinc-600 shadow-lg">
                      <div className="text-4xl">?</div>
                    </div>
                    <CardFront prize={card?.prize} />
                  </div>
                </div>
              ))}
            </div>

            {/* –∫–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å" */}
            <div className="sticky bottom-3 mt-5 z-10">
              <button
                className={`w-full px-4 py-3 rounded-xl font-semibold shadow-lg transition active:scale-[0.98] ${opening ? 'bg-zinc-700 cursor-not-allowed text-zinc-300' : 'bg-orange-500 hover:bg-orange-600 text-black'}`}
                onClick={onStart}
                disabled={opening}
              >
                –û—Ç–∫—Ä—ã—Ç—å –∑–∞ {data.priceStars} ‚≠ê
              </button>
            </div>

            {/* –ø–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π, –∫–æ–≥–¥–∞ –ø—Ä–∏–∑ –æ—Ç–∫—Ä—ã—Ç */}
            {phase === 'revealed' && landedPrize && (
              <div className="mt-4 flex items-center justify-between gap-3 rounded-2xl p-3 border border-zinc-700 bg-zinc-900/70">
                <div className="flex items-center gap-2">
                  <div className="text-2xl">{landedPrize.emoji ?? 'üéÅ'}</div>
                  <div className="text-sm">
                    <div className="font-semibold">{landedPrize.label}</div>
                    <div className={`mt-1 inline-block px-2 py-0.5 rounded-full text-[10px] ${rarityColor(landedPrize.rarity)}`}>{landedPrize.rarity}</div>
                  </div>
                </div>
                <div className="flex gap-2">
                  <button
                    className="px-3 py-2 rounded-xl font-semibold bg-zinc-800 border border-zinc-700 text-zinc-100 hover:bg-zinc-700 transition"
                    onClick={() => onSellPrize(landedPrize)}
                  >
                    –ü—Ä–æ–¥–∞—Ç—å –∑–∞ {({common:1,rare:2,epic:6,legendary:20}[landedPrize.rarity]||1)} ‚≠ê
                  </button>
                  <button
                    className="px-4 py-2 rounded-xl font-semibold bg-orange-500 hover:bg-orange-600 text-black shadow"
                    onClick={() => onClaimPrize(landedPrize)}
                  >
                    –ó–∞–±—Ä–∞—Ç—å
                  </button>
                </div>
              </div>
            )}
          </div>

          {/* —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–∑–æ–≤ –Ω–∏–∂–µ */}
          <div className="mt-5 rounded-2xl p-4 border border-zinc-700 bg-zinc-900/70 backdrop-blur fade-in">
            <div className="text-sm text-zinc-400 mb-3">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–∏–∑—ã</div>
            <div className="grid grid-cols-2 gap-3 sm:grid-cols-3">
              {data.prizes.map((p) => (
                <div key={p.id} className="flex items-center gap-2 p-2 rounded-xl border border-zinc-700 bg-zinc-900">
                  <div className="text-xl">{p.emoji ?? 'üéÅ'}</div>
                  <div className="text-sm">
                    <div className="font-medium text-zinc-100">{p.label}</div>
                    <div className={`mt-1 inline-block px-2 py-0.5 rounded-full text-[10px] ${rarityColor(p.rarity)}`}>{p.rarity}</div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // ===== Toast / Spinner =====
    const Toast = ({ text, onClose }) => {
      useEffect(()=>{ const t=setTimeout(onClose,2000); return ()=>clearTimeout(t); },[onClose]);
      return <div className="fixed bottom-20 left-1/2 -translate-x-1/2 px-4 py-2 rounded-xl bg-orange-500 text-black shadow-xl z-[60]">{text}</div>;
    };
    const Spinner = ({ spinning }) => (
      <div className="relative h-24 my-4 flex items-center justify-center">
        <div className={`w-20 h-20 rounded-full border-4 border-zinc-700 border-t-orange-500 ${spinning?'animate-spin':''}`} />
      </div>
    );

    // ===== –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç + —Ç–∞–±-–±–∞—Ä =====
    function App(){
      const [cases] = useState(DEFAULT_CASES);
      const [stars,setStars]=useState(START_STARS);
      const [opening,setOpening]=useState(false);
      const [selectedCase,setSelectedCase]=useState(null);
      const [lastPrize,setLastPrize]=useState(null);
      const [toast,setToast]=useState(null);
      const [history,setHistory]=useState([]);
      const [inventory,setInventory]=useState([]); // {id,label,emoji,rarity,starsValue,ts}
      const [tab,setTab]=useState('home'); // home | inventory | history

      useEffect(()=>{ try{ tg?.WebApp?.ready?.(); tg?.WebApp?.expand?.(); }catch(e){} },[]);
      const addHistory = (p) => setHistory((h)=> [{prize:p, ts:Date.now(), caseTitle:selectedCase?.title||'–ö–µ–π—Å'}, ...h].slice(0,50));

      const openDetails=(c)=>{ setSelectedCase(c); setTab('home'); };

      // —Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
      const onOpenServerPrepare = async (c) => {
        if (opening) return false;
        if (stars < c.priceStars) { setToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚≠ê'); tg?.WebApp?.HapticFeedback?.notificationOccurred?.('warning'); return false; }
        setOpening(true);
        setLastPrize(null);
        setStars(s=>s-c.priceStars);
        tg?.WebApp?.HapticFeedback?.impactOccurred?.('medium');
        await new Promise(r=>setTimeout(r, 200));
        setOpening(false);
        return true;
      };

      const onSellPrize = (p) => {
        const v = SELL_BY_RARITY[p.rarity] || 1;
        setStars(s=>s+v);
        setToast(`–ü—Ä–æ–¥–∞–Ω–æ: +${v} ‚≠ê`);
      };

      const onClaimPrize = (p) => {
        setInventory((inv)=> [{...p, ts:Date.now()}, ...inv].slice(0,200));
        if (p.starsValue) setStars(s=>s+p.starsValue);
        setToast('–ü—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å');
      };

      // ===== UI =====
      return (
        <div className="min-h-dvh pb-20 px-4 py-5">
          <div className="mx-auto max-w-md">
            <header className="flex items-center justify-between fade-in" style={{animationDelay:'20ms'}}>
              <div>
                <h1 className="text-2xl font-bold tracking-tight">–ö–µ–π—Å—ã –∑–∞ ‚≠ê</h1>
                <p className="text-zinc-400 text-sm">–û—Ç–∫—Ä—ã–≤–∞–π –∫–µ–π—Å—ã –∏ –∑–∞–±–∏—Ä–∞–π –ø—Ä–∏–∑—ã</p>
              </div>
              <div className="px-3 py-2 rounded-xl bg-orange-500 text-black font-semibold shadow-lg">{stars} ‚≠ê</div>
            </header>

            {/* –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ —Ç–∞–±–∞–º */}
            {tab === 'home' && !selectedCase && (
              <>
                {/* –°–µ—Ç–∫–∞ –∫–µ–π—Å–æ–≤: 2 –≤ —Ä—è–¥ */}
                <section className="mt-5 grid grid-cols-2 gap-4">
                  {cases.map((c, i)=>(
                    <div
                      key={c.id}
                      role="button"
                      onClick={()=>openDetails(c)}
                      className="rounded-2xl p-4 bg-zinc-900/70 border border-zinc-700 hover:border-orange-500 hover:shadow-[0_0_0_2px_rgba(234,88,12,.35)] transition transform hover:scale-[1.02] backdrop-blur cursor-pointer fade-in"
                      style={{animationDelay: `${i*60+40}ms`}}
                    >
                      <div className="flex items-start gap-3">
                        <div className="text-3xl">{c.bannerEmoji ?? 'üéÅ'}</div>
                        <div className="min-w-0">
                          <div className="text-base font-semibold">{c.title}</div>
                          <div className="text-xs text-zinc-400 line-clamp-2">{c.description}</div>
                        </div>
                      </div>
                      <div className="mt-3 flex items-center justify-between">
                        <div className="text-xs text-zinc-400">–¶–µ–Ω–∞: <span className="text-zinc-200">{c.priceStars} ‚≠ê</span></div>
                        <span className="px-2 py-1 rounded-lg bg-orange-500/20 text-orange-300 text-xs border border-orange-500/30">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</span>
                      </div>
                    </div>
                  ))}
                </section>

                {/* –†–µ–∑—É–ª—å—Ç–∞—Ç (–ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏–∑) */}
                <section className="mt-6 fade-in" style={{animationDelay:'120ms'}}>
                  <div className="rounded-2xl p-4 border border-zinc-700 bg-zinc-900/70 backdrop-blur">
                    <div className="text-sm text-zinc-400">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
                    <Spinner spinning={opening} />
                    {!opening && lastPrize && (
                      <div className="text-center">
                        <div className="text-4xl mb-2">{lastPrize.emoji ?? 'üéâ'}</div>
                        <div className="text-lg font-semibold">{lastPrize.label}</div>
                        <div className={`mt-2 inline-block px-2 py-1 rounded-full text-xs ${rarityColor(lastPrize.rarity)}`}>{lastPrize.rarity}</div>
                        {lastPrize.starsValue ? (<div className="text-sm text-zinc-400 mt-2">–í–æ–∑–≤—Ä–∞—Ç: +{lastPrize.starsValue} ‚≠ê</div>) : null}
                      </div>
                    )}
                    {!opening && !lastPrize && (<div className="text-center text-zinc-500 text-sm">–û—Ç–∫—Ä–æ–π –∫–µ–π—Å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–∏–∑</div>)}
                  </div>
                </section>
              </>
            )}

            {selectedCase && tab==='home' && (
              <section className="mt-5">
                <CaseDetailCards
                  data={selectedCase}
                  onBack={()=>setSelectedCase(null)}
                  onOpenServer={onOpenServerPrepare}
                  opening={opening}
                  setLastPrize={setLastPrize}
                  addHistory={(p)=>setHistory((h)=> [{prize:p, ts:Date.now(), caseTitle:selectedCase?.title||'–ö–µ–π—Å'}, ...h].slice(0,50))}
                  setToast={setToast}
                  onClaimPrize={onClaimPrize}
                  onSellPrize={onSellPrize}
                />
              </section>
            )}

            {tab === 'inventory' && (
              <section className="mt-5 fade-in">
                <div className="rounded-2xl p-4 border border-zinc-700 bg-zinc-900/70 backdrop-blur">
                  <div className="text-sm text-zinc-400 mb-3">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
                  {inventory.length === 0 ? (
                    <div className="text-zinc-500 text-sm text-center py-6">–ü—É—Å—Ç–æ. –û—Ç–∫—Ä–æ–π –∫–µ–π—Å –∏ –Ω–∞–∂–º–∏ ¬´–ó–∞–±—Ä–∞—Ç—å¬ª.</div>
                  ) : (
                    <div className="grid grid-cols-2 gap-3">
                      {inventory.map((p, i)=>(
                        <div key={i} className="rounded-xl border border-zinc-700 bg-zinc-900 p-3">
                          <div className="flex items-center gap-2">
                            <div className="text-2xl">{p.emoji ?? 'üéÅ'}</div>
                            <div className="text-sm">
                              <div className="font-medium">{p.label}</div>
                              <div className={`mt-1 inline-block px-2 py-0.5 rounded-full text-[10px] ${rarityColor(p.rarity)}`}>{p.rarity}</div>
                            </div>
                          </div>
                          <div className="mt-3 flex justify-between items-center">
                            <span className="text-xs text-zinc-500">{new Date(p.ts).toLocaleTimeString()}</span>
                            <button
                              className="px-2 py-1 rounded-lg bg-zinc-800 border border-zinc-700 text-zinc-200 text-xs hover:bg-zinc-700"
                              onClick={()=>{ const v=SELL_BY_RARITY[p.rarity]||1; setStars(s=>s+v); setInventory(inv=>inv.filter((_,idx)=>idx!==i)); setToast(`–ü—Ä–æ–¥–∞–Ω–æ –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è: +${v} ‚≠ê`); }}
                            >
                              –ü—Ä–æ–¥–∞—Ç—å (+{SELL_BY_RARITY[p.rarity]||1}‚≠ê)
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </section>
            )}

            {tab === 'history' && (
              <section className="mt-5 fade-in">
                <div className="rounded-2xl p-4 border border-zinc-700 bg-zinc-900/70 backdrop-blur">
                  <div className="text-sm font-semibold mb-2">–ò—Å—Ç–æ—Ä–∏—è</div>
                  {history.length === 0 ? (
                    <div className="text-zinc-500 text-sm text-center py-6">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>
                  ) : history.map((h, i)=>(
                    <div key={i} className="flex items-center justify-between py-2 border-b border-zinc-800 last:border-0">
                      <div className="flex items-center gap-2">
                        <span className={`px-2 py-1 rounded-full text-xs ${rarityColor(h.prize.rarity)}`}>{h.prize.rarity}</span>
                        <span className="text-base">{(h.prize.emoji ?? 'üéÅ') + ' ' + h.prize.label}</span>
                        <span className="text-zinc-500 text-sm">–≤ {h.caseTitle}</span>
                      </div>
                      <span className="text-zinc-500 text-sm">{new Date(h.ts).toLocaleTimeString()}</span>
                    </div>
                  ))}
                </div>
              </section>
            )}

            <footer className="mt-8 text-center text-zinc-500 text-xs fade-in" style={{animationDelay:'200ms'}}>
              –î–µ–º–æ—Ä–µ–∂–∏–º. –°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∏–∑ —á–µ—Ä–µ–∑ <span className="text-orange-400">/api/open</span>.
            </footer>
          </div>

          {toast && <Toast text={toast} onClose={()=>setToast(null)} />}

          {/* –ù–∏–∂–Ω–∏–π —Ç–∞–±-–±–∞—Ä */}
          <nav className="fixed bottom-0 left-0 right-0 z-50">
            <div className="mx-auto max-w-md">
              <div className="m-3 rounded-2xl border border-zinc-700 bg-zinc-900/90 backdrop-blur shadow-[0_0_0_1px_rgba(255,255,255,.02)]">
                <div className="grid grid-cols-3">
                  <button className={`py-3 text-sm font-medium ${tab==='home' ? 'text-orange-400' : 'text-zinc-400'} hover:text-orange-300`} onClick={()=>{ setSelectedCase(null); setTab('home'); }}>
                    –ì–ª–∞–≤–Ω–∞—è
                  </button>
                  <button className={`py-3 text-sm font-medium ${tab==='inventory' ? 'text-orange-400' : 'text-zinc-400'} hover:text-orange-300`} onClick={()=>setTab('inventory')}>
                    –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
                  </button>
                  <button className={`py-3 text-sm font-medium ${tab==='history' ? 'text-orange-400' : 'text-zinc-400'} hover:text-orange-300`} onClick={()=>setTab('history')}>
                    –ò—Å—Ç–æ—Ä–∏—è
                  </button>
                </div>
              </div>
            </div>
          </nav>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>

