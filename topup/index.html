<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <script src="https://unpkg.com/tonweb@0.0.66/dist/tonweb.js"></script>
  
  <style>
    /* === 1. FULLSCREEN INIT === */
    html { background: #0b0d12; }
    body {
      margin: 0; padding: 0;
      width: 100vw; height: 100vh;
      overflow: hidden; 
      background: #0b0d12;
      color: #fff;
      font-family: system-ui, -apple-system, sans-serif;
      padding-top: calc(env(safe-area-inset-top) - 22px); 
      display: flex; flex-direction: column;
    }
    
    .page {
      width: 100%; height: 100%;
      overflow-y: auto; 
      -webkit-overflow-scrolling: touch;
      max-width: 520px; margin: 0 auto;
      padding: 0 16px 90px;
      display: flex; flex-direction: column;
    }

    :root {
        --bg: #0b0d12; --card: #151921; --text: #fff;
        --accent: #ffd400; --border: #232838; --ton-blue: #0098ea;
    }

    /* === –®–ê–ü–ö–ê === */
    .header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 0; z-index: 2; position: relative; flex-shrink: 0;
      margin-bottom: 10px;
    }
    .header-left { display: flex; align-items: center; gap: 8px; }
    
     .back-arrow {
      display: flex; align-items: center; justify-content: center;
      width: 32px; height: 32px;
      color: #fff; cursor: pointer;
      background: rgba(255,255,255,0.05);
      border-radius: 50%;
      transition: background 0.2s;
      text-decoration: none;
    }
    .back-arrow:active { background: rgba(255,255,255,0.15); transform: scale(0.95); }
    .back-arrow svg { width: 20px; height: 20px; fill: currentColor; }
    
    .logo { height: clamp(30px, 6vw, 36px); }
    .balance { 
      background: var(--accent); color: #171a1f; 
      font-weight: 900; border-radius: 999px; 
      padding: 8px 14px; display: flex; gap: 8px; align-items: center; 
      text-decoration: none; font-size: 14px;
    }
    .balance .star { font-size: 16px; }

    /* === –ì–ï–†–û–ô === */
    .content-wrapper { flex: 1; display: flex; flex-direction: column; padding-bottom: 20px; }

    .topup-hero { display: flex; flex-direction: column; align-items: center; margin: 10px 0 20px; }
    .big-icon {
        width: 120px; height: 120px; object-fit: contain;
        filter: drop-shadow(0 0 30px rgba(255, 212, 0, 0.2));
        margin-bottom: 10px;
        animation: float 4s ease-in-out infinite;
    }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
    
    .topup-title h1 { font-size: 24px; font-weight: 900; margin: 0; text-transform: uppercase; text-align: center; }
    .topup-title span { color: #777; font-size: 13px; display: block; text-align: center; margin-top: 4px; }

    /* === –¢–ê–ë–´ (Stars / TON) === */
    .tabs {
        display: flex; background: #11141b; border-radius: 16px; padding: 4px;
        margin-bottom: 20px; border: 1px solid var(--border);
    }
    .tab {
        flex: 1; text-align: center; padding: 10px; border-radius: 12px;
        font-weight: 800; font-size: 14px; color: #777; cursor: pointer;
        transition: 0.2s;
    }
    .tab.active { background: #2c313f; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .tab.active.ton-tab { background: rgba(0, 152, 234, 0.15); color: var(--ton-blue); }

    /* === –ö–ê–†–¢–û–ß–ö–ê === */
    .pay-card {
        background: var(--card); border: 1px solid var(--border);
        border-radius: 24px; padding: 24px; position: relative;
        overflow: hidden;
    }
    .input-label { font-size: 12px; color: #777; margin-bottom: 10px; display: block; font-weight: 700; text-transform: uppercase; }
    
    .input-wrapper { position: relative; margin-bottom: 20px; }
    .input-icon {
        position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
        color: var(--accent); font-size: 20px; pointer-events: none; font-weight: 900;
    }
    .ton-icon { color: var(--ton-blue); }

    .amount-input {
        width: 100%; background: #0b0d12; border: 1px solid #2a2f3d;
        border-radius: 16px; color: #fff; font-size: 28px; font-weight: 800;
        padding: 18px 16px 18px 45px; outline: none; transition: border-color 0.2s;
    }
    .amount-input:focus { border-color: var(--accent); }
    .amount-input.ton-mode:focus { border-color: var(--ton-blue); }

    .calc-info {
        display: flex; justify-content: space-between; font-size: 13px; font-weight: 700;
        color: #777; margin-bottom: 20px; padding: 0 4px;
    }
    .calc-val { color: #fff; }
    .ton-bonus { color: #2ad06c; font-weight: 800; }

    /* –ö–ù–û–ü–ö–ò */
    .btn-pay {
        width: 100%; background: var(--accent); color: #000; border: none;
        padding: 18px; border-radius: 16px; font-size: 18px; font-weight: 900;
        text-transform: uppercase; cursor: pointer; transition: transform 0.1s;
    }
    .btn-pay:active { transform: scale(0.97); }
    
    .btn-ton {
        background: var(--ton-blue); color: #fff; 
        display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .btn-ton:disabled { opacity: 0.6; cursor: not-allowed; }

    /* TON CONNECT CONTAINER */
    #ton-connect-ui { display: flex; justify-content: center; margin-bottom: 15px; }

    .nav-spacer { height: 90px; flex-shrink: 0; }
    
    .hidden { display: none; }
  </style>
</head>
<body>

  <div class="page">
    <header class="header">
      <div class="header-left">
        <a href="/profile/" class="back-arrow">
           <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        </a>
        <img class="logo" src="/assets/logo.png" alt="LAMBO DROP">
      </div>
      <a class="balance" href="/topup/">
        <span class="star">‚òÖ</span> <span id="balanceValue">...</span>
      </a>
    </header>

    <div class="content-wrapper">
        <div class="topup-hero">
            <img class="big-icon" src="/assets/topup.png" onerror="this.src='/assets/logo.png'">
            <div class="topup-title">
                <h1>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</h1>
                <span>–í—ã–±–µ—Ä–∏ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</span>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('stars')">Telegram Stars</div>
            <div class="tab ton-tab" onclick="switchTab('ton')">TON (Crypto)</div>
        </div>

        <div id="starsForm" class="pay-card">
            <label class="input-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥</label>
            <div class="input-wrapper">
                <span class="input-icon">‚òÖ</span>
                <input id="starsInput" class="amount-input" type="number" value="50" min="1" placeholder="0">
            </div>
            <button id="payStarsBtn" class="btn-pay">–ö—É–ø–∏—Ç—å –ó–≤–µ–∑–¥—ã</button>
            <div style="text-align:center; color:#555; font-size:11px; margin-top:16px;">
                –û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π —á–µ—Ä–µ–∑ Telegram
            </div>
        </div>

        <div id="tonForm" class="pay-card hidden">
            <div id="ton-connect-ui"></div>

            <div id="tonInputs" class="hidden">
                <label class="input-label">–°—É–º–º–∞ –≤ TON</label>
                <div class="input-wrapper">
                    <span class="input-icon ton-icon">üíé</span>
                    <input id="tonInput" class="amount-input ton-mode" type="number" value="1" min="0.1" step="0.1" placeholder="0">
                </div>

                <div class="calc-info">
                    <span class="ton-bonus">‚ö°Ô∏è +10% –∫ –±–∞–ª–∞–Ω—Å—É</span>
                    <span>–ü–æ–ª—É—á–∏—à—å: <span id="calcStars" class="calc-val">110</span> ‚òÖ</span>
                </div>

                <button id="payTonBtn" class="btn-pay btn-ton">
                    –û–ü–õ–ê–¢–ò–¢–¨ TON
                </button>
                <div style="text-align:center; color:#555; font-size:11px; margin-top:16px;">
                    –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —á–µ—Ä–µ–∑ Tonkeeper / Wallet
                </div>
            </div>
            
            <div id="connectHint" style="text-align:center; color:#777; font-size:13px;">
                –ü–æ–¥–∫–ª—é—á–∏ –∫–æ—à–µ–ª–µ–∫, —á—Ç–æ–±—ã –æ–ø–ª–∞—Ç–∏—Ç—å
            </div>
        </div>

    </div>
    
    <div class="nav-spacer"></div>
  </div>

  <nav class="nav">
    <a class="btn" href="/">–ö–µ–π—Å—ã</a>
    <a class="btn" href="/crash.html">Crash üöÄ</a>
    <a class="btn active" href="/profile/">–ü—Ä–æ—Ñ–∏–ª—å</a>
  </nav>

  <script>
    const tg = window.Telegram.WebApp;
    
    // === –ù–ê–°–¢–†–û–ô–ö–ò –ö–û–®–ï–õ–¨–ö–ê ===
    const MY_WALLET_ADDRESS = "UQAWibvuLtk2ftlol9ep9YbL_fK1sKeV3HMFObsVfpHIo86W"; 
      const APP_BOT_LINK = "https://t.me/LamboLuckBot/app";
    const TON_RATE = 110; // –ö—É—Ä—Å –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤ –æ—Å—Ç–∞–ª—Å—è, –Ω–æ —Å–∫—Ä—ã—Ç –∏–∑ UI

    // Init App
    function initApp() {
        tg.ready();
        try { tg.expand(); } catch (e) {}
        try { tg.setHeaderColor('#0b0d12'); tg.setBackgroundColor('#0b0d12'); } catch (e) {}
    }
    initApp();

    const balEl = document.getElementById('balanceValue');
    const starsForm = document.getElementById('starsForm');
    const tonForm = document.getElementById('tonForm');
    const tabs = document.querySelectorAll('.tab');
    
    // === TON CONNECT SETUP ===
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: 'https://lambodrop.vercel.app/tonconnect-manifest.json',
        buttonRootId: 'ton-connect-ui'
    });

    tonConnectUI.onStatusChange(wallet => {
        if (wallet) {
            document.getElementById('tonInputs').classList.remove('hidden');
            document.getElementById('connectHint').classList.add('hidden');
        } else {
            document.getElementById('tonInputs').classList.add('hidden');
            document.getElementById('connectHint').classList.remove('hidden');
        }
    });

    // === TABS ===
    window.switchTab = (mode) => {
        if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        if (mode === 'stars') {
            starsForm.classList.remove('hidden');
            tonForm.classList.add('hidden');
            tabs[0].classList.add('active');
            tabs[1].classList.remove('active');
        } else {
            starsForm.classList.add('hidden');
            tonForm.classList.remove('hidden');
            tabs[0].classList.remove('active');
            tabs[1].classList.add('active');
        }
    };

    // === CALCULATOR ===
    const tonInp = document.getElementById('tonInput');
    const calcVal = document.getElementById('calcStars');
    
    tonInp.addEventListener('input', () => {
        const val = parseFloat(tonInp.value) || 0;
        calcVal.textContent = Math.floor(val * TON_RATE);
    });

    // === PAYMENT: TON (–° –ø—Ä–æ–≤–µ—Ä–∫–æ–π) ===
    document.getElementById('payTonBtn').onclick = async () => {
        const amount = parseFloat(tonInp.value);
        if(!amount || amount < 0.1) return tg.showAlert("–ú–∏–Ω–∏–º—É–º 0.1 TON");

        const btn = document.getElementById('payTonBtn');
        btn.disabled = true;
        btn.textContent = "–ü–û–î–ü–ò–°–ê–ù–ò–ï...";

        try {
            // 1. –§–æ—Ä–º–∏—Ä—É–µ–º Payload —Å ID —é–∑–µ—Ä–∞
            const userId = tg.initDataUnsafe?.user?.id || '0';
            const comment = `user_${userId}`;

            const tonweb = new TonWeb();
            const cell = new TonWeb.boc.Cell();
            cell.bits.writeUint(0, 32); 
            cell.bits.writeString(comment);
            const payload = TonWeb.utils.bytesToBase64(await cell.toBoc());

            // 2. –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            const amountNano = Math.floor(amount * 1000000000).toString();
            const transaction = {
                validUntil: Math.floor(Date.now() / 1000) + 600,
                messages: [{
                    address: MY_WALLET_ADDRESS,
                    amount: amountNano,
                    payload: payload
                }]
            };

            // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º
            await tonConnectUI.sendTransaction(transaction);
            
            btn.textContent = "–ü–†–û–í–ï–†–ö–ê...";
            btn.style.background = "#ffd400";
            btn.style.color = "#000";
            tg.showAlert(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ...`);

            // 4. –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏
            checkPaymentLoop();

        } catch (e) {
            console.error(e);
            tg.showAlert("–û—Ç–º–µ–Ω–∞ –æ–ø–ª–∞—Ç—ã");
            btn.disabled = false;
            btn.textContent = "–û–ü–õ–ê–¢–ò–¢–¨ TON";
            btn.style.background = "";
        }
    };

    function checkPaymentLoop() {
        let attempts = 0;
        const interval = setInterval(async () => {
            attempts++;
            if(attempts > 30) { // –ñ–¥–µ–º 2.5 –º–∏–Ω—É—Ç—ã
                clearInterval(interval);
                tg.showAlert("–ü–æ–∫–∞ –Ω–µ –≤–∏–¥–∏–º –æ–ø–ª–∞—Ç—É. –ü—Ä–æ–≤–µ—Ä—å –±–∞–ª–∞–Ω—Å –ø–æ–∑–∂–µ.");
                return;
            }

            try {
                // –°—Ç—É—á–∏–º—Å—è –≤ –Ω–∞—à –µ–¥–∏–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
                const res = await fetch('/api/bot', { 
                    method: 'POST',
                    headers: {'Content-Type':'application/json', 'X-Telegram-Data':tg.initData},
                    body: JSON.stringify({ action: 'check_ton' }) 
                }).then(r => r.json());

                if (res.success) {
                    clearInterval(interval);
                    tg.showAlert(`–£–°–ü–ï–•! +${res.addedStars} –∑–≤–µ–∑–¥!`);
                    refreshBalance();
                    document.getElementById('payTonBtn').textContent = "–£–°–ü–ï–• ‚úÖ";
                    document.getElementById('payTonBtn').style.background = "#2ad06c";
                }
            } catch(e) {}
        }, 5000);
    }

    // === PAYMENT: STARS ===
    document.getElementById('payStarsBtn').onclick = async () => {
        const inp = document.getElementById('starsInput');
        const btn = document.getElementById('payStarsBtn');
        const amount = parseInt(inp.value);
        
        if(!amount || amount < 1) return tg.showAlert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É!');
        
        btn.disabled = true;
        btn.textContent = '...';

        try {
            const inv = await fetch('/api/create-stars-invoice', {
                method:'POST',
                headers:{'Content-Type':'application/json', 'X-Telegram-Data':tg.initData},
                body: JSON.stringify({ amount })
            }).then(r=>r.json());

            if(tg.openInvoice) {
                tg.openInvoice(inv.invoice_url, (status) => {
                    if(status === 'paid') {
                        tg.showAlert(`–£—Å–ø–µ—à–Ω–æ! +${amount} ‚òÖ`);
                        refreshBalance();
                        inp.value = '';
                    }
                    btn.disabled = false;
                    btn.textContent = '–ö—É–ø–∏—Ç—å –ó–≤–µ–∑–¥—ã';
                });
            } else {
                tg.openLink(inv.invoice_url);
                btn.disabled = false;
            }
        } catch(e) {
            tg.showAlert('–û—à–∏–±–∫–∞');
            btn.disabled = false;
            btn.textContent = '–ö—É–ø–∏—Ç—å –ó–≤–µ–∑–¥—ã';
        }
    };

    // –ë–∞–ª–∞–Ω—Å
    async function refreshBalance() {
        fetch('/api/profile', {headers:{'X-Telegram-Data':tg.initData}}).then(r=>r.json()).then(d=>{if(d.stars!==undefined) balEl.textContent=d.stars});
    }
    refreshBalance();

  </script>
</body>
</html>
