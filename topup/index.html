<script>
    const tg = window.Telegram.WebApp;
    
    // === НАСТРОЙКИ ===
    // Вставь сюда СВОЙ кошелек!
    const MY_WALLET_ADDRESS = "UQAWibvuLtk2ftlol9ep9YbL_fK1sKeV3HMFObsVfpHIo86W"; 
    const TON_RATE = 110; 

    // Init
    function initApp() {
        tg.ready();
        try { tg.expand(); } catch (e) {}
        try { tg.setHeaderColor('#0b0d12'); tg.setBackgroundColor('#0b0d12'); } catch (e) {}
    }
    initApp();

    const balEl = document.getElementById('balanceValue');
    const starsForm = document.getElementById('starsForm');
    const tonForm = document.getElementById('tonForm');
    const tabs = document.querySelectorAll('.tab');
    const tonInp = document.getElementById('tonInput');
    const calcVal = document.getElementById('calcStars');

    // === TON CONNECT ===
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: window.location.origin + '/tonconnect-manifest.json',
        buttonRootId: 'ton-connect-ui'
    });

    tonConnectUI.onStatusChange(wallet => {
        const tonInputs = document.getElementById('tonInputs');
        const connectHint = document.getElementById('connectHint');
        if (wallet) {
            tonInputs.classList.remove('hidden');
            connectHint.classList.add('hidden');
        } else {
            tonInputs.classList.add('hidden');
            connectHint.classList.remove('hidden');
        }
    });

    // === ЛОГИКА ОПЛАТЫ TON (ИСПРАВЛЕННАЯ) ===
    let checkInterval = null;

    document.getElementById('payTonBtn').onclick = async () => {
        const amount = parseFloat(tonInp.value);
        if(!amount || amount < 0.1) return tg.showAlert("Минимум 0.1 TON");

        const btn = document.getElementById('payTonBtn');
        
        try {
            // 1. Готовим Payload
            const userId = tg.initDataUnsafe?.user?.id || '0';
            const comment = `user_${userId}`;
            
            const tonweb = new TonWeb();
            const cell = new TonWeb.boc.Cell();
            cell.bits.writeUint(0, 32); 
            cell.bits.writeString(comment);
            const payload = TonWeb.utils.bytesToBase64(await cell.toBoc());

            // 2. Готовим транзакцию
            const amountNano = Math.floor(amount * 1000000000).toString();
            const transaction = {
                validUntil: Math.floor(Date.now() / 1000) + 1200, // 20 минут валидности
                messages: [{
                    address: MY_WALLET_ADDRESS,
                    amount: amountNano,
                    payload: payload
                }]
            };

            // 3. Блокируем кнопку
            btn.disabled = true;
            btn.textContent = "ОТКРЫВАЕМ КОШЕЛЕК...";

            // 4. ЗАПУСК ОТПРАВКИ (Без await, чтобы не блочить наш UI)
            const sendPromise = tonConnectUI.sendTransaction(transaction);

            // 5. ФОРСИРОВАННЫЙ ПЕРЕХОД В РЕЖИМ ПРОВЕРКИ
            // Если через 4 секунды TonConnect не вернул ошибку/успех, 
            // мы считаем, что юзер ушел в кошелек, и меняем интерфейс.
            setTimeout(() => {
                btn.textContent = "ПРОВЕРЯЕМ ОПЛАТУ... ⏳";
                btn.style.background = "#ffd400"; // Желтый цвет ожидания
                btn.style.color = "#000";
                
                // Запускаем долгую проверку
                startLongPolling();
            }, 4000);

            // Обработка ответа от кошелька (если он придет)
            sendPromise.then(() => {
                // Если кошелек быстро ответил "ОК"
                tg.showAlert("Транзакция подписана! Ждем блокчейн...");
            }).catch((e) => {
                // Если юзер нажал "Отмена" в кошельке или ошибка
                console.warn(e);
                // Но мы не отменяем проверку сразу, вдруг он все-таки отправил?
                // (Оставляем проверку работать в фоне, но кнопку можно разблокировать через время)
            });

        } catch (e) {
            console.error(e);
            tg.showAlert("Ошибка подготовки");
            btn.disabled = false;
            btn.textContent = "ОПЛАТИТЬ TON";
        }
    };

    function startLongPolling() {
        if (checkInterval) clearInterval(checkInterval);
        
        let attempts = 0;
        const maxAttempts = 60; // 60 раз * 5 сек = 5 минут ожидания

        checkInterval = setInterval(async () => {
            attempts++;
            
            // Если прошло 5 минут и ничего нет
            if (attempts > maxAttempts) {
                clearInterval(checkInterval);
                tg.showAlert("Время вышло. Если списались деньги — напиши в поддержку.");
                
                const btn = document.getElementById('payTonBtn');
                btn.disabled = false;
                btn.textContent = "Я ОПЛАТИЛ (ПРОВЕРИТЬ ЕЩЕ)";
                btn.style.background = "";
                btn.style.color = "";
                return;
            }

            try {
                // Стучимся на сервер
                const res = await fetch('/api/bot', { 
                    method: 'POST',
                    headers: {'Content-Type':'application/json', 'X-Telegram-Data':tg.initData},
                    body: JSON.stringify({ action: 'check_ton' }) 
                }).then(r => r.json());

                if (res.success) {
                    clearInterval(checkInterval);
                    if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                    
                    tg.showAlert(`УСПЕХ! +${res.addedStars} звезд!`);
                    refreshBalance();
                    
                    const btn = document.getElementById('payTonBtn');
                    btn.textContent = "УСПЕХ ✅";
                    btn.style.background = "#2ad06c";
                    btn.style.color = "#fff";
                    btn.disabled = true;
                }
            } catch(e) { 
                console.error("Check error", e); 
            }
        }, 5000); // Каждые 5 секунд
    }

    // === ОСТАЛЬНОЙ JS (Табы, Stars и т.д.) ===
    window.switchTab = (mode) => {
        if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        if (mode === 'stars') {
            starsForm.classList.remove('hidden');
            tonForm.classList.add('hidden');
            tabs[0].classList.add('active');
            tabs[1].classList.remove('active');
        } else {
            starsForm.classList.add('hidden');
            tonForm.classList.remove('hidden');
            tabs[0].classList.remove('active');
            tabs[1].classList.add('active');
        }
    };

    tonInp.addEventListener('input', () => {
        const val = parseFloat(tonInp.value) || 0;
        calcVal.textContent = Math.floor(val * TON_RATE);
    });

    document.getElementById('payStarsBtn').onclick = async () => {
        const inp = document.getElementById('starsInput');
        const btn = document.getElementById('payStarsBtn');
        const amount = parseInt(inp.value);
        if(!amount || amount < 1) return tg.showAlert('Введите сумму!');
        
        btn.disabled = true;
        btn.textContent = '...';
        try {
            const inv = await fetch('/api/create-stars-invoice', {
                method:'POST',
                headers:{'Content-Type':'application/json', 'X-Telegram-Data':tg.initData},
                body: JSON.stringify({ amount })
            }).then(r=>r.json());

            if(tg.openInvoice) {
                tg.openInvoice(inv.invoice_url, (status) => {
                    if(status === 'paid') {
                        tg.showAlert(`Успешно! +${amount} ★`);
                        refreshBalance();
                        inp.value = '';
                    }
                    btn.disabled = false;
                    btn.textContent = 'Купить Звезды';
                });
            } else {
                tg.openLink(inv.invoice_url);
                btn.disabled = false;
            }
        } catch(e) {
            btn.disabled = false;
            btn.textContent = 'Купить Звезды';
        }
    };

    async function refreshBalance() {
        fetch('/api/profile', {headers:{'X-Telegram-Data':tg.initData}}).then(r=>r.json()).then(d=>{if(d.stars!==undefined) balEl.textContent=d.stars});
    }
    refreshBalance();
</script>
