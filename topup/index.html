<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  (async () => {
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // Автоподстановка юзернейма
    try {
      const u = tg.initDataUnsafe && tg.initDataUnsafe.user;
      if (u && u.username) {
        const userInput = document.querySelector('#topup-username');
        if (userInput) userInput.value = '@' + u.username;
      }
    } catch (_) {}

    const amountInput = document.querySelector('#topup-amount');
    const payBtn = document.querySelector('#topup-submit');

    if (!payBtn) return;

    payBtn.addEventListener('click', async () => {
      const raw = (amountInput && amountInput.value || '').trim();
      const amount = Number(raw);

      if (!Number.isInteger(amount) || amount <= 0) {
        tg.showAlert('Укажи количество звёзд (целое число > 0)');
        return;
      }

      payBtn.disabled = true;

      try {
        const res = await fetch('/api/create-stars-invoice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            initData: tg.initData,
            amount
          })
        }).then(r => r.json());

        console.log('create-stars-invoice:', res);

        if (!res.ok) {
          const msg =
            res.tg?.description ||
            res.reason ||
            'Неизвестная ошибка при создании счёта';
          tg.showAlert('Ошибка при создании счёта:\n' + msg);
          return;
        }

        if (!res.link) {
          tg.showAlert('Сервер не вернул ссылку на платёж');
          return;
        }

        // Открываем звёздный инвойс
        tg.openTelegramLink(res.link);
      } catch (e) {
        console.error(e);
        tg.showAlert('Ошибка сети при создании счёта');
      } finally {
        payBtn.disabled = false;
      }
    });
  })();
</script>
