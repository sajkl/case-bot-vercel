<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>–ü–æ–ø–æ–ª–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –∑–≤—ë–∑–¥–∞–º–∏ ‚Äî Lambo Drop</title>
  <link rel="stylesheet" href="/styles.css?v=13">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">

    <!-- –®–∞–ø–∫–∞ -->
    <header class="header">
      <a class="back" href="/profile/"><span>–ó–∞–∫—Ä—ã—Ç—å</span></a>
      <img class="logo" src="/assets/logo.png" alt="LAMBO DROP" style="height:32px;">
      <div class="balance" id="balance">
        <span class="star">‚òÖ</span><span class="value" id="balanceValue">0</span>
      </div>
    </header>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è -->
    <main class="topup-page">

      <!-- –ë–æ–ª—å—à–∞—è –∑–≤–µ–∑–¥–∞ -->
      <section class="topup-hero">
        <!-- –ü–æ–ª–æ–∂–∏ —Å—é–¥–∞ —Å–≤–æ—é –∫–∞—Ä—Ç–∏–Ω–∫—É –∑–≤–µ–∑–¥—ã -->
        <img class="big-star" src="/assets/topup-star.png" alt="–ó–≤–µ–∑–¥–∞">
      </section>

      <!-- –¢—ë–º–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º -->
      <section class="topup-card">
        <h1>–ü–æ–ø–æ–ª–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç<br>–∑–≤—ë–∑–¥–∞–º–∏</h1>
      </section>

      <!-- –ü–æ–ª—è –≤–≤–æ–¥–∞ -->
      <section class="topup-form">

        <!-- –Æ–∑–µ—Ä–Ω–µ–π–º -->
        <div class="topup-row">
          <span class="topup-icon">@</span>
          <input
            id="topup-username"
            type="text"
            placeholder="–Æ–∑–µ—Ä–Ω–µ–π–º">
          <button id="topup-self" class="topup-chip">–°–µ–±–µ</button>
        </div>

        <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥ -->
        <div class="topup-row">
          <span class="topup-icon">‚òÖ</span>
          <input
            id="topup-amount"
            type="number"
            min="1"
            step="1"
            placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥"
            value="10">
        </div>

      </section>

      <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ -->
      <button id="topup-submit" class="primary xl topup-submit">
        –ü–æ–ø–æ–ª–Ω–∏—Ç—å
      </button>

    </main>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å–Ω–∏–∑—É -->
    <div class="nav-spacer" aria-hidden="true"></div>
    <nav class="nav">
      <a class="btn" href="/profile/">–ü—Ä–æ—Ñ–∏–ª—å</a>
      <a class="btn" href="/vote/">–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</a>
    </nav>
  </div>

  <!-- –õ–û–ì–ò–ö–ê –ü–û–ü–û–õ–ù–ï–ù–ò–Ø -->
<script>
  (async () => {
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const usernameInput = document.getElementById('topup-username');
    const selfBtn       = document.getElementById('topup-self');
    const amountInput   = document.getElementById('topup-amount');
    const submitBtn     = document.getElementById('topup-submit');
    const balEl         = document.getElementById('balanceValue');

    // 1) –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º —é–∑–µ—Ä–∞ –∏ –±–∞–ª–∞–Ω—Å
    async function loadProfile() {
      try {
        const unsafeUser = tg.initDataUnsafe && tg.initDataUnsafe.user;
        if (unsafeUser && unsafeUser.username && usernameInput && !usernameInput.value) {
          usernameInput.value = '@' + unsafeUser.username;
        }

        const prof = await fetch('/api/profile', { credentials:'include' })
          .then(r => r.ok ? r.json() : null)
          .catch(() => null);

        if (prof && typeof prof.stars !== 'undefined') {
          balEl.textContent = prof.stars;
        }
      } catch (e) {
        console.warn('init topup error', e);
      }
    }

    await loadProfile();

    // 2) –ö–Ω–æ–ø–∫–∞ "–°–µ–±–µ"
    if (selfBtn) {
      selfBtn.addEventListener('click', () => {
        try {
          const u = tg.initDataUnsafe && tg.initDataUnsafe.user;
          if (u && u.username) {
            usernameInput.value = '@' + u.username;
          } else {
            tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å username –∏–∑ Telegram');
          }
        } catch (e) {
          console.warn(e);
        }
      });
    }

    // 3) –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–∞ –∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ –æ–ø–ª–∞—Ç—ã –≤ –º–∏–Ω–∏-–∞–ø–ø–µ
    async function createAndOpenInvoice() {
      const raw = (amountInput && amountInput.value || '').trim();
      const amount = Number(raw);

      if (!Number.isInteger(amount) || amount <= 0) {
        tg.showAlert('–£–∫–∞–∂–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥ (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ > 0)');
        return;
      }

      submitBtn.disabled = true;

      try {
        const payload = {
          amount,
          username: (usernameInput && usernameInput.value || '').trim()
        };

        const res = await fetch('/api/create-stars-invoice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        }).then(r => r.json());

        console.log('create-stars-invoice:', res);

        if (!res || !res.ok) {
          const msg =
            (res && res.tg && res.tg.description) ||
            (res && res.reason) ||
            '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á—ë—Ç–∞';
          tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á—ë—Ç–∞:\n' + msg);
          return;
        }

        if (!res.invoice_url) {
          tg.showAlert('–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª —Å—Å—ã–ª–∫—É –Ω–∞ —Å—á—ë—Ç');
          return;
        }

        if (!tg.openInvoice) {
          // fallback, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –∫–ª–∏–µ–Ω—Ç —Å—Ç–∞—Ä—ã–π –∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç openInvoice
          tg.showAlert('–û–ø–ª–∞—Ç–∞ –≤ Mini App –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —ç—Ç–æ–º –∫–ª–∏–µ–Ω—Ç–µ Telegram.\n' +
                       '–°—á—ë—Ç: ' + res.invoice_url);
          return;
        }

        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–ª–∞—Ç—ë–∂ Stars –≤–Ω—É—Ç—Ä–∏ –º–∏–Ω–∏-–∞–ø–ø–∞
        tg.openInvoice(res.invoice_url, async (status) => {
          console.log('invoice status:', status);

          if (status === 'paid') {
            tg.showAlert('–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –ó–≤—ë–∑–¥—ã —Å–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–µ üëå');

            // –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
            try {
              await loadProfile();
            } catch (e) {
              console.warn('profile reload error', e);
            }
          } else if (status === 'cancelled') {
            tg.showAlert('–û–ø–ª–∞—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞');
          } else if (status === 'failed') {
            tg.showAlert('–û–ø–ª–∞—Ç–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑');
          } else {
            tg.showAlert('–°—á—ë—Ç –∑–∞–∫—Ä—ã—Ç —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º: ' + status);
          }
        });

      } catch (e) {
        console.error('buyStars error', e);
        tg.showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á—ë—Ç–∞');
      } finally {
        submitBtn.disabled = false;
      }
    }

    if (submitBtn) {
      submitBtn.addEventListener('click', (e) => {
        e.preventDefault();
        createAndOpenInvoice();
      });
    }
  })();
</script>


</body>
</html>
