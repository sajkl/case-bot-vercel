<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å ‚Äî Lambo Drop</title>
  <link rel="stylesheet" href="/styles.css?v=14">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* –õ–æ–∫–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    body {
        background: #0b0d12;
        color: #fff;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }
    .container {
        padding: 0 16px;
        max-width: 480px;
        margin: 0 auto;
        width: 100%;
        box-sizing: border-box;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    /* –ì–µ—Ä–æ–π-—Å–µ–∫—Ü–∏—è —Å–æ –∑–≤–µ–∑–¥–æ–π */
    .topup-hero {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        margin-bottom: 20px;
    }
    .big-star {
        width: 120px;
        height: 120px;
        filter: drop-shadow(0 0 30px rgba(255, 212, 0, 0.4));
        animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
    .topup-title {
        text-align: center;
        margin-bottom: 30px;
    }
    .topup-title h1 {
        font-size: 28px;
        font-weight: 900;
        line-height: 1.1;
        margin: 0;
        text-transform: uppercase;
        background: linear-gradient(180deg, #fff, #bbb);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    /* –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ */
    .topup-form {
        background: #151921;
        border: 1px solid #232838;
        border-radius: 20px;
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .input-group {
        position: relative;
        margin-bottom: 10px;
    }
    
    .input-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 20px;
        color: var(--accent);
        pointer-events: none;
    }

    .topup-input {
        width: 100%;
        background: #0b0d12;
        border: 1px solid #2a2f3d;
        color: #fff;
        font-size: 24px;
        font-weight: 800;
        padding: 16px 16px 16px 50px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ –∏–∫–æ–Ω–∫—É */
        border-radius: 12px;
        outline: none;
        transition: border-color 0.2s;
        box-sizing: border-box; /* –í–∞–∂–Ω–æ —á—Ç–æ–±—ã –Ω–µ –≤—ã–ª–µ–∑–∞–ª–æ */
    }
    .topup-input:focus {
        border-color: var(--accent);
    }

    .helper-text {
        text-align: center;
        color: #777;
        font-size: 13px;
        margin-top: 12px;
    }

    /* –ö–Ω–æ–ø–∫–∞ */
    .btn-pay {
        width: 100%;
        background: var(--accent);
        color: #000;
        border: none;
        padding: 18px;
        border-radius: 16px;
        font-size: 18px;
        font-weight: 900;
        text-transform: uppercase;
        cursor: pointer;
        transition: transform 0.1s;
        box-shadow: 0 4px 20px rgba(255, 212, 0, 0.25);
    }
    .btn-pay:active {
        transform: scale(0.96);
    }
    .btn-pay:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

  </style>
</head>
<body>

  <div class="container">
    <header class="header">
      <a class="back" href="/profile/">‚Üê –ù–∞–∑–∞–¥</a>
      <img class="logo" src="/assets/logo.png" alt="LAMBO" style="height:32px;">
      <div class="balance">
        <span class="star">‚òÖ</span><span class="value" id="balanceValue">...</span>
      </div>
    </header>

    <main style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
        
        <section class="topup-hero">
            <img class="big-star" src="/assets/star-big.png" onerror="this.style.display='none'" alt="‚òÖ">
        </section>

        <section class="topup-title">
            <h1>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ<br>–ë–∞–ª–∞–Ω—Å–∞</h1>
        </section>

        <section class="topup-form">
            <div class="input-group">
                <span class="input-icon">‚òÖ</span>
                <input 
                    id="topup-amount" 
                    class="topup-input" 
                    type="number" 
                    inputmode="numeric" 
                    min="1" 
                    step="1" 
                    placeholder="100" 
                    value="50"
                >
            </div>
            
            <button id="topup-submit" class="btn-pay">
                –ö—É–ø–∏—Ç—å –ó–≤–µ–∑–¥—ã
            </button>
            
            <div class="helper-text">
                –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Telegram Stars.<br>–ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.
            </div>
        </section>

    </main>

    <div class="nav-spacer" style="height: 80px;"></div>
    <nav class="nav">
      <a class="btn" href="/">–ö–µ–π—Å—ã</a>
      <a class="btn" href="/crash.html">Crash üöÄ</a>
      <a class="btn active" href="/profile/">–ü—Ä–æ—Ñ–∏–ª—å</a>
    </nav>
  </div>

  <script>
  (async () => {
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const amountInput = document.getElementById('topup-amount');
    const submitBtn   = document.getElementById('topup-submit');
    const balEl       = document.getElementById('balanceValue');

    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å
    async function loadBalance() {
        try {
            const prof = await fetch('/api/profile', { 
                headers: {'X-Telegram-Data': tg.initData} 
            }).then(r => r.json());
            
            if (prof && typeof prof.stars !== 'undefined') {
                balEl.textContent = prof.stars;
            }
        } catch (e) { console.error(e); }
    }
    loadBalance();

    // 2. –õ–æ–≥–∏–∫–∞ –æ–ø–ª–∞—Ç—ã
    submitBtn.addEventListener('click', async () => {
        const amount = parseInt(amountInput.value);
        if (!amount || amount < 1) return tg.showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É!');

        submitBtn.disabled = true;
        submitBtn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ —Å—á–µ—Ç–∞...';

        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–∞
            // –í–∞–∂–Ω–æ: –º—ã –Ω–µ –ø–µ—Ä–µ–¥–∞–µ–º username, —Å–µ—Ä–≤–µ—Ä —Å–∞–º –≤–æ–∑—å–º–µ—Ç –µ–≥–æ –∏–∑ initData (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)
            const res = await fetch('/api/create-stars-invoice', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-Telegram-Data': tg.initData // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
                },
                body: JSON.stringify({ amount })
            }).then(r => r.json());

            if (!res.ok) {
                tg.showAlert('–û—à–∏–±–∫–∞: ' + (res.reason || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—á–µ—Ç'));
                resetBtn();
                return;
            }

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Ç–∏–≤–Ω—É—é –æ–ø–ª–∞—Ç—É
            if (tg.openInvoice) {
                tg.openInvoice(res.invoice_url, async (status) => {
                    if (status === 'paid') {
                        tg.showAlert(`–£—Å–ø–µ—à–Ω–æ! +${amount} –∑–≤–µ–∑–¥ –∑–∞—á–∏—Å–ª–µ–Ω–æ.`);
                        submitBtn.textContent = '–£—Å–ø–µ—à–Ω–æ!';
                        setTimeout(() => {
                            resetBtn();
                            loadBalance(); // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
                            amountInput.value = '';
                        }, 2000);
                    } else if (status === 'cancelled') {
                        resetBtn();
                    } else {
                        tg.showAlert('–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã: ' + status);
                        resetBtn();
                    }
                });
            } else {
                // –§–æ–ª–ª–±–µ–∫ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (–æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É)
                tg.openLink(res.invoice_url);
                resetBtn();
            }

        } catch (e) {
            console.error(e);
            tg.showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            resetBtn();
        }
    });

    function resetBtn() {
        submitBtn.disabled = false;
        submitBtn.textContent = '–ö—É–ø–∏—Ç—å –ó–≤–µ–∑–¥—ã';
    }

  })();
  </script>
</body>
</html>
