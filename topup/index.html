<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Покупка звёзд — Lambo Drop</title>
  <link rel="stylesheet" href="/styles.css?v=13">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">

    <!-- Шапка -->
    <header class="header">
      <a class="back" href="/profile/"><span>Закрыть</span></a>
      <img class="logo" src="/assets/logo.png" alt="LAMBO DROP" style="height:32px;">
      <div class="balance" id="balance">
        <span class="star">★</span><span class="value" id="balanceValue">0</span>
      </div>
    </header>

    <!-- Контент пополнения -->
    <main class="topup-page">

      <!-- Картинка сверху (если захочешь – подставь свою) -->
      <div class="topup-art">
        <!-- <img src="/assets/topup-star.png" alt=""> -->
      </div>

      <h1 class="topup-title">Покупка звёзд</h1>
      <p class="topup-subtitle">На Telegram аккаунт и без KYC</p>
      <p class="topup-note">
        После покупки вы получите звёзды на аккаунт Telegram (не на баланс приложения)!
      </p>

      <!-- Поле юзернейма -->
      <section class="topup-field">
        <div class="label">@ Юзернейм</div>
        <div class="field-with-button">
          <input
            id="topup-username"
            type="text"
            class="input"
            placeholder="@username">
          <button id="topup-self" class="small-btn">Себе</button>
        </div>
      </section>

      <!-- Поле количества звёзд -->
      <section class="topup-field">
        <div class="label">★ Количество звёзд</div>
        <input
          id="topup-amount"
          type="number"
          class="input"
          min="1"
          step="1"
          value="10">
      </section>

      <!-- Основная кнопка -->
      <button id="topup-submit" class="primary big-btn">
        Пополнить
      </button>

    </main>

    <!-- Навигация снизу -->
    <div class="nav-spacer" aria-hidden="true"></div>
    <nav class="nav">
      <a class="btn" href="/profile/">Профиль</a>
      <a class="btn" href="/vote/">Голосование</a>
    </nav>
  </div>

  <!-- ЛОГИКА ПОПОЛНЕНИЯ -->
  <script>
  (async () => {
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const usernameInput = document.getElementById('topup-username');
    const selfBtn       = document.getElementById('topup-self');
    const amountInput   = document.getElementById('topup-amount');
    const submitBtn     = document.getElementById('topup-submit');
    const balEl         = document.getElementById('balanceValue');

    // 1) Подтягиваем юзера и баланс
    try {
      const unsafeUser = tg.initDataUnsafe && tg.initDataUnsafe.user;
      if (unsafeUser && unsafeUser.username && usernameInput && !usernameInput.value) {
        usernameInput.value = '@' + unsafeUser.username;
      }

      const prof = await fetch('/api/profile')
        .then(r => r.ok ? r.json() : null)
        .catch(() => null);

      if (prof && typeof prof.stars !== 'undefined') {
        balEl.textContent = prof.stars;
      }
    } catch (e) {
      console.warn('init topup error', e);
    }

    // 2) Кнопка "Себе" — подставляем текущий username
    if (selfBtn) {
      selfBtn.addEventListener('click', () => {
        try {
          const u = tg.initDataUnsafe && tg.initDataUnsafe.user;
          if (u && u.username) {
            usernameInput.value = '@' + u.username;
          } else {
            tg.showAlert('Не удалось получить username из Telegram');
          }
        } catch (e) {
          console.warn(e);
        }
      });
    }

    // 3) Создание инвойса и открытие оплаты
    async function createAndOpenInvoice() {
      const raw = (amountInput && amountInput.value || '').trim();
      const amount = Number(raw);

      if (!Number.isInteger(amount) || amount <= 0) {
        tg.showAlert('Укажи количество звёзд (целое число > 0)');
        return;
      }

      submitBtn.disabled = true;

      try {
        const payload = {
          initData: tg.initData,   // сырые данные от Telegram для проверки на бэке
          amount,
          username: (usernameInput && usernameInput.value || '').trim()
        };

        const res = await fetch('/api/create-stars-invoice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(r => r.json());

        console.log('create-stars-invoice:', res);

        if (!res.ok) {
          const msg =
            (res.tg && res.tg.description) ||
            res.reason ||
            'Неизвестная ошибка при создании счёта';
          tg.showAlert('Ошибка при создании счёта:\n' + msg);
          return;
        }

        if (!res.link) {
          tg.showAlert('Сервер не вернул ссылку на платёж');
          return;
        }

        // Открываем инвойс в Stars (через Telegram)
        if (typeof tg.openInvoice === 'function') {
          // если позже будешь использовать openInvoice
          tg.openTelegramLink(res.link);
        } else {
          tg.openTelegramLink(res.link);
        }
      } catch (e) {
        console.error('buyStars error', e);
        tg.showAlert('Ошибка сети при создании счёта');
      } finally {
        submitBtn.disabled = false;
      }
    }

    if (submitBtn) {
      submitBtn.addEventListener('click', (e) => {
        e.preventDefault();
        createAndOpenInvoice();
      });
    }
  })();
  </script>
</body>
</html>
