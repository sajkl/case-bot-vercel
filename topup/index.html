<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>–ü–æ–∫—É–ø–∫–∞ –∑–≤—ë–∑–¥ ‚Äî Lambo Drop</title>
  <link rel="stylesheet" href="/styles.css?v=13">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">

    <!-- –®–∞–ø–∫–∞ -->
    <header class="header">
      <a class="back" href="/profile/"><span>–ó–∞–∫—Ä—ã—Ç—å</span></a>
      <img class="logo" src="/assets/logo.png" alt="LAMBO DROP" style="height:32px;">
      <div class="balance" id="balance">
        <span class="star">‚òÖ</span><span class="value" id="balanceValue">0</span>
      </div>
    </header>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è -->
    <main class="topup-page">

      <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å–≤–µ—Ä—Ö—É (–µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å ‚Äì –ø–æ–¥—Å—Ç–∞–≤—å —Å–≤–æ—é) -->
      <div class="topup-art">
        <!-- <img src="/assets/topup-star.png" alt=""> -->
      </div>

      <h1 class="topup-title">–ü–æ–∫—É–ø–∫–∞ –∑–≤—ë–∑–¥</h1>
      <p class="topup-subtitle">–ù–∞ Telegram –∞–∫–∫–∞—É–Ω—Ç –∏ –±–µ–∑ KYC</p>
      <p class="topup-note">
        –ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –∑–≤—ë–∑–¥—ã –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç Telegram (–Ω–µ –Ω–∞ –±–∞–ª–∞–Ω—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)!
      </p>

      <!-- –ü–æ–ª–µ —é–∑–µ—Ä–Ω–µ–π–º–∞ -->
      <section class="topup-field">
        <div class="label">@ –Æ–∑–µ—Ä–Ω–µ–π–º</div>
        <div class="field-with-button">
          <input
            id="topup-username"
            type="text"
            class="input"
            placeholder="@username">
          <button id="topup-self" class="small-btn">–°–µ–±–µ</button>
        </div>
      </section>

      <!-- –ü–æ–ª–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–≤—ë–∑–¥ -->
      <section class="topup-field">
        <div class="label">‚òÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥</div>
        <input
          id="topup-amount"
          type="number"
          class="input"
          min="1"
          step="1"
          value="10">
      </section>

      <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ -->
      <button id="topup-submit" class="primary big-btn">
        –ü–æ–ø–æ–ª–Ω–∏—Ç—å
      </button>

    </main>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å–Ω–∏–∑—É -->
    <div class="nav-spacer" aria-hidden="true"></div>
    <nav class="nav">
      <a class="btn" href="/profile/">–ü—Ä–æ—Ñ–∏–ª—å</a>
      <a class="btn" href="/vote/">–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</a>
    </nav>
  </div>

  <!-- –õ–û–ì–ò–ö–ê –ü–û–ü–û–õ–ù–ï–ù–ò–Ø -->
  <script>
  (async () => {
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const usernameInput = document.getElementById('topup-username');
    const selfBtn       = document.getElementById('topup-self');
    const amountInput   = document.getElementById('topup-amount');
    const submitBtn     = document.getElementById('topup-submit');
    const balEl         = document.getElementById('balanceValue');

    // 1) –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º —é–∑–µ—Ä–∞ –∏ –±–∞–ª–∞–Ω—Å
    try {
      const unsafeUser = tg.initDataUnsafe && tg.initDataUnsafe.user;
      if (unsafeUser && unsafeUser.username && usernameInput && !usernameInput.value) {
        usernameInput.value = '@' + unsafeUser.username;
      }

      const prof = await fetch('/api/profile', { credentials:'include' })
        .then(r => r.ok ? r.json() : null)
        .catch(() => null);

      if (prof && typeof prof.stars !== 'undefined') {
        balEl.textContent = prof.stars;
      }
    } catch (e) {
      console.warn('init topup error', e);
    }

    // 2) –ö–Ω–æ–ø–∫–∞ "–°–µ–±–µ"
    if (selfBtn) {
      selfBtn.addEventListener('click', () => {
        try {
          const u = tg.initDataUnsafe && tg.initDataUnsafe.user;
          if (u && u.username) {
            usernameInput.value = '@' + u.username;
          } else {
            tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å username –∏–∑ Telegram');
          }
        } catch (e) {
          console.warn(e);
        }
      });
    }

    // 3) –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–∞
    async function createAndOpenInvoice() {
      const raw = (amountInput && amountInput.value || '').trim();
      const amount = Number(raw);

      if (!Number.isInteger(amount) || amount <= 0) {
        tg.showAlert('–£–∫–∞–∂–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥ (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ > 0)');
        return;
      }

      submitBtn.disabled = true;

      try {
        const payload = {
          amount,
          username: (usernameInput && usernameInput.value || '').trim()
        };

        const res = await fetch('/api/create-stars-invoice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',              // <-- –≤–∞–∂–Ω–æ! –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º sid
          body: JSON.stringify(payload)
        }).then(r => r.json());

        console.log('create-stars-invoice:', res);

        if (!res.ok) {
          const msg =
            (res.tg && res.tg.description) ||
            res.reason ||
            '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á—ë—Ç–∞';
          tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á—ë—Ç–∞:\n' + msg);
          return;
        }

    if (!res.ok) {
  const msg =
    (res.tg && res.tg.description) ||
    res.reason ||
    '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á—ë—Ç–∞';
  tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á—ë—Ç–∞:\n' + msg);
  return;
}

// –≤—Å—ë –æ–∫ ‚Äî —Å—á—ë—Ç —É–ª–µ—Ç–µ–ª —Ç–µ–±–µ –≤ –ª–∏—á–∫—É —Å –±–æ—Ç–æ–º
tg.showAlert('–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ —Å—á—ë—Ç –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º,\n–æ–ø–ª–∞—Ç–∏ –µ–≥–æ —Ç–∞–º üëå');

      } catch (e) {
        console.error('buyStars error', e);
        tg.showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á—ë—Ç–∞');
      } finally {
        submitBtn.disabled = false;
      }
    }

    if (submitBtn) {
      submitBtn.addEventListener('click', (e) => {
        e.preventDefault();
        createAndOpenInvoice();
      });
    }
  })();
</script>

</body>
</html>
