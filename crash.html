<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Crash ‚Äî Lambo Drop</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    /* === –°—Ç–∏–ª–∏ Crash (Game Area) === */
    .crash-area {
      position: relative;
      margin: 0 16px 16px;
      height: 260px;
      background: #171b24;
      border-radius: 24px;
      border: 1px solid #232838;
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    
    .crash-info {
      position: relative; z-index: 2; text-align: center;
    }
    .crash-counter {
      font-size: 56px; font-weight: 900; color: #fff;
      font-feature-settings: "tnum";
      text-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .crash-status {
      font-size: 14px; font-weight: 700; color: #a5abb8; text-transform: uppercase; letter-spacing: 1px;
    }
    .crash-counter.crashed { color: var(--b-red); }
    .crash-counter.loading { color: var(--accent); font-size: 42px; }

    /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    .controls-panel {
      margin: 0 16px 20px; padding: 16px;
      background: #1d212b; border-radius: 24px; border: 1px solid #2a2f3d;
    }
    .bet-row { display: flex; gap: 10px; margin-bottom: 12px; }
    .bet-input-wrap {
      flex: 1; background: #11141b;
      border: 1px solid #232838; border-radius: 16px;
      padding: 10px 14px; display: flex; align-items: center; gap: 8px;
    }
    .bet-input {
      width: 100%; background: transparent; border: none;
      color: #fff; font-size: 18px; font-weight: 700; outline: none;
    }
    
    .action-btn {
      width: 100%; padding: 16px; border-radius: 16px;
      font-size: 20px; font-weight: 900; text-transform: uppercase;
      transition: 0.1s; cursor: pointer; border: none;
    }
    .btn-start { background: var(--accent); color: #111; box-shadow: 0 4px 15px rgba(255, 212, 0, 0.3); }
    .btn-cashout { background: #ff9f00; color: #111; box-shadow: 0 0 20px rgba(255, 159, 0, 0.4); }
    .btn-wait { background: #2c313f; color: #777; pointer-events: none; opacity: 0.7; }
    
    .preset-btn {
      background: #2c313f; border: 1px solid #363c4a; color: #fff;
      border-radius: 12px; padding: 0 12px; font-weight: 700; font-size: 13px;
    }

    /* –ò—Å—Ç–æ—Ä–∏—è (pill bar) */
    .history-bar {
      display: flex; gap: 6px; padding: 0 16px 10px;
      overflow-x: auto; scrollbar-width: none;
      mask-image: linear-gradient(to right, black 85%, transparent 100%);
      min-height: 36px; /* –ß—Ç–æ–±—ã –Ω–µ –ø—Ä—ã–≥–∞–ª–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ */
    }
    .hist-pill {
      background: #232838; padding: 5px 10px; border-radius: 8px;
      font-size: 12px; font-weight: 800; color: #a5abb8; white-space: nowrap;
    }
    .hist-pill.high { color: var(--b-green); background: rgba(42, 208, 108, 0.15); }
    .hist-pill.low { color: var(--b-red); background: rgba(255, 77, 77, 0.15); }

    /* === –°–ü–ò–°–û–ö –°–¢–ê–í–û–ö (LIVE BETS) === */
    .bets-container {
      margin: 0 16px 80px; /* –æ—Ç—Å—Ç—É–ø –ø–æ–¥ –Ω–∞–≤–±–∞—Ä */
    }
    .bets-header {
      font-size: 14px; font-weight: 700; color: #a5abb8; margin-bottom: 8px;
      display: flex; justify-content: space-between;
    }
    .bets-list {
      display: flex; flex-direction: column; gap: 8px;
    }
    .player-row {
      display: flex; align-items: center; justify-content: space-between;
      background: #171b24; padding: 10px 14px; border-radius: 14px;
      border: 1px solid #232838;
    }
    .player-info { display: flex; align-items: center; gap: 10px; }
    .player-avatar {
      width: 32px; height: 32px; border-radius: 50%; background: #2c313f;
      display: grid; place-items: center; font-size: 14px; font-weight: 700; color: #777;
    }
    .player-name { font-size: 14px; font-weight: 700; color: #fff; }
    .player-bet { font-size: 14px; font-weight: 700; color: var(--accent); }
    
    .player-win {
      text-align: right;
    }
    .win-mult { display: block; font-size: 12px; color: var(--b-green); font-weight: 800; }
    .win-val { font-size: 14px; font-weight: 800; color: #fff; }
    
    .player-row.success { border-color: rgba(42, 208, 108, 0.3); background: rgba(42, 208, 108, 0.05); }
    .player-row.crash { opacity: 0.6; }

  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <a href="/" class="back" style="text-decoration:none; font-weight:900; font-size:20px;">‚Üê</a>
      <div style="font-weight:900; font-size:20px;">CRASH</div>
      <div class="balance" id="balance">
        <span class="star">‚òÖ</span><span class="value" id="balanceValue">...</span>
      </div>
    </header>

    <div class="history-bar" id="historyBar">
      </div>

    <div class="crash-area">
      <canvas id="gameCanvas"></canvas>
      <div class="crash-info">
        <div class="crash-counter" id="counter">1.00x</div>
        <div class="crash-status" id="statusText">–ó–ê–ì–†–£–ó–ö–ê...</div>
      </div>
    </div>

    <div class="controls-panel">
      <div class="bet-row">
        <div class="bet-input-wrap">
          <span class="star" style="color:var(--accent)">‚òÖ</span>
          <input type="number" id="betAmount" class="bet-input" value="10" placeholder="–°—É–º–º–∞">
        </div>
        <button class="preset-btn" onclick="setBet(50)">50</button>
        <button class="preset-btn" onclick="setBet(100)">100</button>
        <button class="preset-btn" onclick="setBet(500)">500</button>
      </div>
      
      <button id="mainBtn" class="action-btn btn-wait">...</button>
    </div>

    <div class="bets-container">
      <div class="bets-header">
        <span>–ò–ì–†–û–ö–ò</span>
        <span id="playersCount">0</span>
      </div>
      <div class="bets-list" id="betsList">
      </div>
    </div>

    <nav class="nav">
      <a class="btn" href="/profile/">–ü—Ä–æ—Ñ–∏–ª—å</a>
      <a class="btn active" href="/crash.html" style="color:#ffd400;">Crash üöÄ</a>
    </nav>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    // === –≠–õ–ï–ú–ï–ù–¢–´ ===
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const counterEl = document.getElementById('counter');
    const statusEl = document.getElementById('statusText');
    const btn = document.getElementById('mainBtn');
    const balEl = document.getElementById('balanceValue');
    const historyBar = document.getElementById('historyBar');
    const betsListEl = document.getElementById('betsList');
    const playersCountEl = document.getElementById('playersCount');

    // === –ü–ï–†–ï–ú–ï–ù–ù–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø ===
    let myId = tg.initDataUnsafe?.user?.id || 0; // ID —Ç–µ–∫—É—â–µ–≥–æ —é–∑–µ—Ä–∞
    let currentRoundId = null;
    let serverStartTime = 0; // –í—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
    let serverPhase = 'LOADING'; // BETTING, FLYING, CRASHED
    
    let myBet = null; // { id: gameId, amount: 100 } –µ—Å–ª–∏ —è –ø–æ—Å—Ç–∞–≤–∏–ª
    let myCashout = false; // –£—Å–ø–µ–ª –ª–∏ —è –∑–∞–±—Ä–∞—Ç—å

    // === –ì–†–ê–§–ò–ö–ê ===
    let width, height;
    function resize() {
      width = canvas.parentElement.clientWidth;
      height = canvas.parentElement.clientHeight;
      canvas.width = width * 2; canvas.height = height * 2;
      ctx.scale(2, 2);
    }
    window.addEventListener('resize', resize); resize();

    // === –õ–û–ì–ò–ö–ê –û–¢–†–ò–°–û–í–ö–ò ===
    function drawGraph(multiplier) {
      ctx.clearRect(0, 0, width, height);
      if (serverPhase !== 'FLYING' && serverPhase !== 'CRASHED') return;

      // –°–µ—Ç–∫–∞
      ctx.strokeStyle = '#232838'; ctx.lineWidth = 1; ctx.beginPath();
      for(let i=1; i<5; i++) {
        const y = height - (i * height / 5);
        ctx.moveTo(0, y); ctx.lineTo(width, y);
      }
      ctx.stroke();

      // –ö—Ä–∏–≤–∞—è
      ctx.beginPath();
      ctx.lineWidth = 5;
      ctx.strokeStyle = serverPhase === 'CRASHED' ? '#ff4d4d' : '#ffd400';
      ctx.lineCap = 'round';
      
      const startX = 0; const startY = height;
      const endX = width * 0.8; const endY = height * 0.2;

      ctx.moveTo(startX, startY);
      // –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –∫—Ä–∏–≤–æ–π
      ctx.quadraticCurveTo(width * 0.4, height, endX, endY);
      ctx.stroke();

      if (serverPhase === 'FLYING') {
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(endX, endY, 6, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'rgba(255, 212, 0, 0.4)'; ctx.beginPath(); ctx.arc(endX, endY, 15 + Math.sin(Date.now()/50)*4, 0, Math.PI*2); ctx.fill();
      }
    }

    // === –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ (–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è) ===
    function renderLoop() {
      const now = Date.now();

      if (serverPhase === 'BETTING') {
        // –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç
        const timeLeft = Math.max(0, Math.ceil((serverStartTime - now) / 1000));
        counterEl.textContent = `00:0${timeLeft}`;
        counterEl.classList.add('loading');
        statusEl.textContent = "–ü–†–ò–ï–ú –°–¢–ê–í–û–ö";
        ctx.clearRect(0, 0, width, height);
      } 
      else if (serverPhase === 'FLYING') {
        // –°—á–∏—Ç–∞–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
        // –§–æ—Ä–º—É–ª–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–æ–º!
        const ms = now - serverStartTime;
        if (ms < 0) { // –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω –Ω–µ–±–æ–ª—å—à–æ–π
           counterEl.textContent = "1.00x";
        } else {
           const mult = Math.pow(Math.E, 0.00006 * ms);
           counterEl.textContent = mult.toFixed(2) + 'x';
           drawGraph(mult);
        }
        counterEl.classList.remove('loading', 'crashed');
        statusEl.textContent = "–í –ü–û–õ–ï–¢–ï";
      }
      // CRASHED –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ pollState (–∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º —á–∏—Å–ª–æ)
      
      requestAnimationFrame(renderLoop);
    }
    requestAnimationFrame(renderLoop);

    // === –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° –°–ï–†–í–ï–†–û–ú (POLLING) ===
    async function pollState() {
      try {
        const res = await fetch('/api/state').then(r => r.json());
        
        // 1. –ü–ï–†–í–ò–ß–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ò–°–¢–û–†–ò–ò (–ù–û–í–û–ï!)
        if (historyBar.children.length === 0 && res.history && res.history.length > 0) {
           // –°–µ—Ä–≤–µ—Ä –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º. –ü–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ
           for (let i = res.history.length - 1; i >= 0; i--) {
              addHistory(res.history[i]); 
           }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∞–∑—É
        const prevPhase = serverPhase;
        serverPhase = res.phase;
        
        // –ï—Å–ª–∏ –ø—Ä–∏—à–µ–ª –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥
        if (currentRoundId !== res.roundId) {
          currentRoundId = res.roundId;
          // –°–±—Ä–æ—Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
          myBet = null;
          myCashout = false;
          btn.onclick = placeBet; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ —Ä–µ–∂–∏–º —Å—Ç–∞–≤–∫–∏
        }

        // –ï—Å–ª–∏ —Ñ–∞–∑–∞ –ø–æ–º–µ–Ω—è–ª–∞—Å—å –Ω–∞ CRASHED - –¥–æ–±–∞–≤–∏–º –≤ –∏—Å—Ç–æ—Ä–∏—é (live)
        if (prevPhase === 'FLYING' && serverPhase === 'CRASHED') {
           // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏—Å–ª–∞–ª –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–Ω—å—à–µ)
           const lastVal = historyBar.firstElementChild?.textContent;
           const newVal = res.value.toFixed(2) + 'x';
           
           if (lastVal !== newVal) {
              addHistory(res.value); 
           }

           counterEl.textContent = res.value.toFixed(2) + 'x';
           counterEl.classList.add('crashed');
           statusEl.textContent = "CRASHED";
           tg.HapticFeedback.notificationOccurred('error');
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
        renderBets(res.bets);
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å—Ç–∞—Ä—Ç–∞
        if (serverPhase === 'BETTING') {
           serverStartTime = Date.now() + res.value; 
        } else if (serverPhase === 'FLYING') {
           const elapsed = Math.log(res.value) / 0.00006;
           serverStartTime = Date.now() - elapsed;
        }

        updateButtonState();

      } catch (e) {
        console.error("Poll error", e);
      }
    }
    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–ø—Ä–æ—Å
    setInterval(pollState, 1000);
    pollState(); // –°—Ä–∞–∑—É –ø–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤

    // === –ö–ù–û–ü–ö–ê (UI) ===
    function updateButtonState() {
      if (serverPhase === 'BETTING') {
        if (myBet) {
          btn.className = 'action-btn btn-wait';
          btn.textContent = '–ñ–î–ï–ú –í–ó–õ–ï–¢...';
          btn.onclick = null;
        } else {
          btn.className = 'action-btn btn-start';
          btn.textContent = '–°–¢–ê–í–ö–ê';
          btn.onclick = placeBet;
        }
      }
      else if (serverPhase === 'FLYING') {
        if (myBet && !myCashout) {
          btn.className = 'action-btn btn-cashout';
          btn.textContent = '–ó–ê–ë–†–ê–¢–¨';
          btn.onclick = doCashout;
        } else if (myCashout) {
          btn.className = 'action-btn btn-wait';
          btn.textContent = '–£–°–ü–ï–•';
          btn.style.background = '#2ad06c'; // –ó–µ–ª–µ–Ω—ã–π
          btn.style.color = '#fff';
        } else {
          btn.className = 'action-btn btn-wait';
          btn.textContent = '–ñ–î–ï–ú –†–ê–£–ù–î';
          btn.style.background = ''; // –°–±—Ä–æ—Å
        }
      }
      else {
        btn.className = 'action-btn btn-wait';
        btn.textContent = '–ö–†–ê–®';
        btn.style.background = '';
      }
    }

    // === –î–ï–ô–°–¢–í–ò–Ø (API) ===
    async function placeBet() {
      const amount = parseInt(document.getElementById('betAmount').value);
      if(!amount || amount < 1) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");

      btn.textContent = "...";
      btn.disabled = true;

      try {
        const res = await fetch('/api/crash', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-Telegram-Data': tg.initData },
          body: JSON.stringify({ action: 'start', bet: amount })
        }).then(r => r.json());

        if (res.ok) {
          myBet = { id: res.gameId, amount: amount };
          tg.HapticFeedback.impactOccurred('medium');
          if(res.balance) balEl.textContent = res.balance;
        } else {
          tg.showAlert(res.error || "–û—à–∏–±–∫–∞");
        }
      } catch (e) { console.error(e); }
      btn.disabled = false;
      pollState(); // –û–±–Ω–æ–≤–∏–º —Å—Ä–∞–∑—É
    }

    async function doCashout() {
      if (!myBet) return;
      btn.textContent = "...";
      
      try {
        const res = await fetch('/api/crash', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-Telegram-Data': tg.initData },
          body: JSON.stringify({ action: 'cashout', gameId: myBet.id })
        }).then(r => r.json());

        if (res.ok) {
          myCashout = true;
          tg.HapticFeedback.notificationOccurred('success');
          if(res.balance) balEl.textContent = res.balance;
        } else {
          tg.HapticFeedback.notificationOccurred('error');
        }
      } catch(e) { console.error(e); }
      pollState();
    }

    // === –û–¢–†–ò–°–û–í–ö–ê –°–ü–ò–°–ö–ê –ò–ì–†–û–ö–û–í ===
    function renderBets(bets) {
      if(!bets) return;
      playersCountEl.textContent = bets.length;
      
      betsListEl.innerHTML = bets.map(b => {
        const isMe = (b.user_id == myId);
        const isWin = (b.status === 'cashed_out');
        const profit = isWin ? Math.floor(b.bet_amount * b.cashout_point) : 0;
        
        let rowClass = 'player-row';
        if (isWin) rowClass += ' success';
        else if (b.status === 'busted') rowClass += ' crash';

        let name = isMe ? "–í–´" : `User ${b.user_id.toString().slice(0,3)}...`;
        
        return `
        <div class="${rowClass}">
          <div class="player-info">
            <div class="player-avatar">${name[0]}</div>
            <div>
              <div class="player-name">${name}</div>
              <div class="player-bet">${b.bet_amount} ‚òÖ</div>
            </div>
          </div>
          <div class="player-win">
            ${isWin ? `
              <span class="win-mult">${b.cashout_point}x</span>
              <span class="win-val">+${profit}</span>
            ` : (b.status === 'active' ? '<span style="color:#aaa">...</span>' : '')}
          </div>
        </div>
        `;
      }).join('');
    }

    // –•–µ–ª–ø–µ—Ä—ã
    function setBet(val) { document.getElementById('betAmount').value = val; }
    
    function addHistory(val) {
      const el = document.createElement('div');
      const num = parseFloat(val);
      el.className = `hist-pill ${num >= 2.0 ? 'high' : 'low'}`;
      el.textContent = num.toFixed(2) + 'x';
      
      // –í—Å—Ç–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
      historyBar.prepend(el);
      if(historyBar.children.length > 20) historyBar.lastChild.remove();
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    fetch('/api/profile', { headers: { 'X-Telegram-Data': tg.initData } })
      .then(r=>r.json())
      .then(d=>{ if(d.stars) balEl.textContent = d.stars; });

  </script>
</body>
</html>
