<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Crash ‚Äî Lambo Drop</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    /* –°—Ç–∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è Crash */
    .crash-area {
      position: relative;
      margin: 0 16px 16px;
      height: 300px;
      background: #171b24;
      border-radius: 24px;
      border: 1px solid #232838;
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    
    .crash-counter {
      position: relative; z-index: 2;
      font-size: 64px; font-weight: 900; color: #fff;
      font-feature-settings: "tnum";
      text-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .crash-counter.crashed { color: var(--b-red); }

    .controls-panel {
      margin: 0 16px; padding: 18px;
      background: #1d212b; border-radius: 24px; border: 1px solid #2a2f3d;
    }
    .bet-row { display: flex; gap: 12px; margin-bottom: 12px; }
    .bet-input-wrap {
      flex: 1; background: #11141b;
      border: 1px solid #232838; border-radius: 16px;
      padding: 12px 16px; display: flex; align-items: center; gap: 8px;
    }
    .bet-input {
      width: 100%; background: transparent; border: none;
      color: #fff; font-size: 18px; font-weight: 700; outline: none;
    }
    .action-btn {
      width: 100%; padding: 18px; border-radius: 18px;
      font-size: 20px; font-weight: 900; text-transform: uppercase;
      transition: 0.1s; cursor: pointer; border: none;
    }
    .btn-start { background: var(--accent); color: #111; box-shadow: 0 4px 15px rgba(255, 212, 0, 0.3); }
    .btn-cashout { background: #ff9f00; color: #111; box-shadow: 0 0 20px rgba(255, 159, 0, 0.4); }
    .btn-wait { background: #2c313f; color: #777; pointer-events: none; }
    
    /* –ü—Ä–µ—Å–µ—Ç—ã —Å—Ç–∞–≤–æ–∫ */
    .preset-btn {
      background: #2c313f; border: 1px solid #363c4a; color: #fff;
      border-radius: 12px; padding: 0 14px; font-weight: 700; font-size: 13px;
    }

    /* –ò—Å—Ç–æ—Ä–∏—è */
    .history-bar {
      display: flex; gap: 8px; padding: 0 16px 12px;
      overflow-x: auto; scrollbar-width: none;
    }
    .hist-pill {
      background: #232838; padding: 6px 12px; border-radius: 10px;
      font-size: 13px; font-weight: 800; color: #a5abb8; white-space: nowrap;
    }
    .hist-pill.high { color: var(--b-green); background: rgba(42, 208, 108, 0.15); }
    .hist-pill.low { color: var(--b-red); background: rgba(255, 77, 77, 0.15); }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <a href="/" class="back" style="text-decoration:none; font-weight:900; font-size:20px;">‚Üê</a>
      <div style="font-weight:900; font-size:20px;">CRASH</div>
      <div class="balance" id="balance">
        <span class="star">‚òÖ</span><span class="value" id="balanceValue">...</span>
      </div>
    </header>

    <div class="history-bar" id="historyBar">
      </div>

    <div class="crash-area">
      <canvas id="gameCanvas"></canvas>
      <div class="crash-counter" id="counter">1.00x</div>
    </div>

    <div class="controls-panel">
      <div class="bet-row">
        <div class="bet-input-wrap">
          <span class="star" style="color:var(--accent)">‚òÖ</span>
          <input type="number" id="betAmount" class="bet-input" value="10" placeholder="–°—É–º–º–∞">
        </div>
        <button class="preset-btn" onclick="setBet(50)">50</button>
        <button class="preset-btn" onclick="setBet(100)">100</button>
        <button class="preset-btn" onclick="setBet(500)">500</button>
      </div>
      
      <button id="mainBtn" class="action-btn btn-start">–°–¢–ê–í–ö–ê</button>
    </div>

    <nav class="nav">
      <a class="btn" href="/profile/">–ü—Ä–æ—Ñ–∏–ª—å</a>
      <a class="btn active" href="/crash.html" style="color:#ffd400;">Crash üöÄ</a>
    </nav>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const counterEl = document.getElementById('counter');
    const btn = document.getElementById('mainBtn');
    const balEl = document.getElementById('balanceValue');
    const historyBar = document.getElementById('historyBar');
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã
    let width, height;
    let animationId;
    let startTime;
    let gameState = 'IDLE'; // IDLE, PLAYING, CRASHED
    let gameId = null;
    let currentMultiplier = 1.00;

    // –†–µ—Å–∞–π–∑ –∫–∞–Ω–≤–∞—Å–∞
    function resize() {
      const parent = canvas.parentElement;
      width = parent.clientWidth;
      height = parent.clientHeight;
      canvas.width = width * 2; 
      canvas.height = height * 2;
      ctx.scale(2, 2);
    }
    window.addEventListener('resize', resize);
    resize();

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞
    function drawGraph() {
      ctx.clearRect(0, 0, width, height);

      // –°–µ—Ç–∫–∞
      ctx.strokeStyle = '#232838'; ctx.lineWidth = 1; ctx.beginPath();
      for(let i=1; i<5; i++) {
        const y = height - (i * height / 5);
        ctx.moveTo(0, y); ctx.lineTo(width, y);
      }
      ctx.stroke();

      if (gameState === 'IDLE') return;

      // –†–∏—Å—É–µ–º —Ä–∞–∫–µ—Ç—É
      const time = (Date.now() - startTime) / 1000; // —Å–µ–∫—É–Ω–¥—ã
      
      // –ü—Ä–æ—Å—Ç–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è: –∫—Ä–∏–≤–∞—è –∏–¥–µ—Ç –≤–≤–µ—Ä—Ö
      // X: –≤—Ä–µ–º—è, Y: –≤—ã—Å–æ—Ç–∞
      // –ß—Ç–æ–±—ã –≥—Ä–∞—Ñ–∏–∫ –≤—Å–µ–≥–¥–∞ –±—ã–ª –∫—Ä–∞—Å–∏–≤—ã–º, –º—ã "–∑—É–º–∏–º" –µ–≥–æ –ø–æ –º–µ—Ä–µ —Ä–æ—Å—Ç–∞
      
      ctx.beginPath();
      ctx.lineWidth = 5;
      ctx.strokeStyle = gameState === 'CRASHED' ? '#ff4d4d' : '#ffd400';
      ctx.lineCap = 'round';
      
      const startX = 0; const startY = height;
      const endX = width * 0.8; 
      const endY = height * 0.2;

      ctx.moveTo(startX, startY);
      ctx.quadraticCurveTo(width * 0.4, height, endX, endY);
      ctx.stroke();

      // –ö—Ä—É–∂–æ–∫ —Ä–∞–∫–µ—Ç—ã
      if (gameState !== 'CRASHED') {
        ctx.fillStyle = '#fff'; ctx.beginPath();
        ctx.arc(endX, endY, 6, 0, Math.PI*2); ctx.fill();
        // –°–≤–µ—á–µ–Ω–∏–µ
        ctx.fillStyle = 'rgba(255, 212, 0, 0.4)'; ctx.beginPath();
        ctx.arc(endX, endY, 16 + Math.sin(Date.now()/50)*4, 0, Math.PI*2); ctx.fill();
      }
    }

    // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
    function gameLoop() {
      if (gameState !== 'PLAYING') return;

      const now = Date.now();
      const ms = now - startTime;
      // –¢–ê –°–ê–ú–ê–Ø –§–û–†–ú–£–õ–ê, —Å–æ–≤–ø–∞–¥–∞—é—â–∞—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
      currentMultiplier = Math.pow(Math.E, 0.00006 * ms);
      
      counterEl.textContent = currentMultiplier.toFixed(2) + 'x';
      drawGraph();

      animationId = requestAnimationFrame(gameLoop);
    }

    // 1. –°–¢–ê–†–¢ –ò–ì–†–´
    async function startGame() {
      const betVal = parseInt(document.getElementById('betAmount').value);
      if(!betVal || betVal < 1) return tg.showAlert('–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É!');

      btn.disabled = true;

      try {
        const res = await fetch('/api/crash', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ action: 'start', bet: betVal })
        }).then(r => r.json());

        if (!res.ok) {
          tg.showAlert(res.error || '–û—à–∏–±–∫–∞');
          btn.disabled = false;
          return;
        }

        // –°—Ç–∞—Ä—Ç —É—Å–ø–µ—à–µ–Ω
        gameId = res.gameId;
        startTime = res.startTime; // –ë–µ—Ä–µ–º –≤—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞!
        if(res.balance !== undefined) balEl.textContent = res.balance;

        gameState = 'PLAYING';
        counterEl.classList.remove('crashed');
        counterEl.style.color = '#fff';
        
        btn.disabled = false;
        btn.className = 'action-btn btn-cashout';
        btn.textContent = '–ó–ê–ë–†–ê–¢–¨';
        btn.onclick = cashOut;

        gameLoop();

      } catch (e) {
        console.error(e);
        btn.disabled = false;
      }
    }

    // 2. –ó–ê–ë–†–ê–¢–¨ –î–ï–ù–¨–ì–ò
    async function cashOut() {
      if (gameState !== 'PLAYING' || !gameId) return;
      
      btn.disabled = true; 
      btn.textContent = '...';

      try {
        const res = await fetch('/api/crash', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ action: 'cashout', gameId: gameId })
        }).then(r => r.json());

        if (res.ok) {
          // –ü–æ–±–µ–¥–∞!
          finishGame(true, res.multiplier, res.win);
          if(res.balance !== undefined) balEl.textContent = res.balance;
        } else {
          // –ù–µ —É—Å–ø–µ–ª (–ö—Ä–∞—à –±—ã–ª —Ä–∞–Ω—å—à–µ)
          finishGame(false, res.crashPoint || currentMultiplier.toFixed(2));
        }
      } catch (e) {
        console.error(e);
      }
    }

    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞—É–Ω–¥–∞
    function finishGame(win, point, amount) {
      gameState = win ? 'IDLE' : 'CRASHED';
      cancelAnimationFrame(animationId);
      
      counterEl.textContent = parseFloat(point).toFixed(2) + 'x';
      
      if (win) {
        btn.className = 'action-btn btn-start';
        btn.textContent = `–í–´–ò–ì–†–´–®: +${amount}`;
        btn.style.background = '#2ad06c';
        addHistory(point, true);
        tg.HapticFeedback.notificationOccurred('success');
      } else {
        counterEl.classList.add('crashed');
        btn.className = 'action-btn btn-wait';
        btn.textContent = '–ö–†–ê–®';
        addHistory(point, false);
        tg.HapticFeedback.notificationOccurred('error');
      }
      
      gameId = null;
      setTimeout(resetBtn, 2000);
    }

    function resetBtn() {
      if (gameState === 'PLAYING') return; // –∑–∞—â–∏—Ç–∞
      gameState = 'IDLE';
      btn.className = 'action-btn btn-start';
      btn.textContent = '–°–¢–ê–í–ö–ê';
      btn.onclick = startGame;
      btn.disabled = false;
      
      ctx.clearRect(0, 0, width, height);
      counterEl.textContent = '1.00x';
      counterEl.style.color = '#fff';
    }

    // –•–µ–ª–ø–µ—Ä—ã
    function setBet(val) { document.getElementById('betAmount').value = val; }
    
    function addHistory(val, isWin) {
      const el = document.createElement('div');
      el.className = `hist-pill ${isWin ? 'high' : 'low'}`;
      el.textContent = parseFloat(val).toFixed(2) + 'x';
      historyBar.prepend(el);
      if(historyBar.children.length > 15) historyBar.lastChild.remove();
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ
    fetch('/api/profile').then(r=>r.json()).then(d=>{
      if(d && d.stars) balEl.textContent = d.stars;
    }).catch(console.error);
    
    // –ò–Ω–∏—Ç –∫–Ω–æ–ø–∫–∏
    btn.onclick = startGame;
  </script>
</body>
</html>
