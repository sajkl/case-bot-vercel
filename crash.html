<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Crash ‚Äî Lambo Drop</title>
  <style>
    :root{--bg:#0b0d12;--text:#f7f8fb;--accent:#ffd400;--green:#2ad06c;--red:#ff4d4d}
    * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none; }
    html,body{ margin:0; min-height:100%; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,"Futura PT",sans-serif; overflow-x:hidden; }
    .page{max-width:520px;margin:0 auto;padding:14px 16px 80px;}

    /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
    .top{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;margin-bottom:16px;}
    .back{background:none;color:#fff;font-weight:900;border:none;font-size:24px;cursor:pointer;padding:0;}
    .balance{background:var(--accent);color:#171a1f;font-weight:900;border-radius:999px;padding:6px 14px;display:flex;gap:6px;font-size:15px;}

    /* –ò—Å—Ç–æ—Ä–∏—è */
    .history-bar {
      display: flex; gap: 6px; padding-bottom: 12px;
      overflow-x: auto; scrollbar-width: none;
      mask-image: linear-gradient(to right, black 85%, transparent 100%);
      min-height: 34px;
    }
    .hist-pill {
      background: #232838; padding: 6px 10px; border-radius: 8px;
      font-size: 12px; font-weight: 800; color: #a5abb8; white-space: nowrap;
    }
    /* –£–°–õ–û–í–ò–ï 3: –ó–µ–ª–µ–Ω—ã–π –æ—Ç 1.49 */
    .hist-pill.high { color: var(--green); background: rgba(42, 208, 108, 0.15); }
    .hist-pill.low { color: var(--red); background: rgba(255, 77, 77, 0.15); }

    /* –ò–≥—Ä–æ–≤–∞—è –∑–æ–Ω–∞ */
    .crash-area {
      position: relative; height: 260px;
      background: #171b24; border-radius: 24px; border: 1px solid #232838;
      overflow: hidden; display: flex; align-items: center; justify-content: center;
      margin-bottom: 16px;
    }
    canvas { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 1; }
    
    .crash-info { position: relative; z-index: 2; text-align: center; }
    
    /* –°—á–µ—Ç—á–∏–∫ –º–Ω–æ–∂–∏—Ç–µ–ª—è */
    .crash-counter {
      font-size: 64px; font-weight: 900; color: #fff;
      font-feature-settings: "tnum"; text-shadow: 0 4px 30px rgba(0,0,0,0.5);
      transition: color 0.1s linear; /* –ü–ª–∞–≤–Ω–∞—è —Å–º–µ–Ω–∞ —Ü–≤–µ—Ç–∞ */
    }
    .crash-status { font-size: 14px; font-weight: 700; color: #777; letter-spacing: 1px; margin-top: -5px; }
    
    .crash-counter.crashed { color: var(--red) !important; animation: shake 0.4s; }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞ (–¶–ò–§–†–´) */
    .countdown-num {
      font-size: 80px; font-weight: 900; color: var(--accent);
      opacity: 0; transform: scale(0.5);
    }
    .countdown-num.pop {
      animation: popIn 0.9s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    @keyframes popIn {
      0% { opacity: 0; transform: scale(0.5); }
      20% { opacity: 1; transform: scale(1.1); }
      40% { transform: scale(1); }
      80% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(1.2); }
    }
    @keyframes shake {
      0% { transform: translate(1px, 1px) rotate(0deg); }
      10% { transform: translate(-1px, -2px) rotate(-1deg); }
      20% { transform: translate(-3px, 0px) rotate(1deg); }
      30% { transform: translate(3px, 2px) rotate(0deg); }
      40% { transform: translate(1px, -1px) rotate(1deg); }
      50% { transform: translate(-1px, 2px) rotate(-1deg); }
      60% { transform: translate(-3px, 1px) rotate(0deg); }
      70% { transform: translate(3px, 1px) rotate(-1deg); }
      80% { transform: translate(-1px, -1px) rotate(1deg); }
      90% { transform: translate(1px, 2px) rotate(0deg); }
      100% { transform: translate(1px, -2px) rotate(-1deg); }
    }

    /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    .controls {
      background: #1d212b; padding: 16px; border-radius: 24px; border: 1px solid #2a2f3d;
      margin-bottom: 20px;
    }
    .input-row { display: flex; gap: 10px; margin-bottom: 12px; }
    .input-wrap {
      flex: 1; background: #11141b; border: 1px solid #232838; border-radius: 16px;
      padding: 12px; display: flex; align-items: center; gap: 8px;
    }
    .input-wrap input {
      width: 100%; background: transparent; border: none; color: #fff;
      font-size: 18px; font-weight: 700; outline: none;
    }
    .presets { display: flex; gap: 8px; }
    .preset {
      background: #2c313f; border: 1px solid #363c4a; color: #fff;
      border-radius: 12px; padding: 0 12px; font-weight: 700; font-size: 13px; cursor: pointer;
    }

    .main-btn {
      width: 100%; padding: 18px; border-radius: 18px; border: none;
      font-size: 20px; font-weight: 900; text-transform: uppercase; cursor: pointer;
      transition: transform 0.1s;
    }
    .main-btn:active { transform: scale(0.98); }
    .btn-bet { background: var(--accent); color: #111; box-shadow: 0 4px 15px rgba(255, 212, 0, 0.3); }
    .btn-cashout { background: #ff9f00; color: #111; box-shadow: 0 0 20px rgba(255, 159, 0, 0.4); }
    .btn-wait { background: #2c313f; color: #777; }

    /* –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ */
    .bets-header { display: flex; justify-content: space-between; color: #777; font-size: 13px; font-weight: 700; margin-bottom: 8px; }
    .player-row {
      display: flex; justify-content: space-between; align-items: center;
      background: #171b24; padding: 10px 14px; border-radius: 14px; border: 1px solid #232838;
      margin-bottom: 8px;
    }
    .player-row.win { border-color: rgba(42, 208, 108, 0.3); background: rgba(42, 208, 108, 0.05); }
    .player-row.lost { opacity: 0.5; }
    .p-name { font-weight: 700; font-size: 14px; }
    .p-bet { color: var(--accent); font-weight: 700; font-size: 14px; }
    .p-profit { color: var(--green); font-weight: 800; font-size: 14px; }

    /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
    .nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(11,13,18,0.95); backdrop-filter: blur(10px);
      border-top: 1px solid #1f232e; padding: 12px 16px 24px;
      display: flex; justify-content: space-around; z-index: 100;
    }
    .nav a { color: #5d6470; text-decoration: none; font-weight: 800; font-size: 14px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .nav a.active { color: var(--accent); }
  </style>
</head>
<body>
  <div class="page">
    <div class="top">
      <button class="back" onclick="location.href='/'">‚Üê</button>
      <div style="font-weight:900; font-size:20px;">CRASH</div>
      <div class="balance">‚òÖ <span id="bal">...</span></div>
    </div>

    <div class="history-bar" id="historyBar"></div>

    <div class="crash-area">
      <canvas id="gameCanvas"></canvas>
      <div class="crash-info">
        <div class="crash-counter" id="counter">1.00x</div>
        <div class="crash-status" id="statusText">–ó–ê–ì–†–£–ó–ö–ê</div>
      </div>
    </div>

    <div class="controls">
      <div class="input-row">
        <div class="input-wrap">
          <span style="color:var(--accent)">‚òÖ</span>
          <input type="number" id="betAmount" value="100" placeholder="–°—É–º–º–∞">
        </div>
        <div class="presets">
          <button class="preset" onclick="setBet(50)">50</button>
          <button class="preset" onclick="setBet(100)">100</button>
          <button class="preset" onclick="setBet(500)">500</button>
        </div>
      </div>
      <button id="mainBtn" class="main-btn btn-wait">...</button>
    </div>

    <div class="bets-list">
      <div class="bets-header"><span>–ò–ì–†–û–ö–ò</span> <span id="plCount">0</span></div>
      <div id="betsContainer"></div>
    </div>

    <nav class="nav">
      <a href="/">–ö–µ–π—Å—ã</a>
      <a href="/crash.html" class="active">Crash üöÄ</a>
      <a href="/profile/">–ü—Ä–æ—Ñ–∏–ª—å</a>
    </nav>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    // Elements
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const counterEl = document.getElementById('counter');
    const statusEl = document.getElementById('statusText');
    const historyBar = document.getElementById('historyBar');
    const mainBtn = document.getElementById('mainBtn');
    const betsContainer = document.getElementById('betsContainer');
    const balEl = document.getElementById('bal');

    // State
    let width, height;
    let myId = tg.initDataUnsafe?.user?.id || 0;
    let currentRoundId = null;
    let serverPhase = 'LOADING';
    let serverStartTime = 0;
    let myBet = null;
    let myCashout = false;
    let lastSecond = -1; // –î–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —Ç–∞–π–º–µ—Ä–∞

    // === –ì–†–ê–§–ò–ö–ê ===
    function resize() {
      width = canvas.parentElement.clientWidth;
      height = canvas.parentElement.clientHeight;
      canvas.width = width * 2; canvas.height = height * 2;
      ctx.scale(2, 2);
    }
    window.addEventListener('resize', resize); resize();

    function drawGraph(mult) {
      ctx.clearRect(0, 0, width, height);
      
      // –°–µ—Ç–∫–∞
      ctx.strokeStyle = '#232838'; ctx.lineWidth = 1; ctx.beginPath();
      for(let i=1; i<5; i++) {
        const y = height - (i * height / 5);
        ctx.moveTo(0, y); ctx.lineTo(width, y);
      }
      ctx.stroke();

      if (serverPhase !== 'FLYING' && serverPhase !== 'CRASHED') return;
      if (mult <= 1.00) return; // –ù–µ —Ä–∏—Å—É–µ–º –ª–∏–Ω–∏—é –µ—Å–ª–∏ 1.00

      // –õ–∏–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
      ctx.beginPath();
      ctx.lineWidth = 5;
      
      // –¶–≤–µ—Ç –ª–∏–Ω–∏–∏ –º–µ–Ω—è–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å –∫—ç—Ñ–æ–º
      if(mult < 2.0) ctx.strokeStyle = '#fff';
      else if(mult < 10.0) ctx.strokeStyle = '#2ad06c'; // Green
      else ctx.strokeStyle = '#ffd400'; // Gold

      const progress = Math.min(1, Math.log(mult) / 4); // –£—Å–ª–æ–≤–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å
      const endX = width * 0.1 + (width * 0.8 * progress);
      const endY = height * 0.9 - (height * 0.8 * progress);

      ctx.moveTo(0, height);
      ctx.quadraticCurveTo(width * 0.1, height, endX, endY);
      ctx.stroke();

      if (serverPhase === 'FLYING') {
         // –¢–æ—á–∫–∞ –Ω–∞ –∫–æ–Ω—Ü–µ
         ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(endX, endY, 6, 0, Math.PI*2); ctx.fill();
      }
    }

    // === –¶–í–ï–¢–û–í–û–ô –ì–†–ê–î–ò–ï–ù–¢ (–ó–∞–¥–∞–Ω–∏–µ 4) ===
    function updateCounterColor(mult) {
      if (serverPhase === 'CRASHED') return; // –ü—Ä–∏ –∫—Ä–∞—à–µ —Ü–≤–µ—Ç –∫—Ä–∞—Å–Ω—ã–π —Å—Ç–∞–≤–∏—Ç—Å—è –∫–ª–∞—Å—Å–æ–º

      // 1.00 -> 2.00 (–ë–µ–ª—ã–π -> –ó–µ–ª–µ–Ω—ã–π)
      if (mult < 2.00) {
        // –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç 0 –¥–æ 1
        const pct = (mult - 1.0) / 1.0; 
        // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è RGB: White(255,255,255) -> Green(42, 208, 108)
        // R: 255 -> 42
        // G: 255 -> 208
        // B: 255 -> 108
        const r = 255 - (213 * pct);
        const g = 255 - (47 * pct);
        const b = 255 - (147 * pct);
        counterEl.style.color = `rgb(${r}, ${g}, ${b})`;
      } 
      // 2.00+ -> –ó–µ–ª–µ–Ω—ã–π -> –ó–æ–ª–æ—Ç–æ–π (–ø–ª–∞–≤–Ω–æ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–æ–ª–æ—Ç–æ–π)
      else if (mult < 5.00) {
         counterEl.style.color = '#2ad06c'; // –ß–∏—Å—Ç–æ –∑–µ–ª–µ–Ω—ã–π
      } else {
         counterEl.style.color = '#ffd400'; // –ó–æ–ª–æ—Ç–æ–π –¥–ª—è –≤—ã—Å–æ–∫–∏—Ö
      }
    }

    // === –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ ===
    function renderLoop() {
      const now = Date.now();

      if (serverPhase === 'BETTING') {
        const timeLeft = Math.max(0, Math.ceil((serverStartTime - now) / 1000));
        
        // –£–°–õ–û–í–ò–ï 1: –ê–Ω–∏–º–∞—Ü–∏—è —Ü–∏—Ñ—Ä (–ø–æ—è–≤–ª—è—é—Ç—Å—è –∏ –∏—Å—á–µ–∑–∞—é—Ç)
        if (timeLeft !== lastSecond) {
           lastSecond = timeLeft;
           counterEl.className = 'countdown-num'; // –°–±—Ä–æ—Å –∫–ª–∞—Å—Å–∞
           void counterEl.offsetWidth; // –¢—Ä–∏–≥–≥–µ—Ä —Ä–µ—Ñ–ª–æ—É –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
           counterEl.textContent = timeLeft;
           counterEl.classList.add('pop');
           counterEl.style.color = 'var(--accent)'; // –ñ–µ–ª—Ç—ã–π –¥–ª—è —Ç–∞–π–º–µ—Ä–∞
           statusEl.textContent = "–ü–†–ò–ï–ú –°–¢–ê–í–û–ö";
           ctx.clearRect(0, 0, width, height); // –ß–∏—Å—Ç–∏–º –≥—Ä–∞—Ñ–∏–∫
        }
      } 
      else if (serverPhase === 'FLYING') {
        const ms = now - serverStartTime;
        let mult = 1.00;
        if (ms > 0) mult = Math.pow(Math.E, 0.00006 * ms);

        counterEl.className = 'crash-counter'; // –û–±—ã—á–Ω—ã–π —Å—Ç–∏–ª—å
        counterEl.textContent = mult.toFixed(2) + 'x';
        statusEl.textContent = "–í –ü–û–õ–ï–¢–ï";
        
        updateCounterColor(mult); // –ì—Ä–∞–¥–∏–µ–Ω—Ç
        drawGraph(mult);
      }
      
      requestAnimationFrame(renderLoop);
    }
    requestAnimationFrame(renderLoop);

    // === –õ–û–ì–ò–ö–ê ===
    async function pollState() {
      try {
        const res = await fetch('/api/state').then(r => r.json());

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
        if (historyBar.children.length === 0 && res.history?.length) {
          for(let i=res.history.length-1; i>=0; i--) addHistory(res.history[i]);
        }

        const prevPhase = serverPhase;
        serverPhase = res.phase;

        // –ù–æ–≤—ã–π —Ä–∞—É–Ω–¥
        if (currentRoundId !== res.roundId) {
          currentRoundId = res.roundId;
          myBet = null; myCashout = false;
          // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
          lastSecond = -1;
        }

        // –ö–†–ê–® (–û–±—Ä–∞–±–æ—Ç–∫–∞)
        if (prevPhase === 'FLYING' && serverPhase === 'CRASHED') {
          handleCrash(res.value);
        }
        // –£–°–õ–û–í–ò–ï 2: –ï—Å–ª–∏ –º—ã –∑–∞—à–ª–∏, –∞ —Ç–∞–º —É–∂–µ –∫—Ä–∞—à (–¥–∞–∂–µ 1.00x), –Ω–∞–¥–æ –ø–æ–∫–∞–∑–∞—Ç—å
        if (serverPhase === 'CRASHED' && prevPhase !== 'CRASHED') {
           handleCrash(res.value);
        }

        // –°–∏–Ω—Ö—Ä–æ–Ω –≤—Ä–µ–º–µ–Ω–∏
        if (serverPhase === 'BETTING') serverStartTime = Date.now() + res.value;
        else if (serverPhase === 'FLYING') {
           const elapsed = Math.log(res.value) / 0.00006;
           serverStartTime = Date.now() - elapsed;
        }

        renderBets(res.bets);
        updateBtn();

      } catch (e) { console.error(e); }
    }
    setInterval(pollState, 1000);
    pollState();

    function handleCrash(val) {
      // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
      const lastVal = historyBar.firstElementChild?.textContent;
      const newVal = val.toFixed(2) + 'x';
      if (lastVal !== newVal) addHistory(val);

      // –í–∏–∑—É–∞–ª –∫—Ä–∞—à–∞
      counterEl.className = 'crash-counter crashed';
      counterEl.textContent = newVal;
      counterEl.style.color = ''; // –°–±—Ä–æ—Å –∏–Ω–ª–∞–π–Ω —Ü–≤–µ—Ç–∞, —á—Ç–æ–±—ã —Å—Ä–∞–±–æ—Ç–∞–ª CSS –∫–ª–∞—Å—Å .crashed
      statusEl.textContent = "CRASHED";
      tg.HapticFeedback.notificationOccurred('error');
    }

    // –£–°–õ–û–í–ò–ï 3: –ò—Å—Ç–æ—Ä–∏—è (1.49+)
    function addHistory(val) {
      const el = document.createElement('div');
      const num = parseFloat(val);
      // –ó–µ–ª–µ–Ω—ã–π –µ—Å–ª–∏ >= 1.49, –∏–Ω–∞—á–µ –ö—Ä–∞—Å–Ω—ã–π
      el.className = `hist-pill ${num >= 1.49 ? 'high' : 'low'}`;
      el.textContent = num.toFixed(2) + 'x';
      historyBar.prepend(el);
      if(historyBar.children.length > 20) historyBar.lastChild.remove();
    }

    // –ö–Ω–æ–ø–∫–∏
    function updateBtn() {
      if (serverPhase === 'BETTING') {
         if (myBet) {
            mainBtn.className = 'main-btn btn-wait'; mainBtn.textContent = '–ñ–î–ï–ú...'; mainBtn.onclick = null;
         } else {
            mainBtn.className = 'main-btn btn-bet'; mainBtn.textContent = '–°–¢–ê–í–ö–ê'; mainBtn.onclick = doBet;
         }
      } else if (serverPhase === 'FLYING') {
         if (myBet && !myCashout) {
            mainBtn.className = 'main-btn btn-cashout'; mainBtn.textContent = '–ó–ê–ë–†–ê–¢–¨'; mainBtn.onclick = doCashout;
         } else if (myCashout) {
            mainBtn.className = 'main-btn btn-wait'; mainBtn.textContent = '–£–°–ü–ï–•'; mainBtn.onclick = null;
            mainBtn.style.background = '#2ad06c'; mainBtn.style.color = '#fff';
         } else {
            mainBtn.className = 'main-btn btn-wait'; mainBtn.textContent = '–ò–î–ï–¢ –†–ê–£–ù–î'; mainBtn.onclick = null;
            mainBtn.style.background = '';
         }
      } else {
         mainBtn.className = 'main-btn btn-wait'; mainBtn.textContent = 'CRASHED'; mainBtn.onclick = null;
         mainBtn.style.background = '';
      }
    }

    // API Actions
    async function doBet() {
      const amount = +document.getElementById('betAmount').value;
      if(!amount) return;
      mainBtn.textContent = "...";
      try {
        const res = await fetch('/api/crash', { method: 'POST', headers: {'Content-Type':'application/json','X-Telegram-Data':tg.initData}, body: JSON.stringify({action:'start', bet:amount}) }).then(r=>r.json());
        if(res.ok) { myBet = {id:res.gameId}; if(res.balance) balEl.textContent = res.balance; }
      } catch(e){}
      pollState();
    }
    async function doCashout() {
      if(!myBet) return;
      try {
        const res = await fetch('/api/crash', { method: 'POST', headers: {'Content-Type':'application/json','X-Telegram-Data':tg.initData}, body: JSON.stringify({action:'cashout', gameId:myBet.id}) }).then(r=>r.json());
        if(res.ok) { myCashout = true; if(res.balance) balEl.textContent = res.balance; tg.HapticFeedback.notificationOccurred('success'); }
      } catch(e){}
      pollState();
    }

    function renderBets(bets) {
      if(!bets) return;
      document.getElementById('plCount').textContent = bets.length;
      betsContainer.innerHTML = bets.map(b => {
        const isMe = b.user_id == myId;
        const isWin = b.status === 'cashed_out';
        const profit = isWin ? Math.floor(b.bet_amount * b.cashout_point) : 0;
        return `
          <div class="player-row ${isWin?'win':(b.status==='busted'?'lost':'')}">
             <div class="p-name">${isMe ? '–í–´' : `User ${b.user_id.toString().slice(0,3)}..`}</div>
             <div class="p-bet">${b.bet_amount} ‚òÖ</div>
             <div class="p-profit">${isWin ? `+${profit}` : (b.status==='active'?'...':'')}</div>
          </div>
        `;
      }).join('');
    }

    function setBet(v){document.getElementById('betAmount').value=v}
    
    // Init balance
    fetch('/api/profile', {headers:{'X-Telegram-Data':tg.initData}}).then(r=>r.json()).then(d=>{if(d.stars) balEl.textContent=d.stars});
  </script>
</body>
</html>
