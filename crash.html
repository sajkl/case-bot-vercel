<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Crash ‚Äî Lambo Drop</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <style>
    /* === 1. FULLSCREEN INIT === */
    html { background: #0b0d12; }
    body {
      margin: 0; padding: 0;
      width: 100vw; height: 100vh;
      overflow: hidden; 
      background: #0b0d12;
      color: #f7f8fb;
      font-family: system-ui, -apple-system, "Futura PT", sans-serif;
      padding-top: calc(env(safe-area-inset-top) + 20px); 
    }

    .page {
      width: 100%; height: 100%;
      overflow-y: auto; 
      -webkit-overflow-scrolling: touch;
      max-width: 520px; margin: 0 auto;
      padding: 0 16px 90px;
      display: flex; flex-direction: column;
    }

    :root{--bg:#0b0d12;--text:#f7f8fb;--accent:#ffd400}
    *{box-sizing:border-box}

    /* === HEADER === */
    .header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 0; z-index: 2; position: relative; flex-shrink: 0;
      margin-bottom: 10px;
    }
    .header-left { display: flex; align-items: center; gap: 8px; }
    
    .back-arrow {
      display: flex; align-items: center; justify-content: center;
      width: 32px; height: 32px;
      color: #fff; cursor: pointer;
      background: rgba(255,255,255,0.05);
      border-radius: 50%;
      transition: background 0.2s;
      text-decoration: none;
    }
    .back-arrow:active { background: rgba(255,255,255,0.15); transform: scale(0.95); }
    .back-arrow svg { width: 20px; height: 20px; fill: currentColor; }

    .logo { height: clamp(30px, 6vw, 36px); }

    .balance { 
      background: var(--accent); color: #171a1f; 
      font-weight: 900; border-radius: 999px; 
      padding: 8px 14px; display: flex; gap: 8px; align-items: center; 
      text-decoration: none; font-size: 14px;
    }
    .balance .star { font-size: 16px; }

    /* === CRASH GAME STYLES === */
    :root{--green:#2ad06c;--red:#ff4d4d}

    .title-area { margin-bottom: 12px; text-align: center; }
    .h1 { font-weight:900; font-size:32px; margin:0; line-height: 1; text-transform: uppercase; letter-spacing: 1px; }

    .history-bar {
      display: flex; gap: 6px; padding-bottom: 12px;
      overflow-x: auto; scrollbar-width: none;
      mask-image: linear-gradient(to right, black 85%, transparent 100%);
      min-height: 34px; flex-shrink: 0;
    }
    .hist-pill {
      background: #232838; padding: 6px 10px; border-radius: 8px;
      font-size: 12px; font-weight: 800; color: #a5abb8; white-space: nowrap;
    }
    .hist-pill.high { color: var(--green); background: rgba(42, 208, 108, 0.15); }
    .hist-pill.low { color: var(--red); background: rgba(255, 77, 77, 0.15); }

    .crash-area {
      position: relative; height: 260px; width: 100%;
      background: #171b24; border-radius: 24px; border: 1px solid #232838;
      overflow: hidden; display: flex; align-items: center; justify-content: center;
      margin-bottom: 16px; flex-shrink: 0;
    }
    canvas { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 1; }
    .crash-info { position: relative; z-index: 2; text-align: center; pointer-events: none; }
    
    .crash-counter {
      font-size: 64px; font-weight: 900; color: #fff;
      font-feature-settings: "tnum"; text-shadow: 0 4px 30px rgba(0,0,0,0.5);
      transition: color 0.1s linear;
    }
    .crash-status { font-size: 14px; font-weight: 700; color: #777; letter-spacing: 1px; margin-top: -5px; }
    .crash-counter.crashed { color: var(--red) !important; animation: shake 0.4s; }

    .countdown-num { font-size: 80px; font-weight: 900; color: var(--accent); opacity: 0; transform: scale(0.5); }
    .countdown-num.pop { animation: popIn 0.9s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    @keyframes popIn { 0% { opacity:0;transform:scale(0.5) } 20% { opacity:1;transform:scale(1.1) } 100% { opacity:0;transform:scale(1.2) } }
    @keyframes shake { 0%,100% {transform:translate(0,0)} 25% {transform:translate(-2px,2px)} 75% {transform:translate(2px,-2px)} }

    .controls {
      background: #1d212b; padding: 16px; border-radius: 24px; border: 1px solid #2a2f3d;
      margin-bottom: 20px; flex-shrink: 0;
    }
    .input-row { display: flex; gap: 10px; margin-bottom: 12px; }
    .input-wrap {
      flex: 1; background: #11141b; border: 1px solid #232838; border-radius: 16px;
      padding: 12px; display: flex; align-items: center; gap: 8px;
    }
    .input-wrap input {
      width: 100%; background: transparent; border: none; color: #fff;
      font-size: 18px; font-weight: 700; outline: none;
    }
    .presets { display: flex; gap: 8px; }
    .preset {
      background: #2c313f; border: 1px solid #363c4a; color: #fff;
      border-radius: 12px; padding: 0 12px; font-weight: 700; font-size: 13px; cursor: pointer;
    }

    .main-btn {
      width: 100%; padding: 18px; border-radius: 18px; border: none;
      font-size: 20px; font-weight: 900; text-transform: uppercase; cursor: pointer;
      transition: transform 0.1s;
    }
    .main-btn:active { transform: scale(0.98); }
    .btn-bet { background: var(--accent); color: #111; box-shadow: 0 4px 15px rgba(255, 212, 0, 0.3); }
    .btn-cashout { background: #ff9f00; color: #111; box-shadow: 0 0 20px rgba(255, 159, 0, 0.4); }
    .btn-wait { background: #2c313f; color: #777; }

    .bets-list { flex-shrink: 0; }
    .bets-header { display: flex; justify-content: space-between; color: #777; font-size: 13px; font-weight: 700; margin-bottom: 8px; }
    .player-row {
      display: flex; justify-content: space-between; align-items: center;
      background: #171b24; padding: 10px 14px; border-radius: 14px; border: 1px solid #232838;
      margin-bottom: 8px;
    }
    .player-row.win { border-color: rgba(42, 208, 108, 0.3); background: rgba(42, 208, 108, 0.05); }
    .player-row.lost { opacity: 0.5; }
    .p-name { font-weight: 700; font-size: 14px; }
    .p-bet { color: var(--accent); font-weight: 700; font-size: 14px; }
    .p-profit { color: var(--green); font-weight: 800; font-size: 14px; }
    
    .nav-spacer { height: 90px; flex-shrink: 0; }
  </style>
</head>
<body>
  <div class="page">
    
    <header class="header">
      <div class="header-left">
        <a href="/" class="back-arrow">
           <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        </a>
        <img class="logo" src="/assets/logo.png" alt="LAMBO DROP">
      </div>
      
      <a class="balance" href="/topup/">
        <span class="star">‚òÖ</span> <span id="bal">...</span>
      </a>
    </header>

    <div class="title-area">
       <div class="h1">CRASH üöÄ</div>
    </div>

    <div class="history-bar" id="historyBar"></div>

    <div class="crash-area">
      <canvas id="gameCanvas"></canvas>
      <div class="crash-info">
        <div class="crash-counter" id="counter">1.00x</div>
        <div class="crash-status" id="statusText">–ó–ê–ì–†–£–ó–ö–ê</div>
      </div>
    </div>

    <div class="controls">
      <div class="input-row">
        <div class="input-wrap">
          <span style="color:var(--accent)">‚òÖ</span>
          <input type="number" id="betAmount" value="100" placeholder="–°—É–º–º–∞">
        </div>
        <div class="presets">
          <button class="preset" onclick="setBet(50)">50</button>
          <button class="preset" onclick="setBet(100)">100</button>
          <button class="preset" onclick="setBet(500)">500</button>
        </div>
      </div>
      <button id="mainBtn" class="main-btn btn-wait">...</button>
    </div>

    <div class="bets-list">
      <div class="bets-header"><span>–ò–ì–†–û–ö–ò</span> <span id="plCount">0</span></div>
      <div id="betsContainer"></div>
    </div>

    <div class="nav-spacer"></div>
  </div>

  <nav class="nav">
    <a class="btn" href="/">–ö–µ–π—Å—ã</a>
    <a class="btn active" href="/crash.html">Crash üöÄ</a>
    <a class="btn" href="/profile/">–ü—Ä–æ—Ñ–∏–ª—å</a>
  </nav>

  <script>
    const tg = window.Telegram.WebApp;

    // === FULLSCREEN INIT ===
    function initApp() {
        tg.ready();
        try {
            if (tg.requestFullscreen) tg.requestFullscreen();
            else tg.expand();
        } catch (e) { tg.expand(); }
        try { tg.setHeaderColor('#0b0d12'); tg.setBackgroundColor('#0b0d12'); } catch (e) {}
    }
    initApp();
    setTimeout(initApp, 100);

    // Elements
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const counterEl = document.getElementById('counter');
    const statusEl = document.getElementById('statusText');
    const historyBar = document.getElementById('historyBar');
    const mainBtn = document.getElementById('mainBtn');
    const betsContainer = document.getElementById('betsContainer');
    const balEl = document.getElementById('bal');

    // State
    let width, height;
    let myId = tg.initDataUnsafe?.user?.id || 0;
    let currentRoundId = null;
    let serverPhase = 'LOADING';
    let serverStartTime = 0;
    let myBet = null;
    let myCashout = false;
    let lastSecond = -1;
    let isActionLoading = false;

    // === –ê–í–¢–û–ú–û–ë–ò–õ–ò ===
    const CAR_ASSETS = [
        '/assets/cars/lm002.png',
        '/assets/cars/countach.png',
        '/assets/cars/urus.png',
        '/assets/cars/huracan.png'
    ];
    let currentCarImg = new Image();
    
    // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –º–∞—à–∏–Ω—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    function pickRandomCar() {
        const path = CAR_ASSETS[Math.floor(Math.random() * CAR_ASSETS.length)];
        currentCarImg.src = path;
    }
    pickRandomCar(); // –ó–∞–ø—É—Å–∫–∞–µ–º –≤—ã–±–æ—Ä

    // === –°–ò–°–¢–ï–ú–ê –î–´–ú–ê (Particles) ===
    let particles = [];
    function createSmoke(x, y) {
        // –°–æ–∑–¥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å—Ç–∏—Ü
        for(let i=0; i<2; i++) {
            particles.push({
                x: x,
                y: y + 10, // –ß—É—Ç—å –Ω–∏–∂–µ —Ü–µ–Ω—Ç—Ä–∞
                vx: -2 - Math.random() * 2, // –õ–µ—Ç–∏—Ç –Ω–∞–∑–∞–¥
                vy: -1 + Math.random() * 2, // –ù–µ–º–Ω–æ–≥–æ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑
                life: 1.0, // –ñ–∏–∑–Ω—å –æ—Ç 1 –¥–æ 0
                size: 5 + Math.random() * 5
            });
        }
    }

    function drawSmoke() {
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.life -= 0.03; // –£–≥–∞—Å–∞–Ω–∏–µ
            p.size += 0.3; // –†–∞—Å—Ç–µ—Ç

            if (p.life <= 0) {
                particles.splice(i, 1);
            } else {
                ctx.globalAlpha = p.life * 0.4; // –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π
                ctx.fillStyle = '#888';
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }
        }
    }

    // === –ì–†–ê–§–ò–ö–ê ===
    function resize() {
      width = canvas.parentElement.clientWidth;
      height = canvas.parentElement.clientHeight;
      canvas.width = width * 2; canvas.height = height * 2;
      ctx.scale(2, 2);
    }
    window.addEventListener('resize', resize); resize();

    function drawGraph(mult) {
      ctx.clearRect(0, 0, width, height);
      
      // –°–µ—Ç–∫–∞
      ctx.strokeStyle = '#232838'; ctx.lineWidth = 1; ctx.beginPath();
      for(let i=1; i<5; i++) {
        const y = height - (i * height / 5);
        ctx.moveTo(0, y); ctx.lineTo(width, y);
      }
      ctx.stroke();

      if (serverPhase !== 'FLYING' && serverPhase !== 'CRASHED') {
          // –û—á–∏—â–∞–µ–º –¥—ã–º –µ—Å–ª–∏ –∏–≥—Ä–∞ –Ω–µ –∏–¥–µ—Ç
          particles = [];
          return;
      }
      if (mult <= 1.00) return; 

      // –õ–∏–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
      ctx.beginPath();
      ctx.lineWidth = 4;
      
      if(mult < 2.0) ctx.strokeStyle = '#fff';
      else if(mult < 5.0) ctx.strokeStyle = '#2ad06c'; 
      else ctx.strokeStyle = '#ffd400'; 

      // –ö—Ä–∏–≤–∞—è –ë–µ–∑—å–µ
      const progress = Math.min(1, Math.log(mult) / 4);
      const endX = width * 0.1 + (width * 0.8 * progress);
      const endY = height * 0.9 - (height * 0.8 * progress);

      ctx.moveTo(0, height);
      ctx.quadraticCurveTo(width * 0.1, height, endX, endY);
      ctx.stroke();

      if (serverPhase === 'FLYING') {
         // –†–∏—Å—É–µ–º –¥—ã–º
         createSmoke(endX, endY);
         drawSmoke();

         // –†–∏—Å—É–µ–º –º–∞—à–∏–Ω–∫—É
         // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–≤–æ—Ä–æ—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –º–∞—à–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –Ω–∞–∫–ª–æ–Ω—è—Ç—å—Å—è)
         ctx.save();
         ctx.translate(endX, endY);
         
         // –í—ã—á–∏—Å–ª—è–µ–º —É–≥–æ–ª –Ω–∞–∫–ª–æ–Ω–∞ (–∫–∞—Å–∞—Ç–µ–ª—å–Ω–∞—è)
         // –£–ø—Ä–æ—â–µ–Ω–Ω–æ: —á–µ–º –≤—ã—à–µ –ª–µ—Ç–∏–º, —Ç–µ–º –±–æ–ª—å—à–µ –Ω–∞–∫–ª–æ–Ω (–¥–æ 45 –≥—Ä–∞–¥—É—Å–æ–≤)
         const angle = -Math.min(Math.PI / 4, progress * Math.PI / 2);
         ctx.rotate(angle);

         // –†–∏—Å—É–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É (—Ü–µ–Ω—Ç—Ä –º–∞—à–∏–Ω–∫–∏ –≤ —Ç–æ—á–∫–µ –≥—Ä–∞—Ñ–∏–∫–∞)
         const carW = 60; // –®–∏—Ä–∏–Ω–∞ –º–∞—à–∏–Ω–∫–∏
         const carH = 30; // –í—ã—Å–æ—Ç–∞ –º–∞—à–∏–Ω–∫–∏
         if (currentCarImg.complete) {
             ctx.drawImage(currentCarImg, -carW/2, -carH/2, carW, carH);
         } else {
             // –§–æ–ª–±–µ–∫ (–±–µ–ª–∞—è —Ç–æ—á–∫–∞, –µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å)
             ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(0, 0, 6, 0, Math.PI*2); ctx.fill();
         }
         
         ctx.restore();
      }
    }

    // === –ü–õ–ê–í–ù–´–ô –¶–í–ï–¢–û–í–û–ô –ü–ï–†–ï–•–û–î ===
    function updateCounterColor(mult) {
      if (serverPhase === 'CRASHED') return; 

      if (mult < 2.00) {
        const pct = (mult - 1.0); 
        const r = 255 - (213 * pct); 
        const g = 255 - (47 * pct);  
        const b = 255 - (147 * pct); 
        counterEl.style.color = `rgb(${r}, ${g}, ${b})`;
      } 
      else if (mult < 5.00) {
         const pct = (mult - 2.0) / 3.0;
         const r = 42 + (213 * pct);
         const g = 208 + (4 * pct);
         const b = 108 - (108 * pct);
         counterEl.style.color = `rgb(${r}, ${g}, ${b})`;
      } 
      else {
         counterEl.style.color = '#ffd400';
      }
    }

    // === –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ ===
    function renderLoop() {
      const now = Date.now();

      if (serverPhase === 'BETTING') {
        const timeLeft = Math.max(0, Math.ceil((serverStartTime - now) / 1000));
        
        if (timeLeft !== lastSecond) {
           lastSecond = timeLeft;
           counterEl.className = 'countdown-num'; 
           void counterEl.offsetWidth; 
           counterEl.textContent = timeLeft;
           counterEl.classList.add('pop');
           counterEl.style.color = 'var(--accent)'; 
           statusEl.textContent = "–ü–†–ò–ï–ú –°–¢–ê–í–û–ö";
           ctx.clearRect(0, 0, width, height); 
           particles = []; // –°–±—Ä–æ—Å –¥—ã–º–∞
           // –ú–æ–∂–Ω–æ —Ç—É—Ç –º–µ–Ω—è—Ç—å –º–∞—à–∏–Ω—É –Ω–∞ –∫–∞–∂–¥—ã–π —Ä–∞—É–Ω–¥
           if(timeLeft === 5) pickRandomCar(); 
        }
      } 
      else if (serverPhase === 'FLYING') {
        const ms = now - serverStartTime;
        let mult = 1.00;
        if (ms > 0) mult = Math.pow(Math.E, 0.00006 * ms);

        counterEl.className = 'crash-counter'; 
        counterEl.textContent = mult.toFixed(2) + 'x';
        statusEl.textContent = "–í –ü–û–õ–ï–¢–ï";
        
        updateCounterColor(mult); 
        drawGraph(mult);
      }
      
      requestAnimationFrame(renderLoop);
    }
    requestAnimationFrame(renderLoop);

    // === –õ–û–ì–ò–ö–ê ===
    async function pollState() {
      try {
        const res = await fetch('/api/state').then(r => r.json());

        if (historyBar.children.length === 0 && res.history?.length) {
          for(let i=res.history.length-1; i>=0; i--) addHistory(res.history[i]);
        }

        const prevPhase = serverPhase;
        serverPhase = res.phase;

        if (currentRoundId !== res.roundId) {
          currentRoundId = res.roundId;
          myBet = null; myCashout = false;
          lastSecond = -1;
        }

        if (prevPhase === 'FLYING' && serverPhase === 'CRASHED') {
          handleCrash(res.value);
        }
        if (serverPhase === 'CRASHED' && prevPhase !== 'CRASHED') {
           handleCrash(res.value);
        }

        if (serverPhase === 'BETTING') serverStartTime = Date.now() + res.value;
        else if (serverPhase === 'FLYING') {
           const elapsed = Math.log(res.value) / 0.00006;
           serverStartTime = Date.now() - elapsed;
        }

        renderBets(res.bets);
        updateBtn();

      } catch (e) { console.error(e); }
    }
    setInterval(pollState, 250);
    pollState();

    function handleCrash(val) {
      const lastVal = historyBar.firstElementChild?.textContent;
      const newVal = val.toFixed(2) + 'x';
      if (lastVal !== newVal) addHistory(val);

      counterEl.className = 'crash-counter crashed';
      counterEl.textContent = newVal;
      counterEl.style.color = ''; 
      statusEl.textContent = "CRASHED";
      tg.HapticFeedback.notificationOccurred('error');
    }

    function addHistory(val) {
      const el = document.createElement('div');
      const num = parseFloat(val);
      el.className = `hist-pill ${num >= 1.49 ? 'high' : 'low'}`;
      el.textContent = num.toFixed(2) + 'x';
      historyBar.prepend(el);
      if(historyBar.children.length > 20) historyBar.lastChild.remove();
    }

    function updateBtn() {
      if (isActionLoading) return; 

      if (serverPhase === 'BETTING') {
         if (myBet) {
            mainBtn.className = 'main-btn btn-wait'; 
            mainBtn.textContent = '–°–¢–ê–í–ö–ê –ü–†–ò–ù–Ø–¢–ê';
            mainBtn.onclick = null;
         } else {
            mainBtn.className = 'main-btn btn-bet'; 
            mainBtn.textContent = '–ü–û–°–¢–ê–í–ò–¢–¨'; 
            mainBtn.onclick = doBet;
         }
      } else if (serverPhase === 'FLYING') {
         if (myBet && !myCashout) {
            mainBtn.className = 'main-btn btn-cashout'; 
            mainBtn.textContent = '–ó–ê–ë–†–ê–¢–¨'; 
            mainBtn.onclick = doCashout;
         } else if (myCashout) {
            mainBtn.className = 'main-btn btn-wait'; 
            mainBtn.textContent = '–£–°–ü–ï–•'; 
            mainBtn.onclick = null;
            mainBtn.style.background = '#2ad06c'; 
            mainBtn.style.color = '#fff';
         } else {
            mainBtn.className = 'main-btn btn-wait'; 
            mainBtn.textContent = '–ò–î–ï–¢ –†–ê–£–ù–î'; 
            mainBtn.onclick = null;
            mainBtn.style.background = '';
         }
      } else {
         mainBtn.className = 'main-btn btn-wait'; 
         mainBtn.textContent = 'CRASHED'; 
         mainBtn.onclick = null;
         mainBtn.style.background = '';
      }
    }

    async function doBet() {
      if (isActionLoading) return;
      const amount = +document.getElementById('betAmount').value;
      if (!amount) return;

      isActionLoading = true;
      tg.HapticFeedback.selectionChanged();
      mainBtn.className = 'main-btn btn-wait';
      mainBtn.textContent = "–û–±—Ä–∞–±–æ—Ç–∫–∞...";
      
      try {
        const res = await fetch('/api/crash', { 
            method: 'POST', 
            headers: {'Content-Type':'application/json','X-Telegram-Data':tg.initData}, 
            body: JSON.stringify({action:'start', bet:amount}) 
        }).then(r=>r.json());

        if (res.ok) { 
            myBet = {id:res.gameId}; 
            if(res.balance) balEl.textContent = res.balance; 
            tg.HapticFeedback.notificationOccurred('success');
        } else {
            tg.showAlert(res.error || '–û—à–∏–±–∫–∞ —Å—Ç–∞–≤–∫–∏');
        }
      } catch(e){
          console.error(e);
      } finally {
          isActionLoading = false;
          pollState();
      }
    }

    async function doCashout() {
      if (!myBet || isActionLoading) return;
      
      isActionLoading = true;
      tg.HapticFeedback.impactOccurred('medium');
      mainBtn.className = 'main-btn btn-wait';
      mainBtn.style.background = '#2ad06c';
      mainBtn.style.color = '#fff';
      mainBtn.textContent = "–ó–ê–ë–ò–†–ê–ï–ú...";

      try {
        const res = await fetch('/api/crash', { 
            method: 'POST', 
            headers: {'Content-Type':'application/json','X-Telegram-Data':tg.initData}, 
            body: JSON.stringify({action:'cashout', gameId:myBet.id}) 
        }).then(r=>r.json());

        if (res.ok) { 
            myCashout = true; 
            if(res.balance) balEl.textContent = res.balance; 
            tg.HapticFeedback.notificationOccurred('success');
        }
      } catch(e){
      } finally {
         isActionLoading = false;
         pollState();
      }
    }

    function renderBets(bets) {
      if(!bets) return;
      document.getElementById('plCount').textContent = bets.length;
      betsContainer.innerHTML = bets.map(b => {
        const isMe = b.user_id == myId;
        const isWin = b.status === 'cashed_out';
        const profit = isWin ? Math.floor(b.bet_amount * b.cashout_point) : 0;
        return `
          <div class="player-row ${isWin?'win':(b.status==='busted'?'lost':'')}">
             <div class="p-name">${isMe ? '–í–´' : `User ${b.user_id.toString().slice(0,3)}..`}</div>
             <div class="p-bet">${b.bet_amount} ‚òÖ</div>
             <div class="p-profit">${isWin ? `+${profit}` : (b.status==='active'?'...':'')}</div>
          </div>
        `;
      }).join('');
    }

    function setBet(v){document.getElementById('betAmount').value=v}
    
    fetch('/api/profile', {headers:{'X-Telegram-Data':tg.initData}}).then(r=>r.json()).then(d=>{if(d.stars) balEl.textContent=d.stars});
  </script>
</body>
</html>
